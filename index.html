<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rivift OS</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
<script type="module">
    import { Editor } from 'https://esm.sh/@tiptap/core';
    import * as core from 'https://esm.sh/@tiptap/core'; 
    import StarterKit from 'https://esm.sh/@tiptap/starter-kit';
    import Placeholder from 'https://esm.sh/@tiptap/extension-placeholder';
    import { TextAlign } from 'https://esm.sh/@tiptap/extension-text-align';
    import { TextStyle } from 'https://esm.sh/@tiptap/extension-text-style';
    import { Color } from 'https://esm.sh/@tiptap/extension-color';
    import { FontFamily } from 'https://esm.sh/@tiptap/extension-font-family';
    import { Underline } from 'https://esm.sh/@tiptap/extension-underline';
    import 'https://esm.run/@material/web/switch/switch.js';
    window.Tiptap = {
        core, 
        Editor,
        StarterKit,
        Placeholder,
        TextAlign,
        TextStyle,
        Color,
        FontFamily,
        Underline
    };
</script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs/editor/editor.main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs/loader.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
:root {
            --bg-color-dark: #121212;
            --bg-color-light: #f4f4f4;
            --text-color-dark: #e0e0e0;
            --text-color-light: #181818;
            --taskbar-bg-dark: rgba(28, 28, 28, 0.7);
            --taskbar-bg-light: rgba(245, 245, 245, 0.7);
            --panel-bg-dark: rgba(28, 28, 28, 0.85);
            --panel-bg-light: rgba(248, 248, 248, 0.85);
            --window-bg-dark: #1e1e1e;
            --window-bg-light: #fdfdfd;
            --header-bg-dark: rgba(40, 40, 40, 0.8);
            --header-bg-light: rgba(240, 240, 240, 0.8);
            --sidebar-bg-dark: #252526;
            --sidebar-bg-light: #f3f3f3;
            --border-color-dark: rgba(255, 255, 255, 0.1);
            --border-color-light: rgba(0, 0, 0, 0.1);
            --input-bg-dark: rgba(255, 255, 255, 0.05);
            --input-bg-light: #f0f0f0;
            --input-border-dark: rgba(100, 100, 100, 0.5);
            --input-border-light: rgba(180, 180, 180, 0.5);
            --accent-color: #007bff;
            --accent-color-hover: #0056b3;
            --accent-color-text: #ffffff;
            --status-indicator-color-active: var(--accent-color);
            --status-indicator-color-minimized: #ffbd2e;
            --status-indicator-color-inactive: #888;
            --quick-setting-tile-bg-off-dark: rgba(255, 255, 255, 0.1);
            --quick-setting-tile-bg-on-dark: var(--accent-color);
            --quick-setting-tile-bg-off-light: rgba(0, 0, 0, 0.05);
            --quick-setting-tile-bg-on-light: var(--accent-color);
            --quick-setting-tile-text-off-dark: #f4f4f4;
            --quick-setting-tile-text-on-dark: var(--accent-color-text);
            --quick-setting-tile-text-off-light: #333;
            --quick-setting-tile-text-on-light: var(--accent-color-text);
            --context-menu-bg-dark: rgba(50, 50, 50, 0.95);
            --context-menu-bg-light: rgba(250, 250, 250, 0.95);
            --context-menu-border-dark: rgba(70, 70, 70, 1);
            --context-menu-border-light: rgba(200, 200, 200, 1);
            --context-menu-item-hover-bg-dark: rgba(70, 70, 70, 1);
            --context-menu-item-hover-bg-light: rgba(220, 220, 220, 1);
        }
        body {
        font-family: 'Inter', sans-serif;
        overflow: hidden;
        transition: background-color 0.5s ease;
    -webkit-font-smoothing: antialiased; 
    -moz-osx-font-smoothing: grayscale;   
    text-rendering: optimizeLegibility;    
        }
        h3, h4 {
        letter-spacing: -0.02em; 
        }
        body.dark-mode {
            background-color: var(--bg-color-dark);
            color: var(--text-color-dark);
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.2); 
        }
        body.dark-mode #rivift-os-container {
            background-color: var(--bg-color-dark);
        }
        body.dark-mode #taskbar {
            background-color: var(--taskbar-bg-dark);
        }
        body.dark-mode #quick-settings,
        body.dark-mode #start-menu,
        body.dark-mode #all-apps-fullscreen {
            background-color: var(--panel-bg-dark);
        }
        body.dark-mode .app-window {
            background-color: var(--window-bg-dark);
        }
        body.dark-mode .window-header {
            background-color: var(--header-bg-dark);
            border-bottom-color: var(--border-color-dark);
        }
        body.dark-mode #settings-sidebar {
            background-color: var(--sidebar-bg-dark);
        }
        .app-window {
            position: absolute;
            transform-origin: center center;
        }
        body.dark-mode .calculator-display,
        body.dark-mode #app-window-notepad textarea,
        body.dark-mode #browser-input,
        body.dark-mode #new-event-input,
        body.dark-mode #clock-alarm-input,
        body.dark-mode #clock-timer-input,
        body.dark-mode #clock-stopwatch-display,
        body.dark-mode #script-editor-code,
        body.dark-mode #script-editor-output {
            background-color: var(--input-bg-dark);
            border-color: var(--input-border-dark);
            color: var(--text-color-dark);
        }
        body.dark-mode .quick-setting-toggle {
            background-color: #555;
        }
        body.dark-mode .quick-setting-toggle.active { 
            background-color: #007bff;
        }
        body.dark-mode .slider-container {
            background-color: #555;
        }
        body.dark-mode .power-options button,
        body.dark-mode .calculator-buttons button,
        body.dark-mode #app-window-music-player .controls button,
        body.dark-mode #app-window-calendar .calendar-day,
        body.dark-mode #app-window-calendar .event-item,
        body.dark-mode #app-window-clock .clock-tab-button,
        body.dark-mode #script-editor-run-button {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-color-dark);
        }
        body.dark-mode #app-window-calendar .calendar-weekday {
            color: #ccc;
        }
        body.dark-mode #app-window-calendar .event-section {
            border-top-color: var(--border-color-dark);
        }
        body.dark-mode #settings-sidebar ul li {
            color: var(--text-color-dark);
        }
        body.dark-mode #settings-sidebar ul li:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        body.dark-mode #settings-sidebar ul li.active {
            background-color: #007bff;
            color: #f4f4f4;
        }
        body.dark-mode .notification-item {
            background-color: rgba(30, 30, 30, 0.9);
            color: var(--text-color-dark);
        }
        body.dark-mode .notification-item.has-buttons {
            background-color: rgba(40, 40, 40, 0.95);
        }
        body.dark-mode .notification-button {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-color-dark);
        }
        body.dark-mode .notification-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        body.dark-mode .quick-setting-tile {
            background-color: var(--quick-setting-tile-bg-off-dark);
            color: var(--quick-setting-tile-text-off-dark);
        }
        body.dark-mode .quick-setting-tile.active {
            background-color: var(--quick-setting-tile-bg-on-dark);
            color: var(--quick-setting-tile-text-on-dark);
        }
        body.dark-mode #message-box {
            background-color: var(--panel-bg-dark);
            color: var(--text-color-dark);
        }
        body.dark-mode #message-box-overlay.network-error-overlay {
            backdrop-filter: blur(15px); 
            background-color: rgba(0, 0, 0, 0.5); 
        }
        body.dark-mode #message-box-overlay.network-error-overlay #message-box {
            background-color: var(--panel-bg-dark); 
            color: var(--text-color-dark);
        }
        body.dark-mode .taskbar-context-menu {
            background-color: var(--context-menu-bg-dark);
            border-color: var(--context-menu-border-dark);
        }
        body.dark-mode .taskbar-context-menu-item:hover {
            background-color: var(--context-menu-item-hover-bg-dark);
        }
        body.dark-mode .taskbar-context-menu-item i {
            color: #ccc;
        }
        body.light-mode {
            background-color: var(--bg-color-light);
            color: var(--text-color-light);
        }
body.light-mode #app-window-settings {
    background-color: var(--window-bg-light);
    color: var(--text-color-light);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}
body.light-mode #app-window-settings .window-header {
    background-color: var(--header-bg-light);
    border-bottom-color: var(--border-color-light);
}
body.light-mode #app-window-settings #settings-sidebar {
    background-color: var(--sidebar-bg-light);
    border-right: 1px solid var(--border-color-light); 
}
body.light-mode #app-window-settings #settings-sidebar ul li:hover {
    background-color: rgba(0, 0, 0, 0.05);
}
body.light-mode #app-window-settings #settings-sidebar ul li.active {
    background-color: #007bff;
    color: #f4f4f4;
}
body.light-mode #app-window-settings #settings-main-content {
    background-color: var(--window-bg-light);
}
body.aero-enabled.light-mode #app-window-settings .window-header {
    background-color: transparent !important;
    border-bottom-color: var(--border-color-light) !important;
}
body.aero-enabled.light-mode #app-window-settings #settings-sidebar,
body.aero-enabled.light-mode #app-window-settings #settings-main-content {
    background-color: transparent !important;
}
        body.light-mode #desktop-icons .desktop-icon-label {
            color: #181818;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }
        body.light-mode #rivift-os-container {
            background-color: var(--bg-color-light);
        }
        body.light-mode #taskbar {
            background-color: var(--taskbar-bg-light);
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
        }
        body.light-mode #taskbar-left .taskbar-icon,
        body.light-mode #taskbar-center .taskbar-icon,
        body.light-mode #taskbar-right .taskbar-icon {
            background-color: rgba(0, 0, 0, 0.05);
        }
        body.light-mode #taskbar-left .taskbar-icon i,
        body.light-mode #taskbar-center .taskbar-icon i,
        body.light-mode #taskbar-right .taskbar-icon i {
            color: #333;
        }
        body.light-mode #taskbar-left .taskbar-icon:hover,
        body.light-mode #taskbar-center .taskbar-icon:hover,
        body.light-mode #taskbar-right .taskbar-icon:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        body.light-mode #current-time {
            color: var(--text-color-light);
            background-color: rgba(0, 0, 0, 0.05);
        }
        body.light-mode #current-time:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        body.light-mode #quick-settings,
        body.light-mode #start-menu,
        body.light-mode #all-apps-fullscreen {
            background-color: var(--panel-bg-light);
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            color: var(--text-color-light);
        }
        body.light-mode #quick-settings h3,
        body.light-mode #start-menu h3,
        body.light-mode #all-apps-fullscreen h3 {
            color: var(--text-color-light);
        }
        body.light-mode .quick-setting-item {
            color: var(--text-color-light);
        }
        body.light-mode .power-options button {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-color-light);
        }
        body.light-mode .power-options button:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        body.light-mode #all-apps-button {
            background-color: #007bff; 
            color: #f4f4f4;
        }
        body.light-mode #recent-apps-files h4 {
            color: #666;
        }
        body.light-mode .recent-item {
            color: var(--text-color-light);
            background-color: rgba(0, 0, 0, 0.05);
        }
        body.light-mode .recent-item:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        body.light-mode .recent-item i {
            color: #666;
        }
        body.light-mode .app-window {
            background-color: var(--window-bg-light);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            color: var(--text-color-light);
        }
        body.light-mode .window-header {
            background-color: var(--header-bg-light);
            border-bottom-color: var(--border-color-light);
        }
        body.light-mode .window-header span {
            color: var(--text-color-light);
        }
        body.light-mode .window-control-btn i {
            color: rgba(0, 0, 0, 0);
        }
        body.light-mode .window-control-btn:hover i {
            color: rgba(0, 0, 0, 0.8);
        }
        body.light-mode .window-content {
            color: var(--text-color-light);
        }
        body.light-mode #settings-sidebar {
            background-color: var(--sidebar-bg-light);
        }
        body.light-mode #settings-sidebar ul li {
            color: var(--text-color-light);
        }
        body.light-mode #settings-sidebar ul li:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        body.light-mode #settings-sidebar ul li.active {
            background-color: #007bff;
            color: #f4f4f4;
        }
        body.light-mode #settings-main-content h4 {
            color: var(--text-color-light);
        }
        body.light-mode .setting-item span {
            color: var(--text-color-light);
        }
        body.light-mode .setting-item {
            border-bottom-color: var(--border-color-light);
        }
        body.light-mode .wallpaper-preview {
            border-color: rgba(0,0,0,0.1);
        }
        body.light-mode .wallpaper-preview.selected {
            border-color: #007bff;
        }
        body.light-mode #local-wallpaper-status {
            color: #666;
        }
        body.light-mode .calculator-display {
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-color-light);
        }
        body.light-mode .calculator-buttons button {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-color-light);
        }
        body.light-mode .calculator-buttons button:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        body.light-mode #app-window-notepad textarea,
        body.light-mode #script-editor-code,
        body.light-mode #script-editor-output {
            background-color: var(--input-bg-light);
            color: var(--text-color-light);
            border-color: var(--input-border-light);
        }
        body.light-mode #browser-input,
        body.light-mode #new-event-input,
        body.light-mode #clock-alarm-input,
        body.light-mode #clock-timer-input,
        body.light-mode #clock-stopwatch-display {
            background-color: var(--input-bg-light);
            color: var(--text-color-light);
            border-color: var(--input-border-light);
        }
        body.light-mode #browser-iframe {
            background-color: #f4f4f4;
        }
        body.light-mode #browser-message {
            background-color: rgba(255, 255, 255, 0.9);
            color: var(--text-color-light);
        }
        body.light-mode #current-song-display {
            color: var(--text-color-light);
        }
        body.light-mode #app-window-music-player .controls button,
        body.light-mode #script-editor-run-button {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-color-light);
        }
        body.light-mode #app-window-music-player .controls button:hover,
        body.light-mode #script-editor-run-button:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        body.light-mode #app-window-calendar .calendar-day {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-color-light);
        }
        body.light-mode #app-window-calendar .calendar-day:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        body.light-mode #app-window-calendar .calendar-day.other-month {
            color: #999;
        }
        body.light-mode #app-window-calendar .event-list p {
            color: #666;
        }
        body.light-mode #app-window-calendar .event-item {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-color-light);
        }
        body.light-mode #app-window-calendar .event-section {
            border-top-color: var(--border-color-light);
        }
        body.light-mode #app-window-files .w-1_4 { 
            background-color: var(--sidebar-bg-light);
        }
        body.light-mode #app-window-files h4 {
            color: var(--text-color-light);
        }
        body.light-mode #app-window-files ul li {
            color: var(--text-color-light);
        }
        body.light-mode #app-window-files ul li:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        body.light-mode #app-window-files .grid div {
            color: var(--text-color-light);
        }
        body.light-mode #app-window-files .grid div:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        body.light-mode #app-window-files .grid div i {
            color: #666;
        }
        body.light-mode .notification-item {
            background-color: rgba(255, 255, 255, 0.9);
            color: var(--text-color-light);
        }
        body.light-mode .notification-item.has-buttons {
            background-color: rgba(240, 240, 240, 0.95);
        }
        body.light-mode .notification-button {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-color-light);
        }
        body.light-mode .notification-button:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        body.light-mode .quick-setting-toggle {
            background-color: rgba(0,0,0,0.05); 
        }
        body.light-mode .quick-setting-toggle.active { 
            background-color: #007bff;
        }
        body.light-mode .quick-setting-tile {
            background-color: var(--quick-setting-tile-bg-off-light);
            color: var(--quick-setting-tile-text-off-light);
        }
        body.light-mode .quick-setting-tile.active {
            background-color: var(--quick-setting-tile-bg-on-light);
            color: var(--quick-setting-tile-text-on-light);
        }
        body.light-mode #message-box {
            background-color: var(--panel-bg-light);
            color: var(--text-color-light);
        }
        body.light-mode #message-box-overlay.network-error-overlay {
            backdrop-filter: blur(15px); 
            background-color: rgba(0, 0, 0, 0.5); 
        }
        body.light-mode #message-box-overlay.network-error-overlay #message-box {
            background-color: var(--panel-bg-light); 
            color: var(--text-color-light);
        }
        body.light-mode .taskbar-context-menu {
            background-color: var(--context-menu-bg-light);
            border-color: var(--context-menu-border-light);
        }
        body.light-mode .taskbar-context-menu-item:hover {
            background-color: var(--context-menu-item-hover-bg-light);
        }
        body.light-mode .taskbar-context-menu-item i {
            color: #555;
        }
        body.light-mode #all-apps-fullscreen {
            color: var(--text-color-light); 
        }
        body.light-mode #all-apps-header h3 {
            color: var(--text-color-light);
        }
        body.light-mode #all-apps-search-bar {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-color-light);
            border: 1px solid var(--border-color-light);
        }
        body.light-mode #all-apps-search-bar::placeholder {
            color: rgba(0, 0, 0, 0.4);
        }
        body.light-mode #all-apps-search-bar:focus {
            background-color: rgba(0, 0, 0, 0.1);
        }
        body.light-mode .app-icon-fullscreen {
            color: var(--text-color-light);
        }
        body.light-mode .app-icon-fullscreen .icon-box {
            background-color: rgba(0, 0, 0, 0.05);
        }
        body.light-mode .app-icon-fullscreen .icon-box i {
            color: var(--text-color-light);
        }
        body.light-mode .app-icon-fullscreen .pin-button {
            background-color: rgba(0, 0, 0, 0.3);
        }
        body.light-mode .app-icon-fullscreen .pin-button i {
            color: #f4f4f4;
        }
        body.light-mode .app-icon-fullscreen .pin-button.pinned i {
            color: #007bff;
        }
        body.light-mode #exit-all-apps {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-color-light);
        }
        body.light-mode #exit-all-apps:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        #rivift-os-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out; 
        }
        #desktop {
            flex-grow: 1;
            position: relative;
            overflow: hidden; 
        }
#taskbar {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: calc(100% - 40px);
    height: 60px;
    display: flex;
    align-items: center;
    padding: 0 20px;
    gap: 20px;
    overflow: hidden;
    backdrop-filter: blur(10px);
    box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
    transition: transform 0.3s ease-in-out, border-radius 0.3s ease, width 0.3s ease, height 0.3s ease;
    z-index: 10000;
    border-radius: 15px 15px 0 0;
}
#taskbar.hidden {
    transform: translateX(-50%) translateY(100%);
}
#taskbar.full-width {
    width: 100%;
    max-width: none;
    border-radius: 0;
}
#taskbar-left,
#taskbar-right {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
}
#taskbar-center {
    flex-grow: 1;
    min-width: 0;
    height: 100%;
    display: flex;
    align-items: center;
    gap: 10px;
    overflow-x: scroll;
    scrollbar-width: none;
    justify-content: flex-start; 
}
#taskbar-center::-webkit-scrollbar {
    display: none;
}
#taskbar-center.center-align {
    justify-content: center;
}
#taskbar-center.auto-fit-icons {
    overflow-x: hidden;
    justify-content: center;
}
.taskbar-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    flex-direction: column; 
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    user-select: none;
    flex-shrink: 0;
}
#taskbar-center.auto-fit-icons .taskbar-icon {
    flex-shrink: 1;
}
.taskbar-icon.dragging {
    opacity: 0.5;
    transform: scale(1.1);
}
.taskbar-icon.drag-over {
    border: 2px dashed #007bff;
}
.taskbar-icon:hover {
    transform: translateY(-2px);
}
.taskbar-icon i {
    font-size: 1.2rem;
}
.taskbar-icon .status-indicator {
    position: absolute;
    bottom: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 3px;
    background-color: var(--status-indicator-color-inactive);
    border-radius: 2px;
    opacity: 0;
    transition: width 0.3s ease, background-color 0.3s ease, opacity 0.3s ease;
}
.taskbar-icon.app-state-active .status-indicator {
    width: calc(100% - 10px);
    background-color: var(--status-indicator-color-active);
    opacity: 1;
}
.taskbar-icon.app-state-minimized .status-indicator,
.taskbar-icon.app-state-hidden .status-indicator {
    width: 16px;
    background-color: var(--status-indicator-color-inactive);
    opacity: 1;
}
#current-time {
    font-size: 0.9rem;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 8px;
    transition: background-color 0.2s ease;
}
#current-time:hover {
    background-color: rgba(255, 255, 255, 0.1);
}
#taskbar-center {
    --mask-start-percent: 5%;
    --mask-end-percent: 95%;
    -webkit-mask-image: linear-gradient(to right, 
        transparent 0%, #202020 var(--mask-start-percent), 
        #202020 var(--mask-end-percent), transparent 100%);
    mask-image: linear-gradient(to right, 
        transparent 0%, #202020 var(--mask-start-percent), 
        #202020 var(--mask-end-percent), transparent 100%);
}
        #current-time {
            font-size: 0.9rem;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }
        #current-time:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        #quick-settings {
            position: absolute;
            bottom: 70px; 
            right: 20px; 
            width: 300px;
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4);
            transform: translateY(100%) scale(0.8);
            opacity: 0;
            visibility: hidden;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out, visibility 0.3s;
            z-index: 999;
        }
        #quick-settings.active {
            transform: translateY(0) scale(1);
            opacity: 1;
            visibility: visible;
        }
        .quick-setting-tiles-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .quick-setting-tile {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            min-height: 80px; 
            justify-content: space-between;
        }
        .quick-setting-tile i {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
        .quick-setting-tile span {
            font-size: 0.9rem;
            font-weight: 500;
        }
        .quick-setting-toggle {
            position: relative;
            width: 40px; 
            height: 20px; 
            border-radius: 10px; 
            cursor: pointer;
            transition: background-color 0.3s ease, justify-content 0.3s ease; 
            display: flex;
            align-items: center;
            justify-content: flex-start; 
        }
        .quick-setting-toggle.active {
            justify-content: flex-end; 
        }
        .quick-setting-toggle .slider {
            width: 16px; 
            height: 16px; 
            background-color: #f4f4f4;
            border-radius: 50%;
            transition: transform 0.3s ease; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            margin: 0 2px; 
        }
        .slider-container {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            position: relative;
            margin-top: 5px;
        }
        .slider-fill {
            height: 100%;
            background-color: #007bff;
            border-radius: 44px;
            width: 50%; 
        }
input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 8px; 
    background: transparent;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
    cursor: pointer;
}
input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px; 
    height: 16px;
    background: #f4f4f4;
    border-radius: 50%;
    margin-top: -4px; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.4);
    transition: transform 0.2s;
}
body.light-mode input[type="range"]::-webkit-slider-thumb {
    background: #333;
}
input[type="range"]:hover::-webkit-slider-thumb,
input[type="range"]:active::-webkit-slider-thumb {
    transform: scale(1.2);
}
#music-progress::-webkit-slider-thumb {
    background: #007bff;
}
body.light-mode #music-progress::-webkit-slider-thumb {
    background: #007bff;
}
        .power-options button {
            padding: 8px 12px;
            border-radius: 8px;
            margin-right: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex; 
            align-items: center;
            gap: 5px;
        }
        .power-options button i { 
            color: inherit;
        }
        .power-options button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
#start-menu {
    position: absolute;
    bottom: 70px; 
    left: 20px;   
    transform: translateY(100%) scale(0.9); 
    width: 520px;
    max-width: 90vw;
    height: 550px;
    max-height: 70vh;
    backdrop-filter: blur(15px);
    border-radius: 15px;
    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4);
    opacity: 0;
    visibility: hidden;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                visibility 0.3s;
    z-index: 10001;
}
#start-menu.active {
    transform: translateY(0) scale(1); 
    opacity: 1;
    visibility: visible;
}
        #notification-center {
            margin-bottom: 20px;
            max-height: 150px;
            overflow-y: auto;
        }
        .notification-item {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            backdrop-filter: blur(5px); 
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            position: relative;
            overflow: hidden; 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
        }
        .notification-item-content {
            flex-grow: 1;
        }
        .notification-close-btn {
            background: none;
            border: none;
            color: inherit;
            font-size: 1rem;
            cursor: pointer;
            padding: 0 5px;
            margin-left: 10px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .notification-close-btn:hover {
            opacity: 1;
        }
        .notification-item.hide {
            transform: translateX(100%);
            opacity: 0;
        }
        .notification-item.has-buttons {
            padding-bottom: 5px; 
        }
        .notification-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 10px;
        }
        .notification-button {
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #all-apps-button {
            background-color: #007bff;
            color: #f4f4f4;
            padding: 10px 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-bottom: 20px;
        }
        #all-apps-button:hover {
            background-color: #0056b3;
        }
        #recent-apps-files {
            flex-grow: 1;
            overflow-y: auto; 
        }
        #recent-apps-files-list { 
        }
        #no-recent-items { 
            color: #999; 
            text-align: center;
            padding: 10px;
        }
        .recent-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }
        .recent-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .recent-item i {
            margin-right: 10px;
            color: #ccc;
        }
#all-apps-fullscreen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(20px);
    z-index: 11000;
    display: grid; 
    grid-template-rows: auto 1fr auto;
    align-items: center;
    justify-items: center;
    padding: 5vh 0;
    gap: 2vh;
    visibility: hidden;
    opacity: 0;
    transition: opacity 0.4s ease-out, visibility 0.4s;
}
#all-apps-fullscreen.active { visibility: visible; opacity: 1; }
#all-apps-header {
    width: 100%;
    max-width: 400px;
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    gap: 15px;
}
#all-apps-search-bar {
    grid-column: 2 / 3;
    width: 100%;
    padding: 10px 20px;
    border-radius: 25px;
    background-color: rgba(255, 255, 255, 0.15);
    border: none;
    color: #f4f4f4;
    font-size: 1.1rem;
    outline: none;
    transition: background-color 0.2s ease;
    text-align: center;
}
#all-apps-search-bar::placeholder { color: rgba(255, 255, 255, 0.7); }
#all-apps-search-bar:focus { background-color: rgba(255, 255, 255, 0.25); }
#select-pin-apps-button,
#exit-all-apps {
    grid-row: 1 / 2;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.8);
    display: grid;
    place-items: center;
    cursor: pointer;
    font-size: 1.1rem;
    transition: all 0.2s;
    border: none;
}
#select-pin-apps-button { grid-column: 1 / 2; }
#exit-all-apps { grid-column: 3 / 4; }
#select-pin-apps-button:hover,
#exit-all-apps:hover {
    background-color: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
}
#select-pin-apps-button.active {
    background-color: #007bff;
    color: #f4f4f4;
    transform: rotate(360deg);
}
#all-apps-main-content {
    display: flex;
    flex-direction: row; 
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%; 
    gap: 20px; 
}
#all-apps-grid-container {
    width: 100%;
    height: 100%;
    display: flex;
    overflow-x: scroll;
    scroll-snap-type: x mandatory; 
    scrollbar-width: none;
}
#all-apps-grid-container::-webkit-scrollbar { display: none; }
.all-apps-grid-page {
    width: 100%;
    height: 100%;
    flex-shrink: 0;
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    grid-template-rows: repeat(5, 1fr);
    padding: 20px 8vw;
    box-sizing: border-box;
    scroll-snap-align: center;
    place-items: center; 
}
#all-apps-pagination {
    display: flex;
    gap: 16px; 
    padding: 0 20px;
    align-items: center; 
}
#all-apps-pagination .dot {
    width: 8px; 
    height: 8px; 
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.4);
    cursor: pointer; 
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
}
#all-apps-pagination .dot:hover {
    transform: scale(1.5);
    background-color: rgba(255, 255, 255, 0.6);
}
#all-apps-pagination .dot.active {
    background-color: rgba(255, 255, 255, 0.9);
    transform: scale(1.8);
}
body.light-mode #all-apps-pagination .dot { background-color: rgba(0, 0, 0, 0.3); }
body.light-mode #all-apps-pagination .dot:hover { background-color: rgba(0, 0, 0, 0.4); }
body.light-mode #all-apps-pagination .dot.active { background-color: rgba(0, 0, 0, 0.7); }
.app-icon-fullscreen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center; 
    width: 120px;
    height: 120px; 
    color: #f4f4f4;
    cursor: pointer;
    transition: transform 0.2s ease;
}
.app-icon-fullscreen:hover {
    transform: translateY(-5px);
}
.icon-wrapper {
    position: relative; 
    width: 80px;
    height: 80px;
    margin-bottom: 8px;
}
.app-icon-fullscreen .icon-box {
    width: 100%; 
    height: 100%; 
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 22.5%; 
    display: flex;
    justify-content: center;
    align-items: center;
}
.app-icon-fullscreen .icon-box i,
.app-icon-fullscreen .icon-box img {
    font-size: 3rem;
    color: #f4f4f4;
    width: 3rem;
    height: 3rem;
}
.app-icon-fullscreen span {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.8);
    text-align: center;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.app-icon-fullscreen .pin-button {
    position: absolute;
    top: -4px;
    right: -4px;
    width: 24px;
    height: 24px;
    background-color: #333;
    border: 2px solid #555;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    opacity: 0;
    transform: scale(0.8);
    transition: all 0.2s ease;
}
.app-icon-fullscreen.pin-mode .pin-button {
    opacity: 1;
    transform: scale(1);
}
.app-icon-fullscreen .pin-button i {
    font-size: 0.8rem;
    color: #f4f4f4;
}
.app-icon-fullscreen .pin-button.pinned {
    background-color: #007bff;
    border-color: #f4f4f4;
}
.app-icon-fullscreen .pin-button.pinned i {
    transform: rotate(0); 
    color: #f4f4f4;
}
body.light-mode .app-icon-fullscreen span { color: #555; text-shadow: none; }
body.light-mode .app-icon-fullscreen .icon-box { background-color: rgba(255, 255, 255, 0.8); }
body.light-mode .app-icon-fullscreen .icon-box i, body.light-mode .app-icon-fullscreen .icon-box img { color: #333; }
body.light-mode .app-icon-fullscreen .pin-button { background-color: #eee; border-color: #ccc; }
body.light-mode .app-icon-fullscreen .pin-button i { color: #555; }
body.light-mode .app-icon-fullscreen .pin-button.pinned { background-color: #007bff; border-color: #f4f4f4; }
body.light-mode .app-icon-fullscreen .pin-button.pinned i { color: #f4f4f4; }
body.light-mode #select-pin-apps-button,
body.light-mode #exit-all-apps {
    background-color: rgba(0, 0, 0, 0.05); color: #606060;
}
#exit-all-apps {
    display: none;
}
#select-pin-apps-button {
    display: none;
}
body.light-mode #all-apps-fullscreen {
    background-color: rgba(255, 255, 255, 0.7);
}
body.light-mode #all-apps-search-bar {
    background-color: rgba(0, 0, 0, 0.05);
    color: #333;
    border: 1px solid rgba(0,0,0,0.1);
}
body.light-mode #all-apps-search-bar::placeholder {
    color: rgba(0, 0, 0, 0.4);
}
body.light-mode #all-apps-pagination .dot {
    background-color: rgba(0, 0, 0, 0.3);
}
body.light-mode #all-apps-pagination .dot.active {
    background-color: rgba(0, 0, 0, 0.7);
}
body.light-mode .app-icon-fullscreen {
    color: #333;
}
body.light-mode .app-icon-fullscreen span {
    text-shadow: none;
    color: #555; 
}
body.light-mode .app-icon-fullscreen .icon-box {
    background-color: rgba(255, 255, 255, 0.8);
}
body.light-mode .app-icon-fullscreen .icon-box i,
body.light-mode .app-icon-fullscreen .icon-box img {
    color: #333;
}
        .app-window {
            position: absolute;
            backdrop-filter: blur(15px);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            resize: both; 
            min-width: 300px;
            min-height: 200px;
            z-index: 1; 
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, width 0.2s ease, height 0.2s ease, border-radius 0.3s ease;
        }
        .app-window.active {
            opacity: 1;
            transform: scale(1);
        }
        .app-window.maximized {
            border-radius: 0; 
        }
        #app-window-calculator.maximized,
        #app-window-pingpong.maximized {
        }
        .window-header {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            border-bottom: 1px solid;
            cursor: grab; 
            position: relative; 
            height: 40px; 
             flex-shrink: 0;
        }
        #app-window-settings .window-header {
            border-radius: 0; 
        }
        .app-window:not(#app-window-settings) .window-header {
             border-radius: 15px 15px 0 0;
        }
        .app-window.maximized .window-header {
            border-radius: 0; 
        }
        .window-header span { 
            font-weight: 500;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: none; 
        }
body.aero-enabled .app-window .window-header {
    background-color: transparent !important; 
    border-bottom: 1px solid var(--border-color-dark) !important;
}
body.aero-enabled.light-mode .app-window .window-header {
    border-bottom: 1px solid var(--border-color-light) !important;
}
body:not(.aero-enabled) .app-window .window-header {
    background-color: var(--header-bg-dark) !important;
}
body:not(.aero-enabled).light-mode .app-window .window-header {
    background-color: var(--header-bg-light) !important;
}
        .window-controls {
            display: flex;
            gap: 8px;
            z-index: 1; 
            margin-left: 0; 
            position: absolute; 
            top: 50%;
            transform: translateY(-50%);
            left: 15px;
        }
        #app-window-settings .window-controls {
            position: static; 
            transform: none;
            margin-left: 0; 
        }
        .window-control-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
            position: relative; 
            display: flex; 
            justify-content: center;
            align-items: center;
        }
        .window-control-btn i {
            color: rgba(0, 0, 0, 0); 
            font-size: 0.7rem;
            transition: color 0.1s ease;
        }
#desktop-icons {
    -webkit-user-select: none; user-select: none;
    inset: 0;
    padding: 10px;
    display: grid;
    grid-auto-flow: column; 
    grid-template-rows: repeat(auto-fill, 90px); 
    grid-template-columns: repeat(auto-fill, 90px); 
    gap: 10px;
    justify-content: start; 
    align-content: start;   
}
#desktop-icons.grid-mode {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
    gap: 10px;
    align-content: flex-start;
}
.desktop-icon {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    width: 90px;
    height: 90px;
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
}
.desktop-icon:hover, .desktop-icon.selected {
    background-color: rgba(255, 255, 255, 0.15);
}
.desktop-icon-img {
    width: 48px;
    height: 48px;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.desktop-icon-img img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}
.desktop-icon-img i {
    font-size: 40px; 
    line-height: 1;
    color: #f4f4f4;
}
.desktop-icon-label {
    font-size: 12px;
    color: #f4f4f4;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    text-align: center;
    width: 80px; 
    word-wrap: break-word; 
    line-height: 1.2;
}
.desktop-icon.dragging {
    opacity: 0.5;
}
        .window-control-btn.close { background-color: #ff5f56; } 
        .window-control-btn.minimize { background-color: #ffbd2e; } 
        .window-control-btn.maximize { background-color: #27c93f; } 
        .window-control-btn.close:hover i { color: #4c0000; } 
        .window-control-btn.minimize:hover i { color: #5c3b00; } 
        .window-control-btn.maximize:hover i { color: #004c00; } 
        .window-content {
            flex-grow: 1;
            padding: 15px;
            overflow: auto; 
        }
.window-control-btn.maximize {
    position: relative;
}
#maximize-preview-box {
    position: absolute;
    border: 2px solid #007bff;
    border-radius: 10px;
    background-color: rgba(0, 123, 255, 0.2);
    backdrop-filter: blur(5px);
    pointer-events: none; 
    opacity: 0;
    transition: all 0.2s ease;
    z-index: 999;
    display: none; 
}
#maximize-preview-box.active {
    display: block;
    opacity: 1;
}
#snap-layouts-popup {
    position: fixed;
    display: grid;
    grid-template-areas:
        "qtl qtr . hl hr"
        "qbl qbr . hl hr";
    grid-template-columns: 60px 60px 10px 60px 60px; 
    grid-template-rows: 42px 42px; 
    gap: 6px;
    width: auto; 
    height: auto; 
    background-color: var(--panel-bg-dark, rgba(28, 28, 28, 0.9));
    backdrop-filter: blur(15px);
    border: 1px solid var(--border-color-dark, rgba(255, 255, 255, 0.1));
    border-radius: 8px;
    padding: 10px;
    z-index: 5000;
    opacity: 0;
    transition: opacity 0.2s, transform 0.2s;
    transform-origin: top center;
    transform: scale(0.95);
    pointer-events: none;
}
body.light-mode #snap-layouts-popup {
    background-color: var(--panel-bg-light, rgba(248, 248, 248, 0.9));
    border-color: var(--border-color-light, rgba(0, 0, 0, 0.1));
}
#snap-layouts-popup.visible {
    opacity: 1;
    transform: scale(1);
    pointer-events: auto;
}
.snap-layout-option {
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
}
.snap-layout-option:hover {
    background-color: #007bff;
    border-color: #f4f4f4;
    transform: scale(1.05);
}
.snap-layout-option[data-layout="quarter-top-left"] { grid-area: qtl; }
.snap-layout-option[data-layout="quarter-top-right"] { grid-area: qtr; }
.snap-layout-option[data-layout="quarter-bottom-left"] { grid-area: qbl; }
.snap-layout-option[data-layout="quarter-bottom-right"] { grid-area: qbr; }
.snap-layout-option[data-layout="half-left"] { grid-area: hl; }
.snap-layout-option[data-layout="half-right"] { grid-area: hr; }
        #app-window-settings {
            display: flex;
            flex-direction: column; 
            background-color: var(--window-bg-dark); 
            color: var(--text-color-dark); 
        }
        #app-window-settings .window-content-wrapper { 
            display: flex;
            flex-direction: row;
            flex-grow: 1; 
            overflow: hidden; 
        }
        #app-window-settings .window-content {
            padding: 0; 
            display: flex;
            flex-direction: row;
            flex-grow: 1; 
        }
        #settings-sidebar {
            width: 200px; 
            padding: 15px;
            flex-shrink: 0; 
            background-color: var(--sidebar-bg-dark); 
            color: var(--text-color-dark); 
            overflow-y: auto; 
        }
        #settings-sidebar ul li {
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        #settings-sidebar ul li i {
            margin-right: 10px;
        }
        #settings-sidebar ul li.active {
            background-color: #007bff;
            color: #f4f4f4;
        }
        body.light-mode #settings-sidebar ul li.active {
            background-color: #007bff;
            color: #f4f4f4;
        }
        #settings-main-content {
        flex-grow: 1;
        padding: 15px;
        overflow-y: auto;
        background-color: var(--window-bg-dark);
        }
        body.light-mode #settings-main-content {
            background-color: var(--window-bg-light);
        }
        #app-window-settings .setting-category {
            margin-bottom: 20px;
        }
        #app-window-settings .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color-dark); 
        }
        body.light-mode #app-window-settings .setting-item {
            border-bottom: 1px solid var(--border-color-light); 
        }
        #app-window-settings .setting-item:last-child {
            border-bottom: none;
        }
        #app-window-settings .wallpaper-preview {
            width: 80px;
            height: 50px;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s ease;
        }
        #app-window-settings .wallpaper-preview.selected {
            border-color: #007bff;
        }
        #app-window-settings .file-input-button {
            background-color: #007bff;
            color: #f4f4f4;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        #app-window-settings .file-input-button:hover {
            background-color: #0056b3;
        }
        #app-window-settings .password-pattern-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            width: 200px; 
            margin: 15px auto 0 auto; 
        }
        #app-window-settings .password-pattern-grid button {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            transition: background-color 0.2s ease;
        }
        #app-window-settings .password-pattern-grid button.selected {
            background-color: #007bff;
        }
        #app-window-calculator {
            width: 300px;
            height: 400px;
        }
        .calculator-display {
            font-size: 2.5rem;
            text-align: right;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            min-height: 60px;
            display: flex;
            align-items: flex-end;
            justify-content: flex-end;
            word-break: break-all;
        }
        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .calculator-buttons button {
            font-size: 1.5rem;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .calculator-buttons button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .calculator-buttons button.operator {
            background-color: #007bff;
        }
        .calculator-buttons button.operator:hover {
            background-color: #0056b3;
        }
        .calculator-buttons button.equals {
            background-color: #28a745;
        }
        .calculator-buttons button.equals:hover {
            background-color: #218838;
        }
        #app-window-notepad textarea {
            width: 100%;
            height: 100%;
            border: none;
            padding: 10px;
            border-radius: 8px;
            resize: none;
            outline: none;
        }
        #app-window-music-player .controls button {
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #app-window-music-player .controls button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        #app-window-calendar .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        #app-window-calendar .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        #app-window-calendar .calendar-day,
        #app-window-calendar .calendar-weekday {
            padding: 8px;
            border-radius: 8px;
        }
        #app-window-calendar .calendar-weekday {
            font-weight: bold;
        }
        #app-window-calendar .calendar-day {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #app-window-calendar .calendar-day:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        #app-window-calendar .calendar-day.current-month {
            color: inherit;
        }
        #app-window-calendar .calendar-day.other-month {
            color: #666;
        }
        #app-window-calendar .calendar-day.selected {
            background-color: #007bff;
            font-weight: bold;
            color: #f4f4f4;
        }
        #app-window-calendar .event-list {
            margin-top: 20px;
            border-top: 1px solid;
            padding-top: 15px;
        }
        #app-window-calendar .event-item {
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        #app-window-clock .clock-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        #app-window-clock .clock-tab-button {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin: 0 5px;
        }
        #app-window-clock .clock-tab-button.active {
            background-color: #007bff;
            color: #f4f4f4;
        }
        #app-window-clock .clock-tab-content {
            text-align: center;
        }
        #app-window-clock #clock-display {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 20px;
        }
        #app-window-clock #clock-alarm-input,
        #app-window-clock #clock-timer-input {
            width: 150px;
            text-align: center;
        }
        #app-window-clock #clock-stopwatch-display {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 20px;
        }
        #app-window-clock .alarm-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid var(--border-color-dark);
        }
        body.light-mode #app-window-clock .alarm-list-item {
            border-bottom: 1px solid var(--border-color-light);
        }
        #app-window-pingpong {
            width: 600px;
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        #pingpong-game-area {
            flex-grow: 1;
            background-color: #333;
            position: relative;
            overflow: hidden;
            border-radius: 0 0 15px 15px;
        }
        #pingpong-paddle-player, #pingpong-paddle-ai, #pingpong-ball {
            position: absolute;
            background-color: #007bff;
            border-radius: 5px;
        }
        #pingpong-paddle-player, #pingpong-paddle-ai {
            width: 15px;
            height: 80px;
        }
        #pingpong-ball {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }
        #pingpong-score {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            color: #f4f4f4;
            font-size: 1.5rem;
            z-index: 10;
        }
        #pingpong-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #f4f4f4;
            font-size: 2rem;
            text-align: center;
            z-index: 11;
            background-color: rgba(0,0,0,0.7);
            padding: 15px 30px;
            border-radius: 10px;
            display: none; 
        }
        #pingpong-start-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #28a745;
            color: #f4f4f4;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            z-index: 12;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #pingpong-start-button:hover {
            background-color: #218838;
        }
        #message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 21000;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s;
        }
        #message-box-overlay.active {
            visibility: visible;
            opacity: 1;
        }
        #message-box {
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        #message-box h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        #message-box p {
            margin-bottom: 25px;
            line-height: 1.5;
        }
        #message-box-custom-content { 
            margin-bottom: 25px;
        }
        #message-box-buttons button {
            background-color: #007bff;
            color: #f4f4f4;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin: 0 10px;
            transition: background-color 0.2s ease;
        }
        #message-box-buttons button:hover {
            background-color: #0056b3;
        }
        #message-box-buttons button.cancel {
            background-color: #555;
        }
        #message-box-buttons button.cancel:hover {
            background-color: #333;
        }
        @keyframes expandBackground {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        #all-apps-fullscreen.active #all-apps-grid {
            animation: expandBackground 0.4s ease-out forwards;
        }
#lock-screen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 15000;
    color: #f4f4f4; 
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.5s ease-in-out, visibility 0s linear 0.5s;
}
#lock-screen.visible {
    opacity: 1;
    visibility: visible;
    transition-delay: 0s;
}
#lock-screen-bg {
    position: absolute; inset: 0;
    background-size: cover; background-position: center;
    transition: filter 0.5s ease-in-out, transform 0.5s ease-in-out;
}
#lock-screen.password-mode #lock-screen-bg {
    filter: blur(20px) brightness(0.5);
    transform: scale(1.05);
}
#lock-screen-default-content {
    position: absolute; inset: 0;
    transition: opacity 0.3s;
}
#lock-screen.password-mode #lock-screen-default-content {
    opacity: 0; pointer-events: none;
}
#lock-screen-unlock-content {
    position: absolute; inset: 0;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
}
#lock-screen.password-mode #lock-screen-unlock-content {
    opacity: 1; pointer-events: auto;
}
#lock-screen-time { font-size: 5rem; font-weight: 200; }
#lock-screen-date { font-size: 1.5rem; }
#lock-screen.password-mode #lock-screen-user-area {
    transform: translateY(-70px) scale(1.0);
}
#lock-pin-input-container {
    display: flex;
    background-color: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
#lock-pin-input {
    flex-grow: 1; padding: 0.75rem; background: transparent; border: none;
    color: #f4f4f4; font-size: 1.125rem; text-align: left; outline: none;
    letter-spacing: 0.2em;
}
#lock-pin-input::placeholder {
    color: rgba(255, 255, 255, 0.5); letter-spacing: normal;
}
#unlock-button {
    background-color: transparent; border: none; color: #f4f4f4;
    padding: 0 1rem; cursor: pointer; transition: background-color 0.2s;
    font-size: 1.25rem;
}
#unlock-button:hover { background-color: rgba(255, 255, 255, 0.2); }
#lock-screen-password-area .password-pattern-grid button {
    width: 40px; height: 40px; border-radius: 8px;
    background-color: rgba(255, 255, 255, 0.1) !important;
    transition: background-color 0.2s ease;
}
#lock-screen-password-area .password-pattern-grid button.selected {
    background-color: #007bff !important;
}
#desktop-notifications-container {
    position: absolute;
    bottom: 80px; 
    right: 20px;
    top: auto; 
    display: flex;
    flex-direction: column;
    gap: 12px;
    z-index: 12000;
    pointer-events: none;
}
.desktop-notification {
    width: 340px;
    border-radius: 16px; 
    padding: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    pointer-events: auto;
    display: flex;
    gap: 12px;
    align-items: flex-start;
    transform: translateX(120%); 
    opacity: 0;
    transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1), 
                opacity 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.desktop-notification.show {
    transform: translateX(0);
    opacity: 1;
}
.desktop-notification.hide {
    transform: translateX(120%);
    opacity: 0;
}
body.dark-mode .desktop-notification {
    background-color: rgba(45, 45, 45, 0.7);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #f5f5f7;
}
body.dark-mode .desktop-notification-title { color: #f5f5f7; }
body.dark-mode .desktop-notification-body { color: #d2d2d7; }
body.dark-mode .desktop-notification-close-btn { color: #a1a1a6; }
body.dark-mode .desktop-notification-close-btn:hover { background-color: rgba(255,255,255,0.1); }
body.dark-mode .desktop-notification-button { background-color: rgba(255, 255, 255, 0.15); color: #f5f5f7; }
body.dark-mode .desktop-notification-button:hover { background-color: rgba(255, 255, 255, 0.25); }
body.light-mode .desktop-notification {
    background-color: rgba(249, 249, 249, 0.8);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(0, 0, 0, 0.08);
    color: #1d1d1f;
}
body.light-mode .desktop-notification-title { color: #1d1d1f; }
body.light-mode .desktop-notification-body { color: #333333; }
body.light-mode .desktop-notification-close-btn { color: #8a8a8e; }
body.light-mode .desktop-notification-close-btn:hover { background-color: rgba(0,0,0,0.05); }
body.light-mode .desktop-notification-button { background-color: rgba(0, 0, 0, 0.05); color: #1d1d1f; }
body.light-mode .desktop-notification-button:hover { background-color: rgba(0, 0, 0, 0.1); }
.desktop-notification-icon {
    width: 40px;
    height: 40px;
    flex-shrink: 0;
}
.desktop-notification-content {
    flex-grow: 1;
}
.desktop-notification-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 4px;
}
.desktop-notification-title {
    font-weight: 600;
    font-size: 1.05em;
}
.desktop-notification-body {
    font-size: 0.95em;
    line-height: 1.4;
}
.desktop-notification-close-btn {
    background: none;
    border: none;
    cursor: pointer;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1em;
    margin: -4px -4px 0 8px; 
}
.desktop-notification-buttons {
    display: flex;
    gap: 8px;
    margin-top: 12px;
}
.desktop-notification-button {
    flex-grow: 1;
    padding: 8px 12px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.2s;
}
        .taskbar-context-menu {
            position: absolute;
            min-width: 180px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            padding: 8px;
            z-index: 10001; 
            opacity: 0;
            transform: scale(0.95) translateY(10px);
            transition: opacity 0.15s ease-out, transform 0.15s ease-out;
            pointer-events: none;
        }
        body.dark-mode #context-menu {
            background-color: var(--context-menu-bg-dark);
            border: 1px solid var(--context-menu-border-dark);
            color: var(--text-color-dark);
            z-index: 10001;
        }
        body.dark-mode #context-menu .taskbar-context-menu-item:hover {
            background-color: var(--context-menu-item-hover-bg-dark);
        }
        body.dark-mode #context-menu .context-menu-separator {
            background-color: var(--context-menu-border-dark);
        }
        body.light-mode #context-menu {
            background-color: var(--context-menu-bg-light);
            border: 1px solid var(--context-menu-border-light);
            color: var(--text-color-light);
            z-index: 10001;
        }
        body.light-mode #context-menu .taskbar-context-menu-item:hover {
            background-color: var(--context-menu-item-hover-bg-light);
        }
         body.light-mode #context-menu .context-menu-separator {
            background-color: var(--context-menu-border-light);
        }
        .context-menu-separator {
            height: 1px;
            margin: 4px 0;
            background-color: #444;
        }
        .taskbar-context-menu.active {
            opacity: 1;
            transform: scale(1) translateY(0);
            pointer-events: auto;
        }
        .taskbar-context-menu-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .taskbar-context-menu-item i {
            margin-right: 10px;
            width: 16px; 
            text-align: center;
        }
        #app-window-script-editor .window-content {
            display: flex;
            flex-direction: column;
            padding: 0; 
        }
        #script-editor-code, #script-editor-output {
            flex-grow: 1;
            width: 100%;
            border: none;
            padding: 10px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            resize: none;
            outline: none;
            min-height: 100px; 
        }
        #script-editor-code {
            border-bottom: 1px solid var(--border-color-dark);
        }
        body.light-mode #script-editor-code {
            border-bottom: 1px solid var(--border-color-light);
        }
        #script-editor-controls {
            padding: 10px;
            display: flex;
            justify-content: flex-end;
        }
        #script-editor-run-button {
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
@media (max-width: 768px) {
    #taskbar {
        width: 95%;
        height: 50px;
        padding: 0 10px;
    }
    .taskbar-icon {
        width: 35px;
        height: 35px;
        border-radius: 8px;
    }
    .taskbar-icon i {
        font-size: 1rem;
    }
    #current-time {
        font-size: 0.8rem;
        padding: 6px 10px;
    }
    #quick-settings, #start-menu {
        width: 90%;
        left: 5%;
        right: 5%;
        bottom: 60px;
    }
    #all-apps-grid {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 15px;
        width: 90%;
    }
    .app-icon-fullscreen .icon-box {
        width: 60px;
        height: 60px;
        border-radius: 12px;
    }
    .app-icon-fullscreen .icon-box i {
        font-size: 2rem;
    }
    .app-icon-fullscreen span {
        font-size: 0.8rem;
    }
    .app-window {
        min-width: 280px;
        min-height: 180px;
        width: 95% !important;
        height: 80% !important;
        left: 2.5% !important;
        top: 5% !important;
        transform: none !important;
    }
    .app-window.maximized {
        width: 100vw !important;
        height: calc(100vh - var(--taskbar-height, 50px)) !important;
        left: 0 !important;
        top: 0 !important;
        transform: none !important;
    }
    #app-window-calculator, #app-window-pingpong {
        width: 90% !important;
        height: auto !important;
        left: 5% !important;
        top: 5% !important;
        transform: none !important;
    }
    #app-window-calculator.maximized,
    #app-window-pingpong.maximized {
        width: 100vw !important;
        height: calc(100vh - var(--taskbar-height, 50px)) !important;
        left: 0 !important;
        top: 0 !important;
        transform: none !important;
    }
    #app-window-settings .window-content-wrapper {
        flex-direction: column;
    }
    #settings-sidebar {
        width: 100%;
        border-radius: 0;
        border-bottom: 1px solid var(--border-color-dark);
    }
    body.light-mode #settings-sidebar {
        border-bottom: 1px solid var(--border-color-light);
    }
    #lock-screen-time {
        font-size: 3rem;
    }
}
::-webkit-scrollbar-button {
    display: none;
}
::-webkit-scrollbar {
    width: 12px;
    height: 12px;
}
::-webkit-scrollbar-track {
    background: transparent;
}
::-webkit-scrollbar-thumb {
    background-clip: padding-box;
    border: 4px solid transparent;
    border-radius: 6px;
    transition: background-color 0.3s;
}
::-webkit-scrollbar-thumb:not(:hover) {
    background-color: transparent;
}
body.dark-mode ::-webkit-scrollbar-thumb:hover {
    background-color: rgba(255, 255, 255, 0.6);
}
body.light-mode ::-webkit-scrollbar-thumb:hover {
    background-color: rgba(0, 0, 0, 0.6);
}
* {
    scrollbar-width: thin;
}
body.dark-mode * {
    scrollbar-color: rgba(255, 255, 255, 0.4) transparent;
}
body.light-mode * {
    scrollbar-color: rgba(0, 0, 0, 0.4) transparent;
}
#music-progress {
    -webkit-appearance: none;
    appearance: none;
    background: transparent;
    cursor: pointer;
    width: 100%;
}
#music-progress::-webkit-slider-runnable-track {
    height: 4px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
    transition: height 0.2s;
}
#progress-container:hover #music-progress::-webkit-slider-runnable-track {
    height: 6px; 
}
#music-progress::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 14px;
    height: 14px;
    background: #f4f4f4;
    border-radius: 50%;
    margin-top: -5px; 
    opacity: 0; 
    transition: opacity 0.2s;
}
#progress-container:hover #music-progress::-webkit-slider-thumb {
    opacity: 1; 
}
body.light-mode #music-progress-fill {
    background: #444;
}
body.light-mode #music-progress::-webkit-slider-runnable-track {
    background: rgba(0, 0, 0, 0.2);
}
body.light-mode #music-progress::-webkit-slider-thumb {
    background: #444;
}
.logo-circles-wrapper {
    filter: saturate(1.2); 
}
.logo-circle {
    position: absolute;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    mix-blend-mode: screen; 
    opacity: 0.85;
}
.logo-circle.green {
    background-color: #0c9d58; 
    top: 0;
    left: 50%;
    transform: translateX(-50%);
}
.logo-circle.red {
    background-color: #db4437; 
    bottom: 0;
    right: 0;
}
.logo-circle.blue {
    background-color: #4285f4; 
    bottom: 0;
    left: 0;
}
.logo-text {
    font-family: 'Inter', sans-serif;
}
.logo-circles-wrapper {
    filter: saturate(1.2); 
}
.logo-circle {
    position: absolute;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    mix-blend-mode: screen; 
    opacity: 0.85;
}
.logo-circle.green {
    background-color: #0c9d58; 
    top: 0;
    left: 50%;
    transform: translateX(-50%);
}
.logo-circle.red {
    background-color: #db4437; 
    bottom: 0;
    right: 0;
}
.logo-circle.blue {
    background-color: #4285f4; 
    bottom: 0;
    left: 0;
}
.logo-text {
    font-family: 'Inter', sans-serif;
}
#boot-screen.hide {
    opacity: 0;
}
#boot-loader {
  width: 48px;
  height: 48px;
  border: 5px solid #f4f4f4;
  border-bottom-color: transparent; 
  border-radius: 50%;
  display: inline-block;
  box-sizing: border-box;
  animation: rotate 1s linear infinite; 
}
@keyframes rotate {
    100% { transform: rotate(360deg); }
}
#boot-screen.start-anim #boot-logo-container {
    opacity: 1;
    transition-delay: 0.5s;
}
#boot-screen.start-anim #boot-version-text {
    opacity: 1;
    transition-delay: 1.5s;
}
#boot-screen.start-anim #boot-loader {
    opacity: 1;
    transition-delay: 2.5s;
}
#window-resizer {
    position: absolute;
    top: 0;
    width: 8px; 
    height: 100%;
    cursor: col-resize; 
    z-index: 2500; 
    transform: translateX(-50%); 
}
#lock-screen.password-mode #lock-screen-user-area {
    transform: translateY(-70px) scale(1.0); 
}
body.dark-mode .delete-icon-btn,
body.dark-mode .delete-color-btn {
    background-color: #3a3a3a; 
}
body.dark-mode .delete-icon-btn:hover,
body.dark-mode .delete-color-btn:hover {
    background-color: #4f4f4f;
}
body.light-mode .delete-icon-btn,
body.light-mode .delete-color-btn {
    background-color: #e0e0e0; 
    color: #333; 
}
body.light-mode .delete-icon-btn:hover,
body.light-mode .delete-color-btn:hover {
    background-color: #d1d1d1;
}
#app-window-connect .window-content {
    padding: 0;
    background-color: var(--bg-dark, #1e1e1e);
    color: var(--text-primary, #e0e0e0);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    overflow: hidden; 
}
#app-window-connect #app-container {
    width: 100%;
    height: 100%;
}
#app-window-connect .view {
    width: 100%;
    height: 100%;
    display: none;
}
#app-window-connect .view.active {
    display: flex;
}
#app-window-connect .hidden {
    display: none !important;
}
#app-window-connect #auth-view {
    justify-content: center;
    align-items: center;
}
#app-window-connect .auth-box {
    width: 340px;
    padding: 40px;
    background-color: var(--bg-medium, #2d2d2d);
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
#app-window-connect .auth-box h1 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #f4f4f4;
}
#app-window-connect .auth-description {
    color: var(--text-secondary, #a0a0a0);
    margin-bottom: 30px;
    font-size: 14px;
}
#app-window-connect .auth-box input,
#app-window-connect .auth-box button {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 4px;
    border: 1px solid var(--bg-light, #3c3c3c);
    background-color: var(--bg-dark, #1e1e1e);
    color: var(--text-primary, #e0e0e0);
    font-size: 16px;
}
#app-window-connect .auth-box button {
    background-color: var(--accent-blue, #007bff);
    border: none;
    cursor: pointer;
    transition: background-color 0.2s;
}
#app-window-connect .auth-box button:hover {
    background-color: #0056b3;
}
#app-window-connect .auth-toggle {
    font-size: 13px;
    color: var(--text-secondary, #a0a0a0);
}
#app-window-connect .auth-toggle a {
    color: var(--accent-blue, #007bff);
    text-decoration: none;
}
#app-window-connect #main-view {
    flex-direction: row;
}
#app-window-connect .sidebar {
    width: 300px;
    background-color: var(--bg-medium, #2d2d2d);
    display: flex;
    flex-direction: column;
    border-right: 1px solid #111;
}
#app-window-connect .sidebar-header {
    padding: 15px;
    border-bottom: 1px solid #111;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#app-window-connect .current-user-profile {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    overflow: hidden;
    flex-grow: 1;
    padding: 5px;
    border-radius: 5px;
    transition: background-color 0.2s;
}
#app-window-connect .current-user-profile:hover {
    background-color: var(--bg-light, #3c3c3c);
}
#app-window-connect .profile-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--bg-light, #3c3c3c);
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
}
#app-window-connect #current-user-display-name {
    font-weight: bold;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
#app-window-connect #logout-btn {
    background: none;
    border: none;
    color: var(--text-secondary, #a0a0a0);
    cursor: pointer;
    font-size: 18px;
    padding: 8px;
    border-radius: 50%;
}
#app-window-connect #logout-btn:hover {
    color: var(--text-primary, #e0e0e0);
    background-color: var(--bg-light, #3c3c3c);
}
#app-window-connect .sidebar-actions {
    display: flex;
    padding: 10px;
    gap: 10px;
    border-bottom: 1px solid #111;
}
#app-window-connect .sidebar-actions button {
    flex-grow: 1;
    padding: 10px;
    font-size: 18px;
    border-radius: 4px;
    border: 1px solid var(--bg-light, #3c3c3c);
    background-color: var(--bg-light, #3c3c3c);
    color: var(--text-primary, #e0e0e0);
    cursor: pointer;
    transition: background-color 0.2s;
}
#app-window-connect .sidebar-actions button:hover {
    background-color: #4a4a4a;
}
#app-window-connect .contact-list {
    list-style: none;
    padding: 0;
    margin: 0;
    flex-grow: 1;
    overflow-y: auto;
}
#app-window-connect .contact-list li {
    padding: 12px 15px;
    cursor: pointer;
    border-bottom: 1px solid var(--bg-dark, #1e1e1e);
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    gap: 12px;
    position: relative;
}
#app-window-connect .contact-list li:hover { background-color: var(--bg-light, #3c3c3c); }
#app-window-connect .contact-list li.active { background-color: var(--accent-blue, #007bff); }
#app-window-connect .contact-info { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
#app-window-connect .contact-info .display-name { font-weight: bold; }
#app-window-connect .contact-info .last-message { font-size: 13px; color: var(--text-secondary, #a0a0a0); text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
#app-window-connect .unread-badge { background-color: var(--accent-blue, #007bff); color: #f4f4f4; font-size: 11px; font-weight: bold; padding: 2px 6px; border-radius: 10px; margin-left: auto; }
#app-window-connect .sidebar-section { padding: 15px; border-top: 1px solid #111; }
#app-window-connect .sidebar-section h4 { margin: 0 0 10px 0; font-size: 14px; color: var(--text-secondary, #a0a0a0); display: flex; align-items: center; gap: 8px; }
#app-window-connect .notification-badge:not(.visible) { display: none; }
#app-window-connect #request-list, #app-window-connect #sent-request-list { list-style: none; padding: 0; margin: 0; }
#app-window-connect #request-list li, #app-window-connect #sent-request-list li { display: flex; justify-content: space-between; align-items: center; font-size: 14px; margin-bottom: 8px; }
#app-window-connect .request-actions button { background: none; border: none; color: var(--text-secondary, #a0a0a0); cursor: pointer; margin-left: 5px; font-size: 20px; padding: 5px; }
#app-window-connect .accept-btn { color: var(--accent-green, #28a745); }
#app-window-connect .reject-btn, #app-window-connect .cancel-btn { color: var(--accent-red, #dc3545); }
#app-window-connect .main-content { flex-grow: 1; display: flex; }
#app-window-connect .content-area { width: 100%; height: 100%; display: none; }
#app-window-connect .content-area.active { display: flex; flex-direction: column; }
#app-window-connect .welcome-message { margin: auto; text-align: center; color: var(--text-secondary, #a0a0a0); }
#app-window-connect .welcome-message i { font-size: 60px; margin-bottom: 20px; }
#app-window-connect .chat-header { padding: 15px 20px; border-bottom: 1px solid #333; background-color: var(--bg-medium, #2d2d2d); display: flex; align-items: center; gap: 15px; }
#app-window-connect .chat-header h3 { margin: 0; }
#app-window-connect .messages-container { flex-grow: 1; overflow-y: auto; padding: 20px; }
#app-window-connect .message { display: flex; margin-bottom: 15px; gap: 10px; }
#app-window-connect .message.sent { flex-direction: row-reverse; }
#app-window-connect .message-content { display: flex; flex-direction: column; }
#app-window-connect .message.sent .message-content { align-items: flex-end; }
#app-window-connect .message.received .message-content { align-items: flex-start; }
#app-window-connect .bubble { padding: 10px 15px; border-radius: 20px; max-width: 450px; line-height: 1.5; word-wrap: break-word; }
#app-window-connect .bubble img.message-image { max-width: 100%; max-height: 250px; border-radius: 15px; cursor: pointer; }
#app-window-connect .bubble img.message-stamp { width: 100px; height: 100px; }
#app-window-connect .bubble a.message-file { display: flex; align-items: center; gap: 10px; background-color: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; text-decoration: none; color: var(--text-primary, #e0e0e0); }
#app-window-connect .bubble a.message-file i { font-size: 24px; }
#app-window-connect .message.sent .bubble { background-color: var(--accent-blue, #007bff); color: #f4f4f4; border-bottom-right-radius: 5px; }
#app-window-connect .message.received .bubble { background-color: var(--bg-light, #3c3c3c); border-bottom-left-radius: 5px; }
#app-window-connect .message-meta { font-size: 11px; color: var(--text-secondary, #a0a0a0); margin-top: 4px; padding: 0 8px; }
#app-window-connect .message-input-area { display: flex; padding: 15px 20px; border-top: 1px solid #333; background-color: var(--bg-medium, #2d2d2d); align-items: center; position: relative; }
#app-window-connect .message-input-area button { background: none; border: none; color: var(--text-secondary, #a0a0a0); cursor: pointer; font-size: 20px; padding: 10px; }
#app-window-connect #message-input { flex-grow: 1; border-radius: 20px; padding: 10px 20px; border: none; background-color: var(--bg-light, #3c3c3c); color: var(--text-primary, #e0e0e0); font-size: 16px; margin: 0 10px; }
#app-window-connect #send-message-btn { color: var(--accent-blue, #007bff); }
#app-window-connect #stamp-panel { position: absolute; bottom: 80px; right: 20px; background-color: var(--bg-light, #3c3c3c); border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); padding: 10px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
#app-window-connect #stamp-panel img { width: 60px; height: 60px; cursor: pointer; transition: transform 0.1s; }
#app-window-connect #stamp-panel img:hover { transform: scale(1.1); }
body.dark-mode .glass-effect {
    background-color: rgba(40, 40, 40, 0.6); 
    backdrop-filter: blur(25px) saturate(120%); 
    border: 1px solid rgba(255, 255, 255, 0.1); 
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); 
}
body.aero-enabled.dark-mode .glass-effect {
    background-color: rgba(40, 40, 40, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
}
body.aero-enabled.light-mode .glass-effect {
    background-color: rgba(248, 248, 248, 0.75);
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
}
body:not(.aero-enabled).dark-mode .glass-effect {
    background-color: var(--window-bg-dark); 
    border: 1px solid var(--border-color-dark);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
}
body:not(.aero-enabled).light-mode .glass-effect {
    background-color: var(--window-bg-light);
    border: 1px solid var(--border-color-light);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
}
body:not(.aero-enabled) #app-window-settings .window-header {
    background-color: var(--header-bg-dark) !important;
}
body:not(.aero-enabled).light-mode #app-window-settings .window-header {
    background-color: var(--header-bg-light) !important;
}
body.aero-enabled.dark-mode #settings-sidebar,
body.aero-enabled.dark-mode #settings-main-content {
    background-color: transparent; 
}
body.aero-enabled.light-mode #settings-sidebar {
    background-color: transparent;
}
body.aero-enabled.light-mode #settings-main-content {
    background-color: transparent;
}
body.aero-enabled.dark-mode #app-window-command .font-mono,
body.aero-enabled.dark-mode #app-window-command #command-input,
body.aero-enabled.light-mode #app-window-command .font-mono,
body.aero-enabled.light-mode #app-window-command #command-input {
    background-color: transparent;
}
body.aero-enabled.light-mode #app-window-command .font-mono,
body.aero-enabled.light-mode #app-window-command #command-input,
body.aero-enabled.light-mode #app-window-command .flex span {
    color: var(--text-color-light);
}
body.aero-enabled .glass-effect {
    backdrop-filter: blur(25px) saturate(120%);
}
body.light-mode .glass-effect {
    background-color: rgba(248, 248, 248, 0.75);
    backdrop-filter: blur(20px) saturate(120%);
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
}
#taskbar, .app-window, #quick-settings, #start-menu, #all-apps-fullscreen {
    transition: all 0.3s ease; 
}
#taskbar {
    border-bottom: none; 
}
.window-header {
    border-bottom-color: transparent !important; 
}
.taskbar-icon, .quick-setting-tile, .power-options button, #all-apps-button, .recent-item {
    transition: transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1), background-color 0.2s;
}
.taskbar-icon:hover, .quick-setting-tile:hover, .power-options button:hover, #all-apps-button:hover, .recent-item:hover {
    transform: translateY(-3px); 
}
.taskbar-icon:active, .quick-setting-tile:active, .power-options button:active, #all-apps-button:active, .recent-item:active {
    transform: translateY(-1px); 
    transition-duration: 0.1s;
}
.app-window {
    transform-origin: center center; 
    transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                width 0.2s ease, height 0.2s ease, border-radius 0.3s ease;
    transform: scale(0.95); 
    opacity: 0;
}
.app-window.active {
    transform: scale(1);
    opacity: 1;
}
.app-window.minimizing {
    transition: transform 0.35s cubic-bezier(0.55, 0, 1, 0.45), 
                opacity 0.35s cubic-bezier(0.55, 0, 1, 0.45);
    opacity: 0;
    transform-origin: top left; 
}
#quick-settings, #start-menu {
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s ease-out, visibility 0.4s;
}
input[type="range"]::-webkit-slider-thumb {
    transition: transform 0.2s ease;
}
input[type="range"]:active::-webkit-slider-thumb {
    transform: scale(1.25); 
}
body.aero-enabled.dark-mode #app-window-notepad textarea,
body.aero-enabled.dark-mode #app-window-calculator .calculator-display,
body.aero-enabled.dark-mode #app-window-calculator .calculator-buttons button,
body.aero-enabled.dark-mode #app-window-music-player .music-player-container,
body.aero-enabled.dark-mode #app-window-files .w-3_4, 
body.aero-enabled.dark-mode #app-window-script-editor #script-editor-code,
body.a-enabled.dark-mode #app-window-script-editor #script-editor-output {
    background-color: transparent;
}
body.aero-enabled.dark-mode #app-window-music-player #music-sidebar {
    background-color: rgba(0, 0, 0, 0.2); 
}
body.aero-enabled.light-mode #app-window-notepad textarea,
body.aero-enabled.light-mode #app-window-calculator .calculator-display,
body.aero-enabled.light-mode #app-window-calculator .calculator-buttons button,
body.aero-enabled.light-mode #app-window-music-player .music-player-container,
body.aero-enabled.light-mode #app-window-files .w-3_4,
body.aero-enabled.light-mode #app-window-script-editor #script-editor-code,
body.aero-enabled.light-mode #app-window-script-editor #script-editor-output {
    background-color: transparent;
}
body.aero-enabled.light-mode #app-window-music-player #music-sidebar {
    background-color: rgba(255, 255, 255, 0.2);
}
#snap-layouts-popup {
    border-radius: 12px; 
    padding: 12px;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
}
.snap-layout-option {
    border-radius: 5px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    background-color: rgba(255, 255, 255, 0.1);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}
.snap-layout-option:hover {
    background-color: #007bff;
    border-color: #007bff;
    transform: scale(1.08); 
}
body.light-mode #snap-layouts-popup .snap-layout-option {
    border-color: rgba(0, 0, 0, 0.2);
    background-color: rgba(0, 0, 0, 0.05);
}
body.light-mode #snap-layouts-popup .snap-layout-option:hover {
    background-color: #007bff;
    border-color: #007bff;
}
.mode-select-container {
    display: flex;
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 3px;
}
.mode-select-button {
    padding: 5px 15px;
    border-radius: 6px;
    border: none;
    background-color: transparent;
    color: var(--text-color-dark);
    cursor: pointer;
    transition: background-color 0.2s, color 0.2s;
}
.mode-select-button.active {
    background-color: rgba(255, 255, 255, 0.9);
    color: #181818;
    font-weight: 600;
}
body.light-mode .mode-select-container {
    background-color: rgba(0, 0, 0, 0.1);
}
body.light-mode .mode-select-button {
    color: var(--text-color-light);
}
body.light-mode .mode-select-button.active {
    background-color: #f4f4f4;
    color: #181818;
}
body.aero-enabled .glass-effect {
    backdrop-filter: blur(25px) saturate(120%);
}
body.aero-enabled.dark-mode .glass-effect {
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
}
body.aero-enabled.light-mode .glass-effect {
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
}
body.aero-enabled.aero-mode-clear .app-window {
    background-color: transparent !important;
}
body.aero-enabled.aero-mode-clear.dark-mode #settings-sidebar,
body.aero-enabled.aero-mode-clear.light-mode #settings-sidebar,
body.aero-enabled.aero-mode-clear.dark-mode #settings-main-content,
body.aero-enabled.aero-mode-clear.light-mode #settings-main-content {
    background-color: transparent !important;
}
body.aero-enabled.aero-mode-smoke.dark-mode .glass-effect {
    background-color: rgba(45, 45, 45, 0.65) !important;
}
body.aero-enabled.aero-mode-smoke.dark-mode #settings-sidebar,
body.aero-enabled.aero-mode-smoke.dark-mode #settings-main-content,
body.aero-enabled.aero-mode-smoke.dark-mode #app-window-notepad textarea {
    background-color: transparent !important;
}
body.aero-enabled.aero-mode-smoke.light-mode .glass-effect {
    background-color: rgba(249, 249, 249, 0.7) !important;
}
body.aero-enabled.aero-mode-smoke.light-mode #settings-sidebar,
body.aero-enabled.aero-mode-smoke.light-mode #settings-main-content,
body.aero-enabled.aero-mode-smoke.light-mode #app-window-notepad textarea {
    background-color: transparent !important;
}
#mission-control-overlay {
    position: absolute; inset: 0;
    background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px);
    z-index: 11000; opacity: 0;
    transition: opacity 0.4s ease-in-out;
    pointer-events: none;
}
#mission-control-overlay.active {
    opacity: 1; pointer-events: auto;
}
.app-window.in-mission-control {
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.75);
    resize: none !important;
    overflow: visible !important;
    cursor: pointer;
}
.app-window.in-mission-control .window-header { 
    cursor: pointer;
}
.mc-close-btn {
    position: absolute;
    top: 0;
    right: 0;
    width: 32px;
    height: 32px;
    background-color: #ff5f56;
    color: rgba(0, 0, 0, 0.6);
    border: none;
    border-radius: 0 15px 0 8px; 
    font-size: 20px;
    font-weight: bold;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    pointer-events: auto;
    opacity: 0;
    transform-origin: top right;
    transform: scale(var(--mc-scale, 1)) translateY(-5px);
    transition: opacity 0.2s, transform 0.2s;
}
.app-window.in-mission-control:hover .mc-close-btn {
    opacity: 1;
    transform: scale(var(--mc-scale, 1)) translateY(0);
}
#files-grid.grid-view {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(96px, 1fr)); 
    gap: 1rem;
}
#files-grid.list-view {
    display: flex;
    flex-direction: column; 
    gap: 2px;
}
.list-view .file-item-list {
    display: grid;
    grid-template-columns: 24px 1fr 150px 150px; 
    align-items: center;
    gap: 1rem;
    padding: 0.5rem;
    border-radius: 0.5rem;
}
.view-mode-btn { transition: background-color 0.2s; color: #9ca3af; }
.view-mode-btn.active { background-color: rgba(255, 255, 255, 0.2); color: #f4f4f4; }
body.light-mode .view-mode-btn { color: #6b7280; }
body.light-mode .view-mode-btn.active { background-color: rgba(0, 0, 0, 0.1); color: #181818; }
#files-grid.grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(96px, 1fr)); gap: 1rem; }
#files-grid.list-view { display: flex; flex-direction: column; gap: 2px; }
.list-view .file-item-list { display: grid; grid-template-columns: 24px 1fr 150px 150px; align-items: center; gap: 1rem; padding: 0.5rem; border-radius: 0.5rem; }
.list-view .file-item-list .file-name,
.list-view .file-item-list .file-meta { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.list-view .file-item-list .file-meta { font-size: 0.8rem; color: #9ca3af; }
body.light-mode .list-view .file-item-list .file-meta { color: #6b7280; }
.file-item-grid:not(.selected):hover,
.list-view .file-item-list:not(.selected):hover { background-color: rgba(255, 255, 255, 0.1); }
body.light-mode .file-item-grid:not(.selected):hover,
body.light-mode .list-view .file-item-list:not(.selected):hover { background-color: rgba(0, 0, 0, 0.05); }
.file-item-grid.selected,
.list-view .file-item-list.selected { background-color: rgba(59, 130, 246, 0.5); }
body.light-mode .file-item-grid.selected,
body.light-mode .list-view .file-item-list.selected { background-color: rgba(59, 130, 246, 0.5); }
.file-item-grid.selected:hover,
.list-view .file-item-list.selected:hover { background-color: rgba(96, 165, 250, 0.6); }
body.light-mode .file-item-grid.selected:hover,
body.light-mode .list-view .file-item-list.selected:hover { background-color: rgba(96, 165, 250, 0.6); }
#spotlight-overlay {
    align-items: flex-start; 
    padding-top: 20vh;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    z-index: 13000;
}
#spotlight-overlay.visible {
    opacity: 1;
}
#spotlight-container {
    backdrop-filter: blur(0px);
    transform: scale(1.1);
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), 
                backdrop-filter 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}
#spotlight-overlay.visible #spotlight-container {
    backdrop-filter: blur(60px);
    transform: scale(1);
}
.spotlight-result-item {
    transition: background-color 0.1s ease-in-out;
}
body.light-mode #file-picker-dialog {
    background-color: var(--window-bg-light);
    color: var(--text-color-light);
}
body.light-mode #file-picker-dialog .p-2 {
    border-color: var(--border-color-light);
}
body.light-mode #file-picker-dialog #file-picker-path {
    background-color: rgba(0,0,0,0.05);
}
body.light-mode #file-picker-dialog .text-center {
    color: #6b7280;
}
body.light-mode #file-picker-dialog .hover\:bg-#f4f4f4\/10:hover {
    background-color: rgba(0,0,0,0.05);
}
body.light-mode #file-picker-dialog #file-picker-filename {
    background-color: var(--input-bg-light);
    border-color: var(--input-border-light);
}
.drop-target-overlay {
    position: absolute;
    inset: 0;
    background-color: rgba(59, 130, 246, 0.2); 
    border: 2px dashed #8ab4f8; 
    z-index: 20; 
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: #d2e3fc;
    pointer-events: none; 
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
}
.drop-target-overlay.visible {
    opacity: 1;
}
#modal-overlay {
    z-index: 14000; 
}
#qs-theme-toggle, 
#qs-aero-toggle-container, 
.qs-dummy-tile, 
#quick-settings .flex.justify-around {
    background-color: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
}
body.light-mode #qs-theme-toggle,
body.light-mode #qs-aero-toggle-container,
body.light-mode .qs-dummy-tile,
body.light-mode #quick-settings .flex.justify-around {
    background-color: rgba(0, 0, 0, 0.05);
    border-color: rgba(0, 0, 0, 0.1);
}
body.light-mode #qs-aero-toggle span,
body.light-mode #qs-theme-text,
body.light-mode .qs-aero-option span {
    color: var(--text-color-light) !important;
}
#qs-theme-toggle.active,
#qs-aero-toggle-container.active {
    background-color: var(--status-indicator-color-active);
    color: #f4f4f4;
    border-color: transparent !important;
}
body.light-mode #qs-theme-toggle.active,
body.light-mode #qs-aero-toggle-container.active {
    background-color: var(--status-indicator-color-active);
}
body.light-mode #qs-theme-toggle.active #qs-theme-text,
body.light-mode #qs-aero-toggle-container.active span {
    color: #f4f4f4;
}
#qs-volume-slider-track,
#qs-brightness-slider-track {
    background-color: rgba(0, 0, 0, 0.4); 
    border-radius: 12px; 
    transition: transform 0.1s ease-out;
    overflow: hidden; 
}
body.light-mode #qs-volume-slider-track,
body.light-mode #qs-brightness-slider-track {
    background-color: rgba(0, 0, 0, 0.1);
}
#qs-volume-slider-track.dragging,
#qs-brightness-slider-track.dragging {
    transform: scale(1.05);
}
.qs-slider-fill {
    background-color: var(--status-indicator-color-active);
    border-radius: 0; 
}
body.light-mode #qs-aero-submenu {
    background-color: rgba(255,255,255,0.8);
}
body.light-mode .qs-aero-option:hover {
    background-color: rgba(0,0,0,0.1);
}
#qs-theme-toggle, 
#qs-aero-toggle-container, 
.qs-dummy-tile {
    background-color: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
}
body.light-mode #qs-theme-toggle,
body.light-mode #qs-aero-toggle-container,
body.light-mode .qs-dummy-tile {
    background-color: rgba(0, 0, 0, 0.05);
    border-color: rgba(0, 0, 0, 0.1);
}
#quick-settings > .flex.justify-around {
    background-color: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
}
body.light-mode #quick-settings > .flex.justify-around {
    background-color: rgba(0, 0, 0, 0.05);
    border-color: rgba(0, 0, 0, 0.1);
}
#qs-music-player {
    border: 1px solid rgba(255, 255, 255, 0.1);
}
body.light-mode #qs-music-player {
    border-color: rgba(0, 0, 0, 0.1);
}
body.light-mode #qs-music-progress-fill {
    background-color: #333;
}
#cell-container { display: flex; flex-direction: column; height: 100%; font-family: Arial, sans-serif; background-color: #f8f9fa; }
body.dark-mode #cell-container { background-color: #202124; }
.cell-toolbar { flex-shrink: 0; display: flex; flex-wrap: wrap; align-items: center; gap: 4px; padding: 4px; background-color: #f8f9fa; border-bottom: 1px solid #dadce0; }
body.dark-mode .cell-toolbar { background-color: #2d2d2d; border-color: #5f6368; }
.cell-toolbar-btn { background: none; border: 1px solid transparent; width: 28px; height: 28px; border-radius: 4px; color: #5f6368; cursor: pointer; display: grid; place-items: center; }
body.dark-mode .cell-toolbar-btn { color: #bdc1c6; }
.cell-toolbar-btn:hover { background-color: #e8eaed; }
body.dark-mode .cell-toolbar-btn:hover { background-color: #3c4043; }
.cell-toolbar-btn.active { background-color: #d2e3fc; color: #1967d2; }
body.dark-mode .cell-toolbar-btn.active { background-color: #a8c7fa; color: #202124; }
.cell-toolbar-separator { width: 1px; height: 20px; background-color: #dadce0; margin: 0 4px; }
body.dark-mode .cell-toolbar-separator { background-color: #5f6368; }
.cell-formula-bar { flex-shrink: 0; display: flex; align-items: center; padding: 4px 8px; border-bottom: 1px solid #dadce0; }
body.dark-mode .cell-formula-bar { border-color: #5f6368; }
#cell-address-input { width: 80px; padding: 4px; border: 2px solid transparent; background-color: transparent; text-align: center; color: #3c4043; }
body.dark-mode #cell-address-input { color: #bdc1c6; }
#cell-address-input:focus { border-color: #1a73e8; outline: none; background-color: #f4f4f4; }
body.dark-mode #cell-address-input:focus { background-color: #2d2d2d; }
#cell-formula-input { flex-grow: 1; padding: 4px; border: none; outline: none; background-color: transparent; color: #202124; }
body.dark-mode #cell-formula-input { color: #e8eaed; }
.cell-grid-container { flex-grow: 1; position: relative; overflow: scroll; cursor: cell; }
#cell-grid-canvas { position: absolute; top: 0; left: 0; }
#cell-selection, #cell-editor { position: absolute; pointer-events: none; z-index: 10; }
#cell-selection { border: 2px solid #1a73e8; background-color: rgba(26, 115, 232, 0.1); }
#cell-editor { pointer-events: auto; }
#cell-editor-textarea { 
    width: 100%; height: 100%; padding: 0 1px;
    border: 2px solid #1a73e8; outline: none; 
    background-color: white; color: black;
    resize: none; overflow: hidden; white-space: pre;
    font: 10pt Arial;
}
#present-container { display: flex; height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f1f3f4; color: #202124; }
body.dark-mode #present-container { background-color: #202124; color: #e8eaed; }
.present-toolbar { flex-shrink: 0; display: flex; align-items: center; gap: 4px; padding: 4px; background-color: #f4f4f4; border-bottom: 1px solid #dadce0; }
body.dark-mode .present-toolbar { background-color: #2d2d2d; border-color: #5f6368; }
.present-toolbar-btn { background: none; border: 1px solid transparent; min-width: 32px; height: 32px; padding: 0 8px; border-radius: 4px; color: #5f6368; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; }
body.dark-mode .present-toolbar-btn { color: #bdc1c6; }
.present-toolbar-btn:hover { background-color: #e8eaed; }
body.dark-mode .present-toolbar-btn:hover { background-color: #3c4043; }
.present-toolbar-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.present-toolbar-separator { width: 1px; height: 20px; background-color: #dadce0; margin: 0 4px; }
body.dark-mode .present-toolbar-separator { background-color: #5f6368; }
#present-main-area { display: flex; flex-grow: 1; overflow: hidden; }
#present-thumbnails-pane { width: 160px; flex-shrink: 0; background-color: #f8f9fa; border-right: 1px solid #dadce0; overflow-y: auto; padding: 8px; }
body.dark-mode #present-thumbnails-pane { background-color: #2d2d2d; border-color: #5f6368; }
.thumbnail-item { position: relative; display: flex; align-items: center; margin-bottom: 8px; border: 2px solid transparent; border-radius: 4px; background-color: #f4f4f4; }
body.dark-mode .thumbnail-item { background-color: #3c4043; }
.thumbnail-item.active { border-color: #1a73e8; }
.thumbnail-index { font-size: 10px; color: #5f6368; text-align: center; width: 20px; flex-shrink: 0; }
body.dark-mode .thumbnail-index { color: #9aa0a6; }
.thumbnail-canvas { width: 120px; height: 67.5px;  cursor: pointer; }
#present-editor-pane { flex-grow: 1; display: flex; align-items: center; justify-content: center; overflow: auto; padding: 16px; }
#present-slide-wrapper { position: relative; background-color: #f4f4f4; box-shadow: 0 1px 3px 1px rgba(60,64,67,0.15); }
body.dark-mode #present-slide-wrapper { background-color: #35363a; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.6), 0 1px 3px 1px rgba(0,0,0,0.3); }
#present-property-pane { width: 240px; flex-shrink: 0; background-color: #f8f9fa; border-left: 1px solid #dadce0; overflow-y: auto; padding: 8px; font-size: 12px; }
body.dark-mode #present-property-pane { background-color: #2d2d2d; border-color: #5f6368; }
.prop-section { margin-bottom: 12px; }
.prop-section h4 { font-weight: 600; font-size: 11px; color: #5f6368; margin-bottom: 4px; text-transform: uppercase; }
body.dark-mode .prop-section h4 { color: #9aa0a6; }
.prop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
.prop-item { display: flex; flex-direction: column; }
.prop-item label { margin-bottom: 2px; }
.prop-item input, .prop-item select { width: 100%; padding: 4px; border-radius: 4px; border: 1px solid #dadce0; background-color: #f4f4f4; }
body.dark-mode .prop-item input, body.dark-mode .prop-item select { border-color: #5f6368; background-color: #3c4043; color: #e8eaed; }
#present-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #202020; z-index: 5000; display: none; align-items: center; justify-content: center; }
#present-fullscreen-slide { max-width: 100%; max-height: 100%; }
#studio-container { display: flex; height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
body:not(.dark-mode) #studio-container { background-color: #f1f3f4; color: #202124; }
body.dark-mode #studio-container { background-color: #202124; color: #e8eaed; }
#studio-palette { width: 250px; background-color: #f8f9fa; border-right: 1px solid #d1d5db; display: flex; flex-direction: column; }
body.dark-mode #studio-palette { background-color: #2d2d2d; border-color: #5f6368; }
#studio-palette-header { padding: 10px; border-bottom: 1px solid #d1d5db; }
body.dark-mode #studio-palette-header { border-color: #5f6368; }
#studio-palette-search { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
body.dark-mode #studio-palette-search { background-color: #3c4043; border-color: #5f6368; color: #e8eaed; }
#studio-palette-content { flex-grow: 1; overflow-y: auto; padding: 10px; }
#studio-workspace-area { flex-grow: 1; display: flex; flex-direction: column; }
.studio-controls { flex-shrink: 0; display: flex; align-items: center; gap: 8px; padding: 5px 10px; background-color: #f8f9fa; border-bottom: 1px solid #d1d5db; }
body.dark-mode .studio-controls { background-color: #2d2d2d; border-color: #5f6368; }
.studio-btn { background: none; border: 1px solid transparent; height: 32px; padding: 0 10px; border-radius: 6px; color: #5f6368; cursor: pointer; display: flex; align-items: center; gap: 6px; }
body.dark-mode .studio-btn { color: #bdc1c6; }
.studio-btn:hover:not(:disabled) { background-color: #e8eaed; }
body.dark-mode .studio-btn:hover:not(:disabled) { background-color: #3c4043; }
.studio-btn:disabled { opacity: 0.4; cursor: not-allowed; }
#studio-workspace-wrapper { flex-grow: 1; overflow: auto; position: relative; background-color: #e9edf0; }
body.dark-mode #studio-workspace-wrapper { background-color: #1a1a1a; }
#studio-workspace { padding: 20px; background-color: #f4f4f4; transform-origin: top left; transition: transform .1s linear; min-width: 100%; min-height: 100%; }
body.dark-mode #studio-workspace { background-color: #282a2d; }
#studio-preview-area { width: 350px; display: flex; flex-direction: column; background-color: #f8f9fa; border-left: 1px solid #d1d5db; }
body.dark-mode #studio-preview-area { background-color: #2d2d2d; border-color: #5f6368; }
#studio-preview-container { position: relative; width: 100%; padding-top: 56.25%; background: #f4f4f4; flex-shrink: 0; }
#studio-preview-iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
#studio-html-display-area { background-color: #282c34; color: #abb2bf; padding: 15px; font-family: 'Fira Code', monospace; font-size: 0.85em; overflow: auto; white-space: pre; flex-grow: 1; display: none; }
#studio-html-display-area.visible { display: block; }
.studio-block { padding: 10px 14px; margin-bottom: 8px; color: #f4f4f4; border-radius: 6px; cursor: grab; user-select: none; font-size: .9em; display: flex; align-items: center; flex-wrap: wrap; gap: 8px; position: relative; }
.studio-block:active { cursor: grabbing; }
.studio-block input, .studio-block select, .studio-block textarea { color: #202020; border: 1px solid #ccc; padding: 4px 8px; font-size: .9em; }
.studio-custom-ghost { position: fixed; opacity: 0.7; pointer-events: none; z-index: 9999; transform: translate(-50%, -50%); }
.studio-drop-placeholder { height: 45px; background: rgba(30, 144, 255, 0.2); border: 2px dashed #1e90ff; border-radius: 6px; margin-bottom: 8px; }
.studio-workspace-block.dragging { opacity: 0.4 !important; }
#studio-context-menu { position: fixed; z-index: 10000; background-color: #f4f4f4; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.25); padding: 6px 0; min-width: 180px; }
body.dark-mode #studio-context-menu { background-color: #3c4043; }
#studio-context-menu button { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 16px; background: none; border: none; text-align: left; cursor: pointer; color: #202124; }
body.dark-mode #studio-context-menu button { color: #e8eaed; }
#studio-context-menu button:hover { background-color: #f0f2f5; }
body.dark-mode #studio-context-menu button:hover { background-color: #5f6368; }
.container-block {
    padding: 10px;
    border: 1px dashed rgba(255, 255, 255, 0.3);
    margin-bottom: 5px;
}
.container-block > .block-header {
    padding-bottom: 8px;
    margin-bottom: 8px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}
.container-block > .block-content {
    min-height: 30px; 
    padding: 5px;
    border-radius: 4px;
    background-color: rgba(0, 0, 0, 0.2);
}
body.light-mode .container-block {
    border-color: rgba(0, 0, 0, 0.2);
}
body.light-mode .container-block > .block-header {
    border-color: rgba(0, 0, 0, 0.1);
}
body.light-mode .container-block > .block-content {
    background-color: rgba(0, 0, 0, 0.05);
}
body.slider-dragging {
    user-select: none; 
    -webkit-user-select: none; 
}
body.dark-mode .studio-block.html { background-color: #ff7f50; }
body.dark-mode .studio-block.css { background-color: #1e90ff; }
body.dark-mode .studio-block.js { background-color: #ffdb58; color: #333; }
body.dark-mode .studio-block.layout { background-color: #9b59b6; }
body.dark-mode .studio-block.array { background-color: #3498db; }
body.dark-mode .studio-block.myblock { background-color: #2ecc71; }
body.light-mode .studio-block.html { background-color: #ff7f50; }
body.light-mode .studio-block.css { background-color: #1e90ff; }
body.light-mode .studio-block.html,
body.light-mode .container-block.html > .block-header {
    background-color: #ff7f50;
    color: #f4f4f4; 
}
body.light-mode .studio-block.css,
body.light-mode .container-block.css > .block-header {
    background-color: #1e90ff;
    color: #f4f4f4;
}
body.light-mode .studio-block.js,
body.light-mode .container-block.js > .block-header {
    background-color: #ffdb58;
    color: #333; 
}
body.light-mode .studio-block.layout,
body.light-mode .container-block.layout > .block-header {
    background-color: #9b59b6;
    color: #f4f4f4;
}
body.light-mode .studio-block.array,
body.light-mode .container-block.array > .block-header {
    background-color: #3498db;
    color: #f4f4f4;
}
body.light-mode .studio-block.myblock,
body.light-mode .container-block.myblock > .block-header {
    background-color: #2ecc71;
    color: #f4f4f4;
}
.window-header, 
.desktop-icon, 
.taskbar-icon, 
#quick-settings, 
#start-menu,
#all-apps-fullscreen .app-icon-fullscreen {
    -webkit-user-select: none; 
    -moz-user-select: none;    
    -ms-user-select: none;     
    user-select: none;         
}
#qs-night-mode-toggle.active {
    background-color: var(--status-indicator-color-active);
    color: #f4f4f4;
    border-color: transparent !important;
}
body.light-mode #qs-night-mode-toggle.active span,
body.light-mode #qs-night-mode-toggle.active i {
    color: #f4f4f4 !important;
}
#all-apps-header {
}
#all-apps-search-bar {
    padding-left: 52px;
    padding-right: 52px;
}
#select-pin-apps-button,
#exit-all-apps {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.8);
    display: grid;
    place-items: center;
    cursor: pointer;
    font-size: 1.1rem;
    transition: all 0.2s;
    border: none;
}
#select-pin-apps-button:hover,
#exit-all-apps:hover {
    background-color: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
}
#select-pin-apps-button.active {
    background-color: #007bff;
    color: #f4f4f4;
    transform: rotate(360deg);
}
body.light-mode #select-pin-apps-button,
body.light-mode #exit-all-apps {
    background-color: rgba(0, 0, 0, 0.05);
    color: #606060;
}
body.light-mode #select-pin-apps-button:hover,
body.light-mode #exit-all-apps:hover {
    background-color: rgba(0, 0, 0, 0.1);
}
body.light-mode #select-pin-apps-button.active {
    background-color: #007bff;
    color: #f4f4f4;
}
md-switch {
    margin-left: auto;
    --md-switch-handle-width: 20px;
    --md-switch-handle-height: 20px;
    --md-switch-selected-handle-width: 24px;
    --md-switch-selected-handle-height: 24px;
    --md-switch-track-width: 52px;
    --md-switch-track-height: 32px;
    --md-switch-icon-size: 16px;
    --md-switch-state-layer-size: 40px;
    --md-switch-selected-state-layer-color: var(--status-indicator-color-active);
    --md-sys-color-primary: var(--status-indicator-color-active);
}
md-switch[selected] {
    --md-switch-selected-track-color: var(--status-indicator-color-active);
    --md-switch-selected-handle-color: #f4f4f4;
}
body.light-mode #file-picker-dialog {
}
body.light-mode #file-picker-dialog .border-b,
body.light-mode #file-picker-dialog .border-t,
body.light-mode #file-picker-dialog .border-r {
    border-color: var(--border-color-light);
}
body.light-mode #file-picker-dialog #file-picker-path {
    background-color: rgba(0,0,0,0.05);
}
body.light-mode #file-picker-dialog #file-picker-sidebar {
    background-color: rgba(0,0,0,0.05);
}
body.light-mode #file-picker-dialog #file-picker-sidebar li:hover {
    background-color: rgba(0,0,0,0.1);
}
body.light-mode #file-picker-dialog #file-picker-filename {
    background-color: var(--input-bg-light);
    border-color: var(--input-border-light);
}
body.light-mode #file-picker-dialog #file-picker-cancel-btn {
    background-color: rgba(0,0,0,0.1);
}
.file-picker-item {
}
body.light-mode:not(.aero-enabled) {
    --bg-color-light: #e9ecef; 
}
body.light-mode:not(.aero-enabled) .app-window,
body.light-mode:not(.aero-enabled) #quick-settings,
body.light-mode:not(.aero-enabled) #start-menu,
body.light-mode:not(.aero-enabled) #all-apps-fullscreen,
body.light-mode:not(.aero-enabled) .taskbar-context-menu {
    background-color: var(--window-bg-light); 
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.08);
    border: 1px solid #d9dde2;
}
body.light-mode:not(.aero-enabled) #taskbar {
    background-color: var(--window-bg-light);
    border-top: 1px solid #d9dde2;
    box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.08);
}
body.light-mode:not(.aero-enabled) .window-header {
    background-color: #f6f8fa; 
}
body.light-mode:not(.aero-enabled) #settings-sidebar {
    background-color: #f6f8fa; 
}
.taskbar-context-menu {
    opacity: 0;
    transform: scale(0.95) translateY(-5px);
    transition: opacity 0.2s ease-out, transform 0.2s ease-out;
    pointer-events: none;
    visibility: hidden; 
}
.taskbar-context-menu.active {
    opacity: 1;
    transform: scale(1) translateY(0);
    pointer-events: auto;
    visibility: visible; 
}
        #setup-screen {
            position: fixed;
            inset: 0;
            z-index: 20000;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #setup-card {
            width: 100%;
            height: 100%;
            background-color: rgba(40, 40, 40, 0.6);
            backdrop-filter: blur(30px) saturate(120%);
            border: none;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        body.light-mode #setup-card {
            background-color: rgba(248, 248, 248, 0.75);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }
        #setup-content-slider {
            flex-grow: 1;
            display: flex;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
        }
        .setup-page {
            width: 100%;
            height: 100%;
            flex-shrink: 0;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .setup-page h2 {
            font-size: 2.5rem;
            font-weight: 200;
            margin-bottom: 1rem;
        }
        .setup-page p {
            color: #ccc;
            max-width: 400px;
        }
        body.light-mode .setup-page p {
            color: #555;
        }
        #setup-footer {
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        body.light-mode #setup-footer {
            border-top-color: rgba(0, 0, 0, 0.1);
        }
        .setup-progress-bar {
            display: flex;
            gap: 8px;
        }
        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            transition: background-color 0.3s;
        }
        body.light-mode .progress-dot {
            background-color: rgba(0, 0, 0, 0.2);
        }
        .progress-dot.active {
            background-color: var(--accent-color);
        }
        .setup-nav-btn {
            background-color: var(--accent-color);
            color: var(--accent-color-text);
            padding: 10px 25px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .setup-nav-btn:hover {
            background-color: var(--accent-color-hover);
        }
        .setup-nav-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        .theme-selector {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }
        .theme-option {
            width: 150px;
            height: 100px;
            border-radius: 10px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: border-color 0.2s, transform 0.2s;
            position: relative;
            overflow: hidden;
        }
        .theme-option.selected {
            border-color: var(--accent-color);
            transform: scale(1.05);
        }
        .theme-option span {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 600;
        }
        #theme-light { background-color: #f4f4f4; color: #333; }
        #theme-dark { background-color: #1e1e1e; color: #eee; }
        .account-setup-grid {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 30px;
            align-items: center;
            width: 100%;
            max-width: 450px;
            margin-top: 20px;
        }
        #setup-icon-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            cursor: pointer;
            display: grid;
            place-items: center;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            transition: border-color 0.2s;
        }
        #setup-icon-preview:hover {
            border-color: var(--accent-color);
        }
        #setup-icon-preview img {
            width: 100%; height: 100%; object-fit: cover; border-radius: 50%;
        }
        .setup-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color-dark);
            background-color: var(--input-bg-dark);
            color: var(--text-color-dark);
            font-size: 1rem;
            margin-bottom: 15px;
        }
        body.light-mode .setup-input {
            border-color: var(--border-color-light);
            background-color: var(--input-bg-light);
            color: var(--text-color-light);
        }
        #setup-screen #message-box-overlay {
            z-index: 22000 !important;
        }
.cloud {
    position: absolute;
    width: 200px; height: 60px;
    background: white;
    border-radius: 60px;
    opacity: 0; 
    transition: opacity 2s ease-in-out;
    animation: drift linear infinite;
    pointer-events: none; 
}
.cloud::before, .cloud::after {
    content: ''; position: absolute; background: white; border-radius: 50%;
}
.cloud::before { width: 120px; height: 80px; top: -40px; left: 40px; }
.cloud::after { width: 80px; height: 60px; top: -30px; right: 30px; }
@keyframes drift {
    from { transform: translateX(-250px); }
    to { transform: translateX(100vw); }
}
</style>
</head>
<body class="dark-mode">
<div id="setup-screen" style="display: none;">
        <div id="setup-card">
            <div id="setup-content-slider">
                <div class="setup-page" id="page-welcome">
                    <h2> Rivift OS </h2>
                    <p>WebOS</p>
                </div>
                <div class="setup-page" id="page-theme">
                    <h2></h2>
                    <p>OS</p>
                    <div class="theme-selector">
                        <div id="theme-light" class="theme-option">
                            <span></span>
                        </div>
                        <div id="theme-dark" class="theme-option selected">
                            <span></span>
                        </div>
                    </div>
                    <div class="setting-item" style="margin-top: 20px; width: 250px;">
                        <span></span>
                        <md-switch id="setup-aero-switch" selected></md-switch>
                    </div>
                </div>
                <div class="setup-page" id="page-account">
                    <h2></h2>
                    <p></p>
                    <div class="account-setup-grid">
                        <div id="setup-icon-preview">
                            <i class="fas fa-user-plus" style="font-size: 40px; color: #888;"></i>
                        </div>
                        <div class="flex flex-col">
                            <input type="text" id="setup-username" class="setup-input" placeholder="">
                            <input type="password" id="setup-password-pin" class="setup-input" placeholder="PIN4">
                        </div>
                    </div>
                </div>
                <div class="setup-page" id="page-finish">
                    <h2></h2>
                    <p>Rivift OS </p>
                </div>
            </div>
            <div id="setup-footer">
                <div class="setup-progress-bar"></div>
                <button id="setup-next-btn" class="setup-nav-btn"></button>
            </div>
        </div>
    </div>
    <div id="brightness-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: black; pointer-events: none; z-index: 9998; opacity: 0;"></div>
        <div id="night-mode-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 159, 0, 0.2); mix-blend-mode: multiply; pointer-events: none; z-index: 9997; display: none;"></div>
        <div id="spotlight-overlay" class="fixed inset-0 z-[6000] hidden items-start justify-center pt-32 bg-black/30 backdrop-blur-sm">
        <div id="spotlight-container" class="w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden" style="background-color: var(--panel-bg-dark); border: 1px solid var(--border-color-dark);">
            <div class="flex items-center p-4 border-b" style="border-color: var(--border-color-dark);">
                <i class="fas fa-search text-gray-400 text-2xl mr-4"></i>
                <input type="text" id="spotlight-input" class="w-full bg-transparent text-2xl text-gray-200 outline-none placeholder-gray-500" placeholder="Spotlight">
            </div>
            <div id="spotlight-results" class="max-h-80 overflow-y-auto">
                <!--  -->
            </div>
        </div>
    </div>
        <div id="snap-layouts-popup" class="glass-effect">
    </div>
    <div id="window-resizer" class="hidden"></div>
<div id="boot-screen" class="fixed inset-0 bg-black flex flex-col items-center justify-center z-[9999] transition-opacity duration-1000 ease-in-out">
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex flex-col items-center">
        <div id="boot-logo-container" class="opacity-0 transition-opacity duration-[2500ms]">
            <span class="logo-text text-6xl font-light text-white tracking-wider">Rivift OS</span>
        </div>
        <div id="boot-version-text" class="text-gray-400 text-lg mt-2 opacity-0 transition-opacity duration-[2500ms]">
            HTML Version
        </div>
    </div>
    <div class="absolute bottom-1/4"> 
        <div id="boot-loader" class="opacity-0 transition-opacity duration-1500"></div>
    </div>
</div>
<div id="boot-screen" class="fixed inset-0 ...">
   <div id="rivift-os-container" style="background-image: url('https://images.unsplash.com/photo-1519681393784-a93987cb0f66?q=80&w=2670&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');">
<div id="dynamic-wallpaper-container" style="position: absolute; inset: 0; z-index: 0; display: none;">
    <!--  -->
    <canvas id="sky-canvas" style="position: absolute; top: 0; left: 0;"></canvas>
    <!--  -->
    <canvas id="landscape-canvas" style="position: absolute; top: 0; left: 0;"></canvas>
    <!-- divOK -->
    <div id="clouds-container"></div> 
</div>
    <div id="desktop">
    <div id="desktop-icons" class="absolute inset-0 p-4 grid grid-cols-12 gap-4">
        <!--  -->
    </div>
    <div id="maximize-preview-box"></div>
    <!-- App windows will be appended here -->
</div>
<div id="file-picker-overlay" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[14000]">
    <div id="file-picker-dialog" class="glass-effect w-full max-w-3xl h-[70vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
        <!--  -->
        <div class="p-3 border-b flex items-center flex-shrink-0" style="border-color: var(--border-color-dark);">
            <h3 id="file-picker-title" class="text-lg font-semibold"></h3>
            <div id="file-picker-path" class="ml-4 font-mono text-sm bg-black/20 px-2 py-1 rounded">/</div>
        </div>
        <!--  ( + ) -->
        <div class="flex flex-grow min-h-0">
            <!--  -->
            <div id="file-picker-sidebar" class="w-48 p-2 border-r flex-shrink-0 overflow-y-auto" style="border-color: var(--border-color-dark); background-color: rgba(0,0,0,0.1);">
                <h4 class="font-semibold text-xs text-gray-400 px-2 mb-1"></h4>
                <ul>
                    <li data-path="/" class="p-2 rounded-lg hover:bg-white/10 cursor-pointer flex items-center gap-2 text-sm"><i class="fas fa-desktop w-4"></i> OS ()</li>
                    <li data-path="/Documents" class="p-2 rounded-lg hover:bg-white/10 cursor-pointer flex items-center gap-2 text-sm"><i class="fas fa-file-alt w-4"></i> Documents</li>
                    <li data-path="/Pictures" class="p-2 rounded-lg hover:bg-white/10 cursor-pointer flex items-center gap-2 text-sm"><i class="fas fa-image w-4"></i> Pictures</li>
                    <li data-path="/Music" class="p-2 rounded-lg hover:bg-white/10 cursor-pointer flex items-center gap-2 text-sm"><i class="fas fa-music w-4"></i> Music</li>
                </ul>
            </div>
            <!--  -->
            <div id="file-picker-grid" class="flex-grow p-2 overflow-y-auto grid grid-cols-[repeat(auto-fill,minmax(112px,1fr))] gap-2 content-start">
                <!-- JS -->
            </div>
        </div>
        <!--  -->
        <div class="p-3 border-t flex items-center gap-4 flex-shrink-0" style="border-color: var(--border-color-dark);">
            <span class="flex-shrink-0 text-sm">:</span>
            <input type="text" id="file-picker-filename" class="flex-grow p-2 rounded-lg" style="background-color: var(--input-bg-dark); border: 1px solid var(--input-border-dark);"/>
            <button id="file-picker-action-btn" class="px-5 py-2 rounded-lg bg-blue-600 text-white font-semibold disabled:bg-gray-500 disabled:cursor-not-allowed"></button>
            <button id="file-picker-cancel-btn" class="px-5 py-2 rounded-lg" style="background-color: rgba(255,255,255,0.1);"></button>
        </div>
    </div>
</div>
<div id="recovery-screen" class="fixed inset-0 bg-black flex-col items-center justify-center z-[9998] hidden">
    <div class="text-center text-white">
        <i class="fas fa-cogs text-5xl fa-spin mb-6"></i>
        <h2 class="text-3xl font-light mb-4">...</h2>
        <p class="text-gray-400 mb-6"><br></p>
        <!--  -->
        <div class="w-full max-w-md bg-gray-700 rounded-full h-2.5">
            <div id="recovery-progress-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
        <!--  -->
        <p id="recovery-status-text" class="mt-4 text-sm text-gray-500 font-mono h-5"></p>
    </div>
</div>
        <div id="file-picker-overlay" class="fixed inset-0 bg-black/50 z-[4000] hidden items-center justify-center">
        <div id="file-picker-dialog" class="w-full max-w-2xl h-[70vh] bg-[--window-bg-dark] rounded-lg shadow-2xl flex flex-col">
        <!--  -->
        <div class="p-2 border-b border-[--border-color-dark] flex items-center">
        <h3 id="file-picker-title" class="text-lg font-semibold"></h3>
        <span id="file-picker-path" class="ml-4 font-mono text-sm bg-black/20 px-2 py-1 rounded">/</span>
        </div>
        <!--  () -->
        <div id="file-picker-grid" class="flex-grow p-2 overflow-y-auto grid grid-cols-4 gap-4">
        <!-- JS -->
        </div>
        <!--  -->
        <div class="p-2 border-t border-[--border-color-dark] flex items-center gap-4">
        <span class="flex-shrink-0">:</span>
        <input type="text" id="file-picker-filename" class="flex-grow p-1 rounded bg-transparent border border-[--input-border-dark]"/>
        <button id="file-picker-action-btn" class="px-4 py-1 rounded bg-blue-600 disabled:bg-gray-500 disabled:cursor-not-allowed"></button>
        <button id="file-picker-cancel-btn" class="px-4 py-1 rounded bg-gray-600"></button>
        </div>
        </div>
        </div>
        <!-- Taskbar App Context Menu (template, will be cloned and positioned by JS) -->
    <div id="taskbar-app-context-menu-template" class="taskbar-context-menu hidden"></div>
    <div id="context-menu" class="taskbar-context-menu fixed z-[3000] hidden"></div>
<div id="file-picker-overlay" class="fixed inset-0 bg-black/50 z-[4000] hidden items-center justify-center">
    <div id="file-picker-dialog" class="w-full max-w-2xl h-[70vh] bg-[--window-bg-dark] rounded-lg shadow-2xl flex flex-col">
        <!--  -->
        <div class="p-2 border-b border-[--border-color-dark] flex items-center">
            <h3 id="file-picker-title" class="text-lg font-semibold"></h3>
            <span id="file-picker-path" class="ml-4 font-mono text-sm bg-black/20 px-2 py-1 rounded">/</span>
        </div>
        <!--  () -->
        <div id="file-picker-grid" class="flex-grow p-2 overflow-y-auto grid grid-cols-4 gap-4">
            <!-- JS -->
        </div>
        <!--  -->
        <div class="p-2 border-t border-[--border-color-dark] flex items-center gap-4">
            <span class="flex-shrink-0">:</span>
            <input type="text" id="file-picker-filename" class="flex-grow p-1 rounded bg-transparent border border-[--input-border-dark]"/>
            <button id="file-picker-action-btn" class="px-4 py-1 rounded bg-blue-600 disabled:bg-gray-500 disabled:cursor-not-allowed"></button>
            <button id="file-picker-cancel-btn" class="px-4 py-1 rounded bg-gray-600"></button>
        </div>
    </div>
</div>
        <div id="taskbar" class="glass-effect" style="display: none;">
            <div id="taskbar-left">
                <div id="menu-button" class="taskbar-icon">
                    <i class="fas fa-bars"></i>
                </div>
                <div id="mission-control-btn" class="taskbar-icon" title="">
                    <i class="fas fa-clone"></i>
                </div>
                <div id="spotlight-btn" class="taskbar-icon" title="">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            <div id="taskbar-center" class="flex gap-2">
                <!-- Pinned apps will be rendered here by JavaScript -->
            </div>
<div id="taskbar-right">
    <div id="notification-icon-container" class="taskbar-icon" style="display: none;">
        <!-- JS -->
    </div>
    <div id="current-time"></div>
    <div id="date-display" class="hidden ml-2 text-sm"></div>
</div>
        </div>
    </div>
<div id="quick-settings" class="hidden md:block !w-[340px] !p-4">
    <div class="grid grid-cols-[1fr,auto,auto] gap-3">
        <!-- :  -->
        <div class="col-span-1 flex flex-col gap-3">
            <div id="qs-theme-toggle" class="h-[75px] bg-black/20 rounded-2xl p-3 flex items-center justify-between cursor-pointer transition-colors">
                <i id="qs-theme-icon" class="fas fa-circle-half-stroke text-2xl transition-transform"></i>
                <span id="qs-theme-text" class="font-semibold"></span>
            </div>
            <div id="qs-aero-toggle-container" class="relative h-[75px] bg-black/20 rounded-2xl p-3 flex items-center justify-between cursor-pointer transition-colors">
                <div id="qs-aero-toggle" class="flex items-center gap-3">
                    <i class="fas fa-wand-magic-sparkles text-2xl"></i>
                    <span class="font-semibold text-white"></span>
                </div>
                <button id="qs-aero-submenu-btn" class="w-7 h-7 rounded-full hover:bg-white/10 flex items-center justify-center">
                    <i class="fas fa-chevron-right text-xs transition-transform"></i>
                </button>
                <!--  -->
                <div id="qs-aero-submenu" class="absolute left-0 top-full mt-2 w-full bg-gray-800/80 backdrop-blur-md rounded-xl p-2 hidden flex-col gap-1 z-10 shadow-lg">
                    <div data-mode="clear" class="qs-aero-option p-2 rounded-lg hover:bg-white/20 flex justify-between items-center"><span></span><i class="fas fa-check opacity-0"></i></div>
                    <div data-mode="smoke" class="qs-aero-option p-2 rounded-lg hover:bg-white/20 flex justify-between items-center"><span></span><i class="fas fa-check opacity-0"></i></div>
                </div>
            </div>
            <div id="qs-night-mode-toggle" class="qs-dummy-tile h-[75px] rounded-2xl p-3 flex items-center justify-between cursor-pointer transition-colors">
    <div class="flex items-center gap-3">
        <i class="fas fa-moon text-2xl"></i>
        <span class="font-semibold text-white"></span>
    </div>
</div>
<!--  -->
<div id="qs-custom-grid" class="grid grid-cols-2 gap-3">
    <div id="qs-music-player" class="col-span-2 row-span-2 bg-black/20 rounded-2xl p-4 flex flex-col justify-between">
        <div class="flex items-center gap-3">
            <div id="qs-music-artwork" class="w-12 h-12 rounded-lg bg-gray-500 flex-shrink-0 grid place-items-center">
                <i class="fas fa-music text-2xl text-gray-300"></i>
            </div>
            <div class="truncate">
                <p id="qs-music-title" class="font-bold truncate"></p>
                <p id="qs-music-artist" class="text-xs text-gray-400 truncate"></p>
            </div>
        </div>
        <div id="qs-progress-container" class="w-full">
            <div class="relative h-2 flex items-center cursor-pointer">
                <div class="w-full h-1 absolute rounded-full bg-white/20"></div>
                <div id="qs-music-progress-fill" class="h-1 absolute rounded-full bg-white" style="width: 0%;"></div>
                <input type="range" id="qs-music-progress-slider" min="0" max="100" value="0" class="absolute inset-0 w-full h-full opacity-0 m-0 p-0">
            </div>
            <div class="flex justify-between text-xs mt-1 text-gray-400">
                <span id="qs-music-current-time">0:00</span>
                <span id="qs-music-duration">0:00</span>
            </div>
        </div>
        <div class="flex items-center justify-around text-lg">
            <button id="qs-music-prev" class="w-10 h-10 rounded-full hover:bg-white/10"><i class="fas fa-backward-step"></i></button>
            <button id="qs-music-play-pause" class="w-12 h-12 rounded-full bg-white text-black text-xl flex items-center justify-center"><i class="fas fa-play"></i></button>
            <button id="qs-music-next" class="w-10 h-10 rounded-full hover:bg-white/10"><i class="fas fa-forward-step"></i></button>
        </div>
    </div>
</div>
        </div>
<!-- :  -->
<div class="qs-v-slider-container w-[55px] flex items-center justify-center">
    <div id="qs-volume-slider-track" class="relative w-full h-full rounded-2xl cursor-pointer">
        <div id="qs-volume-fill" class="qs-slider-fill absolute bottom-0 w-full"></div>
        <i id="qs-volume-icon" class="fas fa-volume-up text-xl absolute top-3 left-1/2 -translate-x-1/2 z-10 text-white/50"></i>
    </div>
</div>
<!-- :  -->
<div class="qs-v-slider-container w-[55px] flex items-center justify-center">
    <div id="qs-brightness-slider-track" class="relative w-full h-full rounded-2xl cursor-pointer">
        <div id="qs-brightness-fill" class="qs-slider-fill absolute bottom-0 w-full"></div>
        <i class="fas fa-sun text-xl absolute top-3 left-1/2 -translate-x-1/2 z-10 text-white/50"></i>
    </div>
</div>
    </div>
    <!--  -->
    <div class="mt-3 flex justify-around items-center bg-black/20 rounded-2xl p-1">
        <button id="power-restart" class="w-10 h-10 rounded-lg hover:bg-white/10"><i class="fas fa-sync-alt"></i></button>
        <button id="power-lock" class="w-10 h-10 rounded-lg hover:bg-white/10"><i class="fas fa-lock"></i></button>
        <button id="power-shutdown" class="w-10 h-10 rounded-lg hover:bg-white/10"><i class="fas fa-power-off"></i></button>
    </div>
</div>
<div id="notification-center-panel" class="hidden md:block glass-effect" 
     style="position: absolute; bottom: 70px; right: 20px; width: 350px; max-height: 500px;
            backdrop-filter: blur(15px); border-radius: 15px; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4);
            transform: translateY(100%) scale(0.8); opacity: 0; visibility: hidden;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out, visibility 0.3s;
            z-index: 10001; display: flex; flex-direction: column;">
    <div class="p-4 flex justify-between items-center flex-shrink-0">
        <h3 class="font-semibold text-lg"></h3>
        <button id="clear-all-notifications-btn" class="text-sm text-blue-400 hover:underline"></button>
    </div>
    <div id="notification-center-list" class="flex-grow p-4 pt-0 overflow-y-auto">
        <p id="no-notifications-message" class="text-center text-gray-500 py-8"></p>
    </div>
</div>
<div id="start-menu" class="hidden md:block">
    <!-- div -->
    <div class="p-3 flex flex-col h-full gap-3">
        <!-- 1.  -->
        <div class="flex items-center gap-3 flex-shrink-0">
            <!--  (flex-grow) -->
            <input type="text" id="launcher-search-bar" placeholder="" 
                   class="flex-grow px-4 py-2 rounded-full outline-none text-center"
                   style="background-color: var(--input-bg-dark); border: 1px solid var(--border-color-dark);">
            <!--  (flex-shrink-0) -->
            <button id="launcher-show-all-apps-btn" 
                    class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-semibold flex items-center gap-2 transition-colors hover:bg-white/10"
                    style="background-color: var(--input-bg-dark); border: 1px solid var(--border-color-dark);">
                <span></span>
                <i class="fas fa-chevron-right text-xs"></i>
            </button>
        </div>
        <!-- 2.  -->
        <div id="launcher-recent-apps-container" class="flex-shrink-0">
            <h4 class="text-xs font-bold text-gray-500 mb-2 px-1"></h4>
            <!--  -->
            <div id="launcher-recent-apps" class="flex gap-4 overflow-x-auto pb-2">
                <!-- JS -->
            </div>
        </div>
        <!-- 3.  -->
        <hr class="border-white/10 flex-shrink-0">
        <!-- 4.  -->
        <div id="launcher-app-grid" class="flex-grow overflow-y-auto pr-2">
            <!-- JS -->
        </div>
    </div>
</div>
        <div id="all-apps-fullscreen">
<div id="all-apps-header">
    <button id="select-pin-apps-button" title="">
        <i class="fas fa-thumbtack"></i>
    </button>
    <input type="text" id="all-apps-search-bar" placeholder="">
    <button id="exit-all-apps" title="">
        <i class="fas fa-times"></i>
    </button>
</div>
<div id="all-apps-grid-container">
    <!-- JS -->
</div>
<div id="all-apps-pagination">
    <!-- JS -->
</div>
        </div>
        <div id="message-box-overlay">
            <div id="message-box">
                <h3 id="message-box-title"></h3>
                <p id="message-box-content"></p>
                <div id="message-box-custom-content"></div> <!-- For progress bar or other custom content -->
                <div id="message-box-buttons">
                    <button id="message-box-ok">OK</button>
                    <button id="message-box-cancel" class="cancel hidden"></button>
                </div>
            </div>
        </div>
<div id="lock-screen" class="hidden">
    <div id="lock-screen-bg" class="absolute inset-0 bg-cover bg-center transition-all duration-500 ease-in-out"></div>
    <!--  -->
    <div id="lock-screen-default-content" class="absolute inset-0 transition-opacity duration-300">
        <div class="absolute top-1/3 left-0 right-0 text-center text-white -translate-y-1/2">
            <div id="lock-screen-time" class="text-6xl font-light"></div>
            <div id="lock-screen-date"></div>
        </div>
        <div id="lock-screen-message" class="absolute bottom-10 left-0 right-0 text-center"></div>
    </div>
    <!--  -->
    <div id="lock-screen-unlock-content" class="absolute inset-0 opacity-0 pointer-events-none transition-opacity duration-300">
<div id="lock-screen-user-area" class="absolute top-1/3 left-0 right-0 text-center text-white -translate-y-1/2">
    <div id="lock-screen-icon-wrapper" class="relative w-32 h-32 mx-auto mb-4 border-2 border-white/50 rounded-full">
        <!-- JS -->
    </div>
    <p id="lock-screen-user-name" class="text-3xl font-semibold"></p>
</div>
<!--    -->
<div id="face-auth-lock-area" class="absolute bottom-1/3 left-1/2 w-full max-w-xs -translate-x-1/2 translate-y-1/2 text-center hidden">
<div id="face-auth-lock-video-wrapper" class="relative w-40 h-30 mx-auto mb-2 bg-black rounded-lg overflow-hidden">
    <video id="face-auth-lock-video" autoplay muted playsinline class="w-full h-full"></video>
</div>
    <p id="face-auth-lock-status" class="text-sm text-gray-300 h-5">...</p>
    <!--  -->
    <button id="show-login-options-btn" class="mt-6 text-sm text-blue-400 hover:underline"> </button>
</div>
<!--    -->
<!--    -->
<div id="lock-screen-password-area" class="absolute bottom-1/3 left-1/2 w-full max-w-xs -translate-x-1/2 translate-y-1/2 hidden">
    <!-- JSUI -->
</div>
    </div>
</div>
        <div id="desktop-notifications-container">
            <!-- Desktop notifications will appear here -->
        </div>
        <!-- Taskbar App Context Menu (template, will be cloned and positioned by JS) -->
        <div id="taskbar-app-context-menu-template" class="taskbar-context-menu hidden">
            <!-- Items will be added by JS -->
        </div>
                <div id="modal-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-[4000]">
            <div id="modal-content" class="bg-[#2d2d2d] text-white p-6 rounded-lg shadow-2xl w-full max-w-md">
                <!-- JS -->
            </div>
        </div>
    </div>
<div id="setup-icon-modal-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center" style="z-index: 22000;">
        <div id="setup-icon-modal-content" class="bg-[#2d2d2d] text-white p-6 rounded-lg shadow-2xl w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4"></h3>
            <div id="setup-icon-grid" class="grid grid-cols-4 gap-4 my-4"></div>
            <div style="text-align: right; margin-top: 20px;">
                <button id="setup-icon-confirm-btn" class="px-5 py-2 rounded-lg bg-blue-600 text-white font-semibold"></button>
            </div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', (event) => {
const VFS_WORKER_CODE = `
const VFS = {
    db: null,
    isInitializing: false, 
    init: function() {
        if (this.isInitializing) {
            console.warn("VFS.init() is already in progress. Ignoring duplicate call.");
            return new Promise(resolve => {
                const checkInterval = setInterval(() => {
                    if (!this.isInitializing) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
            });
        }
        this.isInitializing = true;
        return new Promise((resolve, reject) => {
            (async () => {
                if (navigator.storage && navigator.storage.persist) {
                    try {
                        if (!(await navigator.storage.persisted())) {
                            await navigator.storage.persist();
                        }
                    } catch (error) { console.error(':', error); }
                }
            })();
            const request = indexedDB.open('RiviftFS_v2', 2);
            request.onerror = async (event) => {
                console.error("IndexedDB error:", request.error);
                reject("IndexedDB error: " + request.error);
            };
            request.onsuccess = (event) => {
                this.db = event.target.result;
                this._verifyFileSystemIntegrity().then(() => {
                    return this.recoverFromJournal();
                }).then(() => {
                    console.log("Journal recovery check complete.");
                    return this.setupInitialFolders();
                }).then(() => {
                    console.log("Initial folders setup check complete.");
                    this.isInitializing = false; 
                    resolve();
                }).catch(err => {
                    console.error("Initialization process failed during integrity check or recovery:", err);
                    this.isInitializing = false; 
                    reject(err);
                });
            };
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('files')) {
                    const fileStore = db.createObjectStore('files', { keyPath: 'path' });
                    fileStore.createIndex('parent', 'parent', { unique: false });
                }
                if (!db.objectStoreNames.contains('journal')) {
                    db.createObjectStore('journal', { keyPath: 'id', autoIncrement: true });
                }
            };
        });
    },
    setupInitialFolders: async function() {
        const requiredFolders = ['/Documents', '/Pictures', '/Music', '/Videos', '/Downloads', '/System', '/System/Calendar'];
        for (const path of requiredFolders) {
            const parentPath = path.substring(0, path.lastIndexOf('/')) || '/';
            const folderName = path.substring(path.lastIndexOf('/') + 1);
            await this.createFolder(parentPath, folderName, false);
        }
        await this.createFolder('/', 'Trash', true);
    },
    recoverFromJournal: async function() {
        if (!this.db) return;
        try {
            const transaction = this.db.transaction(['journal'], 'readonly');
            const journalStore = transaction.objectStore('journal');
            const logsToProcess = await new Promise((res, rej) => {
                const req = journalStore.getAll();
                req.onsuccess = () => res(req.result);
                req.onerror = (e) => rej(e.target.error);
            });
            if (logsToProcess.length === 0) return;
            console.warn(\`\${logsToProcess.length}...\`, logsToProcess);
            for (let i = 0; i < logsToProcess.length; i++) {
                const log = logsToProcess[i];
                try {
                    await new Promise((resolve, reject) => {
                        const recoveryTransaction = this.db.transaction(['files', 'journal'], 'readwrite');
                        recoveryTransaction.oncomplete = () => resolve();
                        recoveryTransaction.onerror = (e) => reject(e.target.error);
                        const fileStore = recoveryTransaction.objectStore('files');
                        const journalStoreToDelete = recoveryTransaction.objectStore('journal');
                        if (log.operation === 'writeFile') {
                            fileStore.put(log.data);
                        }
                        journalStoreToDelete.delete(log.id);
                    });
                    console.log(\` (id: \${log.id}) \`);
                } catch (recoveryError) {
                    console.error(\` (id: \${log.id}) :\`, recoveryError);
                }
            }
        } catch (readError) {
            console.error(":", readError);
        }
    },
    listFiles: function(parentPath) {
        return new Promise((resolve, reject) => {
            if (!this.db) {
                console.warn("listFiles called before DB was ready. Retrying in 100ms.");
                setTimeout(() => this.listFiles(parentPath).then(resolve).catch(reject), 100);
                return;
            }
            const transaction = this.db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const index = store.index('parent');
            const request = index.getAll(parentPath);
            request.onsuccess = () => {
                const rawResult = request.result || [];
                const validItems = rawResult.filter(item => item && item.name);
                const sortedItems = validItems.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                resolve(sortedItems);
            };
            request.onerror = (e) => reject(\`Failed to list files: \${e.target.error}\`);
        });
    },
    readFile: function(path) {
        if (path.startsWith('/Apps/')) {
            return Promise.resolve(null);
        }
        return new Promise((resolve, reject) => {
            if (!this.db) return reject("Database not initialized.");
            const transaction = this.db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const request = store.get(path);
            request.onsuccess = () => resolve(request.result);
            request.onerror = (e) => reject(\`Failed to read file: \${e.target.error}\`);
        });
    },
    search: function(query) {
        return new Promise((resolve, reject) => {
            if (!this.db) return reject("Database not initialized.");
            const transaction = this.db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const request = store.getAll();
            request.onsuccess = () => {
                const filesOnly = request.result.filter(item => item.type !== 'folder');
                resolve(filesOnly);
            };
            request.onerror = (e) => reject(\`Failed to search files: \${e.target.error}\`);
        });
    },
    put: function(data) {
        return new Promise((resolve, reject) => {
            if (!this.db) return reject("Database not initialized.");
            const transaction = this.db.transaction(['files'], 'readwrite');
            transaction.oncomplete = () => resolve();
            transaction.onerror = (e) => reject(\`Transaction failed: \${e.target.error}\`);
            const store = transaction.objectStore('files');
            store.put(data);
        });
    },
    createFolder: async function(parentPath, folderName, isSpecial = false) {
        const path = (parentPath === '/' ? '' : parentPath) + '/' + folderName;
        const existingItem = await this.readFile(path).catch(() => null);
        if (existingItem) {
            if (existingItem.special !== isSpecial) {
                existingItem.special = isSpecial;
                return this.put(existingItem);
            }
            return; 
        }
        const newFolder = {
            path: path,
            name: folderName,
            type: 'folder',
            parent: parentPath,
            ctime: Date.now(),
            mtime: Date.now(),
            special: isSpecial
        };
        return this.put(newFolder);
    },
    writeFile: async function(parentPath, fileName, type, content) {
        const path = (parentPath === '/' ? '' : parentPath) + '/' + fileName;
        const fileData = {
            path: path,
            name: fileName,
            type: type,
            content: content,
            parent: parentPath,
            ctime: Date.now(),
            mtime: Date.now()
        };
        const journalEntry = {
            operation: 'writeFile',
            path: path,
            data: fileData, 
            timestamp: Date.now()
        };
        const journalId = await this.addJournal(journalEntry);
        try {
            await this.put(journalEntry.data); 
            await this.removeJournal(journalId);
        } catch (error) {
            console.error(\`writeFile failed for \${path}, journal log (id: \${journalId}) is kept for recovery.\`, error);
            throw error;
        }
    },
    addJournal: function(entry) {
        return new Promise((resolve, reject) => {
            if (!this.db) return reject("Database not initialized.");
            const transaction = this.db.transaction(['journal'], 'readwrite');
            transaction.onerror = (e) => reject(\`addJournal failed: \${e.target.error}\`);
            const store = transaction.objectStore('journal');
            const request = store.add(entry);
            request.onsuccess = () => resolve(request.result);
        });
    },
    removeJournal: function(journalId) {
        return new Promise((resolve, reject) => {
            if (!this.db) return reject("Database not initialized.");
            const transaction = this.db.transaction(['journal'], 'readwrite');
            transaction.oncomplete = () => resolve();
            transaction.onerror = (e) => reject(\`removeJournal failed: \${e.target.error}\`);
            const store = transaction.objectStore('journal');
            store.delete(journalId);
        });
    },
    _physicalDelete: function(path) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['files'], 'readwrite');
            const store = transaction.objectStore('files');
            const request = store.delete(path);
            request.onsuccess = resolve;
            request.onerror = (e) => reject(\`Failed to delete: \${e.target.error}\`);
        });
    },
    delete: async function(path, permanent = false) {
        const item = await this.readFile(path);
        if (!item) throw new Error(\`Item not found: \${path}\`);
        const isActuallyInTrash = item.parent === '/Trash';
        if (permanent || isActuallyInTrash) {
            await this._physicalDelete(path);
            if (item.type === 'folder') {
                const children = await this.listFiles(path);
                for (const child of children) {
                    await this.delete(child.path, true);
                }
            }
        } else {
            const trashPath = \`/Trash/\${item.name}_\${Date.now()}\`;
            const movedItem = { ...item, originalPath: item.path, deletedAt: Date.now(), path: trashPath, parent: '/Trash' };
            await this._physicalDelete(path);
            await this.put(movedItem);
        }
    },
    restore: async function(path) {
        const item = await this.readFile(path);
        if (!item || !item.originalPath) throw new Error('');
        if (await this.readFile(item.originalPath)) {
            throw new Error('');
        }
        const restoredItem = { ...item };
        delete restoredItem.originalPath;
        delete restoredItem.deletedAt;
        restoredItem.path = item.originalPath;
        restoredItem.parent = item.originalPath.substring(0, item.originalPath.lastIndexOf('/')) || '/';
        await this._physicalDelete(path);
        await this.put(restoredItem);
    },
    rename: async function(oldPath, newName) {
        const item = await this.readFile(oldPath);
        if (!item) throw new Error(\`Item not found: \${oldPath}\`);
        const parentPath = item.parent;
        const newPath = (parentPath === '/' ? '' : parentPath) + '/' + newName;
        if (await this.readFile(newPath)) {
            throw new Error(\`An item named "\${newName}" already exists.\`);
        }
        const newItem = { ...item, path: newPath, name: newName, mtime: Date.now() };
        await this._physicalDelete(oldPath);
        return this.put(newItem);
    },
    move: async function(sourcePath, destFolderPath) {
        const item = await this.readFile(sourcePath);
        if (!item) throw new Error(\`Item not found: \${sourcePath}\`);
        const destFolder = await this.readFile(destFolderPath);
        if (!destFolder || destFolder.type !== 'folder') {
             throw new Error("Invalid destination folder.");
        }
        const newPath = (destFolderPath === '/' ? '' : destFolderPath) + '/' + item.name;
        if (await this.readFile(newPath)) {
            throw new Error(\`An item named "\${item.name}" already exists in the destination.\`);
        }
        const newItem = { ...item, path: newPath, parent: destFolderPath, mtime: Date.now() };
        await this._physicalDelete(sourcePath);
        return this.put(newItem);
    },
    _verifyFileSystemIntegrity: function() {
        return new Promise((resolve, reject) => {
            if (!this.db) return reject("Database not initialized.");
            console.log('[VFS Integrity Check] ...');
            const transaction = this.db.transaction(['files'], 'readwrite');
            const store = transaction.objectStore('files');
            const request = store.getAll();
            request.onerror = (e) => reject(\`Integrity check failed: \${e.target.error}\`);
            request.onsuccess = () => {
                const allItems = request.result;
                let repairedCount = 0;
                let rescuedCount = 0;
                const now = Date.now();
                const rescueFolderPath = '/System/Recovered Files';
                const rescueFolderName = 'Recovered Files';
                store.get('/System').onsuccess = (e) => {
                    if (!e.target.result) {
                        store.add({ path: '/System', name: 'System', type: 'folder', parent: '/', ctime: now, mtime: now });
                    }
                    store.get(rescueFolderPath).onsuccess = (e2) => {
                        if (!e2.target.result) {
                            store.add({ path: rescueFolderPath, name: rescueFolderName, type: 'folder', parent: '/System', ctime: now, mtime: now });
                        }
                    };
                };
                allItems.forEach(item => {
                    let needsRepair = false;
                    if (!item || !item.path) {
                        rescuedCount++;
                        console.error('[VFS Rescue] path:', item);
                        if(item && (item.path || item.id)) store.delete(item.path || item.id);
                        const rescuedPath = \`\${rescueFolderPath}/rescued_file_\${now}_\${rescuedCount}\`;
                        const rescuedItem = {
                            path: rescuedPath,
                            name: \`\${rescuedCount}\`,
                            parent: rescueFolderPath,
                            type: 'unknown/corrupted',
                            ctime: now,
                            mtime: now,
                            content: item?.content || null,
                            originalData: JSON.stringify(item)
                        };
                        store.add(rescuedItem);
                        return;
                    }
                    if (!item.name) {
                        item.name = item.path.split('/').pop();
                        needsRepair = true;
                    }
                    if (item.parent === undefined) {
                        item.parent = item.path.substring(0, item.path.lastIndexOf('/')) || '/';
                        needsRepair = true;
                    }
                    if (item.type === undefined) {
                        if (item.name.includes('.')) {
                            const ext = item.name.split('.').pop().toLowerCase();
                            if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) item.type = 'image/jpeg';
                            else if (['txt', 'md'].includes(ext)) item.type = 'text/plain';
                            else item.type = 'application/octet-stream'; 
                        } else if (item.content === undefined) { 
                            item.type = 'folder';
                        } else {
                            item.type = 'unknown';
                        }
                        needsRepair = true;
                    }
                    if (item.ctime === undefined) {
                        item.ctime = now;
                        needsRepair = true;
                    }
                    if (item.mtime === undefined) {
                        item.mtime = now;
                        needsRepair = true;
                    }
                    if (needsRepair) {
                        repairedCount++;
                        store.put(item);
                    }
                });
                transaction.oncomplete = () => {
                    if (repairedCount > 0) console.log(\`%c[VFS Repair] \${repairedCount}\`, 'color: #27c93f;');
                    if (rescuedCount > 0) console.log(\`%c[VFS Rescue] \${rescuedCount}\`, 'color: #ffbd2e;');
                    resolve();
                };
            };
        });
    },
};
`;       
const wallpaperWorkerCode = `
  ${VFS_WORKER_CODE}
  const getWallpaperDataUrl = async (url) => {
      if (url.startsWith('wallpapers/')) {
          try {
              const fileData = await VFS.readFile('/System/Wallpapers/' + url.split('/').pop());
              return fileData ? fileData.content : url;
          } catch (e) {
              return url;
          }
      }
      return url;
  };
  self.onmessage = async (e) => {
      const { wallpaperList, currentWallpaper } = e.data;
      await VFS.init();
      const previewHtmlPromises = wallpaperList.map(async (url) => {
          const dataUrl = await getWallpaperDataUrl(url);
          const isSelected = currentWallpaper === url ? 'selected' : '';
          return \`
              <div class="wallpaper-preview \${isSelected}" 
                   data-wallpaper="\${url}"
                   style="background-image: url('\${dataUrl}');"> 
              </div>
          \`;
      });
      const finalHtml = (await Promise.all(previewHtmlPromises)).join('');
      self.postMessage(finalHtml);
  };
`;
const wallpaperWorkerBlob = new Blob([wallpaperWorkerCode], { type: 'application/javascript' });
const wallpaperWorkerUrl = URL.createObjectURL(wallpaperWorkerBlob);
const wallpaperLoaderWorker = new Worker(wallpaperWorkerUrl);
const fileLoaderWorkerCode = `
  ${VFS_WORKER_CODE}
  VFS.init().catch(err => console.error('Worker VFS init failed:', err));
  self.onmessage = async (e) => {
      const { command, requestId, payload } = e.data;
      try {
          let result = null;
          switch(command) {
              case 'readFile':
                  result = await VFS.readFile(payload.path);
                  break;
              case 'listFiles':
                  result = await VFS.listFiles(payload.path);
                  break;
              case 'search':
                  result = await VFS.search(payload.query);
                  break;
              default:
                  throw new Error('Unknown command: ' + command);
          }
          self.postMessage({ requestId, result, success: true });
      } catch (error) {
          self.postMessage({ requestId, error: error.message, success: false });
      }
  };
`;
const fileLoaderWorkerBlob = new Blob([fileLoaderWorkerCode], { type: 'application/javascript' });
const fileLoaderWorkerUrl = URL.createObjectURL(fileLoaderWorkerBlob);
const fileLoaderWorker = new Worker(fileLoaderWorkerUrl);
let fileRequestIdCounter = 0;
const pendingFileRequests = new Map();
fileLoaderWorker.onmessage = (e) => {
    const { requestId, result, error, success } = e.data;
    if (pendingFileRequests.has(requestId)) {
        const callbacks = pendingFileRequests.get(requestId);
        if (success) {
            callbacks.resolve(result);
        } else {
            callbacks.reject(new Error(error));
        }
        pendingFileRequests.delete(requestId);
    }
};
function readFileWithWorker(path) {
    return new Promise((resolve, reject) => {
        const requestId = fileRequestIdCounter++;
        pendingFileRequests.set(requestId, { resolve, reject });
        fileLoaderWorker.postMessage({ command: 'readFile', requestId, payload: { path } });
    });
}
function listFilesWithWorker(path) {
    return new Promise((resolve, reject) => {
        const requestId = fileRequestIdCounter++;
        pendingFileRequests.set(requestId, { resolve, reject });
        fileLoaderWorker.postMessage({ command: 'listFiles', requestId, payload: { path } });
    });
}
function searchWithWorker(query) {
    return new Promise((resolve, reject) => {
        const requestId = fileRequestIdCounter++;
        pendingFileRequests.set(requestId, { resolve, reject });
        fileLoaderWorker.postMessage({ command: 'search', requestId, payload: { query } });
    });
}
const pingpongWorkerCode = `
  let gameRunning = false;
  let playerY = 160, aiY = 160, ballX = 290, ballY = 190;
  let ballSpeedX = 4, ballSpeedY = 4;
  let playerScore = 0, aiScore = 0;
  const paddleSpeed = 6, paddleHeight = 80, ballSize = 10, paddleWidth = 10;
  let gameAreaWidth = 600, gameAreaHeight = 360;
  function resetBall() {
    ballX = gameAreaWidth / 2 - ballSize / 2;
    ballY = gameAreaHeight / 2 - ballSize / 2;
    ballSpeedX = (Math.random() > 0.5 ? 1 : -1) * 4;
    ballSpeedY = (Math.random() > 0.5 ? 1 : -1) * 4;
  }
  function gameLoop() {
    if (!gameRunning) return;
    ballX += ballSpeedX;
    ballY += ballSpeedY;
    if (ballY <= 0 || ballY >= gameAreaHeight - ballSize) {
      ballSpeedY *= -1;
    }
    if ((ballX <= paddleWidth + 10 && ballX > 10 && ballY + ballSize > playerY && ballY < playerY + paddleHeight) ||
        (ballX >= gameAreaWidth - paddleWidth - 10 - ballSize && ballX < gameAreaWidth - 10 - ballSize && ballY + ballSize > aiY && ballY < aiY + paddleHeight)) {
      ballSpeedX *= -1.05;
      ballSpeedY *= 1.02;
    }
    if (ballX < 0) {
      aiScore++;
      resetBall();
    } else if (ballX > gameAreaWidth) {
      playerScore++;
      resetBall();
    }
    if (ballY + ballSize / 2 < aiY + paddleHeight / 2) {
      aiY = Math.max(0, aiY - paddleSpeed * 0.85);
    }
    if (ballY + ballSize / 2 > aiY + paddleHeight / 2) {
      aiY = Math.min(gameAreaHeight - paddleHeight, aiY + paddleSpeed * 0.85);
    }
    self.postMessage({
      type: 'update',
      playerY, aiY, ballX, ballY, playerScore, aiScore
    });
    setTimeout(gameLoop, 1000 / 60);
  }
  self.onmessage = (e) => {
    const { command, payload } = e.data;
    if (command === 'start') {
      if (gameRunning) return;
      gameRunning = true;
      gameAreaWidth = payload.width;
      gameAreaHeight = payload.height;
      playerScore = 0;
      aiScore = 0;
      resetBall();
      gameLoop();
    } else if (command === 'stop') {
      gameRunning = false;
    } else if (command === 'updatePlayer') {
      playerY = payload.y;
    }
  };
`;
const pingpongWorkerBlob = new Blob([pingpongWorkerCode], { type: 'application/javascript' });
const pingpongWorkerUrl = URL.createObjectURL(pingpongWorkerBlob);
const visualizerWorkerCode = `
  self.onmessage = (e) => {
    const dataArray = e.data;
    if (!dataArray) return;
    const avg = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
    self.postMessage({ avg: avg });
  };
`;
const visualizerWorkerBlob = new Blob([visualizerWorkerCode], { type: 'application/javascript' });
const visualizerWorkerUrl = URL.createObjectURL(visualizerWorkerBlob);
const dynamicWallpaperContainer = document.getElementById('dynamic-wallpaper-container');
const skyCanvas = document.getElementById('sky-canvas');
const landscapeCanvas = document.getElementById('landscape-canvas');
const cloudsContainer = document.getElementById('clouds-container');
const skyCtx = skyCanvas.getContext('2d');
const landscapeCtx = landscapeCanvas.getContext('2d');
let dynamicWallpaperAnimationId = null;
let dynamicWallpaperFixedTime = null;
const skyColorStops = [
    { time: 0.0,  top: '#00001a', bottom: '#000000' },
    { time: 0.20, top: '#000033', bottom: '#000020' },
    { time: 0.25, top: '#2a2a60', bottom: '#503050' },
    { time: 0.30, top: '#f08080', bottom: '#f8c070' },
    { time: 0.35, top: '#87ceeb', bottom: '#f0e68c' },
    { time: 0.5,  top: '#1e90ff', bottom: '#87ceeb' },
    { time: 0.65, top: '#87ceeb', bottom: '#f0e68c' },
    { time: 0.70, top: '#f08080', bottom: '#ff7f50' },
    { time: 0.75, top: '#483d8b', bottom: '#800080' },
    { time: 0.80, top: '#000033', bottom: '#000020' },
    { time: 1.0,  top: '#00001a', bottom: '#000000' }
];
const lerpColor = (color1, color2, factor) => {
    const r1 = parseInt(color1.slice(1, 3), 16);
    const g1 = parseInt(color1.slice(1, 5), 16) >> 8;
    const b1 = parseInt(color1.slice(5, 7), 16);
    const r2 = parseInt(color2.slice(1, 3), 16);
    const g2 = parseInt(color2.slice(1, 5), 16) >> 8;
    const b2 = parseInt(color2.slice(5, 7), 16);
    const r = Math.round(r1 + (r2 - r1) * factor);
    const g = Math.round(g1 + (g2 - g1) * factor);
    const b = Math.round(b1 + (b2 - b1) * factor);
    return `rgb(${r}, ${g}, ${b})`;
};
function updateDynamicWallpaper(fixedDate = null) {
    if (!dynamicWallpaperContainer || dynamicWallpaperContainer.style.display === 'none' || !skyCanvas || !landscapeCanvas) return;
    const now = fixedDate || new Date();
    const width = skyCanvas.width;
    const height = skyCanvas.height;
    const timeRatio = (now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds()) / (24 * 3600);
    let startColor, endColor;
    for (let i = 0; i < skyColorStops.length - 1; i++) {
        if (timeRatio >= skyColorStops[i].time && timeRatio < skyColorStops[i+1].time) {
            startColor = skyColorStops[i];
            endColor = skyColorStops[i+1];
            break;
        }
    }
    const factor = (timeRatio - startColor.time) / (endColor.time - startColor.time);
    const skyTop = lerpColor(startColor.top, endColor.top, factor);
    const skyBottom = lerpColor(startColor.bottom, endColor.bottom, factor);
    skyCtx.clearRect(0, 0, width, height);
    const skyGradient = skyCtx.createLinearGradient(0, 0, 0, height);
    skyGradient.addColorStop(0, skyTop);
    skyGradient.addColorStop(1, skyBottom);
    skyCtx.fillStyle = skyGradient;
    skyCtx.fillRect(0, 0, width, height);
    const dayFactor = Math.sin(timeRatio * Math.PI * 2 - Math.PI / 2) * 0.5 + 0.5;
    const starsOpacity = Math.pow(1 - dayFactor, 3);
    if (starsOpacity > 0.1) {
        skyCtx.fillStyle = `rgba(255, 255, 255, ${starsOpacity * 0.8})`;
        for (let i = 0; i < 150; i++) {
            const x = (Math.sin(i * 1.23) * 0.5 + 0.5) * width;
            const y = (Math.cos(i * 5.67) * 0.5 + 0.5) * height * 0.8;
            const size = (Math.sin(i * 9.12 + Date.now()/2000) * 0.5 + 0.5) * 1.5 + 0.5;
            skyCtx.beginPath();
            skyCtx.arc(x, y, size, 0, Math.PI * 2);
            skyCtx.fill();
        }
    }
    const angle = timeRatio * Math.PI * 2 - Math.PI / 2;
    const celestialX = width / 2 + Math.cos(angle) * width * 0.6;
    const celestialY = height * 1.2 + Math.sin(angle) * height * 1.1;
    const sunOpacity = Math.max(0, dayFactor * 2 - 1);
    if (sunOpacity > 0.1) {
        skyCtx.fillStyle = `rgba(255, 220, 150, ${sunOpacity})`;
        skyCtx.shadowColor = `rgba(255, 200, 100, ${sunOpacity * 0.8})`;
        skyCtx.shadowBlur = 60;
        skyCtx.beginPath();
        skyCtx.arc(celestialX, celestialY, 50, 0, Math.PI * 2);
        skyCtx.fill();
        skyCtx.shadowBlur = 0;
    }
    const moonOpacity = Math.max(0, (1 - dayFactor) * 2 - 1);
    if (moonOpacity > 0.1) {
        skyCtx.fillStyle = `rgba(235, 235, 245, ${moonOpacity})`;
        skyCtx.beginPath();
        skyCtx.arc(celestialX, celestialY, 40, 0, Math.PI * 2);
        skyCtx.fill();
        const haloGradient = skyCtx.createRadialGradient(celestialX, celestialY, 35, celestialX, celestialY, 60);
        haloGradient.addColorStop(0, `rgba(200, 220, 255, ${moonOpacity * 0.4})`);
        haloGradient.addColorStop(1, 'rgba(200, 220, 255, 0)');
        skyCtx.fillStyle = haloGradient;
        skyCtx.beginPath();
        skyCtx.arc(celestialX, celestialY, 60, 0, Math.PI * 2);
        skyCtx.fill();
    }
    landscapeCtx.clearRect(0, 0, width, height);
    const hillColor1 = lerpColor('#0a290a', '#1E5631', dayFactor);
    const hillColor2 = lerpColor('#144514', '#2E8B57', dayFactor);
    landscapeCtx.fillStyle = hillColor1;
    landscapeCtx.beginPath();
    landscapeCtx.moveTo(-width * 0.25, height);
    landscapeCtx.bezierCurveTo(width * 0.25, height * 0.7, width * 0.75, height * 0.7, width * 1.25, height);
    landscapeCtx.fill();
    landscapeCtx.fillStyle = hillColor2;
    landscapeCtx.beginPath();
    landscapeCtx.moveTo(-width * 0.2, height);
    landscapeCtx.bezierCurveTo(width * 0.3, height * 0.8, width * 0.8, height * 0.8, width * 1.2, height);
    landscapeCtx.fill();
    const cloudOpacity = Math.pow(dayFactor, 2) * 0.8;
    if(cloudsContainer) {
        cloudsContainer.querySelectorAll('.cloud').forEach(cloud => {
            cloud.style.opacity = cloudOpacity;
        });
    }
    dynamicWallpaperAnimationId = requestAnimationFrame(() => updateDynamicWallpaper(dynamicWallpaperFixedTime));
}
function setDynamicWallpaperActive(isActive) {
    if (isActive) {
        osContainer.style.backgroundImage = 'none';
        dynamicWallpaperContainer.style.display = 'block';
        const resize = () => {
            skyCanvas.width = landscapeCanvas.width = dynamicWallpaperContainer.clientWidth;
            skyCanvas.height = landscapeCanvas.height = dynamicWallpaperContainer.clientHeight;
        };
        resize();
        window.addEventListener('resize', resize);
        if (cloudsContainer.children.length < 5) {
            for(let i=0; i < 5; i++) {
                setTimeout(createCloud, Math.random() * 20000);
            }
        }
        if (dynamicWallpaperAnimationId) cancelAnimationFrame(dynamicWallpaperAnimationId);
        updateDynamicWallpaper(dynamicWallpaperFixedTime);
    } else {
        dynamicWallpaperContainer.style.display = 'none';
        if (dynamicWallpaperAnimationId) cancelAnimationFrame(dynamicWallpaperAnimationId);
        dynamicWallpaperAnimationId = null;
        osContainer.style.backgroundImage = `url('${currentWallpaper}')`;
    }
}
function createCloud() {
    if (dynamicWallpaperContainer.style.display === 'none') return;
    const cloud = document.createElement('div');
    cloud.className = 'cloud';
    cloud.style.top = `${Math.random() * 40}%`;
    const scale = Math.random() * 0.5 + 0.5;
    cloud.style.transform = `scale(${scale})`;
    cloud.style.animationDuration = `${Math.random() * 50 + 40}s`;
    cloudsContainer.appendChild(cloud);
    cloud.addEventListener('animationend', () => cloud.remove());
}
function applyTaskbarAlignment() {
    const taskbarCenter = document.getElementById('taskbar-center');
    if (!taskbarCenter) return;
    const icons = Array.from(taskbarCenter.querySelectorAll('.taskbar-icon'));
    const firstPositions = new Map();
    icons.forEach(icon => {
        firstPositions.set(icon, icon.getBoundingClientRect());
    });
    taskbarCenter.classList.toggle('center-align', taskbarCenterAlign);
    icons.forEach(icon => {
        const lastPos = icon.getBoundingClientRect();
        const firstPos = firstPositions.get(icon);
        const deltaX = firstPos.left - lastPos.left;
        const deltaY = firstPos.top - lastPos.top;
        if (Math.abs(deltaX) < 1 && Math.abs(deltaY) < 1) {
            return;
        }
        icon.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
        icon.style.transition = 'transform 0s';
        requestAnimationFrame(() => {
            icon.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
            icon.style.transform = ''; 
        });
    });
    setTimeout(() => {
        icons.forEach(icon => {
            icon.style.transition = '';
        });
    }, 400);
    checkTaskbarScroll();
}
const allAppsFullscreen = document.getElementById('all-apps-fullscreen');
const allAppsGridContainer = document.getElementById('all-apps-grid-container');
const allAppsPagination = document.getElementById('all-apps-pagination');
const allAppsScrollHandler = () => {
    if (allAppsGridContainer.clientWidth === 0) return;
    const currentPage = Math.round(allAppsGridContainer.scrollLeft / allAppsGridContainer.clientWidth);
    allAppsPagination.querySelectorAll('.dot').forEach((dot, index) => {
        dot.classList.toggle('active', index === currentPage);
    });
};
const allAppsWheelHandler = (event) => {
    event.preventDefault();
    allAppsGridContainer.scrollLeft += event.deltaY;
};
const onPaginationDotClick = (index) => {
    const targetScrollLeft = index * allAppsGridContainer.clientWidth;
    allAppsGridContainer.scrollTo({
        left: targetScrollLeft,
        behavior: 'smooth'
    });
};
allAppsGridContainer.addEventListener('scroll', allAppsScrollHandler);
allAppsFullscreen.addEventListener('wheel', allAppsWheelHandler, { passive: false });
const taskbarCenter = document.getElementById('taskbar-center');
const hintLeft = document.getElementById('taskbar-scroll-hint-left');
const hintRight = document.getElementById('taskbar-scroll-hint-right');
function checkTaskbarScroll() {
    const taskbarCenter = document.getElementById('taskbar-center');
    if (!taskbarCenter) return;
    const scrollWidth = taskbarCenter.scrollWidth;
    const clientWidth = taskbarCenter.clientWidth;
    const scrollLeft = taskbarCenter.scrollLeft;
    if (taskbarAutoFitIcons) {
        taskbarCenter.style.setProperty('--mask-start-percent', '0%');
        taskbarCenter.style.setProperty('--mask-end-percent', '100%');
        return;
    }
    const isScrollable = scrollWidth > clientWidth + 1;
    if (!isScrollable) {
        taskbarCenter.style.setProperty('--mask-start-percent', '0%');
        taskbarCenter.style.setProperty('--mask-end-percent', '100%');
        return;
    }
    const atStart = scrollLeft < 5;
    const atEnd = scrollLeft + clientWidth > scrollWidth - 5;
    taskbarCenter.style.setProperty('--mask-start-percent', atStart ? '0%' : '5%');
    taskbarCenter.style.setProperty('--mask-end-percent', atEnd ? '100%' : '95%');
}
taskbarCenter.addEventListener('wheel', (event) => {
    event.preventDefault();
    taskbarCenter.scrollLeft += event.deltaY;
}, { passive: false });
taskbarCenter.addEventListener('scroll', checkTaskbarScroll, { passive: true });
window.addEventListener('resize', checkTaskbarScroll);
const observer = new MutationObserver(() => {
    requestAnimationFrame(checkTaskbarScroll);
});
observer.observe(taskbarCenter, { childList: true, subtree: true });
setTimeout(checkTaskbarScroll, 500);
let bootRepairReport = null;
    let faceMatcher = null;
    let isFaceAuthEnabled = JSON.parse(localStorage.getItem('riviftFaceAuthEnabled')) || false;
    let isFaceModelsLoaded = false;
    let faceAuthStream = null;
    let currentVideoTrack = null;
    async function loadFaceAuthModels() {
        if (isFaceModelsLoaded) return true;       
    const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
        try {
            console.log('');
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);
            isFaceModelsLoaded = true;
            console.log('');
            return true;
        } catch (error) {
            console.error('', error);
            createNotification('', '', 'error');
            return false;
        }
    }
    async function showFilePicker(acceptTypes = []) {
    let filesHtml = '<p>...</p>';
    const renderVFSBrowser = async (path) => {
        const items = await VFS.listFiles(path);
        let listHtml = items.map(item => {
            const isAcceptable = acceptTypes.length === 0 || acceptTypes.includes(item.type) || item.type === 'folder';
            if (!isAcceptable) return '';
            return `<li data-path="${item.path}" data-type="${item.type}" class="p-2 rounded cursor-pointer hover:bg-white/10 flex items-center gap-2">
                        <i class="${getIconForType(item.type)}"></i> ${item.name}
                    </li>`;
        }).join('');
        return `<ul class="max-h-64 overflow-y-auto">${listHtml}</ul>`;
    };
    filesHtml = await renderVFSBrowser('/');
    return new Promise(resolve => {
        const dialogId = 'file-picker-dialog';
        const customHtml = `<div id="${dialogId}">${filesHtml}</div>`;
        showMessageBox('', '', { customHtmlContent: customHtml, showCancel: true });
        const dialogEl = document.getElementById(dialogId);
        let selectedFile = null;
        dialogEl.addEventListener('click', async e => {
            const targetLi = e.target.closest('li');
            if (!targetLi) return;
            const path = targetLi.dataset.path;
            const type = targetLi.dataset.type;
            if (type === 'folder') {
                dialogEl.innerHTML = await renderVFSBrowser(path);
            } else {
                dialogEl.querySelectorAll('li').forEach(li => li.style.backgroundColor = '');
                targetLi.style.backgroundColor = 'var(--status-indicator-color-active)';
                selectedFile = path;
            }
        });
        messageBoxOk.onclick = () => { resolve(selectedFile); messageBoxOverlay.classList.remove('active'); };
        messageBoxCancel.onclick = () => { resolve(null); messageBoxOverlay.classList.remove('active'); };
    });
}
const VFS = {
    db: null,
    isInitializing: false, 
    init: function() {
        if (this.isInitializing) {
            console.warn("VFS.init() is already in progress. Ignoring duplicate call.");
            return new Promise(resolve => {
                const checkInterval = setInterval(() => {
                    if (!this.isInitializing) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
            });
        }
        this.isInitializing = true;
        return new Promise((resolve, reject) => {
            (async () => {
                if (navigator.storage && navigator.storage.persist) {
                    try {
                        if (!(await navigator.storage.persisted())) {
                            await navigator.storage.persist();
                        }
                    } catch (error) { console.error(':', error); }
                }
            })();
            const request = indexedDB.open('RiviftFS_v2', 2);
request.onerror = async (event) => {
    console.error("IndexedDB error:", request.error);
    const errorName = request.error.name;
    const corruptionErrors = ['NotReadableError', 'NotFoundError', 'InvalidStateError', 'ConstraintError'];
    if (corruptionErrors.includes(errorName)) {
        const confirmRecovery = await showMessageBox(
            '', 
            `(: ${errorName})\n\n: `,
            { showCancel: true, okText: '' }
        );
        if (confirmRecovery) {
            try {
                if (this.db) { this.db.close(); this.db = null; }
                await new Promise((res, rej) => {
                    const deleteRequest = indexedDB.deleteDatabase('RiviftFS_v2');
                    deleteRequest.onsuccess = () => res();
                    deleteRequest.onerror = (e) => rej(e.target.error);
                    deleteRequest.onblocked = () => rej(new Error("Database is blocked."));
                });
                location.reload();
            } catch (deleteError) {
                await showMessageBox('', ' IndexedDB ');
                this.isInitializing = false;
                reject("");
            }
        } else {
            this.isInitializing = false;
            reject("");
        }
    } else {
        this.isInitializing = false;
        reject("IndexedDB error: " + request.error);
    }
};
request.onsuccess = (event) => {
    this.db = event.target.result;
    this._verifyFileSystemIntegrity().then(() => {
        return this.recoverFromJournal();
    }).then(() => {
        console.log("Journal recovery check complete.");
        return this.setupInitialFolders();
    }).then(() => {
        console.log("Initial folders setup check complete.");
        this.isInitializing = false; 
        resolve();
    }).catch(err => {
        console.error("Initialization process failed during integrity check or recovery:", err);
        this.isInitializing = false; 
        reject(err);
    });
};
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('files')) {
                    const fileStore = db.createObjectStore('files', { keyPath: 'path' });
                    fileStore.createIndex('parent', 'parent', { unique: false });
                }
                if (!db.objectStoreNames.contains('journal')) {
                    db.createObjectStore('journal', { keyPath: 'id', autoIncrement: true });
                }
            };
        });
    },
setupInitialFolders: async function() {
    const requiredFolders = ['/Documents', '/Pictures', '/Music', '/Videos', '/Downloads', '/System', '/System/Calendar'];
    for (const path of requiredFolders) {
        const parentPath = path.substring(0, path.lastIndexOf('/')) || '/';
        const folderName = path.substring(path.lastIndexOf('/') + 1);
        await this.createFolder(parentPath, folderName, false);
    }
    await this.createFolder('/', 'Trash', true);
},
recoverFromJournal: async function() {
    if (!this.db) return;
    const recoveryScreenHTML = `
        <div id="recovery-screen-dynamic" class="fixed inset-0 bg-black flex flex-col items-center justify-center z-[9999]">
            <div class="text-center text-white w-full max-w-lg">
                <i class="fas fa-cogs text-5xl mb-6"></i> 
                <h2 class="text-3xl font-light mb-4">...</h2>
                <p class="text-gray-400 mb-6"><br></p>
                <div class="w-full max-w-md mx-auto bg-gray-700 rounded-full h-2.5">
                    <div id="recovery-progress-bar-dynamic" class="bg-blue-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p id="recovery-status-text-dynamic" class="mt-4 text-sm text-gray-500 font-mono h-5"></p>
            </div>
        </div>
    `;
    try {
        const transaction = this.db.transaction(['journal'], 'readonly');
        const journalStore = transaction.objectStore('journal');
        const logsToProcess = await new Promise((res, rej) => {
            const req = journalStore.getAll();
            req.onsuccess = () => res(req.result);
            req.onerror = (e) => rej(e.target.error);
        });
        if (logsToProcess.length === 0) return;
        document.body.insertAdjacentHTML('beforeend', recoveryScreenHTML);
        const recoveryScreen = document.getElementById('recovery-screen-dynamic');
        const progressBar = document.getElementById('recovery-progress-bar-dynamic');
        const statusText = document.getElementById('recovery-status-text-dynamic');
        console.warn(`${logsToProcess.length}...`, logsToProcess);
        for (let i = 0; i < logsToProcess.length; i++) {
            const log = logsToProcess[i];
            const progress = ((i + 1) / logsToProcess.length) * 100;
            progressBar.style.width = `${progress}%`;
            statusText.textContent = `: ${log.path || `Log ID ${log.id}`}`;
            try {
                await new Promise((resolve, reject) => {
                    const recoveryTransaction = this.db.transaction(['files', 'journal'], 'readwrite');
                    recoveryTransaction.oncomplete = () => resolve();
                    recoveryTransaction.onerror = (e) => reject(e.target.error);
                    const fileStore = recoveryTransaction.objectStore('files');
                    const journalStoreToDelete = recoveryTransaction.objectStore('journal');
                    if (log.operation === 'writeFile') {
                        fileStore.put(log.data);
                    }
                    journalStoreToDelete.delete(log.id);
                });
                console.log(` (id: ${log.id}) `);
            } catch (recoveryError) {
                console.error(` (id: ${log.id}) :`, recoveryError);
                statusText.textContent = `: ${log.path || `Log ID ${log.id}`} `;
            }
        }
        statusText.textContent = 'OS...';
        await new Promise(resolve => setTimeout(resolve, 1500));
        recoveryScreen.remove();
    } catch (readError) {
        console.error(":", readError);
    }
},
listFiles: function(parentPath) {
    return new Promise((resolve, reject) => {
        if (!this.db) {
            console.warn("listFiles called before DB was ready. Retrying in 100ms.");
            setTimeout(() => this.listFiles(parentPath).then(resolve).catch(reject), 100);
            return;
        }
        const transaction = this.db.transaction(['files'], 'readonly');
        const store = transaction.objectStore('files');
        const index = store.index('parent');
        const request = index.getAll(parentPath);
        request.onsuccess = () => {
            const rawResult = request.result || [];
            const validItems = rawResult.filter(item => item && item.name);
            const sortedItems = validItems.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
            resolve(sortedItems);
        };
        request.onerror = (e) => reject(`Failed to list files: ${e.target.error}`);
    });
},
readFile: function(path) {
    if (path.startsWith('/Apps/')) {
        const appId = path.split('/')[2];
        const app = apps.find(a => a.id === appId);
        return Promise.resolve(app ? { ...app, path: path, type: 'application/rivift-app', name: app.name, id: app.id, icon: app.icon } : null);
    }
    return new Promise((resolve, reject) => {
        if (!this.db) return reject("Database not initialized.");
        const transaction = this.db.transaction(['files'], 'readonly');
        const store = transaction.objectStore('files');
        const request = store.get(path);
        request.onsuccess = () => resolve(request.result);
        request.onerror = (e) => reject(`Failed to read file: ${e.target.error}`);
    });
},
    search: function(query) {
        return new Promise((resolve, reject) => {
            if (!this.db) return reject("Database not initialized.");
            const transaction = this.db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const request = store.getAll();
            request.onsuccess = () => {
                const filesOnly = request.result.filter(item => item.type !== 'folder');
                resolve(filesOnly);
            };
            request.onerror = (e) => reject(`Failed to search files: ${e.target.error}`);
        });
    },
put: function(data) {
    return new Promise((resolve, reject) => {
        if (!this.db) return reject("Database not initialized.");
        const transaction = this.db.transaction(['files'], 'readwrite');
        transaction.oncomplete = () => resolve();
        transaction.onerror = (e) => reject(`Transaction failed: ${e.target.error}`);
        const store = transaction.objectStore('files');
        store.put(data);
    });
},
createFolder: async function(parentPath, folderName, isSpecial = false) {
    const path = (parentPath === '/' ? '' : parentPath) + '/' + folderName;
    const existingItem = await this.readFile(path).catch(() => null);
    if (existingItem) {
        if (existingItem.special !== isSpecial) {
            existingItem.special = isSpecial;
            return this.put(existingItem);
        }
        return; 
    }
    const newFolder = {
        path: path,
        name: folderName,
        type: 'folder',
        parent: parentPath,
        ctime: Date.now(),
        mtime: Date.now(),
        special: isSpecial
    };
    return this.put(newFolder);
},
writeFile: async function(parentPath, fileName, type, content) {
    const path = (parentPath === '/' ? '' : parentPath) + '/' + fileName;
    const fileData = {
        path: path,
        name: fileName,
        type: type,
        content: content,
        parent: parentPath,
        ctime: Date.now(),
        mtime: Date.now()
    };
    const journalEntry = {
        operation: 'writeFile',
        path: path,
        data: fileData, 
        timestamp: Date.now()
    };
    const journalId = await this.addJournal(journalEntry);
    try {
        await this.put(journalEntry.data); 
        await this.removeJournal(journalId);
    } catch (error) {
        console.error(`writeFile failed for ${path}, journal log (id: ${journalId}) is kept for recovery.`, error);
        throw error;
    }
},
    addJournal: function(entry) {
        return new Promise((resolve, reject) => {
            if (!this.db) return reject("Database not initialized.");
            const transaction = this.db.transaction(['journal'], 'readwrite');
            transaction.onerror = (e) => reject(`addJournal failed: ${e.target.error}`);
            const store = transaction.objectStore('journal');
            const request = store.add(entry);
            request.onsuccess = () => resolve(request.result);
        });
    },
    removeJournal: function(journalId) {
        return new Promise((resolve, reject) => {
            if (!this.db) return reject("Database not initialized.");
            const transaction = this.db.transaction(['journal'], 'readwrite');
            transaction.oncomplete = () => resolve();
            transaction.onerror = (e) => reject(`removeJournal failed: ${e.target.error}`);
            const store = transaction.objectStore('journal');
            store.delete(journalId);
        });
    },
    _physicalDelete: function(path) {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['files'], 'readwrite');
            const store = transaction.objectStore('files');
            const request = store.delete(path);
            request.onsuccess = resolve;
            request.onerror = (e) => reject(`Failed to delete: ${e.target.error}`);
        });
    },
delete: async function(path, permanent = false) {
    const item = await this.readFile(path);
    if (!item) throw new Error(`Item not found: ${path}`);
    const isActuallyInTrash = item.parent === '/Trash';
    if (permanent || isActuallyInTrash) {
        await this._physicalDelete(path);
        if (item.type === 'folder') {
            const children = await this.listFiles(path);
            for (const child of children) {
                await this.delete(child.path, true);
            }
        }
    } else {
        const trashPath = `/Trash/${item.name}_${Date.now()}`;
        const movedItem = { ...item, originalPath: item.path, deletedAt: Date.now(), path: trashPath, parent: '/Trash' };
        await this._physicalDelete(path);
        await this.put(movedItem);
    }
},
restore: async function(path) {
    const item = await this.readFile(path);
    if (!item || !item.originalPath) throw new Error('');
    if (await this.readFile(item.originalPath)) {
        throw new Error('');
    }
    const restoredItem = { ...item };
    delete restoredItem.originalPath;
    delete restoredItem.deletedAt;
    restoredItem.path = item.originalPath;
    restoredItem.parent = item.originalPath.substring(0, item.originalPath.lastIndexOf('/')) || '/';
    await this._physicalDelete(path);
    await this.put(restoredItem);
},
    rename: async function(oldPath, newName) {
        const item = await this.readFile(oldPath);
        if (!item) throw new Error(`Item not found: ${oldPath}`);
        const parentPath = item.parent;
        const newPath = (parentPath === '/' ? '' : parentPath) + '/' + newName;
        if (await this.readFile(newPath)) {
            throw new Error(`An item named "${newName}" already exists.`);
        }
        const newItem = { ...item, path: newPath, name: newName, mtime: Date.now() };
        await this._physicalDelete(oldPath);
        return this.put(newItem);
    },
    move: async function(sourcePath, destFolderPath) {
        const item = await this.readFile(sourcePath);
        if (!item) throw new Error(`Item not found: ${sourcePath}`);
        const destFolder = await this.readFile(destFolderPath);
        if (!destFolder || destFolder.type !== 'folder') {
             throw new Error("Invalid destination folder.");
        }
        const newPath = (destFolderPath === '/' ? '' : destFolderPath) + '/' + item.name;
        if (await this.readFile(newPath)) {
            throw new Error(`An item named "${item.name}" already exists in the destination.`);
        }
        const newItem = { ...item, path: newPath, parent: destFolderPath, mtime: Date.now() };
        await this._physicalDelete(sourcePath);
        return this.put(newItem);
    },
_verifyFileSystemIntegrity: function() {
    return new Promise((resolve, reject) => {
        if (!this.db) return reject("Database not initialized.");
        console.log('[VFS Integrity Check] ...');
        const transaction = this.db.transaction(['files'], 'readwrite');
        const store = transaction.objectStore('files');
        const request = store.getAll();
        request.onerror = (e) => reject(`Integrity check failed: ${e.target.error}`);
        request.onsuccess = () => {
            const allItems = request.result;
            let repairedCount = 0;
            let rescuedCount = 0;
            const now = Date.now();
            const rescueFolderPath = '/System/Recovered Files';
            const rescueFolderName = 'Recovered Files';
            store.get('/System').onsuccess = (e) => {
                if (!e.target.result) {
                    store.add({ path: '/System', name: 'System', type: 'folder', parent: '/', ctime: now, mtime: now });
                }
                store.get(rescueFolderPath).onsuccess = (e2) => {
                    if (!e2.target.result) {
                        store.add({ path: rescueFolderPath, name: rescueFolderName, type: 'folder', parent: '/System', ctime: now, mtime: now });
                    }
                };
            };
            allItems.forEach(item => {
                let needsRepair = false;
                if (!item || !item.path) {
                    rescuedCount++;
                    console.error('[VFS Rescue] path:', item);
                    if(item && (item.path || item.id)) store.delete(item.path || item.id);
                    const rescuedPath = `${rescueFolderPath}/rescued_file_${now}_${rescuedCount}`;
                    const rescuedItem = {
                        path: rescuedPath,
                        name: `${rescuedCount}`,
                        parent: rescueFolderPath,
                        type: 'unknown/corrupted',
                        ctime: now,
                        mtime: now,
                        content: item?.content || null,
                        originalData: JSON.stringify(item)
                    };
                    store.add(rescuedItem);
                    return;
                }
                if (!item.name) {
                    item.name = item.path.split('/').pop();
                    needsRepair = true;
                }
                if (item.parent === undefined) {
                    item.parent = item.path.substring(0, item.path.lastIndexOf('/')) || '/';
                    needsRepair = true;
                }
                if (item.type === undefined) {
                    if (item.name.includes('.')) {
                        const ext = item.name.split('.').pop().toLowerCase();
                        if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) item.type = 'image/jpeg';
                        else if (['txt', 'md'].includes(ext)) item.type = 'text/plain';
                        else item.type = 'application/octet-stream'; 
                    } else if (item.content === undefined) { 
                        item.type = 'folder';
                    } else {
                        item.type = 'unknown';
                    }
                    needsRepair = true;
                }
                if (item.ctime === undefined) {
                    item.ctime = now;
                    needsRepair = true;
                }
                if (item.mtime === undefined) {
                    item.mtime = now;
                    needsRepair = true;
                }
                if (needsRepair) {
                    repairedCount++;
                    store.put(item);
                }
            });
            transaction.oncomplete = () => {
                if (repairedCount > 0) console.log(`%c[VFS Repair] ${repairedCount}`, 'color: #27c93f;');
                if (rescuedCount > 0) console.log(`%c[VFS Rescue] ${rescuedCount}`, 'color: #ffbd2e;');
                if (repairedCount > 0 || rescuedCount > 0) {
                    bootRepairReport = {
                        repaired: repairedCount,
                        rescued: rescuedCount
                    };
                }
                resolve();
            };
        };
    });
},
};
async function gatherAllOSData() {
    console.log("OS...");
    const allFiles = await VFS.search('');
    console.log(`${allFiles.length}VFS`);
    const settings = {};
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('rivift')) {
            settings[key] = localStorage.getItem(key);
        }
    }
    console.log(`${Object.keys(settings).length}`);
    const backupData = {
        version: '1.0',
        timestamp: new Date().toISOString(),
        vfsFiles: allFiles,
        settings: settings
    };
    console.log("OS");
    return backupData;
}
async function setupFaceAuth(setupButton) {
    setupButton.disabled = true;
    setupButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
    const modelsLoaded = await loadFaceAuthModels();
    if (!modelsLoaded) {
        setupButton.disabled = false;
        setupButton.innerHTML = '<i class="fas fa-camera"></i> ';
        return;
    }
    let videoTrack;
    try {
        faceAuthStream = await navigator.mediaDevices.getUserMedia({ video: true });
        videoTrack = faceAuthStream.getVideoTracks()[0];
        currentVideoTrack = videoTrack;
    } catch (err) {
        createNotification('', '', 'error');
        setupButton.disabled = false;
        setupButton.innerHTML = '<i class="fas fa-camera"></i> ';
        return;
    }
    const modalContent = `
        <div class="text-center">
            <p></p>
            <div class="relative w-64 h-48 mx-auto my-4 bg-black">
                <video id="face-auth-video" autoplay muted playsinline class="w-full h-full"></video>
                <canvas id="face-auth-overlay" class="absolute top-0 left-0 w-full h-full"></canvas>
            </div>
            <p id="face-auth-message" class="h-5">...</p>
        </div>
    `;
    showMessageBox('', '', { customHtmlContent: modalContent, showCancel: false });
    const video = document.getElementById('face-auth-video');
    const canvas = document.getElementById('face-auth-overlay');
    video.srcObject = faceAuthStream;
    let detectionInterval;
    const startDetectionLoop = () => {
        if (!video || video.readyState < 2 || video.videoWidth === 0 || !document.body.contains(video)) {
            setTimeout(startDetectionLoop, 100);
            return;
        }
        detectionInterval = setInterval(async () => {
            const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
            const messageEl = document.getElementById('face-auth-message');
            if (!messageEl) { clearInterval(detectionInterval); return; }
            faceapi.matchDimensions(canvas, video);
            if (detections) {
    if (video.videoWidth === 0 || video.videoHeight === 0) {
        console.error("0");
        messageEl.textContent = '';
        messageEl.style.color = '#ff5f56';
        clearInterval(detectionInterval);
        setTimeout(() => {
            messageBoxOverlay.classList.remove('active');
            createNotification('', '', 'error');
            stopFaceAuthCamera();
        }, 1000);
        return;
    }
                messageEl.textContent = '...';
                messageEl.style.color = '#27c93f';
    const displaySize = { width: video.videoWidth, height: video.videoHeight };
    if (displaySize.width === 0 || displaySize.height === 0) {
        console.error("0");
        return; 
    }
    const resizedDetections = faceapi.resizeResults(detections, displaySize);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                faceapi.draw.drawDetections(canvas, resizedDetections);
                clearInterval(detectionInterval);
                const descriptor = Array.from(detections.descriptor);
                localStorage.setItem('riviftFaceDescriptor', JSON.stringify(descriptor));
                isFaceAuthEnabled = true;
                localStorage.setItem('riviftFaceAuthEnabled', 'true');
                document.getElementById('face-auth-status').textContent = '';
                document.getElementById('setup-face-auth-btn').innerHTML = '<i class="fas fa-camera"></i> ';
                setTimeout(() => {
                    messageBoxOverlay.classList.remove('active');
                    createNotification('', '', 'info');
                    stopFaceAuthCamera();
                }, 1500);
            } else {
                messageEl.textContent = '...';
                messageEl.style.color = '#ff5f56';
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                await adjustCameraForBrightness();
            }
        }, 1000);
    };
    startDetectionLoop();
    const observer = new MutationObserver((mutations) => {
        for (const mutation of mutations) {
            if (mutation.attributeName === 'class' && !messageBoxOverlay.classList.contains('active')) {
                clearInterval(detectionInterval);
                stopFaceAuthCamera();
                observer.disconnect();
                break;
            }
        }
    });
    observer.observe(messageBoxOverlay, { attributes: true });
    setupButton.disabled = false;
    setupButton.innerHTML = '<i class="fas fa-camera"></i> ';
}
async function startFaceAuthOnLockScreen() {
    const faceAuthArea = document.getElementById('face-auth-lock-area');
    const passwordArea = document.getElementById('lock-screen-password-area');
    const statusEl = document.getElementById('face-auth-lock-status');
    const video = document.getElementById('face-auth-lock-video');
    const iconContainer = document.getElementById('face-auth-icon-container');
    const showLoginOptionsBtn = document.getElementById('show-login-options-btn');
    const showPasswordInput = () => {
        faceAuthArea.classList.add('hidden');
        passwordArea.classList.remove('hidden');
        renderLockScreenPasswordInput();
        setTimeout(() => passwordArea.querySelector('input')?.focus(), 100);
    };
    showLoginOptionsBtn.onclick = () => {
        if (detectionInterval) clearInterval(detectionInterval);
        stopFaceAuthCamera();
        showPasswordInput();
    };
    if (!isFaceAuthEnabled || !passwordLoginEnabled) {
        showPasswordInput();
        return;
    }
    faceAuthArea.classList.remove('hidden');
    passwordArea.classList.add('hidden');
    statusEl.textContent = '...';
    const modelsLoaded = await loadFaceAuthModels();
    if (!modelsLoaded) {
        statusEl.textContent = '';
        return;
    }
    const savedDescriptor = JSON.parse(localStorage.getItem('riviftFaceDescriptor'));
    if (!savedDescriptor) {
        statusEl.textContent = '';
        iconContainer.innerHTML = '<i class="fas fa-exclamation-circle text-red-500"></i>';
        return;
    }
    const labeledDescriptor = new faceapi.LabeledFaceDescriptors('user', [Float32Array.from(savedDescriptor)]);
    faceMatcher = new faceapi.FaceMatcher(labeledDescriptor, 0.5);
    let videoTrack;
    try {
        faceAuthStream = await navigator.mediaDevices.getUserMedia({ video: true });
        videoTrack = faceAuthStream.getVideoTracks()[0]; 
        currentVideoTrack = videoTrack;
        video.srcObject = faceAuthStream;
        statusEl.textContent = '...';
    } catch (err) {
        statusEl.textContent = '';
        return;
    }
    let brightnessCheckCanvas;
    async function adjustCameraForBrightness() {
        if (!videoTrack || video.readyState < 2 || video.videoWidth === 0) return;
        const capabilities = videoTrack.getCapabilities ? videoTrack.getCapabilities() : null;
        if (!capabilities || !capabilities.exposureCompensation) return;
        if (!brightnessCheckCanvas) { brightnessCheckCanvas = document.createElement('canvas'); }
        const tempCtx = brightnessCheckCanvas.getContext('2d', { willReadFrequently: true });
        brightnessCheckCanvas.width = video.videoWidth; brightnessCheckCanvas.height = video.videoHeight;
        tempCtx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
        const imageData = tempCtx.getImageData(0, 0, 10, 10);
        const data = imageData.data; let totalBrightness = 0;
        for (let i = 0; i < data.length; i += 4) { totalBrightness += (data[i] + data[i+1] + data[i+2]) / 3; }
        const avgBrightness = totalBrightness / (10 * 10);
        try {
            if (avgBrightness < 70) {
                await videoTrack.applyConstraints({ advanced: [{ exposureCompensation: capabilities.exposureCompensation.max }] });
                console.log("");
            }
        } catch (err) {}
    }
    let detectionInterval;
    const startDetectionLoop = () => {
        if (!video || video.readyState < 2 || video.videoWidth === 0 || !document.body.contains(video)) {
            setTimeout(startDetectionLoop, 100);
            return;
        }
        detectionInterval = setInterval(async () => {
            if (!isLocked) { clearInterval(detectionInterval); stopFaceAuthCamera(); return; }
            statusEl.textContent = '...';
            const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
            if (detections) {
                const bestMatch = faceMatcher.findBestMatch(detections.descriptor);
                if (bestMatch.label === 'user') {
                    statusEl.textContent = '';
                    statusEl.style.color = '#27c93f';
                    clearInterval(detectionInterval);
                    stopFaceAuthCamera();
                    setTimeout(() => unlockOS(true), 200);
                } else {
                    statusEl.textContent = '';
                }
            } else {
                statusEl.textContent = '...';
                await adjustCameraForBrightness();
            }
        }, 2000);
    };
    video.addEventListener('play', startDetectionLoop, { once: true });
    const observer = new MutationObserver(() => {
        if (!lockScreen.classList.contains('visible')) {
            clearInterval(detectionInterval);
            stopFaceAuthCamera();
            observer.disconnect();
        }
    });
    observer.observe(lockScreen, { attributes: true, attributeFilter: ['class'] });
}
async function stopFaceAuthCamera() {
    if (currentVideoTrack && typeof currentVideoTrack.applyConstraints === 'function') {
        try {
            const capabilities = currentVideoTrack.getCapabilities ? currentVideoTrack.getCapabilities() : null;
            if (capabilities && capabilities.exposureCompensation && capabilities.exposureCompensation.min <= 0 && capabilities.exposureCompensation.max >= 0) {
                await currentVideoTrack.applyConstraints({
                    advanced: [{ exposureCompensation: 0 }]
                });
                console.log("");
            }
        } catch (error) {
            console.error(":", error);
        }
    }
    if (faceAuthStream) {
        faceAuthStream.getTracks().forEach(track => track.stop());
        faceAuthStream = null;
        currentVideoTrack = null; 
    }
}
function showFilePicker(options = {}) {
    const { 
        mode = 'open', 
        title = '', 
        actionButtonText = null, 
        acceptTypes = [], 
        defaultName = '', 
        multiple = false,
        selectFolders = false 
    } = options;
    const overlay = document.getElementById('file-picker-overlay');
    const dialog = document.getElementById('file-picker-dialog');
    const titleEl = document.getElementById('file-picker-title');
    const pathEl = document.getElementById('file-picker-path');
    const sidebar = document.getElementById('file-picker-sidebar');
    const gridEl = document.getElementById('file-picker-grid');
    const filenameInput = document.getElementById('file-picker-filename');
    const actionBtn = document.getElementById('file-picker-action-btn');
    const cancelBtn = document.getElementById('file-picker-cancel-btn');
    return new Promise(resolve => {
        let currentPath = '/';
        let selectedItems = new Set();
        const cleanupAndClose = (value) => {
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
            cancelBtn.onclick = null;
            actionBtn.onclick = null;
            filenameInput.oninput = null;
            sidebar.onclick = null;
            gridEl.onclick = null;
            gridEl.ondblclick = null;
            resolve(value);
        };
        titleEl.textContent = title;
        actionBtn.textContent = actionButtonText || (mode === 'open' ? '' : '');
        filenameInput.value = defaultName;
        filenameInput.parentElement.style.display = selectFolders ? 'none' : 'flex';
        actionBtn.disabled = (mode === 'open' && !multiple) || (mode === 'save' && defaultName === '') || (selectFolders && currentPath === null);
        const render = async (path) => {
            currentPath = path;
            pathEl.textContent = path;
            gridEl.innerHTML = '<p class="col-span-full text-center text-gray-400">...</p>';
            selectedItems.clear();
            if (mode === 'open' || selectFolders) actionBtn.disabled = true;
            sidebar.querySelectorAll('li').forEach(li => {
                li.style.backgroundColor = li.dataset.path === path ? 'rgba(255,255,255,0.1)' : '';
                if(document.body.classList.contains('light-mode')) {
                    li.style.backgroundColor = li.dataset.path === path ? 'rgba(0,0,0,0.1)' : '';
                }
            });
            try {
                const items = await VFS.listFiles(path);
                gridEl.innerHTML = '';
                if (path !== '/') {
                    const parentPath = path.substring(0, path.lastIndexOf('/')) || '/';
                    const upDiv = document.createElement('div');
                    upDiv.className = "text-center p-2 rounded-lg hover:bg-white/10 cursor-pointer flex flex-col items-center justify-center h-28";
                    upDiv.innerHTML = `<i class="fas fa-arrow-up text-5xl mb-2 text-gray-400"></i><p class="text-sm">...</p>`;
                    upDiv.dataset.path = parentPath;
                    upDiv.dataset.type = 'folder';
                    gridEl.appendChild(upDiv);
                }
                if (items.length === 0 && path === '/') {
                     gridEl.innerHTML = '<p class="col-span-full text-center text-gray-400"></p>';
                }
                items.forEach(item => {
                    const isFolder = item.type === 'folder';
                    if (selectFolders && !isFolder) return;
                    const isAcceptable = acceptTypes.length === 0 || isFolder || acceptTypes.some(type => item.type && item.type.startsWith(type.replace('*', '')));
                    if (mode === 'open' && !isAcceptable) return;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = "text-center p-2 rounded-lg hover:bg-white/10 cursor-pointer flex flex-col items-center justify-between h-28";
                    itemDiv.title = item.name;
                    itemDiv.dataset.path = item.path;
                    itemDiv.dataset.type = item.type;
                    const iconContainer = document.createElement('div');
                    iconContainer.className = "w-full h-16 flex items-center justify-center mb-1";
                    if (item.type.startsWith('image/') && item.content) {
                        iconContainer.innerHTML = `<img src="${item.content}" class="max-w-full max-h-full object-contain">`;
                    } else {
                        iconContainer.innerHTML = `<i class="${getIconForType(item.type)} text-5xl"></i>`;
                    }
                    const p = document.createElement('p');
                    p.className = "text-sm break-all w-full truncate";
                    p.textContent = item.name;
                    itemDiv.appendChild(iconContainer);
                    itemDiv.appendChild(p);
                    gridEl.appendChild(itemDiv);
                });
            } catch (err) {
                gridEl.innerHTML = `<p class="col-span-full text-center text-red-500"></p>`;
                console.error("File picker render error:", err);
            }
        };
        cancelBtn.onclick = () => cleanupAndClose(null);
        actionBtn.onclick = () => {
            if (selectFolders) {
                cleanupAndClose(currentPath);
            } else if (mode === 'open') {
                cleanupAndClose(multiple ? Array.from(selectedItems) : (selectedItems.values().next().value || null));
            } else {
                const finalName = filenameInput.value.trim();
                if (finalName) {
                    const finalPath = (currentPath === '/' ? '' : currentPath) + '/' + finalName;
                    cleanupAndClose({ path: finalPath, name: finalName });
                }
            }
        };
        filenameInput.oninput = () => {
            if (mode === 'save') {
                actionBtn.disabled = filenameInput.value.trim() === '';
            }
        };
        sidebar.onclick = (e) => {
            const li = e.target.closest('li[data-path]');
            if (li) {
                render(li.dataset.path);
            }
        };
        const handleItemClick = (itemDiv) => {
            const itemPath = itemDiv.dataset.path;
            const itemType = itemDiv.dataset.type;
            if (itemType !== 'folder' && !selectFolders) {
                if (multiple) {
                    if (selectedItems.has(itemPath)) {
                        selectedItems.delete(itemPath);
                        itemDiv.style.backgroundColor = '';
                    } else {
                        selectedItems.add(itemPath);
                        itemDiv.style.backgroundColor = 'rgba(59, 130, 246, 0.5)';
                    }
                } else {
                    gridEl.querySelectorAll('[data-path]').forEach(el => el.style.backgroundColor = '');
                    itemDiv.style.backgroundColor = 'rgba(59, 130, 246, 0.5)';
                    selectedItems = new Set([itemPath]);
                }
                filenameInput.value = selectedItems.size > 1 
                    ? `${selectedItems.size}` 
                    : (selectedItems.values().next().value || '').split('/').pop();
                if(mode === 'open') actionBtn.disabled = selectedItems.size === 0;
            }
        };
        const handleItemDblClick = (itemDiv) => {
            const itemPath = itemDiv.dataset.path;
            const itemType = itemDiv.dataset.type;
            if (itemType === 'folder') {
                render(itemPath);
            } else if (mode === 'open' && !selectFolders) {
                const result = multiple ? [itemPath] : itemPath;
                cleanupAndClose(result);
            }
        };
        let clickTimer = null;
        gridEl.onclick = (e) => {
            const itemDiv = e.target.closest('[data-path]');
            if(itemDiv) {
                if(clickTimer) {
                    clearTimeout(clickTimer);
                    clickTimer = null;
                    handleItemDblClick(itemDiv);
                } else {
                    clickTimer = setTimeout(() => {
                        handleItemClick(itemDiv);
                        clickTimer = null;
                    }, 250);
                }
            }
        };
        overlay.classList.remove('hidden');
        overlay.classList.add('flex');
        render('/');
    });
}
VFS.init().then(() => {
    console.log('Virtual File System initialized.');
}).catch(err => console.error(err));
        const osContainer = document.getElementById('rivift-os-container');
        osContainer.style.opacity = '0';
        const SERVER_URL = "https://rivift-connect-server-v2.onrender.com";
        const getIconForType = (type) => {
        if (type === 'folder') return 'fas fa-folder text-yellow-500';
        if (type.startsWith('image/')) return 'fas fa-file-image text-purple-500';
        if (type.startsWith('audio/')) return 'fas fa-file-audio text-pink-500';
        if (type.startsWith('video/')) return 'fas fa-file-video text-orange-500';
        if (type === 'text/plain') return 'fas fa-file-alt text-gray-400';
        return 'fas fa-file text-gray-400';
        };
        const desktop = document.getElementById('desktop');
        const taskbar = document.getElementById('taskbar');
        const currentTimeDisplay = document.getElementById('current-time');
        const dateDisplay = document.getElementById('date-display');
        const quickSettingsPanel = document.getElementById('quick-settings');
        if (quickSettingsPanel) {
            quickSettingsPanel.addEventListener('click', (e) => {
                if (e.target.closest('#qs-night-mode-toggle')) {
                    toggleNightMode();
                }
            });
        }
        const startMenuPanel = document.getElementById('start-menu');
        const menuButton = document.getElementById('menu-button');
        const allAppsButton = document.getElementById('all-apps-button');
        const allAppsGrid = document.getElementById('all-apps-grid');
        const allAppsSearchBar = document.getElementById('all-apps-search-bar');
        const exitAllAppsButton = document.getElementById('exit-all-apps');
        const selectPinAppsButton = document.getElementById('select-pin-apps-button');
        const messageBoxOverlay = document.getElementById('message-box-overlay');
        const messageBoxTitle = document.getElementById('message-box-title');
        const messageBoxContent = document.getElementById('message-box-content');
        const messageBoxCustomContent = document.getElementById('message-box-custom-content');
        let messageBoxOk = document.getElementById('message-box-ok');
        let messageBoxCancel = document.getElementById('message-box-cancel');
        const lockScreen = document.getElementById('lock-screen');
        const lockScreenTimeDisplay = document.getElementById('lock-screen-time');
        const lockScreenDateDisplay = document.getElementById('lock-screen-date');
        const lockScreenMessage = document.getElementById('lock-screen-message');
        const lockScreenPasswordArea = document.getElementById('lock-screen-password-area');
        const lockScreenError = document.getElementById('lock-screen-error');
        const desktopNotificationsContainer = document.getElementById('desktop-notifications-container');
        const recentAppsFilesList = document.getElementById('recent-apps-files-list');
        const noRecentItemsMessage = document.getElementById('no-recent-items');
        const notificationCenterPanel = document.getElementById('notification-center-panel');
const notificationIconContainer = document.getElementById('notification-icon-container');
const notificationCenterList = document.getElementById('notification-center-list');
const noNotificationsMessage = document.getElementById('no-notifications-message');
const clearAllBtn = document.getElementById('clear-all-notifications-btn');
const qsThemeToggle = document.getElementById('qs-theme-toggle');
const qsAeroToggleContainer = document.getElementById('qs-aero-toggle-container');
const qsAeroToggle = document.getElementById('qs-aero-toggle');
const qsAeroSubmenuBtn = document.getElementById('qs-aero-submenu-btn');
const qsAeroSubmenu = document.getElementById('qs-aero-submenu');
const qsVolumeTrack = document.getElementById('qs-volume-slider-track');
const qsVolumeFill = document.getElementById('qs-volume-fill');
const qsVolumeIcon = document.getElementById('qs-volume-icon');
const qsBrightnessTrack = document.getElementById('qs-brightness-slider-track');
const qsBrightnessFill = document.getElementById('qs-brightness-fill');
const qsMusicPlayPause = document.getElementById('qs-music-play-pause');
const qsMusicNext = document.getElementById('qs-music-next');
const qsMusicPrev = document.getElementById('qs-music-prev');
const qsMusicShuffle = document.getElementById('qs-music-shuffle');
const qsMusicRepeat = document.getElementById('qs-music-repeat');
const qsMusicProgressSlider = document.getElementById('qs-music-progress-slider');
qsThemeToggle.addEventListener('click', () => {
    isDarkMode = !isDarkMode;
    saveIsDarkMode();
    applyTheme();
});
function updateQsThemeToggle() {
    qsThemeToggle.classList.toggle('active', !isDarkMode);
    document.getElementById('qs-theme-text').textContent = isDarkMode ? '' : '';
    const icon = document.getElementById('qs-theme-icon');
    if (icon) icon.style.transform = isDarkMode ? 'rotate(180deg)' : 'rotate(0deg)';
}
qsAeroToggle.addEventListener('click', () => {
    if (!qsAeroSubmenu.classList.contains('hidden')) return;
    aeroEffectEnabled = !aeroEffectEnabled;
    saveAeroEffectEnabled();
    applyVisualEffects();
    updateQsAeroToggle();
});
qsAeroSubmenuBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    const isHidden = qsAeroSubmenu.classList.toggle('hidden');
    qsAeroSubmenu.classList.toggle('flex', !isHidden);
    qsAeroSubmenuBtn.querySelector('i').classList.toggle('rotate-180');
});
qsAeroSubmenu.addEventListener('click', (e) => {
    const option = e.target.closest('.qs-aero-option');
    if (option) {
        aeroMode = option.dataset.mode;
        saveAeroMode();
        applyVisualEffects();
        updateQsAeroToggle();
        setTimeout(() => qsAeroSubmenuBtn.click(), 100);
    }
});
function updateQsAeroToggle() {
    qsAeroToggleContainer.classList.toggle('active', aeroEffectEnabled);
    qsAeroSubmenu.querySelectorAll('.qs-aero-option i').forEach(icon => icon.style.opacity = '0');
    const activeOption = qsAeroSubmenu.querySelector(`.qs-aero-option[data-mode="${aeroMode}"] i`);
    if (activeOption) activeOption.style.opacity = '1';
}
function setupVerticalSlider(trackElement, fillElement, onUpdate, onIconUpdate) {
    let isDragging = false;
    let value = 0;
    const updateSliderFromEvent = (e) => {
        const rect = trackElement.getBoundingClientRect();
        const y = e.clientY - rect.top;
        const percentage = 1 - (y / rect.height);
        value = Math.max(0, Math.min(100, percentage * 100));
        fillElement.style.height = `${value}%`;
        onUpdate(value);
        if (onIconUpdate) onIconUpdate(value);
    };
    trackElement.addEventListener('mousedown', (e) => { isDragging = true; trackElement.classList.add('dragging'); document.body.classList.add('slider-dragging');updateSliderFromEvent(e); });
    document.addEventListener('mousemove', (e) => { if (isDragging) updateSliderFromEvent(e); });
    document.addEventListener('mouseup', () => { if (isDragging) { isDragging = false; trackElement.classList.remove('dragging');document.body.classList.remove('slider-dragging'); } });
    trackElement.setValue = (initialValue) => { value = Math.max(0, Math.min(100, initialValue)); fillElement.style.height = `${value}%`; if (onIconUpdate) onIconUpdate(value); };
    return trackElement;
}
const volumeSliderController = setupVerticalSlider(qsVolumeTrack, qsVolumeFill,
    (value) => {
        systemVolume = value;
        saveSystemVolume();
        openApps.forEach((appData) => { if (appData.audio) appData.audio.volume = value / 100; });
    },
    (value) => {
        if (value == 0) qsVolumeIcon.className = 'fas fa-volume-mute text-xl absolute top-3 left-1/2 -translate-x-1/2 z-10 text-white/50';
        else if (value < 50) qsVolumeIcon.className = 'fas fa-volume-down text-xl absolute top-3 left-1/2 -translate-x-1/2 z-10 text-white/50';
        else qsVolumeIcon.className = 'fas fa-volume-up text-xl absolute top-3 left-1/2 -translate-x-1/2 z-10 text-white/50';
    }
);
const brightnessSliderController = setupVerticalSlider(qsBrightnessTrack, qsBrightnessFill,
    (value) => {
        systemBrightness = value;
        saveSystemBrightness();
        const overlay = document.getElementById('brightness-overlay');
        if (overlay) {
            overlay.style.opacity = (1 - (value / 100)) * 0.6;
        }
    }
);
if (qsMusicPlayPause) {
    qsMusicPlayPause.addEventListener('click', () => {
        if (window.globalMusicState?.isPlaying) { window.globalMusicState.pause(); } 
        else if (window.globalMusicState?.play) { window.globalMusicState.play(); }
    });
}
if (qsMusicNext) { qsMusicNext.addEventListener('click', () => window.globalMusicState?.next()); }
if (qsMusicPrev) { qsMusicPrev.addEventListener('click', () => window.globalMusicState?.prev()); }
if (qsMusicShuffle) { qsMusicShuffle.addEventListener('click', () => window.globalMusicState?.toggleShuffle()); }
if (qsMusicRepeat) { qsMusicRepeat.addEventListener('click', () => window.globalMusicState?.toggleRepeat()); }
if (qsMusicProgressSlider) {
    qsMusicProgressSlider.addEventListener('input', (e) => {
        if (window.globalMusicState?.audioElement) {
            window.globalMusicState.audioElement.currentTime = e.target.value;
        }
    });
}
function updateQuickSettingsMusicPlayer() {
    const musicPlayerTile = document.getElementById('qs-music-player');
    if (!musicPlayerTile) return;
    const titleEl = document.getElementById('qs-music-title');
    const artistEl = document.getElementById('qs-music-artist');
    const playPauseBtnIcon = document.getElementById('qs-music-play-pause').querySelector('i');
    const progressFill = document.getElementById('qs-music-progress-fill');
    const progressSlider = document.getElementById('qs-music-progress-slider');
    const currentTimeEl = document.getElementById('qs-music-current-time');
    const durationEl = document.getElementById('qs-music-duration');
    if (!window.globalMusicState || !window.globalMusicState.track) {
        titleEl.textContent = '';
        artistEl.textContent = '';
        playPauseBtnIcon.className = 'fas fa-play';
        progressFill.style.width = '0%';
        progressSlider.value = 0;
        currentTimeEl.textContent = '0:00';
        durationEl.textContent = '0:00';
    } else {
        const state = window.globalMusicState;
        const audio = state.audioElement;
        titleEl.textContent = state.track.name || '';
        artistEl.textContent = state.track.artist || '';
        playPauseBtnIcon.className = state.isPlaying ? 'fas fa-pause' : 'fas fa-play';
        if (audio && !isNaN(audio.duration)) {
            const progressPercent = (audio.currentTime / audio.duration) * 100;
            progressFill.style.width = `${progressPercent}%`;
            progressSlider.value = audio.currentTime;
            progressSlider.max = audio.duration;
            const formatTime = (s) => isNaN(s) ? "0:00" : `${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`;
            currentTimeEl.textContent = formatTime(audio.currentTime);
            durationEl.textContent = formatTime(audio.duration);
        } else {
            progressFill.style.width = '0%';
            currentTimeEl.textContent = '0:00';
            durationEl.textContent = '0:00';
        }
    }
}
let isNightModeEnabled = JSON.parse(localStorage.getItem('riviftNightModeEnabled')) || false;
const nightModeOverlay = document.getElementById('night-mode-overlay');
function toggleNightMode(enable) {
    isNightModeEnabled = (typeof enable === 'boolean') ? enable : !isNightModeEnabled;
    nightModeOverlay.style.display = isNightModeEnabled ? 'block' : 'none';
    const nightModeToggle = document.getElementById('qs-night-mode-toggle');
    if (nightModeToggle) {
        nightModeToggle.classList.toggle('active', isNightModeEnabled);
        const nightModeText = nightModeToggle.querySelector('span');
        const nightModeIcon = nightModeToggle.querySelector('i');
        const forceWhite = isNightModeEnabled && !document.body.classList.contains('dark-mode');
        if (nightModeText) nightModeText.style.color = forceWhite ? 'white' : '';
        if (nightModeIcon) nightModeIcon.style.color = forceWhite ? 'white' : '';
    }
    localStorage.setItem('riviftNightModeEnabled', JSON.stringify(isNightModeEnabled));
}
function updateAllQsToggles() {
    updateQsThemeToggle();
    updateQsAeroToggle();
    volumeSliderController.setValue(systemVolume);
    brightnessSliderController.setValue(systemBrightness);
    const overlay = document.getElementById('brightness-overlay');
    if (overlay) {
        overlay.style.opacity = (1 - (systemBrightness / 100)) * 0.6;
    }
    openApps.forEach(app => { if (app.audio) app.audio.volume = systemVolume / 100; });
    updateQuickSettingsMusicPlayer();
        nightModeOverlay.style.display = isNightModeEnabled ? 'block' : 'none';
    const nightModeToggle = document.getElementById('qs-night-mode-toggle');
    if (nightModeToggle) {
        nightModeToggle.classList.toggle('active', isNightModeEnabled);
    }
    toggleNightMode(isNightModeEnabled);
}
document.getElementById('power-lock').addEventListener('click', lockOS);
document.getElementById('power-restart').addEventListener('click', async () => { 
    if (await showMessageBox('', 'OS', { showCancel: true })) {
        openApps.forEach(app => app.audio?.pause());
        playSound('shutdown');
        document.body.innerHTML = `<div class="flex items-center justify-center h-screen bg-black text-white text-2xl">Rivift OS...</div>`;
        setTimeout(() => location.reload(), 1500);
    }
});
document.getElementById('power-shutdown').addEventListener('click', async () => {
    if (await showMessageBox('', 'OS', { showCancel: true })) {
        openApps.forEach(app => app.audio?.pause());
        playSound('shutdown');
        document.body.innerHTML = `<div class="flex items-center justify-center h-screen bg-black text-white text-2xl">Rivift OS...</div>`;
        setTimeout(() => { document.body.innerHTML = `<div class="flex items-center justify-center h-screen bg-black text-white text-2xl"></div>`; }, 2000);
    }
});
        let activeWindow = null;
        let desktops = [
            { id: `desktop-${Date.now()}`, name: ' 1', windowIds: [] }
        ];
        let activeDesktopId = desktops[0].id;
        let activeResizer = { active: false, leftWin: null, rightWin: null };
        let desktopIcons = JSON.parse(localStorage.getItem('riviftDesktopIcons')) || [];
        let zIndexCounter = 1;
        const openApps = new Map();
        let isLocked = false;
        let pinMode = false;
        let snapHideTimeout;
        let isDraggingWindow = false;
        let dragTarget = null;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        let maximizePreviewActive = false;
        let snapType = null;
        const calendarEvents = JSON.parse(localStorage.getItem('riviftCalendarEvents')) || {};
        const notifications = [];
        const alarms = JSON.parse(localStorage.getItem('riviftAlarms')) || [];
        let timerIntervalId = null;
        let timerRemaining = 0;
        let stopwatchIntervalId = null;
        let stopwatchElapsedTime = 0;
        let recentItems = JSON.parse(localStorage.getItem('riviftRecentItems')) || [];
        let pinnedApps;
            try {
                const storedPinnedApps = localStorage.getItem('riviftPinnedApps');
                if (storedPinnedApps) {
                    pinnedApps = JSON.parse(storedPinnedApps);
                    if (!Array.isArray(pinnedApps)) {
                        throw new Error('pinnedApps is not an array');
                    }
                } else {
                    pinnedApps = ['settings', 'calculator', 'notepad', 'browser', 'pingpong', 'music-player', 'calendar', 'app-store', 'files', 'command', 'script-editor', 'drawing-tool', 'weather', 'notes', 'image-viewer', 'media-player', 'text-reader'];
                }
            } catch (e) {
                console.error("Error parsing riviftPinnedApps from localStorage. Using default values.", e);
                pinnedApps = ['settings', 'calculator', 'notepad', 'browser', 'pingpong', 'music-player', 'calendar', 'app-store', 'files', 'command', 'script-editor', 'drawing-tool', 'weather', 'notes', 'image-viewer', 'media-player', 'text-reader'];
            }
        let osPassword = localStorage.getItem('riviftOSPassword') || '';
        let osPasswordType = localStorage.getItem('riviftOSPasswordType') || 'pin';
        let osPatternPassword = JSON.parse(localStorage.getItem('riviftOSPatternPassword')) || [];
        let passwordLoginEnabled = JSON.parse(localStorage.getItem('riviftPasswordLoginEnabled')) || false;
        let currentWallpaper = localStorage.getItem('riviftCurrentWallpaper') || 'wallpapers/Whisk_b011e175bae61118a7b4de29d1ad3e16dr.jpeg';
        let wallpaperSlideshowEnabled = JSON.parse(localStorage.getItem('riviftWallpaperSlideshowEnabled')) || false;
        let slideshowInterval = parseInt(localStorage.getItem('riviftSlideshowInterval')) || 60;
        let isDarkMode = JSON.parse(localStorage.getItem('riviftIsDarkMode')) !== null ? JSON.parse(localStorage.getItem('riviftIsDarkMode')) : true;
        let autoThemeEnabled = JSON.parse(localStorage.getItem('riviftAutoThemeEnabled')) || false;
        let systemLanguage = localStorage.getItem('riviftSystemLanguage') || 'ja-JP';
        let desktopNotificationsEnabled = JSON.parse(localStorage.getItem('riviftDesktopNotificationsEnabled')) || true;
        let notificationDismissTime = parseInt(localStorage.getItem('riviftNotificationDismissTime')) || 5;
        let notificationSoundEnabled = JSON.parse(localStorage.getItem('riviftNotificationSoundEnabled')) || true;
        let taskbarAlwaysVisible = JSON.parse(localStorage.getItem('riviftTaskbarAlwaysVisible')) || false;
        let taskbarAutoFitIcons = JSON.parse(localStorage.getItem('riviftTaskbarAutoFitIcons')) || false;
        let taskbarCenterAlign = JSON.parse(localStorage.getItem('riviftTaskbarCenterAlign')) || true;
        let showDateOnTaskbar = JSON.parse(localStorage.getItem('riviftShowDateOnTaskbar')) || false;
        let timeFormat24Hour = JSON.parse(localStorage.getItem('riviftTimeFormat24Hour')) || true;
        let savedNotes = JSON.parse(localStorage.getItem('riviftNotes')) || [];
        let appIconSize = parseInt(localStorage.getItem('riviftAppIconSize')) || 40;
        let desktopIconAlignment = localStorage.getItem('riviftIconAlignment') || 'free';
        let aeroEffectEnabled = JSON.parse(localStorage.getItem('riviftAeroEffectEnabled')) !== null ? JSON.parse(localStorage.getItem('riviftAeroEffectEnabled')) : true;
        let aeroMode = localStorage.getItem('riviftAeroMode') || 'smoke';
        let systemVolume = parseInt(localStorage.getItem('riviftSystemVolume')) || 50;
        let systemBrightness = parseInt(localStorage.getItem('riviftSystemBrightness')) || 100;
        let desktopWidgets = JSON.parse(localStorage.getItem('riviftDesktopWidgets')) || [];
const iconParts = {
    base: [
        'https://api.iconify.design/noto:face-with-monocle.svg?color=%23888888',
        'https://api.iconify.design/noto:robot-face.svg?color=%23888888',
        'https://api.iconify.design/noto:ghost.svg?color=%23888888'
    ],
    eyes: [
        'https://api.iconify.design/noto:eyes.svg?color=%23000000',
        'https://api.iconify.design/noto:winking-face.svg?color=%23000000',
        'https://api.iconify.design/noto:star-struck.svg?color=%23000000'
    ],
    mouth: [
        'https://api.iconify.design/noto:smiling-face-with-smiling-eyes.svg?color=%23000000',
        'https://api.iconify.design/noto:face-with-open-mouth.svg?color=%23000000'
    ],
    accessory: [
        'https://api.iconify.design/noto:top-hat.svg?color=%23000000',
        'https://api.iconify.design/noto:headphone.svg?color=%23000000'
    ]
};
const defaultUserIcons = [
    'https://api.iconify.design/ph:user-circle-thin.svg?color=%23ffffff',
    'https://api.iconify.design/ph:face-mask-thin.svg?color=%23ffffff',
    'https://api.iconify.design/ph:skull-thin.svg?color=%23ffffff',
    'https://api.iconify.design/ph:cat-thin.svg?color=%23ffffff',
    'https://api.iconify.design/ph:dog-thin.svg?color=%23ffffff',
    'https://api.iconify.design/ph:bird-thin.svg?color=%23ffffff',
    'https://api.iconify.design/ph:fish-simple-thin.svg?color=%23ffffff',
    'https://api.iconify.design/ph:alien-thin.svg?color=%23ffffff',
    'https://api.iconify.design/ph:robot-thin.svg?color=%23ffffff',
    'https://api.iconify.design/ph:ghost-thin.svg?color=%23ffffff',
    'https://api.iconify.design/ph:rocket-launch-thin.svg?color=%23ffffff',
    'https://api.iconify.design/ph:magic-wand-thin.svg?color=%23ffffff',
    'https://api.iconify.design/ph:planet-thin.svg?color=%23ffffff',
    'https://api.iconify.design/ph:paint-brush-thin.svg?color=%23ffffff',
    'https://api.iconify.design/ph:game-controller-thin.svg?color=%23ffffff',
    'https://api.iconify.design/ph:music-notes-simple-thin.svg?color=%23ffffff'
];
let userIcon = JSON.parse(localStorage.getItem('riviftUserIcon_v3')) || {
    mode: 'simple',
    simpleUrl: defaultUserIcons[0],
    composite: {
        base: iconParts.base[0],
        eyes: iconParts.eyes[0],
        mouth: iconParts.mouth[0],
        accessory: null
    }
};
let userName = localStorage.getItem('riviftUserName') || 'Guest';
function saveUserAccount() {
    localStorage.setItem('riviftUserIcon_v3', JSON.stringify(userIcon));
    localStorage.setItem('riviftUserName', userName);
}
const defaultWallpapers = [
    'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564',
    'https://images.unsplash.com/photo-1557672172-298e090bd0f1?q=80&w=2515',
    'https://images.unsplash.com/photo-1620121692029-d088224ddc74?q=80&w=2532',
    'https://images.unsplash.com/photo-1604079628040-94301bb21b91?q=80&w=2487',
    'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?q=80&w=2670',
    'https://images.unsplash.com/photo-1614850523296-d8c1af93d400?q=80&w=2670',
    'https://images.unsplash.com/photo-1554034483-04fda0d3507b?q=80&w=2670',
    'https://images.unsplash.com/photo-1607499699372-7bb722dff7e2?q=80&w=2670',
    'https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=2671',
    'https://images.unsplash.com/photo-1507608616759-54f48f0af0ee?q=80&w=2574',
    'wallpapers/.jpg',
    'https://images.unsplash.com/photo-1447752875215-b2761acb3c5d?q=80&w=2574',
    'https://images.unsplash.com/photo-1480714378408-67cf0d13bc1b?q=80&w=2670',
    'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?q=80&w=2670',
    'https://images.unsplash.com/photo-1586348943529-beaae6c28db9?q=80&w=2515',
    'https://images.unsplash.com/photo-1426604966848-d7adac402bff?q=80&w=2670',
    'wallpapers/.jpg',
    'wallpapers/2.svg',
    'wallpapers/.svg',
    'wallpapers/.svg',
    'wallpapers/.jpg',
    'wallpapers/.jpg',
    'wallpapers/.jpg',
    'wallpapers/.jpg',
    'wallpapers/2.jpg',
    'wallpapers/picture_2314_11_26.jpg',
    'wallpapers/.jpg',
    'wallpapers/.png',
    'wallpapers/.jpg',
    'wallpapers/.jpg',
    'wallpapers/.jpg',
    'wallpapers/Whisk_075c9faa247fc929c53477237263fbccdr.jpeg',
    'wallpapers/Whisk_a5c201d8236545399b94b68ed2a62968dr.jpeg',
    'wallpapers/Whisk_46f3f2b137ea7a1a7de408951a3aa22cdr.jpeg',
    'wallpapers/Whisk_8b08c677b0cc722b30c441ac44151f0cdr.jpeg',
    'wallpapers/Whisk_22ad987da73290baef54ddf0812986fbdr.jpeg',
    'wallpapers/Whisk_789cc7814000b1b8cf948a4fe6747a86dr.jpeg',
    'wallpapers/Whisk_65db6b9b0b87a4b9dcf40d4a2f6da060dr.jpeg',
    'wallpapers/Whisk_83f5b2fdb4952aaad7d4f94b0534120bdr.jpeg',
    'wallpapers/Whisk_b011e175bae61118a7b4de29d1ad3e16dr.jpeg',
];
        let currentWallpaperIndex = defaultWallpapers.indexOf(currentWallpaper) !== -1 ? defaultWallpapers.indexOf(currentWallpaper) : 0;
        let slideshowIntervalId = null;
        let isWifiOn = true;
function savePinnedApps() { 
    localStorage.setItem('riviftPinnedApps', JSON.stringify(pinnedApps)); 
    const taskbarCenter = document.getElementById('taskbar-center');
    taskbarCenter.innerHTML = '';
    pinnedApps.forEach((appId, index) => {
        const app = apps.find(a => a.id === appId);
        if (app && app.installed) {
            const iconDiv = document.createElement('div');
            iconDiv.classList.add('taskbar-icon', 'app-launcher');
            iconDiv.dataset.app = app.id;
            iconDiv.dataset.pinned = 'true';
            iconDiv.dataset.index = index;
            iconDiv.draggable = true;
let iconHtml = app.icon.endsWith('.svg')
    ? `<img src="${app.icon}" style="width: 50%; height: 50%;">`
    : `<i class="${app.icon}"></i>`;
iconDiv.innerHTML = `${iconHtml}<div class="status-indicator"></div>`;
iconDiv.addEventListener('click', (e) => {
    const targetAppId = app.id;
    const instancesOnOtherDesktops = [];
    desktops.forEach(d => {
        if (d.id !== activeDesktopId) {
            d.windowIds.forEach(winId => {
                if (winId.startsWith(`app-window-${targetAppId}`)) {
                    instancesOnOtherDesktops.push({ desktop: d, windowId: winId });
                }
            });
        }
    });
    if (e.shiftKey && instancesOnOtherDesktops.length > 0) {
        const { desktop, windowId } = instancesOnOtherDesktops[0];
        desktop.windowIds = desktop.windowIds.filter(id => id !== windowId);
        desktops.find(d => d.id === activeDesktopId).windowIds.push(windowId);
        openApps.get(windowId).windowElement.style.display = 'flex';
        bringWindowToFront(openApps.get(windowId).windowElement);
        updateTaskbarAppStatus();
    } else {
        handleTaskbarIconClick(app.id);
    }
});
iconDiv.addEventListener('contextmenu', (e) => {
    const appIsOpenGlobally = Array.from(openApps.keys()).some(key => key.startsWith(`app-window-${app.id}`));
    showAppContextMenu(e, app.id, iconDiv, appIsOpenGlobally);
});
            iconDiv.addEventListener('dragover', handleTaskbarDragOver);
            iconDiv.addEventListener('drop', handleTaskbarDrop);
            iconDiv.addEventListener('dragend', handleTaskbarDragEnd);
            taskbarCenter.appendChild(iconDiv);
        }
    });
    updateTaskbarAppStatus();
    applyAppIconSize();
    checkTaskbarScroll();
    applyTaskbarAlignment();
}        
        function saveDesktopIcons() { localStorage.setItem('riviftDesktopIcons', JSON.stringify(desktopIcons)); }
        function saveOSPassword() { localStorage.setItem('riviftOSPassword', osPassword); }
        function saveOSPasswordType() { localStorage.setItem('riviftOSPasswordType', osPasswordType); }
        function saveOSPatternPassword() { localStorage.setItem('riviftOSPatternPassword', JSON.stringify(osPatternPassword)); }
        function savePasswordLoginEnabled() { localStorage.setItem('riviftPasswordLoginEnabled', JSON.stringify(passwordLoginEnabled)); }
        function saveCurrentWallpaper() { localStorage.setItem('riviftCurrentWallpaper', currentWallpaper); }
        function saveWallpaperSlideshowEnabled() { localStorage.setItem('riviftWallpaperSlideshowEnabled', JSON.stringify(wallpaperSlideshowEnabled)); }
        function saveSlideshowInterval() { localStorage.setItem('riviftSlideshowInterval', slideshowInterval); }
        function saveIsDarkMode() { localStorage.setItem('riviftIsDarkMode', JSON.stringify(isDarkMode)); }
        function saveAutoThemeEnabled() { localStorage.setItem('riviftAutoThemeEnabled', JSON.stringify(autoThemeEnabled)); }
        function saveSystemLanguage() { localStorage.setItem('riviftSystemLanguage', systemLanguage); }
        function saveDesktopNotificationsEnabled() { localStorage.setItem('riviftDesktopNotificationsEnabled', JSON.stringify(desktopNotificationsEnabled)); }
        function saveNotificationDismissTime() { localStorage.setItem('riviftNotificationDismissTime', notificationDismissTime); }
        function saveNotificationSoundEnabled() { localStorage.setItem('riviftNotificationSoundEnabled', JSON.stringify(notificationSoundEnabled)); }
        function saveTaskbarAlwaysVisible() { localStorage.setItem('riviftTaskbarAlwaysVisible', JSON.stringify(taskbarAlwaysVisible)); }
        function saveShowDateOnTaskbar() { localStorage.setItem('riviftShowDateOnTaskbar', JSON.stringify(showDateOnTaskbar)); }
        function saveTimeFormat24Hour() { localStorage.setItem('riviftTimeFormat24Hour', JSON.stringify(timeFormat24Hour)); }
        function saveNotes() { localStorage.setItem('riviftNotes', JSON.stringify(savedNotes)); }
        function saveRecentItems() { localStorage.setItem('riviftRecentItems', JSON.stringify(recentItems)); }
        function saveAppIconSize() { localStorage.setItem('riviftAppIconSize', appIconSize); }
        function saveDesktopIconAlignment() { localStorage.setItem('riviftIconAlignment', desktopIconAlignment); }
        function saveCalendarEvents() { localStorage.setItem('riviftCalendarEvents', JSON.stringify(calendarEvents)); }function saveCalendarEvents() { localStorage.setItem('riviftCalendarEvents', JSON.stringify(calendarEvents)); }
        function saveAlarms() { localStorage.setItem('riviftAlarms', JSON.stringify(alarms)); }
        function saveDesktopIconAlignment() { localStorage.setItem('riviftIconAlignment', desktopIconAlignment); }
        function saveAeroEffectEnabled() { localStorage.setItem('riviftAeroEffectEnabled', JSON.stringify(aeroEffectEnabled)); }
        function saveAeroMode() { localStorage.setItem('riviftAeroMode', aeroMode); }
        function saveSystemVolume() { localStorage.setItem('riviftSystemVolume', systemVolume); }
        function saveSystemBrightness() { localStorage.setItem('riviftSystemBrightness', systemBrightness); }
        function saveTaskbarAutoFitIcons() { localStorage.setItem('riviftTaskbarAutoFitIcons', JSON.stringify(taskbarAutoFitIcons)); }
        function saveTaskbarCenterAlign() { localStorage.setItem('riviftTaskbarCenterAlign', JSON.stringify(taskbarCenterAlign)); }
function saveDesktopWidgets() {
    localStorage.setItem('riviftDesktopWidgets', JSON.stringify(desktopWidgets));
}
function applyVisualEffects() {
    document.body.classList.toggle('aero-enabled', aeroEffectEnabled);
    if (aeroEffectEnabled) {
        document.body.classList.remove('aero-mode-clear', 'aero-mode-smoke');
        document.body.classList.add(`aero-mode-${aeroMode}`);
    } else {
        document.body.classList.remove('aero-mode-clear', 'aero-mode-smoke');
    }
}
function closeCustomColorPicker() {
    const pickerPopup = document.getElementById('custom-color-picker-popup');
    if (pickerPopup) {
        pickerPopup.remove();
        document.removeEventListener('click', handleClickOutsideColorPicker, true);
    }
}
function handleClickOutsideColorPicker(event) {
    if (!event.target.closest('#custom-color-picker-popup') && !event.target.closest('#add-color-btn')) {
        closeCustomColorPicker();
    }
}
let accentColorMode = 'preset';
        let currentAccentColor = '#007bff';
        let customAccentColors = [];
        function saveAccentColorSettings() {
            localStorage.setItem('riviftAccentColorMode', accentColorMode);
            localStorage.setItem('riviftCurrentAccentColor', currentAccentColor);
            localStorage.setItem('riviftCustomAccentColors', JSON.stringify(customAccentColors));
        }
        function loadAccentColorSettings() {
            accentColorMode = localStorage.getItem('riviftAccentColorMode') || 'preset';
            currentAccentColor = localStorage.getItem('riviftCurrentAccentColor') || '#007bff';
            customAccentColors = JSON.parse(localStorage.getItem('riviftCustomAccentColors')) || [];
        }
        function generateColorVariants(hex) {
            if (!hex.startsWith('#')) return { base: '#007bff', hover: '#0056b3', text: '#ffffff' };
            let r = parseInt(hex.slice(1, 3), 16),
                g = parseInt(hex.slice(3, 5), 16),
                b = parseInt(hex.slice(5, 7), 16);
            const hoverR = Math.max(0, r - 40);
            const hoverG = Math.max(0, g - 40);
            const hoverB = Math.max(0, b - 40);
            const hoverHex = `#${hoverR.toString(16).padStart(2, '0')}${hoverG.toString(16).padStart(2, '0')}${hoverB.toString(16).padStart(2, '0')}`;
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            const textColor = brightness > 125 ? '#000000' : '#ffffff';
            return { base: hex, hover: hoverHex, text: textColor };
        }
        function applyAccentColor(hexColor) {
            const variants = generateColorVariants(hexColor);
            const root = document.documentElement;
            root.style.setProperty('--accent-color', variants.base);
            root.style.setProperty('--accent-color-hover', variants.hover);
            root.style.setProperty('--accent-color-text', variants.text);
        }
async function extractColorFromWallpaper(imageUrl) {
            return new Promise(async (resolve, reject) => {
                let finalImageUrl = imageUrl;
                if (imageUrl.startsWith('wallpapers/')) {
                    try {
                        const fileData = await VFS.readFile(`/System/Wallpapers/${imageUrl.split('/').pop()}`);
                        if (fileData && fileData.content) {
                            finalImageUrl = fileData.content;
                        } else {
                            throw new Error('Wallpaper not found in VFS');
                        }
                    } catch (error) {
                        console.error("Could not load local wallpaper from VFS:", error);
                        resolve(null);
                        return;
                    }
                }
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 50;
                    canvas.height = 50;
                    ctx.drawImage(img, 0, 0, 50, 50);
                    const imageData = ctx.getImageData(0, 0, 50, 50).data;
                    const colorMap = {};
                    let maxCount = 0;
                    let dominantColor = [0, 0, 0];
                    for (let i = 0; i < imageData.length; i += 4) {
                        const r = imageData[i], g = imageData[i+1], b = imageData[i+2];
                        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                        const saturation = Math.max(r,g,b) - Math.min(r,g,b);
                        if (brightness < 40 || brightness > 215 || saturation < 50) continue;
                        const key = `${Math.floor(r/20)*20},${Math.floor(g/20)*20},${Math.floor(b/20)*20}`;
                        colorMap[key] = (colorMap[key] || 0) + 1;
                        if (colorMap[key] > maxCount) {
                            maxCount = colorMap[key];
                            dominantColor = key.split(',').map(Number);
                        }
                    }
                    if (maxCount > 0) {
                        const [r, g, b] = dominantColor;
                        const hex = `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
                        resolve(hex);
                    } else {
                        resolve(null);
                    }
                };
                img.onerror = () => resolve(null);
                img.src = finalImageUrl;
            });
        }
        function renderAccentColorUI() {
            const settingsWindow = document.getElementById('app-window-settings');
            if (!settingsWindow) return;
            const presetContainer = settingsWindow.querySelector('#accent-preset-colors');
            const customContainer = settingsWindow.querySelector('#accent-custom-colors');
            const presetColors = ['#007bff', '#dc3545', '#ffc107', '#28a745', '#6f42c1', '#fd7e14'];
            presetContainer.innerHTML = presetColors.map(color => `
                <button data-color="${color}" style="background-color: ${color};" class="color-button w-8 h-8 rounded-full border-2 ${currentAccentColor === color && accentColorMode === 'preset' ? 'border-white scale-110' : 'border-transparent'}"></button>
            `).join('');
            customContainer.innerHTML = customAccentColors.map(color => `
                <div class="relative group">
                    <button data-color="${color}" style="background-color: ${color};" class="color-button w-8 h-8 rounded-full border-2 ${currentAccentColor === color && accentColorMode === 'custom' ? 'border-white scale-110' : 'border-transparent'}"></button>
                    <button data-color-to-delete="${color}" class="delete-color-btn absolute -top-1 -right-1 w-4 h-4 bg-red-600 text-white rounded-full text-xs hidden group-hover:flex items-center justify-center"></button>
                </div>
            `).join('') + `<button id="add-accent-color-btn" class="w-8 h-8 rounded-full grid place-items-center bg-white/10 border-2 border-dashed border-white/30 text-lg">+</button>`;
            presetContainer.onclick = handleColorSelection;
            customContainer.onclick = handleColorSelection;
        }
        function handleColorSelection(e) {
            const colorButton = e.target.closest('.color-button');
            const addButton = e.target.closest('#add-accent-color-btn');
            const deleteButton = e.target.closest('.delete-color-btn');
            if (deleteButton) {
                e.stopPropagation();
                const colorToDelete = deleteButton.dataset.colorToDelete;
                customAccentColors = customAccentColors.filter(c => c !== colorToDelete);
                if (currentAccentColor === colorToDelete) {
                    accentColorMode = 'preset';
                    currentAccentColor = '#007bff';
                    applyAccentColor(currentAccentColor);
                }
                saveAccentColorSettings();
                renderAccentColorUI();
                return;
            }
            if (colorButton) {
                const newColor = colorButton.dataset.color;
                accentColorMode = e.currentTarget.id === 'accent-preset-colors' ? 'preset' : 'custom';
                currentAccentColor = newColor;
                document.getElementById('accent-auto-switch').selected = false;
                saveAccentColorSettings();
                applyAccentColor(newColor);
                renderAccentColorUI();
            } else if (addButton) {
                const pickerPopup = document.createElement('div');
                pickerPopup.id = 'custom-color-picker-popup';
                pickerPopup.className = 'absolute p-2 rounded-lg shadow-2xl z-50';
                pickerPopup.style.backgroundColor = isDarkMode ? 'var(--panel-bg-dark)' : 'var(--panel-bg-light)';
                pickerPopup.style.border = isDarkMode ? '1px solid var(--border-color-dark)' : '1px solid var(--border-color-light)';
                const pickerInput = document.createElement('input');
                pickerInput.type = 'color';
                pickerInput.className = 'w-full h-12 cursor-pointer bg-transparent border-none';
                pickerInput.addEventListener('change', (ev) => {
                    const newColor = ev.target.value;
                    if (!customAccentColors.includes(newColor)) {
                        customAccentColors.push(newColor);
                    }
                    accentColorMode = 'custom';
                    currentAccentColor = newColor;
                    document.getElementById('accent-auto-switch').selected = false;
                    saveAccentColorSettings();
                    applyAccentColor(newColor);
                    renderAccentColorUI();
                    closeCustomColorPicker();
                });
                pickerPopup.appendChild(pickerInput);
                document.body.appendChild(pickerPopup);
                const btnRect = addButton.getBoundingClientRect();
                pickerPopup.style.left = `${btnRect.left - 50}px`;
                pickerPopup.style.top = `${btnRect.bottom + 8}px`;
                setTimeout(() => document.addEventListener('click', handleClickOutsideColorPicker, true), 0);
            }
        }
let isAudioUnlocked = false;
const deferredSounds = new Set();
const soundMap = {
    startup: 'sounds/startup.mp3',
    shutdown: 'sounds/shutdown.wav',
    notification: 'sounds/notification.wav',
    error: 'sounds/error.wav',
    minimize: 'sounds/minimize.wav',
    maximize: 'sounds/maximize.wav',
    trash: 'sounds/trash.wav',
};
function unlockAudioAndPlayDeferred() {
    if (isAudioUnlocked) return;
    isAudioUnlocked = true;
    deferredSounds.forEach(soundName => {
        playSound(soundName, true);
    });
    deferredSounds.clear();
    console.log("User has interacted. Audio is now unlocked.");
    document.body.removeEventListener('click', unlockAudioAndPlayDeferred, true);
    document.body.removeEventListener('keydown', unlockAudioAndPlayDeferred, true);
}
document.body.addEventListener('click', unlockAudioAndPlayDeferred, true);
document.body.addEventListener('keydown', unlockAudioAndPlayDeferred, true);
function playSound(soundName, forcePlay = false) {
    if (!isAudioUnlocked && !forcePlay) {
        deferredSounds.add(soundName);
        return;
    }
    if (soundName === 'notification' && !notificationSoundEnabled) return;
    if (['error', 'minimize', 'maximize', 'trash', 'shutdown'].includes(soundName) && !desktopNotificationsEnabled) return;
    if (soundMap[soundName]) {
        const audio = new Audio(soundMap[soundName]);
        const volumeSlider = document.getElementById('volume-slider');
        if (volumeSlider) {
            audio.volume = volumeSlider.value / 100;
        }
        audio.play().catch(error => {
            console.error(`Sound playback failed for ${soundName}:`, error);
        });
    }
}
let activeModalContext = null;
function showModal({ title, content, actions, contextWindow }) {
    activeModalContext = contextWindow;
    const modalOverlay = document.getElementById('modal-overlay');
    const modalContent = document.getElementById('modal-content');
    if (!modalOverlay || !modalContent) {
        console.error("OS(#modal-overlay, #modal-content)");
        return;
    }
    modalContent.innerHTML = `<h3>${title}</h3><div class="modal-body">${content}</div>`;
    const actionsEl = document.createElement('div');
    actionsEl.className = 'modal-actions';
    actions.forEach(action => {
        const btn = document.createElement('button');
        btn.innerText = action.text;
        btn.className = action.class;
        btn.onclick = action.action;
        actionsEl.appendChild(btn);
    });
    modalContent.appendChild(actionsEl);
    modalOverlay.classList.remove('hidden');
}
function closeModal() {
    const modalOverlay = document.getElementById('modal-overlay');
    if (modalOverlay) {
        modalOverlay.classList.add('hidden');
    }
    activeModalContext = null;
}
function showMessageBox(title, message, options = {}) {
    const { showCancel = false, isNetworkError = false, customHtmlContent = null, input = null, type = 'alert' } = options;
    return new Promise(resolve => {
        messageBoxTitle.textContent = title;
        messageBoxContent.textContent = message;
        messageBoxCustomContent.innerHTML = customHtmlContent || '';
        if (input) {
            messageBoxCustomContent.innerHTML += `<input type="text" id="message-box-input" class="w-full p-2 rounded-lg mt-2" style="background-color: var(--input-bg-dark); color: var(--text-color-dark); border: 1px solid var(--input-border-dark);" placeholder="${input.placeholder || ''}" value="${input.value || ''}">`;
        }
        messageBoxCancel.classList.toggle('hidden', !showCancel);
        messageBoxOk.textContent = 'OK';
        const newOk = messageBoxOk.cloneNode(true);
        messageBoxOk.parentNode.replaceChild(newOk, messageBoxOk);
        messageBoxOk = newOk;
        const newCancel = messageBoxCancel.cloneNode(true);
        messageBoxCancel.parentNode.replaceChild(newCancel, messageBoxCancel);
        messageBoxCancel = newCancel;
messageBoxOk.onclick = () => {
    if (messageBoxCustomContent.querySelector('#event-title')) {
        const title = messageBoxCustomContent.querySelector('#event-title')?.value;
        const date = messageBoxCustomContent.querySelector('#event-date')?.value;
        const startTime = messageBoxCustomContent.querySelector('#event-start-time')?.value;
        const endTime = messageBoxCustomContent.querySelector('#event-end-time')?.value;
        const description = messageBoxCustomContent.querySelector('#event-description')?.value;
        const color = messageBoxCustomContent.querySelector('#event-color')?.value;
        resolve({ title, date, startTime, endTime, description, color });
    } else if (messageBoxOverlay.querySelector('#message-box-input')) {
        const inputValue = messageBoxOverlay.querySelector('#message-box-input').value;
        resolve(inputValue);
    } else {
        resolve(true);
    }
    messageBoxOverlay.classList.remove('active');
};
        messageBoxCancel.onclick = () => {
            resolve(input ? null : false);
            messageBoxOverlay.classList.remove('active');
        };
        messageBoxOverlay.classList.add('active');
        messageBoxOverlay.classList.toggle('network-error-overlay', isNetworkError);
            if (isNetworkError || title.toLowerCase().includes('error') || title.includes('')) {
            playSound('error');
        }
        messageBoxOverlay.querySelector('#message-box-input')?.focus();
    });
}
const snapPopup = document.getElementById('snap-layouts-popup');
function showSnapPopup(maximizeBtn, windowEl) {
    clearTimeout(snapHideTimeout);
    activeSnapWindow = windowEl;
    const layouts = [
        'quarter-top-left', 'quarter-top-right',
        'quarter-bottom-left', 'quarter-bottom-right',
        'half-left', 'half-right'
    ];
    snapPopup.innerHTML = layouts.map(layout =>
        `<div class="snap-layout-option" data-layout="${layout}"></div>`
    ).join('');
    const btnRect = maximizeBtn.getBoundingClientRect();
    snapPopup.style.top = `${btnRect.bottom + 5}px`;
    const popupWidth = snapPopup.offsetWidth;
    let left = btnRect.left + btnRect.width / 2 - popupWidth / 2;
    if (left < 10) {
        left = 10;
    }
    if (left + popupWidth > window.innerWidth - 10) {
        left = window.innerWidth - 10 - popupWidth;
    }
    snapPopup.style.left = `${left}px`;
    snapPopup.classList.add('visible');
}
function hideSnapPopup() {
    if (snapPopup.matches(':hover')) return;
    snapHideTimeout = setTimeout(() => {
        snapPopup.classList.remove('visible');
        activeSnapWindow = null;
    }, 200);
}
snapPopup.addEventListener('mouseenter', () => clearTimeout(snapHideTimeout));
snapPopup.addEventListener('mouseleave', hideSnapPopup);
snapPopup.addEventListener('click', (e) => {
    const option = e.target.closest('.snap-layout-option');
    if (option && activeSnapWindow) {
        const layout = option.dataset.layout;
        applySnapLayout(activeSnapWindow, layout);
        snapPopup.classList.remove('visible');
        activeSnapWindow = null;
    }
});
setInterval(() => {
    const now = Date.now();
    [...notifications].forEach(notification => {
        if (notification.dismissTime && now >= notification.dismissTime) {
            dismissNotification(notification.id);
        }
    });
}, 1000);
function createNotification(title, message, type = 'info', duration = notificationDismissTime, onSnooze = null, onDismiss = null, appId = null) {
    if (!desktopNotificationsEnabled) return;
    const notificationId = Date.now() + Math.random();
    const notificationDiv = document.createElement('div');
    notificationDiv.id = `notification-${notificationId}`;
    notificationDiv.classList.add('desktop-notification');
    const app = apps.find(a => a.id === appId);
    let iconHtml = app ? (app.icon.endsWith('.svg') ? `<img src="${app.icon}" class="desktop-notification-icon">` : `<div class="desktop-notification-icon grid place-items-center text-xl"><i class="${app.icon}"></i></div>`) : `<div class="desktop-notification-icon grid place-items-center text-xl"><i class="fas fa-info-circle"></i></div>`;
    notificationDiv.innerHTML = `${iconHtml}<div class="desktop-notification-content"><div class="desktop-notification-header"><span class="desktop-notification-title">${title}</span><button class="desktop-notification-close-btn">&times;</button></div><p class="desktop-notification-body">${message}</p></div>`;
    notificationDiv.querySelector('.desktop-notification-close-btn').dataset.id = notificationId;
    desktopNotificationsContainer.appendChild(notificationDiv);
    setTimeout(() => notificationDiv.classList.add('show'), 10);
    const dismissTime = (duration > 0) ? Date.now() + duration * 1000 : null;
    notifications.push({ id: notificationId, element: notificationDiv, dismissTime: dismissTime, title: title, message: message, type: type });
    updateNotificationSystem();
    if (notificationSoundEnabled && type !== 'info') { playSound('notification'); }
}
function dismissNotification(id) {
    const notificationIndex = notifications.findIndex(n => n.id === id);
    if (notificationIndex === -1) return;
    const notificationData = notifications[notificationIndex];
    if (notificationData.element && document.body.contains(notificationData.element)) {
        notificationData.element.classList.remove('show');
        notificationData.element.classList.add('hide');
        setTimeout(() => { notificationData.element.remove(); }, 500);
    }
    notifications.splice(notificationIndex, 1);
    updateNotificationSystem();
}
function updateNotificationSystem() {
    if (!notificationIconContainer || !notificationCenterList || !noNotificationsMessage || !clearAllBtn) return;
    if (notifications.length > 0) {
        if (!notificationIconContainer.hasChildNodes()) {
            const iconButton = document.createElement('button');
            iconButton.innerHTML = `<i class="fas fa-comment-alt"></i><span class="absolute -top-1 -right-1 text-xs bg-red-500 text-white rounded-full w-4 h-4 grid place-items-center">${notifications.length}</span>`;
            iconButton.onclick = () => {
                togglePanel(notificationCenterPanel, quickSettingsPanel);
            };
            notificationIconContainer.appendChild(iconButton);
        } else {
            const countSpan = notificationIconContainer.querySelector('span');
            if (countSpan) {
                countSpan.textContent = notifications.length;
            }
        }
        notificationIconContainer.style.display = 'flex';
    } else {
        notificationIconContainer.innerHTML = '';
        notificationIconContainer.style.display = 'none';
        if(notificationCenterPanel) notificationCenterPanel.classList.remove('active');
    }
    notificationCenterList.innerHTML = '';
    if (notifications.length === 0) {
        noNotificationsMessage.style.display = 'block';
        clearAllBtn.style.display = 'none';
    } else {
        noNotificationsMessage.style.display = 'none';
        clearAllBtn.style.display = 'block';
        [...notifications].reverse().forEach(n => {
            const item = document.createElement('div');
            item.className = 'desktop-notification mb-2';
            item.style.cssText = 'transform: none; opacity: 1; position: relative;';
            item.innerHTML = `
                <div class="desktop-notification-content">
                    <div class="desktop-notification-header">
                        <span class="desktop-notification-title">${n.title}</span>
                        <button class="desktop-notification-close-btn" data-id="${n.id}">&times;</button>
                    </div>
                    <p class="desktop-notification-body">${n.message}</p>
                </div>`;
            notificationCenterList.appendChild(item);
        });
    }
}
        if (clearAllBtn) {
    clearAllBtn.addEventListener('click', () => {
        [...notifications].forEach(n => dismissNotification(n.id));
    });
}
if (notificationCenterList) {
    notificationCenterList.addEventListener('click', (e) => {
        const closeBtn = e.target.closest('.desktop-notification-close-btn');
        if (closeBtn) {
            const notificationId = parseFloat(closeBtn.dataset.id);
            dismissNotification(notificationId);
        }
    });
}
if (desktopNotificationsContainer) {
    desktopNotificationsContainer.addEventListener('click', (e) => {
        const closeBtn = e.target.closest('.desktop-notification-close-btn');
        if (closeBtn) {
            const notificationId = parseFloat(closeBtn.dataset.id);
            dismissNotification(notificationId);
        }
    });
}
function updateTaskbarAppStatus() {
    const activeDesktop = desktops.find(d => d.id === activeDesktopId) || { windowIds: [] };
    const windowIdsOnThisDesktop = new Set(activeDesktop.windowIds);
    const openAppBaseIds = new Map();
    openApps.forEach((appData, windowId) => {
        if (!windowIdsOnThisDesktop.has(windowId)) return;
        let baseAppId = windowId.replace(/^app-window-/, '');
        const matchedApp = apps.find(app => baseAppId.startsWith(app.id));
        if (matchedApp) {
            baseAppId = matchedApp.id;
        } else {
            baseAppId = baseAppId.replace(/-\d+.*$/, '');
        }
        if (!openAppBaseIds.has(baseAppId)) {
            openAppBaseIds.set(baseAppId, []);
        }
        openAppBaseIds.get(baseAppId).push(appData.state);
    });
    document.querySelectorAll('#taskbar-center .taskbar-icon').forEach(icon => {
        const appId = icon.dataset.app;
        icon.classList.remove('app-state-active', 'app-state-minimized', 'app-state-hidden');
        const states = openAppBaseIds.get(appId);
        if (states) {
            if (states.includes('active')) {
                icon.classList.add('app-state-active');
            } else if (states.includes('minimized')) {
                icon.classList.add('app-state-minimized');
            } else if (states.includes('hidden')) {
                icon.classList.add('app-state-hidden');
            }
        }
    });
    if (taskbarAlwaysVisible) {
        taskbar.classList.remove('hidden');
    } else {
        const hasWindowsOnThisDesktop = Array.from(openApps.values()).some(app => windowIdsOnThisDesktop.has(app.windowElement.id));
        if (hasWindowsOnThisDesktop) {
            taskbar.classList.add('hidden');
        } else {
            taskbar.classList.remove('hidden');
        }
    }
    taskbar.classList.toggle('full-width', taskbarAlwaysVisible || allAppsFullscreen.classList.contains('active'));
    checkTaskbarScroll();
}
        let draggedTaskbarItem = null;
        function handleTaskbarDragStart(e) {
            draggedTaskbarItem = e.target.closest('.taskbar-icon');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedTaskbarItem.dataset.app);
            setTimeout(() => { 
                draggedTaskbarItem.classList.add('dragging');
            }, 0);
        }
        function handleTaskbarDragOver(e) {
            e.preventDefault();
            const targetItem = e.target.closest('.taskbar-icon');
            if (targetItem && targetItem !== draggedTaskbarItem) {
                targetItem.classList.add('drag-over');
            }
            document.querySelectorAll('#taskbar-center .taskbar-icon.drag-over').forEach(icon => {
                if (icon !== targetItem) {
                    icon.classList.remove('drag-over');
                }
            });
        }
        function handleTaskbarDrop(e) {
            e.preventDefault();
            const targetItem = e.target.closest('.taskbar-icon');
            if (targetItem && targetItem !== draggedTaskbarItem) {
                const draggedAppId = draggedTaskbarItem.dataset.app;
                const targetAppId = targetItem.dataset.app;
                const draggedIndex = pinnedApps.indexOf(draggedAppId);
                const targetIndex = pinnedApps.indexOf(targetAppId);
                if (draggedIndex !== -1 && targetIndex !== -1) {
                    pinnedApps.splice(draggedIndex, 1);
                    pinnedApps.splice(targetIndex, 0, draggedAppId);
                    savePinnedApps();
                }
            }
            if (targetItem) targetItem.classList.remove('drag-over');
        }
        function handleTaskbarDragEnd() {
            if (draggedTaskbarItem) {
                draggedTaskbarItem.classList.remove('dragging');
            }
            document.querySelectorAll('#taskbar-center .taskbar-icon.drag-over').forEach(icon => {
                icon.classList.remove('drag-over');
            });
            draggedTaskbarItem = null;
        }
function showAppContextMenu(event, appId, iconElement, appIsOpenGlobally) {
    event.preventDefault();
    closeContextMenu();
    closeAppContextMenu(); 
    const app = apps.find(a => a.id === appId);
    if (!app) return;
    const contextMenu = document.createElement('div');
    contextMenu.id = 'taskbar-app-context-menu-active';
    contextMenu.className = 'taskbar-context-menu';
    contextMenu.style.visibility = 'hidden'; 
    const isPinned = pinnedApps.includes(app.id);
    const appIsOpen = appIsOpenGlobally;
    const actionItem = {
        label: appIsOpen ? '' : '',
        icon: appIsOpen ? 'fas fa-times' : 'fas fa-external-link-alt',
        action: () => {
            if (appIsOpen) {
                Array.from(openApps.keys())
                    .filter(key => key.startsWith(`app-window-${appId}`))
                    .forEach(id => openApps.get(id)?.windowElement.querySelector('.close').click());
            } else {
                launchApp(app.id);
            }
        }
    };
    const pinItem = {
        label: isPinned ? '' : '',
        icon: 'fas fa-thumbtack',
        action: () => {
            if (isPinned) {
                pinnedApps = pinnedApps.filter(id => id !== appId);
            } else {
                pinnedApps.push(appId);
            }
            savePinnedApps();
        }
    };
    [actionItem, pinItem].forEach(item => {
        const menuItemEl = document.createElement('div');
        menuItemEl.className = 'taskbar-context-menu-item';
        menuItemEl.innerHTML = `<i class="${item.icon}"></i> <span>${item.label}</span>`;
        if (item.label === '') {
            menuItemEl.querySelector('i').style.transform = 'rotate(45deg)';
        }
        menuItemEl.addEventListener('click', (e) => {
            e.stopPropagation();
            item.action();
            closeAppContextMenu();
        });
        contextMenu.appendChild(menuItemEl);
    });
    document.body.appendChild(contextMenu);
    setTimeout(() => {
        const iconRect = iconElement.getBoundingClientRect();
        const menuHeight = contextMenu.offsetHeight;
        const menuWidth = contextMenu.offsetWidth;
        let top = iconRect.top - menuHeight - 10;
        let left = iconRect.left + (iconRect.width / 2) - (menuWidth / 2);
        if (left < 10) left = 10;
        if (left + menuWidth > window.innerWidth - 10) left = window.innerWidth - menuWidth - 10;
        if (top < 10) {
            top = iconRect.bottom + 10;
        }
        contextMenu.style.top = `${top}px`;
        contextMenu.style.left = `${left}px`;
        contextMenu.style.visibility = 'visible';
        contextMenu.classList.add('active');
    }, 0);
    document.addEventListener('click', handleClickOutsideAppContextMenu, true);
}
function handleClickOutsideAppContextMenu(event) {
    const activeMenu = document.getElementById('taskbar-app-context-menu-active');
    if (activeMenu && !activeMenu.contains(event.target) && !event.target.closest('.taskbar-icon')) {
        closeAppContextMenu();
    }
}
function closeAppContextMenu() {
    const activeMenu = document.getElementById('taskbar-app-context-menu-active');
    if (activeMenu) {
        activeMenu.classList.remove('active');
        setTimeout(() => activeMenu.remove(), 200);
        document.removeEventListener('click', handleClickOutsideAppContextMenu, true);
    }
}
        function handleClickOutsideContextMenu(event) {
            const activeMenu = document.getElementById('taskbar-app-context-menu-active');
            if (activeMenu && !activeMenu.contains(event.target) && !event.target.closest('.taskbar-icon')) {
                closeAppContextMenu();
            }
        }
function initializeSetupScreen() {
            const setupScreen = document.getElementById('setup-screen');
            const slider = document.getElementById('setup-content-slider');
            const pages = setupScreen.querySelectorAll('.setup-page');
            const progressBar = setupScreen.querySelector('.setup-progress-bar');
            const nextBtn = document.getElementById('setup-next-btn');
            const iconModalOverlay = document.getElementById('setup-icon-modal-overlay');
            const iconGrid = document.getElementById('setup-icon-grid');
            const iconConfirmBtn = document.getElementById('setup-icon-confirm-btn');
            let currentPageIndex = 0;
            const totalPages = pages.length;
            const tempSettings = {
                isDarkMode: true,
                aeroEffectEnabled: true,
                userName: '',
                osPassword: '',
                userIcon: { simpleUrl: defaultUserIcons[0] }
            };
            setupScreen.style.backgroundImage = `url('wallpapers/Whisk_b011e175bae61118a7b4de29d1ad3e16dr.jpeg')`;
            setupScreen.style.display = 'flex';
            setTimeout(() => {
                setupScreen.style.opacity = '1';
            }, 10);
            for (let i = 0; i < totalPages; i++) {
                const dot = document.createElement('div');
                dot.className = 'progress-dot';
                progressBar.appendChild(dot);
            }
            const dots = progressBar.querySelectorAll('.progress-dot');
            const goToPage = (pageIndex) => {
                currentPageIndex = pageIndex;
                slider.style.transform = `translateX(-${currentPageIndex * 100}%)`;
                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === currentPageIndex);
                });
                if (currentPageIndex === totalPages - 1) {
                    nextBtn.textContent = '';
                } else {
                    nextBtn.textContent = '';
                }
                const usernameInput = setupScreen.querySelector('#setup-username');
                const passwordInput = setupScreen.querySelector('#setup-password-pin');
                if (currentPageIndex === 2) {
                    nextBtn.disabled = !usernameInput.value.trim() || passwordInput.value.length < 4;
                } else {
                    nextBtn.disabled = false;
                }
            };
            nextBtn.addEventListener('click', () => {
                if (currentPageIndex < totalPages - 1) {
                    goToPage(currentPageIndex + 1);
                } else {
                    localStorage.setItem('riviftSetupComplete', 'true');
                    isDarkMode = tempSettings.isDarkMode;
                    saveIsDarkMode();
                    aeroEffectEnabled = tempSettings.aeroEffectEnabled;
                    saveAeroEffectEnabled();
                    userName = tempSettings.userName;
                    osPassword = tempSettings.osPassword;
                    userIcon = tempSettings.userIcon;
                    passwordLoginEnabled = true;
                    osPasswordType = 'pin';
                    saveUserAccount();
                    saveOSPassword();
                    savePasswordLoginEnabled();
                    saveOSPasswordType();
                    setupScreen.style.opacity = '0';
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                }
            });
            const themeLight = setupScreen.querySelector('#theme-light');
            const themeDark = setupScreen.querySelector('#theme-dark');
            const aeroSwitch = setupScreen.querySelector('#setup-aero-switch');
            themeLight.addEventListener('click', () => {
                tempSettings.isDarkMode = false;
                themeLight.classList.add('selected');
                themeDark.classList.remove('selected');
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
            });
            themeDark.addEventListener('click', () => {
                tempSettings.isDarkMode = true;
                themeDark.classList.add('selected');
                themeLight.classList.remove('selected');
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
            });
            aeroSwitch.addEventListener('input', () => {
                tempSettings.aeroEffectEnabled = aeroSwitch.selected;
                document.body.classList.toggle('aero-enabled', tempSettings.aeroEffectEnabled);
            });
            const iconPreview = setupScreen.querySelector('#setup-icon-preview');
            iconPreview.addEventListener('click', () => {
                iconGrid.innerHTML = defaultUserIcons.map(url => `
                    <img src="${url}" class="w-16 h-16 rounded-full cursor-pointer border-4 ${url === tempSettings.userIcon.simpleUrl ? 'border-blue-500' : 'border-transparent'}" data-icon-url="${url}">
                `).join('');
                iconModalOverlay.style.display = 'flex';
                setTimeout(() => iconModalOverlay.classList.remove('hidden'), 10);
            });
            iconGrid.addEventListener('click', (e) => {
                if (e.target.tagName === 'IMG') {
                    tempSettings.userIcon.simpleUrl = e.target.dataset.iconUrl;
                    iconGrid.querySelectorAll('img').forEach(img => img.classList.replace('border-blue-500', 'border-transparent'));
                    e.target.classList.replace('border-transparent', 'border-blue-500');
                }
            });
            iconConfirmBtn.addEventListener('click', () => {
                iconPreview.innerHTML = `<img src="${tempSettings.userIcon.simpleUrl}">`;
                iconModalOverlay.classList.add('hidden');
                setTimeout(() => iconModalOverlay.style.display = 'none', 300);
            });
            iconModalOverlay.addEventListener('click', (e) => {
                if(e.target === iconModalOverlay) {
                    iconModalOverlay.classList.add('hidden');
                    setTimeout(() => iconModalOverlay.style.display = 'none', 300);
                }
            });
            const usernameInput = setupScreen.querySelector('#setup-username');
            const passwordInput = setupScreen.querySelector('#setup-password-pin');
            const validateAccountPage = () => {
                tempSettings.userName = usernameInput.value.trim();
                tempSettings.osPassword = passwordInput.value;
                nextBtn.disabled = !tempSettings.userName || tempSettings.osPassword.length < 4;
            };
            usernameInput.addEventListener('input', validateAccountPage);
            passwordInput.addEventListener('input', validateAccountPage);
            document.body.classList.toggle('aero-enabled', tempSettings.aeroEffectEnabled);
            goToPage(0);
        }
        function updateTime() {
            const now = new Date();
            const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: !timeFormat24Hour };
            currentTimeDisplay.textContent = now.toLocaleTimeString(systemLanguage, timeOptions);
            if (showDateOnTaskbar) {
                dateDisplay.classList.remove('hidden');
                const dateOptions = { year: 'numeric', month: 'short', day: 'numeric' };
                dateDisplay.textContent = now.toLocaleDateString(systemLanguage, dateOptions);
            } else {
                dateDisplay.classList.add('hidden');
            }
            if (isLocked) {
                const lockTimeOptions = { hour: '2-digit', minute: '2-digit', hour12: !timeFormat24Hour };
                lockScreenTimeDisplay.textContent = now.toLocaleTimeString(systemLanguage, lockTimeOptions);
                lockScreenDateDisplay.textContent = now.toLocaleDateString(systemLanguage, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
            if (autoThemeEnabled) {
                const currentHour = now.getHours();
                const newIsDarkMode = (currentHour >= 18 || currentHour < 6);
                if (isDarkMode !== newIsDarkMode) {
                    isDarkMode = newIsDarkMode;
                    applyTheme();
                    saveIsDarkMode();
                    const settingsWindow = document.getElementById('app-window-settings');
                    if (settingsWindow && settingsWindow.classList.contains('active')) {
                        const darkThemeToggle = settingsWindow.querySelector('[data-setting="dark-theme"]');
                        if (darkThemeToggle) darkThemeToggle.classList.toggle('active', isDarkMode);
                    }
                }
            }
            if (wallpaperSlideshowEnabled && slideshowIntervalId === null) {
                startWallpaperSlideshow();
            } else if (!wallpaperSlideshowEnabled && slideshowIntervalId !== null) {
                clearInterval(slideshowIntervalId);
                slideshowIntervalId = null;
            }
        }
function startWallpaperSlideshow() {
            if (slideshowIntervalId) clearInterval(slideshowIntervalId);
            if (!wallpaperSlideshowEnabled) return;
            const updateWallpaperAndAccent = async () => {
                currentWallpaperIndex = (currentWallpaperIndex + 1) % defaultWallpapers.length;
                currentWallpaper = defaultWallpapers[currentWallpaperIndex];
                osContainer.style.backgroundImage = `url('${currentWallpaper}')`;
                saveCurrentWallpaper();
                if (accentColorMode === 'auto') {
                    const dominantColor = await extractColorFromWallpaper(currentWallpaper);
                    if (dominantColor) {
                        currentAccentColor = dominantColor;
                        saveAccentColorSettings();
                        applyAccentColor(dominantColor);
                        const settingsWindow = document.getElementById('app-window-settings');
                        if (settingsWindow && settingsWindow.querySelector('#accent-preset-colors')) {
                            renderAccentColorUI();
                        }
                    }
                }
            };
            slideshowIntervalId = setInterval(updateWallpaperAndAccent, slideshowInterval * 1000);
        }
async function updateWallpaper(newWallpaperUrl, disableSlideshow = false) {
            osContainer.style.backgroundImage = `url('${newWallpaperUrl}')`;
            currentWallpaper = newWallpaperUrl;
            saveCurrentWallpaper();
            if (accentColorMode === 'auto') {
                const dominantColor = await extractColorFromWallpaper(newWallpaperUrl);
                if (dominantColor) {
                    currentAccentColor = dominantColor;
                    saveAccentColorSettings();
                    applyAccentColor(dominantColor);
                    const settingsWindow = document.getElementById('app-window-settings');
                    if (settingsWindow && settingsWindow.querySelector('#accent-preset-colors')) {
                        renderAccentColorUI();
                    }
                }
            }
            if (disableSlideshow && wallpaperSlideshowEnabled) {
                wallpaperSlideshowEnabled = false;
                saveWallpaperSlideshowEnabled();
                clearInterval(slideshowIntervalId);
                slideshowIntervalId = null;
                const settingsWindow = document.getElementById('app-window-settings');
                if (settingsWindow) {
                    const slideshowSwitch = settingsWindow.querySelector('#slideshow-switch');
                    const slideshowIntervalSetting = settingsWindow.querySelector('#slideshow-interval-setting');
                    if (slideshowSwitch) slideshowSwitch.selected = false;
                    if (slideshowIntervalSetting) slideshowIntervalSetting.classList.add('hidden');
                }
            }
        }        
function applyTheme() {
    document.body.classList.toggle('dark-mode', isDarkMode);
    document.body.classList.toggle('light-mode', !isDarkMode);
const settingsWindow = document.getElementById('app-window-settings');
if (settingsWindow) {
    const darkThemeSwitchInSettings = settingsWindow.querySelector('#dark-theme-switch');
    if (darkThemeSwitchInSettings) {
        darkThemeSwitchInSettings.selected = isDarkMode;
    }
}
    quickSettingsPanel.querySelectorAll('.quick-setting-tile').forEach(tile => {
        const isActive = tile.classList.contains('active');
        if (isDarkMode) {
            tile.style.backgroundColor = isActive ? 'var(--quick-setting-tile-bg-on-dark)' : 'var(--quick-setting-tile-bg-off-dark)';
            tile.style.color = isActive ? 'var(--quick-setting-tile-text-on-dark)' : 'var(--quick-setting-tile-text-off-dark)';
        } else {
            tile.style.backgroundColor = isActive ? 'var(--quick-setting-tile-bg-on-light)' : 'var(--quick-setting-tile-bg-off-light)';
            tile.style.color = isActive ? 'var(--quick-setting-tile-text-on-light)' : 'var(--quick-setting-tile-text-off-light)';
        }
    });
    if (allAppsFullscreen.classList.contains('active')) {
        allAppsFullscreen.style.backgroundColor = isDarkMode ? 'rgba(0,0,0,0.7)' : 'var(--panel-bg-light)';
        allAppsFullscreen.style.color = isDarkMode ? '#fff' : 'var(--text-color-light)';
        const allAppsHeaderH3 = allAppsFullscreen.querySelector('#all-apps-header h3');
        if (allAppsHeaderH3) allAppsHeaderH3.style.color = isDarkMode ? '#fff' : 'var(--text-color-light)';
        const searchBar = allAppsFullscreen.querySelector('#all-apps-search-bar');
        if (searchBar) {
            searchBar.style.backgroundColor = isDarkMode ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.05)';
            searchBar.style.color = isDarkMode ? '#fff' : 'var(--text-color-light)';
            searchBar.style.borderColor = isDarkMode ? 'transparent' : 'var(--border-color-light)';
        }
        allAppsFullscreen.querySelectorAll('.app-icon-fullscreen').forEach(icon => {
            icon.style.color = isDarkMode ? '#fff' : 'var(--text-color-light)';
            const iconBox = icon.querySelector('.icon-box');
            if (iconBox) {
                iconBox.style.backgroundColor = isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)';
                const iTag = iconBox.querySelector('i');
                if (iTag) iTag.style.color = isDarkMode ? '#fff' : 'var(--text-color-light)';
            }
        });
    }
    applyVisualEffects();
    updateAllQsToggles();
}
        function togglePanel(panel, otherPanel) {
            if (isLocked) return;
            const isActive = panel.classList.contains('active');
            if (otherPanel && otherPanel.classList.contains('active')) {
                otherPanel.classList.remove('active');
                otherPanel.classList.add('hidden');
            }
            panel.classList.toggle('active', !isActive);
            panel.classList.toggle('hidden', isActive);
        }
function closeAllPanels() {
    document.getElementById('quick-settings')?.classList.remove('active');
    document.getElementById('start-menu')?.classList.remove('active');
    document.getElementById('notification-center-panel')?.classList.remove('active');
}
function bringWindowToFront(windowElement) {
    if (!windowElement || !document.body.contains(windowElement)) return;
    let maxZ = 0;
    openApps.forEach(app => {
        if (app.windowElement) {
            const z = parseInt(app.windowElement.style.zIndex || '0', 10);
            if (z > maxZ) {
                maxZ = z;
            }
        }
    });
    const currentZ = parseInt(windowElement.style.zIndex || '0', 10);
    if (currentZ <= maxZ) {
        zIndexCounter = maxZ + 1;
        windowElement.style.zIndex = zIndexCounter;
    }
    if (activeWindow && activeWindow !== windowElement) {
        const prevAppId = activeWindow.id;
        if (openApps.has(prevAppId) && openApps.get(prevAppId).state === 'active') {
             openApps.get(prevAppId).state = 'hidden';
        }
    }
    activeWindow = windowElement;
    const currentAppId = windowElement.id;
    if (openApps.has(currentAppId)) {
         openApps.get(currentAppId).state = 'active';
    }
    updateTaskbarAppStatus();
}
function handleTaskbarIconClick(appId) {
    const activeDesktop = desktops.find(d => d.id === activeDesktopId) || { windowIds: [] };
    const windowIdsOnThisDesktop = new Set(activeDesktop.windowIds);
    const instances = Array.from(openApps.keys()).filter(key => 
        key.startsWith(`app-window-${appId}`) && windowIdsOnThisDesktop.has(key)
    );
    if (instances.length > 0) {
        const targetWindowId = instances[0];
        const appData = openApps.get(targetWindowId);
        const windowElement = appData.windowElement;
        if (appData.state === 'minimized') {
            restoreWindowFromTaskbar(windowElement);
        } else if (windowElement === activeWindow) {
            windowElement.querySelector('.window-control-btn.minimize')?.click();
        } else {
            bringWindowToFront(windowElement);
        }
    } else {
        launchApp(appId);
    }
    updateTaskbarAppStatus();
}
function restoreWindowFromTaskbar(windowElement) {
    if (!windowElement) return;
    const appData = openApps.get(windowElement.id);
    if (!appData || appData.state !== 'minimized') return;
    const baseAppId = windowElement.id.replace(/-\d+$/, '').replace('app-window-', '');
    const taskbarIcon = document.querySelector(`.taskbar-icon[data-app="${baseAppId}"]`);
    windowElement.style.display = 'flex';
    appData.state = 'active';
    if (taskbarIcon) {
        const iconRect = taskbarIcon.getBoundingClientRect();
        let finalRect = appData.originalPos;
        if (appData.wasMaximized) {
            const taskbarHeight = taskbarAlwaysVisible ? taskbar.offsetHeight : 0;
            finalRect = { x: 0, y: 0, width: window.innerWidth, height: window.innerHeight - taskbarHeight };
        } else if (appData.wasSnapped) {
        }
        windowElement.style.transition = 'none';
        const scaleX = iconRect.width / finalRect.width;
        const scaleY = iconRect.height / finalRect.height;
        const translateX = iconRect.left - finalRect.x;
        const translateY = iconRect.top - finalRect.y;
        windowElement.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scaleX}, ${scaleY})`;
        windowElement.style.opacity = '0';
        requestAnimationFrame(() => {
            windowElement.style.transition = 'transform 0.35s cubic-bezier(0, .75, .25, 1), opacity 0.35s';
            windowElement.style.transform = 'translate(0, 0) scale(1)';
            windowElement.style.opacity = '1';
        });
    }
    windowElement.classList.add('active');
    if (appData.wasMaximized) windowElement.classList.add('maximized');
    bringWindowToFront(windowElement);
    updateTaskbarAppStatus();
}
const spotlightOverlay = document.getElementById('spotlight-overlay');
const spotlightInput = document.getElementById('spotlight-input');
const spotlightResults = document.getElementById('spotlight-results');
const spotlightBtn = document.getElementById('spotlight-btn');
let spotlightVisible = false;
let showSpotlightButton = JSON.parse(localStorage.getItem('riviftShowSpotlightButton')) !== false;
let currentSearchId = 0;
function applySpotlightButtonVisibility() {
    spotlightBtn.style.display = showSpotlightButton ? 'flex' : 'none';
}
function saveShowSpotlightButton() {
    localStorage.setItem('riviftShowSpotlightButton', JSON.stringify(showSpotlightButton));
}
function toggleSpotlight() {
    spotlightVisible = !spotlightVisible;
    if (spotlightVisible) {
        spotlightOverlay.classList.remove('hidden');
        spotlightOverlay.classList.add('flex');
        requestAnimationFrame(() => {
            spotlightOverlay.classList.add('visible');
        });
        spotlightInput.value = '';
        spotlightResults.innerHTML = '';
        spotlightInput.focus();
    } else {
        spotlightOverlay.classList.remove('visible');
        setTimeout(() => {
            spotlightOverlay.classList.add('hidden');
            spotlightOverlay.classList.remove('flex');
        }, 300);
    }
}
VFS.search = async function(query) {
    return new Promise((resolve) => {
        if (!this.db) return resolve([]);
        const transaction = this.db.transaction(['files'], 'readonly');
        const store = transaction.objectStore('files');
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => resolve([]);
    });
};
function launchAppByFileType(fileData) {
    if (!fileData || !fileData.type) {
        createNotification('', `${fileData.name}`, 'error');
        return; 
    }
    const appMap = { 
        'image/': 'image-viewer', 
        'audio/': 'music-player', 
        'video/': 'media-player', 
        'text/plain': 'text-reader', 
        'text/html': 'html-editor'
    };
    for (const [typePrefix, appId] of Object.entries(appMap)) {
        if (fileData.type.startsWith(typePrefix)) {
            return launchApp(appId, { path: fileData.path });
        }
    }
    const parentPath = fileData.path.substring(0, fileData.path.lastIndexOf('/')) || '/';
    launchApp('files', { path: parentPath, select: fileData.path });
}
async function renderSpotlightResults(query) {
    const searchId = ++currentSearchId;
    const searchIcon = spotlightOverlay.querySelector('.fa-search, .fa-spinner');
    if (searchIcon) {
        searchIcon.classList.remove('fa-search');
        searchIcon.classList.add('fa-spinner', 'fa-spin');
    }
    spotlightResults.innerHTML = '';
    if (!query) {
        if (searchIcon) {
            searchIcon.classList.remove('fa-spinner', 'fa-spin');
            searchIcon.classList.add('fa-search');
        }
        return;
    }
    const lowerQuery = query.toLowerCase();
    const fragment = document.createDocumentFragment();
    let calculatorResult = null;
    try {
        const result = new Function(`return ${query.replace(/[^0-9\+\-\*\/\.\(\)]/g, '')}`)();
        if (typeof result === 'number' && !isNaN(result) && isFinite(result)) {
            calculatorResult = result;
        }
    } catch (e) {  }
    if (calculatorResult !== null) {
        const item = document.createElement('div');
        item.className = 'flex items-center p-3 spotlight-result-item cursor-pointer';
        item.innerHTML = `<i class="fas fa-calculator text-2xl w-10 text-center mr-4"></i><div><p class="font-semibold text-2xl">${calculatorResult}</p><p class="text-xs text-gray-400"> ()</p></div>`;
        item.onclick = () => { navigator.clipboard.writeText(calculatorResult.toString()); createNotification('', calculatorResult, 'info'); toggleSpotlight(); };
        fragment.appendChild(item);
    }
    const appResults = apps.filter(app => app.installed && app.name.toLowerCase().includes(lowerQuery));
    appResults.forEach(app => {
        const item = document.createElement('div');
        item.className = 'flex items-center p-3 cursor-pointer spotlight-result-item';
        item.innerHTML = `<i class="${app.icon} text-2xl w-10 text-center mr-4"></i><div><p class="font-semibold">${app.name}</p><p class="text-xs text-gray-400"></p></div>`;
        item.onclick = () => { launchApp(app.id); toggleSpotlight(); };
        fragment.appendChild(item);
    });
    if (fragment.childElementCount > 0) {
        spotlightResults.appendChild(fragment);
    } else {
        spotlightResults.innerHTML = `<div class="p-4 text-center text-gray-500">...</div>`;
    }
    const allFiles = await searchWithWorker('');
    const fileResults = allFiles.filter(file => file.name.toLowerCase().includes(lowerQuery)).slice(0, 5);
    if (searchId !== currentSearchId) {
        return;
    }
    const fileFragment = document.createDocumentFragment();
fileResults.forEach(file => {
    if (!file || !file.name) {
        return; 
    }
    const item = document.createElement('div');
    item.className = 'flex items-center p-3 cursor-pointer spotlight-result-item';
    const iconClass = getIconForType(file.type || 'unknown');
    const parentPath = file.parent || '';
    item.innerHTML = `<i class="${iconClass} text-2xl w-10 text-center mr-4"></i><div><p class="font-semibold">${file.name}</p><p class="text-xs text-gray-400">${parentPath}</p></div>`;
    item.onclick = async () => {
        try {
            const fullFileData = await readFileWithWorker(file.path);
            if (fullFileData) {
                launchAppByFileType(fullFileData);
                toggleSpotlight();
            } else {
                throw new Error('');
            }
        } catch (err) {
            console.error('Spotlight:', err);
            createNotification('', `${file.name}`, 'error');
            toggleSpotlight();
        }
    };
    fileFragment.appendChild(item);
});
    if (fileFragment.childElementCount > 0) {
        if (spotlightResults.querySelector('.text-gray-500')) {
            spotlightResults.innerHTML = '';
            spotlightResults.appendChild(fragment);
        }
        spotlightResults.appendChild(fileFragment);
    }
    if (spotlightResults.childElementCount === 0) {
        spotlightResults.innerHTML = `<div class="p-4 text-center text-gray-500"></div>`;
    }
    if (searchIcon) {
        searchIcon.classList.remove('fa-spinner', 'fa-spin');
        searchIcon.classList.add('fa-search');
    }
    const firstResult = spotlightResults.querySelector('.spotlight-result-item');
    if (firstResult) {
        firstResult.classList.add('bg-blue-600/50');
    }
}
document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.code === 'Space') {
        e.preventDefault();
        toggleSpotlight();
    }
    if (!spotlightVisible) return;
    const results = Array.from(spotlightResults.querySelectorAll('.spotlight-result-item'));
    let currentIndex = results.findIndex(item => item.classList.contains('bg-blue-600/50'));
    if (e.key === 'Escape') {
        toggleSpotlight();
    } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (results.length > 0) {
            const nextIndex = (currentIndex + 1) % results.length;
            results[currentIndex]?.classList.remove('bg-blue-600/50');
            results[nextIndex]?.classList.add('bg-blue-600/50');
        }
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (results.length > 0) {
            const prevIndex = (currentIndex - 1 + results.length) % results.length;
            results[currentIndex]?.classList.remove('bg-blue-600/50');
            results[prevIndex]?.classList.add('bg-blue-600/50');
        }
    } else if (e.key === 'Enter') {
        e.preventDefault();
        if (currentIndex !== -1 && results[currentIndex]) {
            results[currentIndex].click();
        }
    }
});
spotlightInput.addEventListener('input', () => renderSpotlightResults(spotlightInput.value));
spotlightOverlay.addEventListener('click', (e) => { if (e.target === spotlightOverlay) toggleSpotlight(); });
spotlightBtn.addEventListener('click', toggleSpotlight);
applySpotlightButtonVisibility();
function createWindow(id, title, contentHtml, width = 600, height = 400, isResizable = true) {
    let windowElement = document.getElementById(id);
    const appDataFromMap = openApps.get(id);
    if (windowElement && appDataFromMap) {
        bringWindowToFront(windowElement);
        if (appDataFromMap.state === 'minimized') {
            windowElement.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
            windowElement.classList.add('active');
            appDataFromMap.state = 'active';
            updateTaskbarAppStatus();
            setTimeout(() => {
                windowElement.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out, width 0.2s ease, height 0.2s ease, border-radius 0.3s ease';
            }, 300);
        }
        bringWindowToFront(windowElement);
        return windowElement;
    }
    windowElement = document.createElement('div');
    windowElement.id = id;
    windowElement.classList.add('app-window');
    windowElement.classList.add('glass-effect');//
    windowElement.style.width = `${width}px`;
    windowElement.style.height = `${height}px`;
    windowElement.style.left = `calc(50% - ${width / 2}px)`;
    windowElement.style.top = `calc(50% - ${height / 2}px)`;
    const headerClass = id === 'app-window-settings' ? 'window-header settings-header' : 'window-header';
    windowElement.innerHTML = `
      <div class="${headerClass}">
        <div class="window-controls">
            <div class="window-control-btn close" title=""><i class="fas fa-times"></i></div>
            <div class="window-control-btn minimize" title=""><i class="fas fa-minus"></i></div>
            <div class="window-control-btn maximize" title=""><i class="fas fa-expand"></i></div>
        </div>
        <span>${title}</span>
       </div>
       <div class="window-content-wrapper">
           <div class="window-content">
             ${contentHtml}
           </div>
       </div>
    `;
    if (id !== 'app-window-settings') {
        const contentWrapper = windowElement.querySelector('.window-content-wrapper');
        const actualContent = windowElement.querySelector('.window-content');
        contentWrapper.parentNode.replaceChild(actualContent, contentWrapper);
    }
    desktop.appendChild(windowElement);
    setTimeout(() => {
        windowElement.classList.add('active');
        bringWindowToFront(windowElement);
    }, 10);
    const appLaunchData = {
        windowElement: windowElement,
        state: 'active',
        isMaximized: false,
        isSnapped: null,
        originalPos: {
            x: windowElement.offsetLeft,
            y: windowElement.offsetTop,
            width: width,
            height: height
        }
    };
    openApps.set(id, appLaunchData);
    const activeDesktop = desktops.find(d => d.id === activeDesktopId);
    if (activeDesktop && !activeDesktop.windowIds.includes(id)) {
        activeDesktop.windowIds.push(id);
    }    
    if (!isResizable) {
        windowElement.style.resize = 'none';
    }
    updateTaskbarAppStatus();
    addRecentItem(id.replace('app-window-', ''), title, apps.find(a => a.id === id.replace('app-window-', ''))?.icon || 'fas fa-window-maximize');
    const header = windowElement.querySelector('.window-header');
    const closeBtn = windowElement.querySelector('.window-control-btn.close');
    const minimizeBtn = windowElement.querySelector('.window-control-btn.minimize');
    const maximizeBtn = windowElement.querySelector('.window-control-btn.maximize');
    let offsetX = 0;
    let offsetY = 0;
const onMouseDown = (e) => {
    if (e.target.closest('.window-controls')) return;
    document.body.classList.add('slider-dragging');
    bringWindowToFront(windowElement);
    const appData = openApps.get(id);
    if (appData.isMaximized || appData.isSnapped) {
        const restoredWidth = appData.originalPos.width;
        windowElement.style.width = `${restoredWidth}px`;
        windowElement.style.height = `${appData.originalPos.height}px`;
        windowElement.style.left = `${e.clientX - (restoredWidth / 2)}px`;
        windowElement.style.top = `${e.clientY - 20}px`; 
        windowElement.classList.remove('maximized');
        windowElement.style.resize = 'both';
        windowElement.style.transition = 'none';
        appData.isMaximized = false;
        if (appData.isSnapped) {
            appData.isSnapped = null;
            updateWindowResizer();
        }
    }
    offsetX = e.clientX - windowElement.getBoundingClientRect().left;
    offsetY = e.clientY - windowElement.getBoundingClientRect().top;
    header.style.cursor = 'grabbing';
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
};
const onMouseMove = (e) => {
    windowElement.style.left = `${e.clientX - offsetX}px`;
    windowElement.style.top = `${e.clientY - offsetY}px`;
    handleDragPreview(e);
};
    const onMouseUp = (e) => {
        header.style.cursor = 'grab';
        document.body.classList.remove('slider-dragging');
        handleSnapFinal(e, windowElement);
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        header.onmouseup = null; 
    };
    const handleDragPreview = (e) => {
        const previewBox = document.getElementById('maximize-preview-box');
        const snapThreshold = 10;
        let snapType = null;
        if (e.clientY <= snapThreshold) snapType = 'top';
        else if (e.clientX <= snapThreshold) snapType = 'left';
        else if (e.clientX >= window.innerWidth - snapThreshold) snapType = 'right';
        if(snapType) {
            const taskbarHeight = taskbarAlwaysVisible ? taskbar.offsetHeight : 0;
            const desktopHeightStyle = `calc(100vh - ${taskbarHeight}px)`;
            if(snapType === 'top') {
                Object.assign(previewBox.style, { width: '100vw', height: desktopHeightStyle, left: '0px', top: '0px' });
            } else if (snapType === 'left') {
                Object.assign(previewBox.style, { width: '50vw', height: desktopHeightStyle, left: '0px', top: '0px' });
            } else if (snapType === 'right') {
                Object.assign(previewBox.style, { width: '50vw', height: desktopHeightStyle, left: '50vw', top: '0px' });
            }
            previewBox.classList.add('active');
        } else {
            previewBox.classList.remove('active');
        }
    };
    const handleSnapFinal = (e, winEl) => {
        const previewBox = document.getElementById('maximize-preview-box');
        previewBox.classList.remove('active');
        const snapThreshold = 10;
        let snapType = null;
        if (e.clientY <= snapThreshold) snapType = 'top';
        else if (e.clientX <= snapThreshold) snapType = 'left';
        else if (e.clientX >= window.innerWidth - snapThreshold) snapType = 'right';
        if (snapType === 'top') applySnapLayout(winEl, 'full');
        if (snapType === 'left') applySnapLayout(winEl, 'half-left');
        if (snapType === 'right') applySnapLayout(winEl, 'half-right');
    };
    header.addEventListener('mousedown', onMouseDown);
closeBtn.addEventListener('click', async () => {
    const appData = openApps.get(id);
    if (appData && typeof appData.hasUnsavedChanges === 'function' && appData.hasUnsavedChanges()) {
        const confirmClose = await showMessageBox(
            '',
            `${title}`,
            { showCancel: true }
        );
        if (!confirmClose) return;
    }
    if (id === 'app-window-connect') {
        if (typeof endCall === 'function') {
            endCall(true);
        }
    }
    if (id.startsWith('app-window-music-player') && openApps.has(id)) {
        const appData = openApps.get(id);
        if (appData && appData.audio) { appData.audio.pause(); appData.audio.src = ''; }
    }
    header.removeEventListener('mousedown', onMouseDown);
    windowElement.classList.remove('active');
    setTimeout(() => {
        const appData = openApps.get(id);
        const wasSnapped = appData?.isSnapped;
        windowElement.remove();
        openApps.delete(id);
        const baseAppId = id.replace(/-\d+$/, '').replace('app-window-', '');
        if (!pinnedApps.includes(baseAppId)) {
            let isOtherInstanceOpen = false;
            openApps.forEach((val, key) => { if (key.startsWith(`app-window-${baseAppId}`)) isOtherInstanceOpen = true; });
            if (!isOtherInstanceOpen) {
                document.querySelector(`.taskbar-icon[data-app="${baseAppId}"]`)?.remove();
            }
        }
        if (wasSnapped) updateWindowResizer();
        updateTaskbarAppStatus();
        if (activeWindow === windowElement) activeWindow = null;
    }, 400);
});
    minimizeBtn.addEventListener('click', () => {
        const appData = openApps.get(id);
        if (!appData) return;
        appData.wasMaximized = appData.isMaximized;
        appData.wasSnapped = appData.isSnapped;
        const baseAppId = id.replace(/-\d+$/, '').replace('app-window-', '');
        const taskbarIcon = document.querySelector(`.taskbar-icon[data-app="${baseAppId}"]`);
        if (taskbarIcon) {
            const iconRect = taskbarIcon.getBoundingClientRect();
            const winRect = windowElement.getBoundingClientRect();
            const scaleX = iconRect.width / winRect.width;
            const scaleY = iconRect.height / winRect.height;
            const translateX = iconRect.left - winRect.left;
            const translateY = iconRect.top - winRect.top;
            windowElement.style.transition = 'transform 0.35s cubic-bezier(0.55, 0, 1, 0.45), opacity 0.35s';
            windowElement.style.transformOrigin = 'top left'; 
            windowElement.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scaleX}, ${scaleY})`;
            windowElement.style.opacity = '0';
            setTimeout(() => {
                windowElement.classList.remove('active');
                windowElement.style.display = 'none';
                appData.state = 'minimized';
                updateTaskbarAppStatus();
            }, 350);
        } else {
            windowElement.classList.remove('active');
            windowElement.style.display = 'none';
            appData.state = 'minimized';
            updateTaskbarAppStatus();
        }
    });
    maximizeBtn.addEventListener('click', () => {
        const appData = openApps.get(id);
        if (appData.isMaximized || appData.isSnapped) {
            applySnapLayout(windowElement, 'restore');
        } else {
            applySnapLayout(windowElement, 'full');
        }
    });
    maximizeBtn.addEventListener('mouseenter', () => showSnapPopup(maximizeBtn, windowElement));
    maximizeBtn.addEventListener('mouseleave', () => hideSnapPopup());
    windowElement.addEventListener('mousedown', () => bringWindowToFront(windowElement));
    bringWindowToFront(windowElement);
    return windowElement;
}
function createWidget(type, initialData = {}) {
    const def = widgetDefinitions[type];
    if (!def) return;
    const newWidget = {
        id: `widget-${type}-${Date.now()}`,
        type: type,
        x: initialData.x || Math.random() * (desktop.clientWidth - (def.defaultWidth || 200)),
        y: initialData.y || Math.random() * (desktop.clientHeight - (def.defaultHeight || 200)),
        zIndex: zIndexCounter++,
        width: initialData.width || def.defaultWidth || 200,
        height: initialData.height || def.defaultHeight || 200,
        data: initialData.data || {} 
    };
    desktopWidgets.push(newWidget);
    saveDesktopWidgets();
    renderWidgets();
    if (autoAlignWidgets) {
        setTimeout(() => {
            alignAllWidgets();
        }, 100);
    }    
}
function renderWidgets() {
    desktop.querySelectorAll('.desktop-widget').forEach(w => w.remove());
    desktopWidgets.forEach((widgetData, index) => {
        const def = widgetDefinitions[widgetData.type];
        if (!def) return;
        const widgetEl = document.createElement('div');
        widgetEl.id = widgetData.id;
        widgetEl.className = 'desktop-widget glass-effect';
        widgetEl.style.cssText = `
        position: absolute;
        left: ${widgetData.x}px;
        top: ${widgetData.y}px;
        z-index: 0; 
        width: ${widgetData.width}px;
        height: ${widgetData.height}px;
            padding: 15px; border-radius: 15px; user-select: none;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        `;
        def.init(widgetEl, widgetData);
        widgetEl.addEventListener('mousedown', (e) => {
            if (e.target.closest('.widget-resize-handle, button, textarea, input, a')) return;
            e.preventDefault();
            const startX = e.clientX, startY = e.clientY;
            const initialLeft = widgetEl.offsetLeft, initialTop = widgetEl.offsetTop;
            const onMouseMove = (moveEvent) => {
                widgetEl.style.left = `${initialLeft + (moveEvent.clientX - startX)}px`;
                widgetEl.style.top = `${initialTop + (moveEvent.clientY - startY)}px`;
            };
            const onMouseUp = () => {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                desktopWidgets[index].x = widgetEl.offsetLeft;
                desktopWidgets[index].y = widgetEl.offsetTop;
                saveDesktopWidgets(); 
            };
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
        widgetEl.addEventListener('contextmenu', (e) => {
            e.preventDefault(); e.stopPropagation();
            showContextMenu([{
                label: '', icon: 'fas fa-trash',
                action: () => {
                    desktopWidgets.splice(index, 1);
                    saveDesktopWidgets();
                    renderWidgets();
                }
            }], e);
        });
        desktop.appendChild(widgetEl);
    });
    updateAllWidgets();
}
function updateAllWidgets() {
    desktop.querySelectorAll('.desktop-widget').forEach(widgetEl => {
        const widgetData = desktopWidgets.find(w => w.id === widgetEl.id);
        const def = widgetDefinitions[widgetData?.type];
        if (widgetData && def) {
            def.update(widgetEl, widgetData);
        }
    });
}
let autoAlignWidgets = JSON.parse(localStorage.getItem('riviftAutoAlignWidgets')) || false;
function saveAutoAlignWidgets() { localStorage.setItem('riviftAutoAlignWidgets', JSON.stringify(autoAlignWidgets)); }
function toggleWidgetAlignment() {
    autoAlignWidgets = !autoAlignWidgets;
    saveAutoAlignWidgets();
    if (autoAlignWidgets) {
        alignAllWidgets();
    }
}
function alignAllWidgets() {
    const PADDING = 15;
    let currentY = PADDING;
    const sortedWidgets = [...desktopWidgets].sort((a, b) => a.zIndex - b.zIndex);
    sortedWidgets.forEach(widgetData => {
        const widgetEl = document.getElementById(widgetData.id);
        if (widgetEl) {
            widgetData.y = currentY;
            widgetEl.style.transition = 'top 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
            widgetEl.style.top = `${currentY}px`;
            widgetData.x = PADDING;
            widgetEl.style.left = `${PADDING}px`;
            currentY += widgetEl.offsetHeight + PADDING;
            setTimeout(() => {
                if (widgetEl) widgetEl.style.transition = '';
            }, 400);
        }
    });
    saveDesktopWidgets();
}
let isMissionControlActive = false;
let missionControlOverlay = null;
const missionControlHandlers = new Map();
function layoutMissionControl(animate = false) {
    const visibleWindows = Array.from(openApps.values())
        .filter(app => (app.state === 'active' || app.state === 'hidden') && app.windowElement && document.body.contains(app.windowElement))
        .map(app => app.windowElement);
    if (visibleWindows.length === 0 && isMissionControlActive) {
        toggleMissionControl();
        return;
    }
    const numWindows = visibleWindows.length;
    const padding = 80;
    const availableWidth = desktop.clientWidth - padding * 2;
    const availableHeight = desktop.clientHeight - padding * 2;
    const cols = Math.ceil(Math.sqrt(numWindows * (availableWidth / availableHeight)));
    const rows = Math.ceil(numWindows / cols);
    const cellWidth = availableWidth / cols;
    const cellHeight = availableHeight / rows;
    visibleWindows.forEach((win, i) => {
        if (!animate) win.style.transition = 'none';
        const originalWidth = win.offsetWidth, originalHeight = win.offsetHeight;
        const aspectRatio = originalWidth / originalHeight;
        let newWidth, newHeight;
        if ((cellWidth / cellHeight) > aspectRatio) { newHeight = cellHeight * 0.8; newWidth = newHeight * aspectRatio; } 
        else { newWidth = cellWidth * 0.8; newHeight = newWidth / aspectRatio; }
        const newX = padding + (i % cols) * cellWidth + (cellWidth - newWidth) / 2;
        const newY = padding + Math.floor(i / cols) * cellHeight + (cellHeight - newHeight) / 2;
        const scale = newWidth / originalWidth;
        const translateX = newX - win.offsetLeft;
        const translateY = newY - win.offsetTop;
        win.style.transformOrigin = 'top left';
        win.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
        win.style.setProperty('--mc-scale', 1 / scale);
        if (!animate) setTimeout(() => { win.style.transition = ''; }, 50);
    });
}
function toggleMissionControl() {
    if (isMissionControlActive) {
        closeMissionControl(activeWindow); 
    } else {
        openMissionControl();
    }
}
function openMissionControl() {
    if (isMissionControlActive) return;
    isMissionControlActive = true;
    activeWindow = null;
    if (!missionControlOverlay) {
        missionControlOverlay = document.createElement('div');
        missionControlOverlay.id = 'mission-control-overlay';
        desktop.appendChild(missionControlOverlay);
        missionControlOverlay.addEventListener('click', (e) => {
            if (e.target === missionControlOverlay) {
                closeMissionControl(null);
            }
        });
    }
    missionControlOverlay.classList.add('active');
    renderDesktopBar();
    const activeDesktop = desktops.find(d => d.id === activeDesktopId);
    const visibleWindows = (activeDesktop ? activeDesktop.windowIds : [])
        .map(id => openApps.get(id)?.windowElement)
        .filter(win => win && (openApps.get(win.id)?.state === 'active' || openApps.get(win.id)?.state === 'hidden'));
    visibleWindows.forEach(win => {
        const closeBtn = document.createElement('button');
        closeBtn.className = 'mc-close-btn';
        closeBtn.innerHTML = '&times;';
        win.appendChild(closeBtn);
        const selectWindow = (e) => {
            e.stopPropagation();
            closeMissionControl(win); 
        };
        const closeWindow = (e) => {
            e.stopPropagation();
            const windowId = win.id;
            win.removeEventListener('click', missionControlHandlers.get(win).selectWindow);
            missionControlHandlers.delete(win);
            if (openApps.has(windowId)) {
                openApps.get(windowId).windowElement.querySelector('.close').click();
            }
            win.remove();
            updateTaskbarAppStatus();
            setTimeout(() => layoutMissionControl(false), 50);
        };
        const stopPropagationOnMouseDown = (e) => {
            e.stopPropagation();
        };
        win.addEventListener('click', selectWindow);
        closeBtn.addEventListener('mousedown', stopPropagationOnMouseDown);
        closeBtn.addEventListener('click', closeWindow);
        missionControlHandlers.set(win, { selectWindow, closeWindow, stopPropagationOnMouseDown });
        win.classList.add('in-mission-control');
        win.dataset.originalZIndex = win.style.zIndex;
        win.style.zIndex = 11001;
    });
    layoutMissionControl(true);
}
function closeMissionControl(windowToActivate = null) {
    if (!isMissionControlActive) return;
    isMissionControlActive = false;
    missionControlOverlay.classList.remove('active');
    missionControlHandlers.forEach((handlers, win) => {
        if (document.body.contains(win)) {
            win.classList.remove('in-mission-control');
            win.style.transform = 'none';
            win.querySelector('.mc-close-btn')?.remove();
            win.removeEventListener('click', handlers.selectWindow);
            const closeBtn = win.querySelector('.mc-close-btn');
            if (closeBtn) {
                closeBtn.removeEventListener('mousedown', handlers.stopPropagationOnMouseDown);
                closeBtn.removeEventListener('click', handlers.closeWindow);
            }
            setTimeout(() => {
                if (document.body.contains(win)) {
                    win.style.zIndex = win.dataset.originalZIndex || 1;
                }
            }, 400);
        }
    });
    missionControlHandlers.clear();
    setTimeout(() => {
        if (windowToActivate && document.body.contains(windowToActivate)) {
            bringWindowToFront(windowToActivate);
        }
        activeWindow = windowToActivate;
    }, 400);
}
function renderDesktopBar() {
    let desktopBar = document.getElementById('mc-desktop-bar');
    if (!desktopBar) {
        desktopBar = document.createElement('div');
        desktopBar.id = 'mc-desktop-bar';
        desktopBar.className = 'absolute top-0 left-0 right-0 h-40 flex items-center justify-center gap-4 p-4 z-[11002]';
        missionControlOverlay.prepend(desktopBar);
    }
    desktopBar.innerHTML = '';
    desktopBar.addEventListener('click', (e) => {
        e.stopPropagation();
    });
    desktops.forEach(desktop => {
        const desktopContainer = document.createElement('div');
        desktopContainer.className = 'group relative flex flex-col items-center gap-1';
        const desktopPreview = document.createElement('div');
        desktopPreview.className = 'relative w-48 h-28 bg-black/20 border-2 rounded-lg cursor-pointer transition-all hover:border-blue-400 overflow-hidden';
        desktopPreview.style.borderColor = (desktop.id === activeDesktopId) ? '#007bff' : 'transparent';
        const wallpaperPreview = document.createElement('div');
        wallpaperPreview.className = 'absolute inset-0';
        wallpaperPreview.style.backgroundImage = osContainer.style.backgroundImage;
        wallpaperPreview.style.backgroundSize = 'cover';
        wallpaperPreview.style.backgroundPosition = 'center';
        desktopPreview.appendChild(wallpaperPreview);
        desktop.windowIds.forEach(winId => {
            const appData = openApps.get(winId);
            if (appData && appData.state !== 'minimized') {
                const win = appData.windowElement;
                const miniWin = document.createElement('div');
                miniWin.className = 'absolute';
                miniWin.style.cssText = win.style.cssText;
                miniWin.style.transform = '';
                miniWin.style.transition = 'none';
                miniWin.innerHTML = win.innerHTML;
                const scaleFactor = 192 / window.innerWidth;
                miniWin.style.transform = `scale(${scaleFactor})`;
                miniWin.style.transformOrigin = 'top left';
                miniWin.style.pointerEvents = 'none';
                wallpaperPreview.appendChild(miniWin);
            }
        });
        const desktopNameInput = document.createElement('input');
        desktopNameInput.type = 'text';
        desktopNameInput.value = desktop.name;
        desktopNameInput.className = 'w-full bg-transparent text-white text-xs text-center border-none outline-none p-1 rounded hover:bg-white/10 focus:bg-white/20';
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '&times;';
        deleteBtn.className = 'absolute top-1 right-1 w-5 h-5 bg-gray-700/50 text-white rounded-full text-xs hidden group-hover:flex items-center justify-center hover:bg-red-500';
        desktopContainer.appendChild(desktopPreview);
        desktopContainer.appendChild(desktopNameInput);
        desktopPreview.appendChild(deleteBtn);
        desktopBar.appendChild(desktopContainer);
        desktopPreview.addEventListener('click', () => {
            switchDesktop(desktop.id);
        });
        desktopNameInput.onclick = (e) => e.stopPropagation();
        desktopNameInput.onchange = (e) => { desktop.name = e.target.value; };
        deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteDesktop(desktop.id);
        });
    });
    const addBtn = document.createElement('div');
    addBtn.className = 'w-24 h-28 bg-black/20 border-2 border-dashed border-gray-600 rounded-lg flex items-center justify-center text-3xl text-gray-400 cursor-pointer hover:bg-white/10 self-start mt-1';
    addBtn.innerHTML = '+';
    addBtn.onclick = () => addDesktop();
    desktopBar.appendChild(addBtn);
}
function addDesktop() {
    const newDesktop = { id: `desktop-${Date.now()}`, name: ` ${desktops.length + 1}`, windowIds: [] };
    desktops.push(newDesktop);
    renderDesktopBar();
}
function deleteDesktop(desktopId) {
    if (desktops.length <= 1) { createNotification('', '', 'error'); return; }
    const index = desktops.findIndex(d => d.id === desktopId);
    if (index > -1) {
        const desktopToDelete = desktops[index];
        desktopToDelete.windowIds.forEach(winId => { openApps.get(winId)?.windowElement.querySelector('.close').click(); });
        desktops.splice(index, 1);
        if (activeDesktopId === desktopId) {
            activeDesktopId = desktops[0].id;
        }
        layoutMissionControl(false);
        renderDesktopBar();
    }
}
function switchDesktop(desktopId) {
    if (activeDesktopId === desktopId && !isMissionControlActive) return;
    activeDesktopId = desktopId;
    openApps.forEach(appData => {
        if (appData.windowElement) appData.windowElement.style.display = 'none';
    });
    const newActiveDesktop = desktops.find(d => d.id === desktopId);
    if (newActiveDesktop) {
        newActiveDesktop.windowIds.forEach(winId => {
            const appData = openApps.get(winId);
            if (appData && appData.state !== 'minimized') {
                appData.windowElement.style.display = 'flex';
            }
        });
    }
    if (isMissionControlActive) {
        closeMissionControl(null); 
    }
    updateTaskbarAppStatus();
}
function applySnapLayout(windowEl, layout) {
    if (!windowEl) return;
    const appData = openApps.get(windowEl.id);
    if (!appData) return;
    if (!appData.isMaximized && !appData.isSnapped) {
        appData.originalPos = {
            x: windowEl.offsetLeft,
            y: windowEl.offsetTop,
            width: windowEl.offsetWidth,
            height: windowEl.offsetHeight
        };
    }
    windowEl.style.transition = 'all 0.2s ease-out';
    const taskbarHeight = taskbarAlwaysVisible ? taskbar.offsetHeight : 0;
    const desktopHeight = window.innerHeight - taskbarHeight;
    const desktopWidth = window.innerWidth;
    let newStyles = {};
    let isSnapped = null;
    let isMaximized = false;
    newStyles.transform = 'none'; 
    switch (layout) {
        case 'full':
            newStyles.width = '100vw';
            newStyles.height = `${desktopHeight}px`;
            newStyles.left = '0px';
            newStyles.top = '0px';
            isMaximized = true;
            break;
        case 'restore':
            newStyles.width = `${appData.originalPos.width}px`;
            newStyles.height = `${appData.originalPos.height}px`;
            newStyles.left = `${appData.originalPos.x}px`;
            newStyles.top = `${appData.originalPos.y}px`;
            break;
        case 'half-left':
            newStyles.width = `${desktopWidth / 2}px`;
            newStyles.height = `${desktopHeight}px`;
            newStyles.left = '0px';
            newStyles.top = '0px';
            isSnapped = 'left';
            break;
        case 'half-right':
            newStyles.width = `${desktopWidth / 2}px`;
            newStyles.height = `${desktopHeight}px`;
            newStyles.left = `${desktopWidth / 2}px`;
            newStyles.top = '0px';
            isSnapped = 'right';
            break;
        case 'quarter-top-left':
            newStyles.width = `${desktopWidth / 2}px`;
            newStyles.height = `${desktopHeight / 2}px`;
            newStyles.left = '0px';
            newStyles.top = '0px';
            isSnapped = 'q-tl';
            break;
        case 'quarter-top-right':
             newStyles.width = `${desktopWidth / 2}px`;
             newStyles.height = `${desktopHeight / 2}px`;
             newStyles.left = `${desktopWidth / 2}px`;
             newStyles.top = '0px';
             isSnapped = 'q-tr';
            break;
        case 'quarter-bottom-left':
             newStyles.width = `${desktopWidth / 2}px`;
             newStyles.height = `${desktopHeight / 2}px`;
             newStyles.left = '0px';
             newStyles.top = `${desktopHeight / 2}px`;
             isSnapped = 'q-bl';
            break;
        case 'quarter-bottom-right':
             newStyles.width = `${desktopWidth / 2}px`;
             newStyles.height = `${desktopHeight / 2}px`;
             newStyles.left = `${desktopWidth / 2}px`;
             newStyles.top = `${desktopHeight / 2}px`;
             isSnapped = 'q-br';
            break;
    }
    Object.assign(windowEl.style, newStyles);
    appData.isMaximized = isMaximized;
    appData.isSnapped = isSnapped;
    if (isMaximized || isSnapped) {
        windowEl.classList.add('maximized');
        windowEl.style.resize = 'none';
    } else {
        windowEl.classList.remove('maximized');
        windowEl.style.resize = 'both';
    }
    setTimeout(() => { 
        windowEl.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out, width 0.2s ease, height 0.2s ease, border-radius 0.3s ease';
        updateWindowResizer();
    }, 300);
}
function updateWindowResizer() {
    const resizer = document.getElementById('window-resizer');
    const leftWinData = Array.from(openApps.values()).find(d => d.isSnapped === 'half-left');
    const rightWinData = Array.from(openApps.values()).find(d => d.isSnapped === 'half-right');
    if (leftWinData && rightWinData) {
        const leftWin = leftWinData.windowElement;
        resizer.classList.remove('hidden');
        resizer.style.left = leftWin.offsetWidth + 'px';
        const taskbarHeight = taskbarAlwaysVisible ? taskbar.offsetHeight : 0;
        resizer.style.height = `calc(100vh - ${taskbarHeight}px)`;
        resizer.style.top = '0px';
        activeResizer = { active: true, leftWin: leftWinData, rightWin: rightWinData };
    } else {
        resizer.classList.add('hidden');
        activeResizer = { active: false, leftWin: null, rightWin: null };
    }
}
document.getElementById('window-resizer').addEventListener('mousedown', (e) => {
    if (!activeResizer.active) return;
    e.preventDefault();
    const startX = e.clientX;
    const startLeftWidth = activeResizer.leftWin.windowElement.offsetWidth;
    const totalWidth = window.innerWidth;
    const onMouseMove = (moveEvent) => {
        const deltaX = moveEvent.clientX - startX;
        const newLeftWidth = startLeftWidth + deltaX;
        const newRightWidth = totalWidth - newLeftWidth;
        if (newLeftWidth < 300 || newRightWidth < 300) return;
        activeResizer.leftWin.windowElement.style.width = newLeftWidth + 'px';
        activeResizer.rightWin.windowElement.style.width = newRightWidth + 'px';
        activeResizer.rightWin.windowElement.style.left = newLeftWidth + 'px';
        document.getElementById('window-resizer').style.left = newLeftWidth + 'px';
    };
    const onMouseUp = () => {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
    };
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
});
let terminalCWD = '/';
let commandHistory = [];
let historyIndex = -1;
const webStudioBlockDefinitions = {        html: {
            title: 'HTML', color: 'html',
            blocks: [
                { type: 'html-container', text: '<i class="fa-solid fa-code"></i> HTML', isContainer: true, help: 'WebHTML' },
                { type: 'div-container', text: '<i class="fa-solid fa-box-archive"></i> (div) ID:<input type="text" data-prop="id" data-id-type="all">', isContainer: true, help: 'divIDCSSJS' },
                { type: 'text-element', text: '<i class="fa-solid fa-font"></i> <select data-prop="tag"><option value="h1">1</option><option value="h2">2</option><option value="p"></option><option value="span"></option></select> ID:<input type="text" data-prop="id" data-id-type="text">  <input type="text" data-prop="text" class="variable-input-target"> ', help: '' },
                { type: 'shape', text: '<i class="fa-solid fa-shapes"></i>  <select data-prop="type"><option value="rect"></option><option value="circle"></option><option value="triangle"></option></select> ID:<input type="text" data-prop="id" data-id-type="all"> ', help: 'CSS' },
                { type: 'image', text: '<i class="fa-solid fa-image"></i>  ID:<input type="text" data-prop="id" data-id-type="all"> URL:<input type="text" data-prop="src"> :<input type="text" data-prop="alt">', help: 'URL' },
                { type: 'link', text: '<i class="fa-solid fa-link"></i>  ID:<input type="text" data-prop="id" data-id-type="all"> URL:<input type="text" data-prop="href"> :<input type="text" data-prop="text" class="variable-input-target">', help: 'Web' },
                { type: 'text-input', text: '<i class="fa-solid fa-i-cursor"></i>  ID:<input type="text" data-prop="id" data-id-type="text"> :<input type="text" data-prop="value" class="variable-input-target">', help: '' },
                { type: 'button', text: '<i class="fa-solid fa-computer-mouse"></i>  ID:<input type="text" data-prop="id" data-id-type="button"> :<input type="text" data-prop="text" class="variable-input-target">', help: 'JS' },
                { type: 'dropdown', text: '<i class="fa-solid fa-caret-down"></i>  ID:<input type="text" data-prop="id" data-id-type="dropdown">', help: 'JS' },
                { type: 'br', text: '<i class="fa-solid fa-turn-down"></i> ', help: '' },
                { type: 'hr', text: '<i class="fa-solid fa-minus"></i> ', help: '' },
                { type: 'list-container', text: '<i class="fa-solid fa-list-ul"></i> <select data-prop="tag"><option value="ul"></option><option value="ol"></option></select> ID:<input type="text" data-prop="id" data-id-type="all">', isContainer: true, help: '(ul)1. 2. 3.(ol)' },
                { type: 'list-item', text: '<i class="fa-solid fa-list-check"></i>  :<input type="text" data-prop="text" class="variable-input-target">', help: '' },
                { type: 'table-container', text: '<i class="fa-solid fa-table"></i>  ID:<input type="text" data-prop="id" data-id-type="all">', isContainer: true, help: '' },
                { type: 'table-row', text: '<i class="fa-solid fa-grip-lines"></i> ', isContainer: true, help: '1' },
                { type: 'table-cell', text: '<i class="fa-solid fa-table-cells"></i>  :<input type="text" data-prop="text" class="variable-input-target">', help: '' },
                { type: 'form-container', text: '<i class="fa-solid fa-file-lines"></i>  ID:<input type="text" data-prop="id" data-id-type="all">', isContainer: true, help: '' },
                { type: 'textarea-input', text: '<i class="fa-solid fa-paragraph"></i>  ID:<input type="text" data-prop="id" data-id-type="text"> :<textarea data-prop="value" class="variable-input-target"></textarea>', help: '' },
                { type: 'video', text: '<i class="fa-solid fa-video"></i>  ID:<input type="text" data-prop="id" data-id-type="all"> URL:<input type="text" data-prop="src">', help: '' },
                { type: 'audio', text: '<i class="fa-solid fa-volume-high"></i>  ID:<input type="text" data-prop="id" data-id-type="all"> URL:<input type="text" data-prop="src">', help: '' },
                { type: 'canvas', text: '<i class="fa-solid fa-palette"></i>  ID:<input type="text" data-prop="id" data-id-type="all"> :<input type="number" data-prop="width" value="300"> :<input type="number" data-prop="height" value="150">', help: 'JavaScript' },
            ]
        },
        layout: {
            title: 'CSS', color: 'layout',
            blocks: [
                { type: 'flex-container', text: '<i class="fa-solid fa-layer-group"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select> Flexbox', isContainer: true, help: 'Flexbox' },
                { type: 'flex-direction', text: '<i class="fa-solid fa-arrow-right-arrow-left"></i> : <select data-prop="direction"><option value="row"></option><option value="column"></option><option value="row-reverse"></option><option value="column-reverse"></option></select>', help: 'Flexbox' },
                { type: 'flex-justify-content', text: '<i class="fa-solid fa-align-justify"></i> : <select data-prop="justify"><option value="flex-start"></option><option value="center"></option><option value="flex-end"></option><option value="space-between"></option><option value="space-around">()</option><option value="space-evenly">()</option></select>', help: '()' },
                { type: 'flex-align-items', text: '<i class="fa-solid fa-align-center"></i> : <select data-prop="align"><option value="stretch"></option><option value="flex-start"></option><option value="center"></option><option value="flex-end"></option></select>', help: '()' },
                { type: 'media-query', text: '<i class="fa-solid fa-mobile-screen-button"></i>  <input type="number" data-prop="width" value="768">px ', isContainer: true, help: 'CSS' }
            ]
        },
        css: {
            title: 'CSS', color: 'css',
            blocks: [
                { type: 'css-container', text: '<i class="fa-brands fa-css3-alt"></i> CSS', isContainer: true, help: 'CSS' },
                { type: 'set-body-background-color', text: '<i class="fa-solid fa-palette"></i>  <input type="color" data-prop="color" value="#f0f2f5"> ', help: '' },
                { type: 'background-color', text: '<i class="fa-solid fa-fill-drip"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="color" data-prop="color" value="#1e90ff"> ', help: '' },
                { type: 'color', text: '<i class="fa-solid fa-font"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="color" data-prop="color" value="#ffffff"> ', help: '' },
                { type: 'font-size', text: '<i class="fa-solid fa-text-height"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="number" data-prop="size" value="16" class="variable-input-target">px', help: '' },
                { type: 'font-family', text: '<i class="fa-solid fa-font"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <select data-prop="family"><option value="sans-serif"></option><option value="serif"></option><option value="monospace"></option></select> ', help: '' },
                { type: 'size', text: '<i class="fa-solid fa-arrows-up-down-left-right"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>   <input type="number" data-prop="width" value="100" class="variable-input-target">px,  <input type="number" data-prop="height" value="50" class="variable-input-target">px ', help: '' },
                { type: 'opacity', text: '<i class="fa-solid fa-star-half-stroke"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="number" data-prop="value" value="100" min="0" max="100" class="variable-input-target">%', help: '0%' },
                { type: 'border-radius', text: '<i class="fa-solid fa-vector-square"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="number" data-prop="radius" value="8" class="variable-input-target">px', help: '' },
                { type: 'border', text: '<i class="fa-solid fa-border-all"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="number" data-prop="width" value="1" min="0">px <select data-prop="style"><option value="solid"></option><option value="dashed"></option><option value="double"></option></select> <input type="color" data-prop="color" value="#000000"> ', help: '' },
                { type: 'border-color', text: '<i class="fa-solid fa-border-top-left"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="color" data-prop="color" value="#000000"> ', help: '' },
                { type: 'border-width', text: '<i class="fa-solid fa-arrows-left-right-to-line"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="number" data-prop="width" value="1" min="0"> px', help: '' },
                { type: 'text-align', text: '<i class="fa-solid fa-align-center"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <select data-prop="align"><option value="left"></option><option value="center"></option><option value="right"></option></select> ', help: '' },
                { type: 'box-shadow', text: '<i class="fa-solid fa-clone"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  X:<input type="number" data-prop="x" value="2"> Y:<input type="number" data-prop="y" value="2"> :<input type="number" data-prop="blur" value="4"> :<input type="color" data-prop="color" value="#888888">', help: '' },
                { type: 'cursor', text: '<i class="fa-solid fa-arrow-pointer"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <select data-prop="cursor"><option value="pointer"></option><option value="text"></option><option value="move"></option><option value="not-allowed"></option></select> ', help: '' },
                { type: 'element-position', text: '<i class="fa-solid fa-arrows-to-dot"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <select data-prop="position"><option value="left"></option><option value="center"></option><option value="right"></option></select> ', help: '' },
                { type: 'set-x-css', text: '<i class="fa-solid fa-arrows-left-right"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select> X <input type="number" data-prop="value" value="0" class="variable-input-target">px ', help: 'CSSpositionrelative, absolute' },
                { type: 'set-y-css', text: '<i class="fa-solid fa-arrows-up-down"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select> Y <input type="number" data-prop="value" value="0" class="variable-input-target">px ', help: 'CSSpositionrelative, absolute' },
                { type: 'transition', text: '<i class="fa-solid fa-wand-magic-sparkles"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="number" data-prop="duration" value="0.5" step="0.1">', help: '' },
            ]
        },
        js: {
            title: 'JS', color: 'js',
            blocks: [
                { type: 'js-container', text: '<i class="fa-brands fa-js"></i> JS', isContainer: true, help: 'JavaScript' },
                { type: 'onclick', text: '<i class="fa-solid fa-hand-pointer"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select> ', isContainer: true, help: '' },
                { type: 'on-key-press', text: '<i class="fa-solid fa-keyboard"></i> <select data-prop="key"><option value="Enter"></option><option value=" "></option><option value="ArrowUp"></option><option value="ArrowDown"></option><option value="ArrowLeft"></option><option value="ArrowRight"></option></select> ', isContainer: true, help: '' },
                { type: 'if-condition', text: '<i class="fa-solid fa-code-branch"></i>  <input type="text" data-prop="val1" class="variable-input-target"> <select data-prop="op"><option value="==="></option><option value="!=="></option><option value=">"></option><option value="<"></option><option value=">="></option><option value="<="></option></select> <input type="text" data-prop="val2" class="variable-input-target"> ', isContainer: true, hasElse: true, help: '' },
                { type: 'loop-forever', text: '<i class="fa-solid fa-infinity"></i>  (:<input type="number" data-prop="interval" value="1000" min="100">)', isContainer: true, help: '' },
                { type: 'loop-times', text: '<i class="fa-solid fa-repeat"></i> <input type="number" data-prop="times" value="10" min="1" class="variable-input-target"> ', isContainer: true, help: '' },
                { type: 'wait-seconds', text: '<i class="fa-solid fa-clock"></i> <input type="number" data-prop="seconds" value="1" min="0" class="variable-input-target"> ', help: '' },
                { type: 'alert', text: '<i class="fa-solid fa-triangle-exclamation"></i> <input type="text" data-prop="message" class="variable-input-target"> ', help: '' },
                { type: 'go-to-url', text: '<i class="fa-solid fa-paper-plane"></i> URL <input type="text" data-prop="url" class="variable-input-target"> ', help: 'URL' },
                { type: 'while-loop', text: '<i class="fa-solid fa-arrows-rotate"></i> <input type="text" data-prop="val1" class="variable-input-target"> <select data-prop="op"><option value="==="></option><option value="!=="></option><option value=">"></option><option value="<"></option></select> <input type="text" data-prop="val2" class="variable-input-target"> ', isContainer: true, help: '' },
                { type: 'switch-case', text: '<i class="fa-solid fa-shuffle"></i>  <select data-prop="var" class="variable-select"></select> ', isContainer: true, help: '' },
                { type: 'case-block', text: '<i class="fa-solid fa-check"></i>  <input type="text" data-prop="value" class="variable-input-target"> ', isContainer: true, help: 'switch' },
                { type: 'local-storage-save', text: '<i class="fa-solid fa-cloud-arrow-down"></i>  :<input type="text" data-prop="key">  :<input type="text" data-prop="value" class="variable-input-target"> ', help: '' },
                { type: 'local-storage-load', text: '<i class="fa-solid fa-cloud-arrow-up"></i>  :<input type="text" data-prop="key">  :<select data-prop="var" class="variable-select"></select> ', help: '' },
            ]
        },
        array: {
            title: 'JS', color: 'array',
            blocks: [
                { type: 'variable-declare', text: '<i class="fa-solid fa-square-plus"></i>  <input type="text" data-prop="name" class="variable-creation-input"> ', help: '' },
                { type: 'variable-set', text: '<i class="fa-solid fa-equals"></i>  <select data-prop="name" class="variable-select"></select>  <input type="text" data-prop="value" class="variable-input-target"> ', help: '' },
                { type: 'variable-value', text: '<i class="fa-solid fa-right-left"></i>  <select data-prop="source" class="variable-select"></select>  <select data-prop="dest" class="variable-select"></select> ', help: '' },
                { type: 'variable-change', text: '<i class="fa-solid fa-plus-minus"></i>  <select data-prop="name" class="variable-select"></select>  <input type="number" data-prop="value" value="1"> ', help: '' },
                { type: 'operator', text: '<i class="fa-solid fa-calculator"></i>  <select data-prop="var" class="variable-select"></select>  <input type="text" data-prop="val1" class="variable-input-target"> <select data-prop="op"><option value="+">+</option><option value="-">-</option><option value="*"></option><option value="/"></option><option value="%"></option></select> <input type="text" data-prop="val2" class="variable-input-target"> ', help: '' },
                { type: 'text-join', text: '<i class="fa-solid fa-link"></i>  <select data-prop="var" class="variable-select"></select>  <span class="join-items-container"><span class="join-item">[<input type="text" data-prop="val0" class="variable-input-target">]</span><span class="join-item"> [<input type="text" data-prop="val1" class="variable-input-target">]</span></span> <span class="join-controls"><button data-action="add">+</button><button data-action="remove">-</button></span> ', help: '' },
                { type: 'set-element-text', text: '<i class="fa-solid fa-pen-to-square"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="text" data-prop="text" class="variable-input-target"> ', help: '' },
                { type: 'get-element-value', text: '<i class="fa-solid fa-arrow-down-a-z"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select> / <select data-prop="var" class="variable-select"></select> ', help: '' },
                { type: 'show-element', text: '<i class="fa-solid fa-eye"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select> ', help: '' },
                { type: 'hide-element', text: '<i class="fa-solid fa-eye-slash"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select> ', help: '' },
                { type: 'toggle-class', text: '<i class="fa-solid fa-toggle-on"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="text" data-prop="class"> ', help: 'CSSCSS' },
                { type: 'set-style-js', text: '<i class="fa-solid fa-paintbrush"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <select data-prop="prop"><option value="backgroundColor"></option><option value="color"></option><option value="width">(px)</option><option value="height">(px)</option><option value="opacity">(0-1)</option><option value="transform">(deg)</option></select>  <input type="text" data-prop="value" class="variable-input-target"> ', help: 'JavaScript' },
                { type: 'dropdown-add-item', text: '<i class="fa-solid fa-square-plus"></i> ID:<select data-prop="id" data-id-filter="dropdown" class="id-select"></select> :<input type="text" data-prop="text"> :<input type="text" data-prop="value"> ', help: '' },
                { type: 'change-x-js', text: '<i class="fa-solid fa-arrow-right-long"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select> X <input type="number" data-prop="value" value="10" class="variable-input-target"> ', help: '' },
                { type: 'change-y-js', text: '<i class="fa-solid fa-arrow-down-long"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select> Y <input type="number" data-prop="value" value="10" class="variable-input-target"> ', help: '' },
                { type: 'get-random-number', text: '<i class="fa-solid fa-dice"></i>  <select data-prop="var" class="variable-select"></select>  <input type="number" data-prop="min" value="1" class="variable-input-target">  <input type="number" data-prop="max" value="100" class="variable-input-target"> ', help: '' },
                { type: 'get-time', text: '<i class="fa-solid fa-calendar-days"></i>  <select data-prop="var" class="variable-select"></select>  <select data-prop="unit"><option value="getFullYear"></option><option value="getMonth">(1-12)</option><option value="getDate"></option><option value="getHours"></option><option value="getMinutes"></option><option value="getSeconds"></option></select> ', help: '' },
                { type: 'array-create', text: '<i class="fa-solid fa-folder-plus"></i>  <input type="text" data-prop="name" class="variable-creation-input"> ', help: '' },
                { type: 'array-add', text: '<i class="fa-solid fa-plus"></i>  <select data-prop="name" class="variable-select"></select>  <input type="text" data-prop="value" class="variable-input-target"> ', help: '' },
                { type: 'array-get', text: '<i class="fa-solid fa-arrow-down-1-9"></i>  <select data-prop="var" class="variable-select"></select>   <select data-prop="name" class="variable-select"></select>  <input type="number" data-prop="index" value="0" min="0" class="variable-input-target"> ', help: '(0)' },
                { type: 'array-set', text: '<i class="fa-solid fa-pen"></i>  <select data-prop="name" class="variable-select"></select>  <input type="number" data-prop="index" value="0" min="0" class="variable-input-target">  <input type="text" data-prop="value" class="variable-input-target"> ', help: '' },
                { type: 'array-loop', text: '<i class="fa-solid fa-diagram-next"></i>  <select data-prop="name" class="variable-select"></select>  <input type="text" data-prop="itemVar" class="variable-creation-input"> ', isContainer: true, help: '' },
                { type: 'fetch-api', text: '<i class="fa-solid fa-cloud-download-alt"></i> URL <input type="text" data-prop="url">  <select data-prop="var" class="variable-select"></select> JSON', help: 'API()' },
            ]
        },
        myblock: {
            title: '', color: 'myblock', blocks: []
        }
    };
let weatherDataCache = null;
let calendarDataCache = null;
const widgetDefinitions = {
    clock: {
        name: '', icon: 'fas fa-clock', defaultWidth: 200, defaultHeight: 200, resizable: true,
        init: (widgetEl, widgetData) => {
            widgetData.mode = widgetData.mode || 'analog';
            widgetEl.innerHTML = `
                <div class="widget-content flex-grow w-full h-full grid place-items-center"></div>
                <button class="widget-mode-switch"><i class="fas fa-sync-alt"></i></button>
                <div class="widget-resize-handle"></div>
            `;
            const style = document.createElement('style');
            style.textContent = `
                #${widgetData.id} .widget-mode-switch { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; border-radius: 50%; background: rgba(0,0,0,0.3); color: white; border: none; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
                #${widgetData.id}:hover .widget-mode-switch { opacity: 1; }
                #${widgetData.id} .widget-resize-handle { position: absolute; bottom: 0; right: 0; width: 20px; height: 20px; cursor: se-resize; }
            `;
            widgetEl.appendChild(style);
            widgetEl.querySelector('.widget-mode-switch').addEventListener('click', (e) => {
                e.stopPropagation();
                widgetData.mode = (widgetData.mode === 'analog') ? 'digital' : 'analog';
                saveDesktopWidgets();
                renderWidgets();
            });
            widgetEl.querySelector('.widget-resize-handle').addEventListener('mousedown', (e) => {
                e.preventDefault(); e.stopPropagation();
                const startSize = widgetData.width;
                const startX = e.clientX;
                const onMouseMove = (moveEvent) => {
                    const newSize = Math.max(100, startSize + (moveEvent.clientX - startX) * 2);
                    widgetData.width = newSize; widgetData.height = newSize;
                    widgetEl.style.width = `${newSize}px`; widgetEl.style.height = `${newSize}px`;
                    updateAllWidgets(); 
                };
                const onMouseUp = () => { document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); saveDesktopWidgets(); };
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
                saveDesktopWidgets(); 
            });
        },
        update: (widgetEl, widgetData) => {
            const content = widgetEl.querySelector('.widget-content');
            const now = new Date();
if (widgetData.mode === 'analog') {
    if (!content.querySelector('canvas')) content.innerHTML = `<canvas></canvas>`;
    const canvas = content.querySelector('canvas');
    if (canvas.width !== widgetData.width - 30) { canvas.width = widgetData.width - 30; canvas.height = widgetData.width - 30; }
    const ctx = canvas.getContext('2d');
    const radius = canvas.width / 2;
    ctx.setTransform(1, 0, 0, 1, 0, 0); ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.translate(radius, radius);
    const textColor = isDarkMode ? 'white' : 'black';
    ctx.strokeStyle = textColor; ctx.fillStyle = textColor;
    ctx.lineWidth = 1;
    for (let i = 0; i < 60; i++) {
        const angle = (i / 60) * 2 * Math.PI;
        const isHourMark = (i % 5 === 0);
        const startRadius = isHourMark ? radius - 10 : radius - 5;
        const endRadius = radius - 2;
        ctx.beginPath();
        ctx.moveTo(startRadius * Math.cos(angle), startRadius * Math.sin(angle));
        ctx.lineTo(endRadius * Math.cos(angle), endRadius * Math.sin(angle));
        ctx.stroke();
    }
    const h = now.getHours()%12, m=now.getMinutes(), s=now.getSeconds();
                const drawHand = (a, l, w, c) => { ctx.beginPath(); ctx.strokeStyle=c; ctx.lineWidth=w; ctx.moveTo(0,0); ctx.lineTo(l*Math.cos(a), l*Math.sin(a)); ctx.stroke(); };
                drawHand((h*30+m/2)*Math.PI/180-Math.PI/2, radius*0.5, 4, textColor);
                drawHand((m*6)*Math.PI/180-Math.PI/2, radius*0.7, 3, textColor);
                drawHand((s*6)*Math.PI/180-Math.PI/2, radius*0.8, 1, "red");
                ctx.beginPath(); ctx.arc(0,0,4,0,2*Math.PI); ctx.fill();
            } else {
                if (!content.querySelector('.digital-clock')) content.innerHTML = `<div class="digital-clock"></div>`;
                const clockDiv = content.querySelector('.digital-clock');
                clockDiv.style.cssText = `font-size: ${widgetData.width / 4}px; font-weight: 200; text-align: center;`;
                clockDiv.textContent = now.toLocaleTimeString(systemLanguage, { hour: '2-digit', minute: '2-digit' });
            }
        }
    },
    weather: {
        name: '', icon: 'fas fa-cloud-sun', defaultWidth: 250, defaultHeight: 150, resizable: false,
        init: (widgetEl, widgetData) => {  },
update: (widgetEl, widgetData) => {
    widgetData.city = widgetData.city || 'Tokyo';
    if (!weatherDataCache || weatherDataCache.city !== widgetData.city) {
        widgetEl.innerHTML = `<p class="text-sm">...</p>`;
    } else if (weatherDataCache.error) {
        widgetEl.innerHTML = `<p class="text-sm text-red-500"></p>`;
    } else {
                const { current, daily } = weatherDataCache.data;
                const icon = getWeatherIcon(current.weather_code, current.is_day);
                widgetEl.innerHTML = `
                    <div class="text-center">
                        <p class="text-sm">${widgetData.city}</p>
                        <i class="${icon} text-5xl my-1"></i>
                        <p class="text-3xl font-bold">${Math.round(current.temperature_2m)}</p>
                        <p class="text-xs text-gray-400">:${Math.round(daily.temperature_2m_max[0])} :${Math.round(daily.temperature_2m_min[0])}</p>
                    </div>
                `;
            }
        }
    },
calendar: {
    name: '', 
    icon: 'fas fa-calendar-alt', 
    defaultWidth: 300, 
    defaultHeight: 320, 
    resizable: true, 
        init: (widgetEl, widgetData) => {  },
update: (widgetEl, widgetData) => {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();
    const todayStr_key = `${year}-${String(month + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    let eventsHtml = '<p class="text-xs text-gray-500 mt-2"></p>';
    if (calendarDataCache && calendarDataCache[todayStr_key]) {
        const todayEvents = calendarDataCache[todayStr_key];
        if (todayEvents.length > 0) {
            eventsHtml = '<div class="space-y-1 mt-2">';
            eventsHtml += todayEvents.map(e => {
                const startTime = new Date(e.start).toLocaleTimeString([],{hour:'2-digit', minute:'2-digit'});
                return `<div class="text-xs truncate flex items-center">
                            <span class="w-1 h-1 rounded-full mr-2" style="background-color:${e.color || '#007bff'};"></span>
                            <span>${startTime} ${e.title}</span>
                        </div>`;
            }).join('');
            eventsHtml += '</div>';
        }
    }
    let calendarHtml = `
        <style>
            #${widgetData.id} .calendar-widget-grid { grid-template-columns: repeat(7, 1fr); text-align: center; flex-shrink: 0; }
            #${widgetData.id} .day-cell { min-width: 28px; height: 28px; display: grid; place-items: center; border-radius: 50%; font-size: 0.8rem; }
            #${widgetData.id} .day-cell.today { background-color: #007bff; color: white; font-weight: bold; }
            #${widgetData.id} .events-list-container { overflow-y: auto; }
        </style>
        <div class="w-full h-full flex flex-col">
            <div class="w-full text-center mb-2 flex-shrink-0">
                <h4 class="font-bold">${year} ${month + 1}</h4>
            </div>
            <div class="calendar-widget-grid grid gap-1">
                <div class="text-xs text-red-400"></div><div class="text-xs"></div><div class="text-xs"></div><div class="text-xs"></div><div class="text-xs"></div><div class="text-xs"></div><div class="text-xs text-blue-400"></div>
    `;
    for (let i = 0; i < firstDay; i++) { calendarHtml += `<div></div>`; }
    for (let i = 1; i <= daysInMonth; i++) {
        const isToday = (i === now.getDate());
        calendarHtml += `<div class="day-cell ${isToday ? 'today' : ''}">${i}</div>`;
    }
    calendarHtml += `</div>`;
    calendarHtml += `<hr class="border-white/10 my-2 flex-shrink-0">`;
    calendarHtml += `<div class="events-list-container flex-grow">${eventsHtml}</div>`;
    calendarHtml += `</div>`;
    widgetEl.innerHTML = calendarHtml;
}
    },
    'system-monitor': {
        name: '', icon: 'fas fa-chart-line', defaultWidth: 250, defaultHeight: 120, resizable: false,
        init: (widgetEl, widgetData) => {  },
        update: (widgetEl, widgetData) => {
            const startTime = performance.now();
            requestAnimationFrame(() => {
                const duration = performance.now() - startTime;
                const usage = Math.min(100, (duration / 16.7) * 100);
                const memory = performance.memory ? (performance.memory.usedJSHeapSize / (1024*1024)).toFixed(1) : 'N/A';
                widgetEl.innerHTML = `
                    <div class="w-full text-sm font-mono">
                        <p>CPU: <span class="float-right">${usage.toFixed(1)} %</span></p>
                        <p>MEM: <span class="float-right">${memory} MB</span></p>
                        <p>APP: <span class="float-right">${openApps.size}</span></p>
                    </div>
                `;
            });
        }
    },
    'music-player': {
        name: 'Music Player', icon: 'fas fa-headphones', defaultWidth: 300, defaultHeight: 120, resizable: false,
        init: (widgetEl, widgetData) => {
            widgetEl.addEventListener('click', (e) => {
                if (e.target.closest('[data-action="play"]')) window.globalMusicState?.play();
                if (e.target.closest('[data-action="pause"]')) window.globalMusicState?.pause();
                if (e.target.closest('[data-action="prev"]')) window.globalMusicState?.prev();
                if (e.target.closest('[data-action="next"]')) window.globalMusicState?.next();
            });
        },
        update: (widgetEl, widgetData) => {
            const state = window.globalMusicState;
            const artwork = state?.track?.artwork || 'fas fa-music text-gray-500';
            const title = state?.track?.name || '';
            const artist = state?.track?.artist || '...';
            const icon = state?.isPlaying ? 'fa-pause' : 'fa-play';
            widgetEl.style.padding = '0';
            widgetEl.innerHTML = `
                <div class="w-full h-full flex items-center p-3 gap-3">
                    <div class="w-20 h-20 rounded-md bg-gray-700 flex-shrink-0 grid place-items-center">
                        ${artwork.startsWith('fas') ? `<i class="${artwork} text-3xl"></i>` : `<img src="${artwork}" class="w-full h-full object-cover rounded-md">`}
                    </div>
                    <div class="flex-grow truncate">
                        <p class="font-bold truncate">${title}</p>
                        <p class="text-xs text-gray-400 truncate">${artist}</p>
                        <div class="flex items-center justify-start gap-4 mt-2 text-lg">
                            <button data-action="prev"><i class="fas fa-backward-step"></i></button>
                            <button data-action="${state?.isPlaying ? 'pause' : 'play'}" class="w-8 h-8 rounded-full bg-white text-black"><i class="fas ${icon}"></i></button>
                            <button data-action="next"><i class="fas fa-forward-step"></i></button>
                        </div>
                    </div>
                </div>
            `;
        }
    },
    'sticky-note': {
        name: '', icon: 'fas fa-sticky-note', defaultWidth: 220, defaultHeight: 220, resizable: true,
        init: (widgetEl, widgetData) => {
            widgetData.text = widgetData.text || '';
            widgetData.color = widgetData.color || '#ffc';
            widgetEl.style.padding = '0';
            widgetEl.innerHTML = `<textarea class="w-full h-full p-4 border-none outline-none resize-none" style="font-family: 'Comic Sans MS', cursive; line-height: 1.5;"></textarea>`;
            const textarea = widgetEl.querySelector('textarea');
            textarea.style.backgroundColor = widgetData.color;
            let debounceTimer;
            textarea.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    widgetData.text = textarea.value;
                    saveDesktopWidgets();
                }, 500);
            });
        },
        update: (widgetEl, widgetData) => {
            const textarea = widgetEl.querySelector('textarea');
            if (textarea.value !== widgetData.text) textarea.value = widgetData.text;
            if (widgetEl.style.width !== `${widgetData.width}px`) { widgetEl.style.width = `${widgetData.width}px`; widgetEl.style.height = `${widgetData.height}px`; }
        }
    },
    'photo-frame': {
        name: '', icon: 'fas fa-image', defaultWidth: 250, defaultHeight: 180, resizable: true,
init: (widgetEl, widgetData) => {
    widgetEl.style.padding = '5px';
    widgetEl.style.backgroundColor = 'white';
    widgetEl.innerHTML = `<img class="w-full h-full object-cover" style="display: none;">`;
    if (widgetData.intervalId) clearInterval(widgetData.intervalId);
    const updateImage = async () => {
        try {
            const pictures = await VFS.listFiles('/Pictures');
            const images = pictures.filter(f => f.type.startsWith('image/'));
            if (images.length > 0) {
                const randomImage = images[Math.floor(Math.random() * images.length)];
                widgetData.data.currentImage = randomImage.content;
                widgetDefinitions['photo-frame'].update(widgetEl, widgetData);
            }
        } catch (e) { console.error(":", e); }
    };
    updateImage();
    widgetData.intervalId = setInterval(updateImage, 10000); 
},
update: (widgetEl, widgetData) => {
    const img = widgetEl.querySelector('img');
    const imageUrl = widgetData.data.currentImage;
    if (imageUrl && img.src !== imageUrl) {
        img.src = imageUrl;
        img.style.display = 'block';
    } else if (!imageUrl) {
        img.style.display = 'none';
    }
    if (widgetEl.style.width !== `${widgetData.width}px`) { widgetEl.style.width = `${widgetData.width}px`; widgetEl.style.height = `${widgetData.height}px`; }
}
    }
};
const fetchWeatherData = () => {
    const weatherWidget = desktopWidgets.find(w => w.type === 'weather');
    if (!weatherWidget) return; 
    const city = weatherWidget.data.city || 'Tokyo';
    const geoParams = new URLSearchParams({ name: city, count: 1, language: 'en', format: 'json' });
    fetch(`https://geocoding-api.open-meteo.com/v1/search?${geoParams.toString()}`)
        .then(res => res.json())
        .then(geoData => {
            if (!geoData.results) throw new Error(`${city}`);
            const { latitude, longitude, timezone } = geoData.results[0];
            const forecastParams = new URLSearchParams({ 
                latitude, longitude, timezone,
                current: 'temperature_2m,relative_humidity_2m,is_day,weather_code',
                daily: 'temperature_2m_max,temperature_2m_min,sunrise,sunset'
            });
            return fetch(`https://api.open-meteo.com/v1/forecast?${forecastParams.toString()}`);
        })
        .then(res => res.json())
        .then(weatherData => {
            weatherDataCache = { city: city, data: weatherData };
            console.log("Weather data updated with sunrise/sunset for", city);
            updateAllWidgets(); 
        })
        .catch(err => {
            console.error("Weather widget update error:", err);
            weatherDataCache = { city: city, error: err.message };
            updateAllWidgets();
        });
};
const fetchCalendarData = async () => {
    try {
        const file = await VFS.readFile('/System/Calendar/events.json');
        if (file) {
            const res = await fetch(file.content);
            calendarDataCache = await res.json();
        }
    } catch (e) { calendarDataCache = {}; }
    console.log("Calendar data updated.");
};
setInterval(fetchWeatherData, 15 * 60 * 1000);
setInterval(fetchCalendarData, 60 * 1000);
fetchWeatherData();
fetchCalendarData();
const getWeatherIcon = (code, isDay = 1) => {
    const isDayTime = isDay === 1;
    const icons = { 0: isDayTime ? 'fas fa-sun text-yellow-300' : 'fas fa-moon text-blue-200', 1: isDayTime ? 'fas fa-cloud-sun text-yellow-300' : 'fas fa-cloud-moon text-blue-300', 2: 'fas fa-cloud text-gray-300', 3: 'fas fa-cloud text-gray-400', 45: 'fas fa-smog text-gray-500', 48: 'fas fa-smog text-gray-500', 51: 'fas fa-cloud-rain text-blue-300', 53: 'fas fa-cloud-rain text-blue-400', 55: 'fas fa-cloud-showers-heavy text-blue-500', 61: 'fas fa-cloud-rain text-blue-400', 63: 'fas fa-cloud-rain text-blue-500', 65: 'fas fa-cloud-showers-heavy text-blue-600', 71: 'fas fa-snowflake text-blue-200', 73: 'fas fa-snowflake text-blue-200', 75: 'fas fa-snowflake text-blue-300', 80: 'fas fa-cloud-showers-heavy text-blue-500', 81: 'fas fa-cloud-showers-heavy text-blue-500', 82: 'fas fa-cloud-showers-heavy text-blue-600', 95: 'fas fa-bolt text-yellow-400', 96: 'fas fa-bolt text-yellow-400', 99: 'fas fa-bolt text-yellow-400' };
    return icons[code] || 'fas fa-question-circle text-gray-400';
};
        const apps = [
{
    id: 'settings', name: '', icon: 'fas fa-cog', installed: true,
    launcher: (params = {}) => {
        const settingsWindow = createWindow('app-window-settings', '', '', 700, 550);
        settingsWindow.classList.add('glass-effect');
        const settingsContentWrapper = settingsWindow.querySelector('.window-content-wrapper');
        settingsContentWrapper.innerHTML = `
            <div id="settings-sidebar">
                <ul>
                    <li data-category="account"><i class="fas fa-user-circle"></i> </li>
                    <li data-category="wallpaper"><i class="fas fa-image"></i> </li>
                    <li data-category="password-management"><i class="fas fa-lock"></i> </li>
                    <li data-category="theme"><i class="fas fa-palette"></i> </li>
                    <li data-category="language"><i class="fas fa-language"></i> </li>
                    <li data-category="notifications"><i class="fas fa-bell"></i> </li>
                    <li data-category="application-manager"><i class="fas fa-box-open"></i> </li>
                    <li data-category="application-bar"><i class="fas fa-grip-horizontal"></i> </li>
                    <li data-category="device-info"><i class="fas fa-info-circle"></i> </li>
                    <li data-category="system-update"><i class="fas fa-sync-alt"></i> </li>
                </ul>
            </div>
            <div id="settings-main-content"></div>
        `;
        const sidebar = settingsWindow.querySelector('#settings-sidebar');
        const mainContent = settingsWindow.querySelector('#settings-main-content');
        const renderCategory = (category) => {
            mainContent.innerHTML = '';
            sidebar.querySelectorAll('li').forEach(li => li.classList.remove('active'));
            const activeLi = sidebar.querySelector(`[data-category="${category}"]`);
            if (activeLi) activeLi.classList.add('active');
if (category === 'account') {
    let userAddedIcons = JSON.parse(localStorage.getItem('riviftUserAddedIcons_v2')) || [];
    let userAddedColors = JSON.parse(localStorage.getItem('riviftUserAddedColors_v2')) || [];
    mainContent.innerHTML = `
        <div class="flex items-center gap-4 mb-6">
            <div id="settings-icon-preview" class="relative w-24 h-24 rounded-full bg-white/5 flex-shrink-0 grid place-items-center">
                <!-- JS -->
            </div>
            <div>
                <input type="text" id="user-name-input" value="${userName}" class="font-bold text-2xl bg-transparent border-b-2 border-transparent focus:border-blue-500 outline-none w-full">
                <p class="text-sm text-gray-400"></p>
            </div>
        </div>
        <h5 class="font-semibold mb-3"></h5>
        <div id="icon-color-palette" class="flex flex-wrap items-center gap-3 mb-6">
            <!-- JS -->
        </div>
        <h5 class="font-semibold mb-3"></h5>
        <div id="default-icon-grid" class="flex flex-wrap gap-3 mb-5">
            <!-- JS -->
        </div>
        <div class="flex items-center justify-between mb-3">
            <h5 class="font-semibold"></h5>
            <button id="add-icon-from-file" class="file-input-button text-sm">
                <i class="fas fa-plus"></i> 
            </button>
        </div>
        <div id="user-added-icon-grid" class="flex flex-wrap gap-3">
            <!-- JS -->
        </div>
    `;
    const previewWrapper = mainContent.querySelector('#settings-icon-preview');
    const defaultIconGrid = mainContent.querySelector('#default-icon-grid');
    const userAddedIconGrid = mainContent.querySelector('#user-added-icon-grid');
    const colorPalette = mainContent.querySelector('#icon-color-palette');
    const presetColors = ['#ffffff', '#ff5f56', '#ffbd2e', '#27c93f', '#007bff', '#8e44ad'];
    const getBaseUrl = (url) => (!url || !url.includes('?color=')) ? url : url.split('?color=')[0];
    const getColoredUrl = (baseUrl, color) => {
        if (!baseUrl.includes('iconify.design')) return baseUrl;
        return `${baseUrl}?color=${color.replace('#', '%23')}`;
    };
    let currentIconInfo = {
        baseUrl: getBaseUrl(userIcon.simpleUrl),
        color: '#ffffff',
        isLocal: !userIcon.simpleUrl.includes('iconify.design')
    };
    if (userIcon.simpleUrl.includes('?color=')) {
        currentIconInfo.color = `#${userIcon.simpleUrl.split('?color=%23')[1]}`;
    }
    const updatePreview = () => {
        const urlToDisplay = currentIconInfo.isLocal ? currentIconInfo.baseUrl : getColoredUrl(currentIconInfo.baseUrl, currentIconInfo.color);
        previewWrapper.innerHTML = currentIconInfo.isLocal
            ? `<img src="${urlToDisplay}" class="w-full h-full object-cover rounded-full">`
            : `<img src="${urlToDisplay}" class="w-20 h-20">`;
    };
    const renderIconGrids = () => {
        defaultIconGrid.innerHTML = defaultUserIcons.map(url => {
            const baseUrl = getBaseUrl(url);
            const isSelected = !currentIconInfo.isLocal && currentIconInfo.baseUrl === baseUrl;
            return `<div data-baseurl="${baseUrl}" class="icon-container w-16 h-16 rounded-full grid place-items-center cursor-pointer border-2 hover:border-blue-500 ${isSelected ? 'border-blue-500' : 'border-transparent'}">
                        <img src="${getColoredUrl(baseUrl, currentIconInfo.color)}" class="w-12 h-12">
                    </div>`;
        }).join('');
        userAddedIconGrid.innerHTML = userAddedIcons.map((localUrl, index) => {
            const isSelected = currentIconInfo.isLocal && currentIconInfo.baseUrl === localUrl;
            return `<div data-baseurl="${localUrl}" data-islocal="true" class="icon-container group relative w-16 h-16 rounded-full grid place-items-center cursor-pointer border-2 hover:border-blue-500 ${isSelected ? 'border-blue-500' : 'border-transparent'}">
                        <img src="${localUrl}" class="w-full h-full object-cover rounded-full">
                        <button data-index="${index}" class="delete-icon-btn absolute top-0 right-0 w-5 h-5 bg-red-600 text-white rounded-full text-xs hidden group-hover:flex items-center justify-center"></button>
                    </div>`;
        }).join('');
    };
    const renderColorPalette = () => {
        const allColors = [...presetColors, ...userAddedColors];
        colorPalette.innerHTML = allColors.map((color, index) => {
            const isSelected = color === currentIconInfo.color;
            const isUserAdded = index >= presetColors.length;
            return `<div class="relative group">
                        <button data-color="${color}" style="background-color: ${color};" class="color-button w-8 h-8 rounded-full border-2 ${isSelected ? 'border-blue-500 scale-110' : 'border-white/20'}"></button>
                        ${isUserAdded ? `<button data-index="${index - presetColors.length}" class="delete-color-btn absolute -top-1 -right-1 w-4 h-4 bg-red-600 text-white rounded-full text-xs hidden group-hover:flex items-center justify-center"></button>` : ''}
                    </div>`;
        }).join('') + 
        `<button id="add-color-btn" class="w-8 h-8 rounded-full grid place-items-center bg-white/10 border-2 border-dashed border-white/30 text-lg">+</button>`;
    };
    mainContent.addEventListener('click', (e) => {
        const iconContainer = e.target.closest('.icon-container');
        if (iconContainer) {
            currentIconInfo.baseUrl = iconContainer.dataset.baseurl;
            currentIconInfo.isLocal = iconContainer.dataset.islocal === 'true';
            mainContent.querySelectorAll('.icon-container').forEach(c => c.classList.replace('border-blue-500', 'border-transparent'));
            iconContainer.classList.replace('border-transparent', 'border-blue-500');
            userIcon.mode = 'simple';
            userIcon.simpleUrl = currentIconInfo.isLocal 
                ? currentIconInfo.baseUrl 
                : getColoredUrl(currentIconInfo.baseUrl, currentIconInfo.color);
            saveUserAccount();
            updatePreview();
        }
    });
    colorPalette.addEventListener('click', (e) => {
        const colorButton = e.target.closest('.color-button');
        const addColorButton = e.target.closest('#add-color-btn');
        const deleteColorButton = e.target.closest('.delete-color-btn');
        if (deleteColorButton) {
            e.stopPropagation();
            const indexToDelete = parseInt(deleteColorButton.dataset.index);
            userAddedColors.splice(indexToDelete, 1);
            localStorage.setItem('riviftUserAddedColors_v2', JSON.stringify(userAddedColors));
            renderColorPalette();
            return;
        }
        if (colorButton) {
            currentIconInfo.color = colorButton.dataset.color;
            colorPalette.querySelectorAll('.color-button').forEach(btn => btn.classList.remove('border-blue-500', 'scale-110'));
            colorButton.classList.add('border-blue-500', 'scale-110');
            if (!currentIconInfo.isLocal) {
                userIcon.simpleUrl = getColoredUrl(currentIconInfo.baseUrl, currentIconInfo.color);
                saveUserAccount();
            }
            updatePreview();
            renderIconGrids();
        } 
else if (addColorButton) {
    if (document.getElementById('custom-color-picker-popup')) {
        closeCustomColorPicker();
        return;
    }
    const pickerPopup = document.createElement('div');
    pickerPopup.id = 'custom-color-picker-popup';
    pickerPopup.className = 'absolute p-2 rounded-lg shadow-2xl z-50';
    pickerPopup.style.backgroundColor = isDarkMode ? 'var(--panel-bg-dark)' : 'var(--panel-bg-light)';
    pickerPopup.style.border = isDarkMode ? '1px solid var(--border-color-dark)' : '1px solid var(--border-color-light)';
    const pickerInput = document.createElement('input');
    pickerInput.type = 'color';
    pickerInput.className = 'w-full h-12 cursor-pointer bg-transparent border-none';
    pickerInput.addEventListener('change', (e) => {
        const newColor = e.target.value;
        if (![...presetColors, ...userAddedColors].includes(newColor)) {
            userAddedColors.push(newColor);
            localStorage.setItem('riviftUserAddedColors_v2', JSON.stringify(userAddedColors));
        }
        currentIconInfo.color = newColor;
        renderColorPalette();
        const newColorButton = colorPalette.querySelector(`[data-color="${newColor}"]`);
        if (newColorButton) {
            newColorButton.click();
        }
        closeCustomColorPicker();
    });
    pickerPopup.appendChild(pickerInput);
    document.body.appendChild(pickerPopup);
    const btnRect = addColorButton.getBoundingClientRect();
    const popupWidth = 100;
    pickerPopup.style.width = `${popupWidth}px`;
    pickerPopup.style.left = `${btnRect.left + (btnRect.width / 2) - (popupWidth / 2)}px`;
    pickerPopup.style.top = `${btnRect.bottom + 8}px`;
    setTimeout(() => {
        document.addEventListener('click', handleClickOutsideColorPicker, true);
    }, 0);
}
    });
    const handleClickOutsideColorPicker = (event) => {
        if (!event.target.closest('#custom-color-picker-popup') && !event.target.closest('#add-color-btn')) {
            closeCustomColorPicker();
        }
    };
    userAddedIconGrid.addEventListener('click', (e) => {
        const deleteBtn = e.target.closest('.delete-icon-btn');
        if (deleteBtn) {
            e.stopPropagation();
            const indexToDelete = parseInt(deleteBtn.dataset.index);
            const deletedUrl = userAddedIcons[indexToDelete];
            userAddedIcons.splice(indexToDelete, 1);
            localStorage.setItem('riviftUserAddedIcons_v2', JSON.stringify(userAddedIcons));
            if (currentIconInfo.baseUrl === deletedUrl) {
                mainContent.querySelector('.icon-container[data-islocal]')?.click();
                const firstDefaultIcon = defaultIconGrid.querySelector('.icon-container');
                if (firstDefaultIcon) firstDefaultIcon.click();
            }
            renderIconGrids();
        }
    });
    mainContent.querySelector('#add-icon-from-file').addEventListener('click', async () => {
        const filePath = await showFilePicker({ mode: 'open', title: '', acceptTypes: ['image/'] });
        if (filePath) {
            try {
                const fileData = await VFS.readFile(filePath);
                if (fileData && fileData.content) {
                    if (!userAddedIcons.includes(fileData.content)) {
                        userAddedIcons.push(fileData.content);
                        localStorage.setItem('riviftUserAddedIcons_v2', JSON.stringify(userAddedIcons));
                    }
                    renderIconGrids();
                }
            } catch (err) {
                createNotification('', `: ${err.message}`, 'error');
            }
        }
    });
    mainContent.querySelector('#user-name-input').addEventListener('change', (e) => {
        userName = e.target.value.trim() || 'Guest';
        saveUserAccount();
    });
    updatePreview();
    renderIconGrids();
    renderColorPalette();
} else if (category === 'wallpaper') {
    mainContent.innerHTML = `
        <h4 class="text-xl font-semibold mb-3"></h4>
        <div id="wallpaper-previews-container" class="flex flex-wrap gap-3 mb-5">
            <p class="text-gray-400">...</p> 
        </div>
        <h4 class="text-xl font-semibold mb-3"></h4>
        <button id="select-local-wallpaper" class="file-input-button">
            <i class="fas fa-folder-open"></i> 
        </button>
        <p id="local-wallpaper-status" class="text-gray-400 text-sm mt-2"></p>
        <hr class="border-white/10 my-6">
        <h4 class="text-xl font-semibold mt-5 mb-3"></h4>
        <div class="setting-item">
            <span></span>
            <md-switch id="slideshow-switch" ${wallpaperSlideshowEnabled ? 'selected' : ''}></md-switch>
        </div>
        <div id="slideshow-interval-setting" class="${wallpaperSlideshowEnabled ? '' : 'hidden'} setting-item flex-col items-start mt-4">
            <span> ()</span>
            <input type="number" id="slideshow-interval-input" value="${slideshowInterval}" min="5" class="w-full p-2 rounded-lg mt-2" style="background-color: var(--input-bg-dark); color: var(--text-color-dark); border: 1px solid var(--input-border-dark);">
        </div>
        <hr class="border-white/10 my-6">
        <h4 class="text-xl font-semibold mb-3"></h4>
        <p class="text-gray-400 text-sm mb-4"></p>
        <div id="widget-gallery" class="flex flex-wrap gap-4">
            ${Object.entries(widgetDefinitions).map(([type, def]) => `
                <div class="widget-add-card" data-widget-type="${type}">
                    <i class="${def.icon} text-3xl mb-2"></i>
                    <span class="text-sm">${def.name}</span>
                </div>
            `).join('')}
        </div>
    `;
    const previewsContainer = mainContent.querySelector('#wallpaper-previews-container');
    wallpaperLoaderWorker.postMessage({
        wallpaperList: defaultWallpapers,
        currentWallpaper: currentWallpaper
    });
    wallpaperLoaderWorker.onmessage = (e) => {
        const isDynamicActive = dynamicWallpaperContainer.style.display === 'block';
        const dynamicPreviewHtml = `
            <div class="wallpaper-preview ${isDynamicActive ? 'selected' : ''}" data-wallpaper="dynamic">
                <div style="width: 100%; height: 100%; background: linear-gradient(to top, #87CEEB, #1E90FF); position: relative; overflow: hidden;">
                    <div style="position: absolute; width: 20px; height: 20px; background: yellow; border-radius: 50%; top: 20%; left: 30%;"></div>
                    <div style="position: absolute; bottom: -10px; width: 150%; height: 50%; background: #2E8B57; border-radius: 50% / 100%; border-bottom-left-radius: 0; border-bottom-right-radius: 0; left: -25%;"></div>
                </div>
            </div>
        `;
        previewsContainer.innerHTML = dynamicPreviewHtml + e.data;
    };
    previewsContainer.addEventListener('click', (e) => {
        const preview = e.target.closest('.wallpaper-preview');
        if (preview) {
            previewsContainer.querySelectorAll('.wallpaper-preview.selected').forEach(p => p.classList.remove('selected'));
            preview.classList.add('selected');
            const wallpaperType = preview.dataset.wallpaper;
            if (wallpaperType === 'dynamic') {
                setDynamicWallpaperActive(true);
            } else {
                setDynamicWallpaperActive(false);
                updateWallpaper(wallpaperType, true);
            }
        }
    });
    const slideshowSwitch = mainContent.querySelector('#slideshow-switch');
    const slideshowIntervalSetting = mainContent.querySelector('#slideshow-interval-setting');
    const slideshowIntervalInput = mainContent.querySelector('#slideshow-interval-input');
    const selectLocalWallpaperButton = mainContent.querySelector('#select-local-wallpaper');
    const localWallpaperStatus = mainContent.querySelector('#local-wallpaper-status');
    selectLocalWallpaperButton.addEventListener('click', async () => {
        const filePath = await showFilePicker({ 
            mode: 'open', 
            title: '', 
            acceptTypes: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'] 
        });
        if (filePath) {
            try {
                const fileData = await VFS.readFile(filePath);
                if (fileData && fileData.content) {
                    const imageUrl = fileData.content;
                    updateWallpaper(imageUrl, true);
                    localWallpaperStatus.textContent = '';
                    previewsContainer.querySelectorAll('.wallpaper-preview.selected').forEach(p => p.classList.remove('selected'));
                }
            } catch (err) {
                localWallpaperStatus.textContent = '';
            }
        }
    });
    slideshowSwitch.addEventListener('input', () => {
        wallpaperSlideshowEnabled = slideshowSwitch.selected;
        slideshowIntervalSetting.classList.toggle('hidden', !wallpaperSlideshowEnabled);
        saveWallpaperSlideshowEnabled();
        if (wallpaperSlideshowEnabled) {
            startWallpaperSlideshow();
        } else {
            clearInterval(slideshowIntervalId);
            slideshowIntervalId = null;
        }
    });
    if (slideshowIntervalInput) {
        slideshowIntervalInput.addEventListener('change', () => {
            slideshowInterval = parseInt(slideshowIntervalInput.value);
            if (isNaN(slideshowInterval) || slideshowInterval < 5) slideshowInterval = 5;
            slideshowIntervalInput.value = slideshowInterval;
            saveSlideshowInterval();
            if (wallpaperSlideshowEnabled) startWallpaperSlideshow();
        });
    }
    const style = document.createElement('style');
    style.textContent = `
        .widget-add-card {
            width: 100px;
            height: 100px;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .widget-add-card:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-5px);
        }
    `;
    mainContent.querySelector('#widget-gallery').addEventListener('click', (e) => {
        const card = e.target.closest('.widget-add-card');
        if (card) {
            const widgetType = card.dataset.widgetType;
            createWidget(widgetType);
        }
    });
    mainContent.appendChild(style);
    const previews = mainContent.querySelectorAll('.wallpaper-preview[data-wallpaper-src]');
    const observer = new IntersectionObserver((entries, obs) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const preview = entry.target;
                const src = preview.dataset.wallpaperSrc;
                if (src) {
                    preview.style.backgroundImage = `url('${src}')`;
                    obs.unobserve(preview);
                }
            }
        });
    }, { root: mainContent, rootMargin: "0px 0px 100px 0px" });
    previews.forEach(preview => {
        observer.observe(preview);
    });
} else if (category === 'password-management') {
    mainContent.innerHTML = `
        <h4 class="text-xl font-semibold mb-3"></h4>
        <div class="setting-item">
            <span></span>
            <md-switch id="password-login-switch" ${passwordLoginEnabled ? 'selected' : ''}></md-switch>
        </div>
                                <div class="setting-item flex-col items-start mt-4">
                                    <span></span>
                                    <select id="password-type-select" class="w-full p-2 rounded-lg mt-2" style="background-color: var(--input-bg-dark); color: var(--text-color-dark); border: 1px solid var(--input-border-dark);">
                                        <option value="pin" ${osPasswordType === 'pin' ? 'selected' : ''}>PIN</option>
                                        <option value="pattern" ${osPasswordType === 'pattern' ? 'selected' : ''}></option>
                                    </select>
                                </div>
                                <div id="password-setting-area" class="mt-4"></div>
                                <p id="password-status-message" class="text-sm mt-2"></p>
                                        <hr class="border-white/10 my-6"> <!--  -->
        <h4 class="text-xl font-semibold mb-3"></h4>
        <div class="setting-item">
            <span></span>
            <div class="flex items-center gap-2">
                <span id="face-auth-status" class="text-sm text-gray-400">${isFaceAuthEnabled ? '' : ''}</span>
                <button id="setup-face-auth-btn" class="file-input-button text-sm">
                    <i class="fas fa-camera"></i> ${isFaceAuthEnabled ? '' : ''}
                </button>
            </div>
        </div>
        <p class="text-gray-400 text-sm mt-2">
            
        </p>
                            `;
                            const passwordLoginToggle = mainContent.querySelector('[data-setting="password-login-toggle"]');
    const passwordLoginSwitch = mainContent.querySelector('#password-login-switch');
    passwordLoginSwitch.addEventListener('input', () => { 
        passwordLoginEnabled = passwordLoginSwitch.selected; 
        savePasswordLoginEnabled(); 
    });
                            const passwordTypeSelect = mainContent.querySelector('#password-type-select');
                            const passwordSettingArea = mainContent.querySelector('#password-setting-area');
                            const passwordStatusMessage = mainContent.querySelector('#password-status-message');
                            const renderPasswordSettingUI = () => {
                                passwordSettingArea.innerHTML = '';
                                if (osPasswordType === 'pin') {
                                    passwordSettingArea.innerHTML = `
                                        <span>PIN</span>
                                        <input type="password" id="set-pin-input" placeholder="PIN" class="w-full p-2 rounded-lg mt-2" style="background-color: var(--input-bg-dark); color: var(--text-color-dark); border: 1px solid var(--input-border-dark);">
                                        <input type="password" id="confirm-pin-input" placeholder="PIN" class="w-full p-2 rounded-lg mt-2" style="background-color: var(--input-bg-dark); color: var(--text-color-dark); border: 1px solid var(--input-border-dark);">
                                        <button id="save-pin-button" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition mt-3">PIN</button>
                                    `;
                                    const setPinInput = passwordSettingArea.querySelector('#set-pin-input');
                                    const confirmPinInput = passwordSettingArea.querySelector('#confirm-pin-input');
                                    const savePinButton = passwordSettingArea.querySelector('#save-pin-button');
                                    savePinButton.addEventListener('click', () => {
                                        const newPin = setPinInput.value;
                                        const confirmPin = confirmPinInput.value;
                                        if (newPin === '') { passwordStatusMessage.textContent = 'PIN'; passwordStatusMessage.style.color = '#ff5f56'; }
                                        else if (newPin !== confirmPin) { passwordStatusMessage.textContent = 'PIN'; passwordStatusMessage.style.color = '#ff5f56'; }
                                        else { osPassword = newPin; saveOSPassword(); passwordStatusMessage.textContent = 'PIN'; passwordStatusMessage.style.color = '#27c93f'; setPinInput.value = ''; confirmPinInput.value = ''; }
                                    });
                                } else if (osPasswordType === 'pattern') {
                                    let currentPattern = [];
                                    passwordSettingArea.innerHTML = `
                                        <span> ()</span>
                                        <div class="password-pattern-grid">
                                            ${Array(16).fill().map((_, i) => `<button data-index="${i}"></button>`).join('')}
                                        </div>
                                        <button id="clear-pattern-button" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition mt-3"></button>
                                        <button id="save-pattern-button" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition mt-3 ml-2"></button>
                                        <p id="current-pattern-display" class="text-sm mt-2">: ${currentPattern.join('-')}</p>
                                    `;
                                    const patternGridButtons = passwordSettingArea.querySelectorAll('.password-pattern-grid button');
                                    const clearPatternButton = passwordSettingArea.querySelector('#clear-pattern-button');
                                    const savePatternButton = passwordSettingArea.querySelector('#save-pattern-button');
                                    const currentPatternDisplay = passwordSettingArea.querySelector('#current-pattern-display');
                                    patternGridButtons.forEach(button => {
                                        button.addEventListener('click', () => {
                                            const index = parseInt(button.dataset.index);
                                            if (!button.classList.contains('selected')) { button.classList.add('selected'); currentPattern.push(index); currentPatternDisplay.textContent = `: ${currentPattern.join('-')}`; }
                                        });
                                    });
                                    clearPatternButton.addEventListener('click', () => { currentPattern = []; patternGridButtons.forEach(button => button.classList.remove('selected')); currentPatternDisplay.textContent = ':'; passwordStatusMessage.textContent = ''; });
                                    savePatternButton.addEventListener('click', () => {
                                        if (currentPattern.length === 0) { passwordStatusMessage.textContent = ''; passwordStatusMessage.style.color = '#ff5f56'; }
                                        else { osPatternPassword = currentPattern; saveOSPatternPassword(); passwordStatusMessage.textContent = ''; passwordStatusMessage.style.color = '#27c93f'; currentPattern = []; patternGridButtons.forEach(button => button.classList.remove('selected')); currentPatternDisplay.textContent = ':'; }
                                    });
                                }
                                applyTheme();
                            };
                            passwordTypeSelect.addEventListener('change', () => { osPasswordType = passwordTypeSelect.value; saveOSPasswordType(); renderPasswordSettingUI(); passwordStatusMessage.textContent = ''; });
                            renderPasswordSettingUI();
                            mainContent.querySelector('#setup-face-auth-btn').addEventListener('click', (e) => {
    setupFaceAuth(e.currentTarget);
});
} else if (category === 'theme') {
                mainContent.innerHTML = `
                    <h4 class="text-xl font-semibold mb-3"></h4>
                    <div class="setting-item">
                        <span></span>
                        <md-switch id="dark-theme-switch" ${isDarkMode ? 'selected' : ''}></md-switch>
                    </div>
                    <div class="setting-item">
                        <span></span>
                        <md-switch id="auto-theme-switch" ${autoThemeEnabled ? 'selected' : ''}></md-switch>
                    </div>
                    <p class="text-gray-400 text-sm mt-4">
                        /
                    </p>
                    <hr class="border-white/10 my-6">
                    <h4 class="text-xl font-semibold mt-6 mb-3"></h4>
                    <div class="setting-item">
                        <span></span>
                        <md-switch id="aero-effect-switch" ${aeroEffectEnabled ? 'selected' : ''}></md-switch>
                    </div>
                    <div id="aero-mode-setting" class="setting-item ${aeroEffectEnabled ? '' : 'hidden'}">
                        <span></span>
                        <div class="mode-select-container">
                            <button class="mode-select-button ${aeroMode === 'clear' ? 'active' : ''}" data-mode="clear"></button>
                            <button class="mode-select-button ${aeroMode === 'smoke' ? 'active' : ''}" data-mode="smoke"></button>
                        </div>
                    </div>
                    <hr class="border-white/10 my-6">
                    <h4 class="text-xl font-semibold mb-3"></h4>
                    <div class="setting-item">
                        <span></span>
                        <md-switch id="accent-auto-switch" ${accentColorMode === 'auto' ? 'selected' : ''}></md-switch>
                    </div>
                    <h5 class="font-semibold text-gray-400 text-sm mt-4 mb-3"></h5>
                    <div id="accent-preset-colors" class="flex flex-wrap gap-3"></div>
                    <div class="flex items-center justify-between mt-4 mb-3">
                        <h5 class="font-semibold text-gray-400 text-sm"></h5>
                    </div>
                    <div id="accent-custom-colors" class="flex flex-wrap gap-3"></div>
                `;
                const darkThemeSwitch = mainContent.querySelector('#dark-theme-switch');
                const autoThemeSwitch = mainContent.querySelector('#auto-theme-switch');
                const aeroEffectSwitch = mainContent.querySelector('#aero-effect-switch');
                const aeroModeSetting = mainContent.querySelector('#aero-mode-setting');
                const accentAutoSwitch = mainContent.querySelector('#accent-auto-switch');
                darkThemeSwitch.addEventListener('input', () => {
                    isDarkMode = darkThemeSwitch.selected;
                    saveIsDarkMode();
                    if (autoThemeEnabled) {
                        autoThemeEnabled = false;
                        autoThemeSwitch.selected = false;
                        saveAutoThemeEnabled();
                    }
                    applyTheme();
                });
                autoThemeSwitch.addEventListener('input', () => {
                    autoThemeEnabled = autoThemeSwitch.selected;
                    saveAutoThemeEnabled();
                    if (autoThemeEnabled) {
                        updateTime();
                    }
                });
                aeroEffectSwitch.addEventListener('input', () => {
                    aeroEffectEnabled = aeroEffectSwitch.selected;
                    saveAeroEffectEnabled();
                    aeroModeSetting.classList.toggle('hidden', !aeroEffectEnabled);
                    applyVisualEffects();
                });
                mainContent.querySelectorAll('.mode-select-button').forEach(button => {
                    button.addEventListener('click', () => {
                        mainContent.querySelectorAll('.mode-select-button').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        aeroMode = button.dataset.mode;
                        saveAeroMode();
                        applyVisualEffects();
                    });
                });
                accentAutoSwitch.addEventListener('input', async () => {
                    accentColorMode = accentAutoSwitch.selected ? 'auto' : 'preset';
                    if (accentColorMode === 'auto') {
                        const dominantColor = await extractColorFromWallpaper(currentWallpaper);
                        if (dominantColor) {
                            currentAccentColor = dominantColor;
                        }
                    } else {
                        currentAccentColor = '#007bff';
                    }
                    saveAccentColorSettings();
                    applyAccentColor(currentAccentColor);
                    renderAccentColorUI();
                });
                renderAccentColorUI();
}  else if (category === 'language') {
                            mainContent.innerHTML = `
                                <h4 class="text-xl font-semibold mb-3"></h4>
                                <div class="setting-item">
                                    <span></span>
                                    <select id="system-language-select" class="p-2 rounded-lg" style="background-color: var(--input-bg-dark); color: var(--text-color-dark); border: 1px solid var(--input-border-dark);">
                                        <option value="ja-JP" ${systemLanguage === 'ja-JP' ? 'selected' : ''}></option>
                                        <option value="en-US" ${systemLanguage === 'en-US' ? 'selected' : ''}>English</option>
                                    </select>
                                </div>
                                <p id="language-change-message" class="text-sm text-yellow-400 mt-4 hidden">
                                    OS
                                </p>
                            `;
                            const languageSelect = mainContent.querySelector('#system-language-select');
                            const languageChangeMessage = mainContent.querySelector('#language-change-message');
                            languageSelect.addEventListener('change', async () => {
                                const newLang = languageSelect.value;
                                if (newLang !== systemLanguage) {
                                    systemLanguage = newLang;
                                    saveSystemLanguage();
                                    languageChangeMessage.classList.remove('hidden');
                                    createNotification('', 'OS', 'info', 0);
                                    const confirmRestart = await showMessageBox('', 'OS', true);
                                    if (confirmRestart) location.reload();
                                }
                            });
} else if (category === 'application-manager') {
    mainContent.innerHTML = `
        <h4 class="text-xl font-semibold mb-4"></h4>
        <div id="installed-apps-list" class="flex flex-col gap-2"></div>
    `;
    const appList = mainContent.querySelector('#installed-apps-list');
    apps.filter(app => app.isWebApp).forEach(app => {
        const appItem = document.createElement('div');
        appItem.className = 'setting-item';
        appItem.innerHTML = `
            <span><i class="${app.icon} mr-2"></i>${app.name}</span>
            <button data-app-id="${app.id}" class="uninstall-btn bg-red-600 text-white px-3 py-1 text-sm rounded hover:bg-red-700"></button>
        `;
        appList.appendChild(appItem);
    });
    appList.addEventListener('click', async (e) => {
        const btn = e.target.closest('.uninstall-btn');
        if (!btn) return;
        const appId = btn.dataset.appId;
        const appIndex = apps.findIndex(app => app.id === appId);
        if (appIndex === -1) return;
        const confirm = await showMessageBox('', `${apps[appIndex].name}`, { showCancel: true });
        if (confirm) {
            apps.splice(appIndex, 1);
            saveCustomWebApps();
            renderCategory('application-manager');
            savePinnedApps();
            populateAllApps();
            createNotification('', '', 'info');
        }
    });
} else if (category === 'notifications') {
    mainContent.innerHTML = `
        <h4 class="text-xl font-semibold mb-3"></h4>
        <div class="setting-item">
            <span></span>
            <md-switch id="desktop-notifications-switch" ${desktopNotificationsEnabled ? 'selected' : ''}></md-switch>
        </div>
        <div class="setting-item flex-col items-start mt-4">
            <span> ()</span>
            <input type="number" id="notification-dismiss-time-input" value="${notificationDismissTime}" min="1" class="w-full p-2 rounded-lg mt-2" style="background-color: var(--input-bg-dark); color: var(--text-color-dark); border: 1px solid var(--input-border-dark);">
        </div>
        <div class="setting-item">
            <span></span>
            <md-switch id="notification-sound-switch" ${notificationSoundEnabled ? 'selected' : ''}></md-switch>
        </div>
        <h4 class="text-xl font-semibold mt-5 mb-3"></h4>
        <div id="app-notification-settings"></div>
    `;
    const desktopNotificationsSwitch = mainContent.querySelector('#desktop-notifications-switch');
    const notificationDismissTimeInput = mainContent.querySelector('#notification-dismiss-time-input');
    const notificationSoundSwitch = mainContent.querySelector('#notification-sound-switch');
    const appNotificationSettingsDiv = mainContent.querySelector('#app-notification-settings');
    desktopNotificationsSwitch.addEventListener('input', () => {
        desktopNotificationsEnabled = desktopNotificationsSwitch.selected;
        saveDesktopNotificationsEnabled();
    });
    notificationDismissTimeInput.addEventListener('change', () => {
        notificationDismissTime = parseInt(notificationDismissTimeInput.value);
        if (isNaN(notificationDismissTime) || notificationDismissTime < 0) {
            notificationDismissTime = 5;
            notificationDismissTimeInput.value = 5;
        }
        saveNotificationDismissTime();
    });
    notificationSoundSwitch.addEventListener('input', () => {
        notificationSoundEnabled = notificationSoundSwitch.selected;
        saveNotificationSoundEnabled();
    });
    apps.filter(app => app.installed).forEach(app => {
        const appSettingItem = document.createElement('div');
        appSettingItem.classList.add('setting-item');
        appSettingItem.innerHTML = `
            <span>${app.name}</span>
            <md-switch data-app-id="${app.id}" selected></md-switch> 
        `;
        appNotificationSettingsDiv.appendChild(appSettingItem);
        const appSwitch = appSettingItem.querySelector('md-switch');
        appSwitch.addEventListener('input', () => {
        saveAppNotificationSetting(app.id, appSwitch.selected);
        });
    });
} else if (category === 'application-bar') {
    mainContent.innerHTML = `
        <h4 class="text-xl font-semibold mb-3"></h4>
        <div class="setting-item flex-col items-start">
            <span> (${appIconSize}px)</span>
            <div class="slider-container w-full relative mt-2">
                <div class="slider-fill" id="icon-size-fill" style="width: ${((appIconSize - 30) / 20 * 100)}%;"></div>
                <input type="range" id="icon-size-slider" min="30" max="50" value="${appIconSize}" class="w-full absolute top-0 left-0">
            </div>
        </div>
        <div class="setting-item">
            <span></span>
            <md-switch id="taskbar-visible-switch" ${taskbarAlwaysVisible ? 'selected' : ''}></md-switch>
        </div>
        <p class="text-gray-400 text-sm mt-2">
            Windows
        </p>
            <div class="setting-item mt-4">
        <span></span>
        <md-switch id="taskbar-align-switch" ${taskbarCenterAlign ? 'selected' : ''}></md-switch>
    </div>
            <div class="setting-item mt-4">
        <span></span>
        <md-switch id="taskbar-autofit-switch" ${taskbarAutoFitIcons ? 'selected' : ''}></md-switch>
    </div>
    <p class="text-gray-400 text-sm mt-2">
        
    </p>
        <div class="setting-item mt-4">
            <span>24</span>
            <md-switch id="time-format-switch" ${timeFormat24Hour ? 'selected' : ''}></md-switch>
        </div>
        <div class="setting-item">
            <span></span>
            <md-switch id="show-date-switch" ${showDateOnTaskbar ? 'selected' : ''}></md-switch>
        </div>
        <div class="setting-item">
            <span></span>
            <md-switch id="show-spotlight-switch" ${showSpotlightButton ? 'selected' : ''}></md-switch>
        </div>
        <h4 class="text-xl font-semibold mt-5 mb-3"></h4>
        <div id="app-bar-sortable-list" class="p-2 border rounded-lg min-h-[100px]">
        </div>
    `;
    const iconSizeSlider = mainContent.querySelector('#icon-size-slider');
    const iconSizeFill = mainContent.querySelector('#icon-size-fill');
    const taskbarVisibleSwitch = mainContent.querySelector('#taskbar-visible-switch');
    const taskbarAutofitSwitch = mainContent.querySelector('#taskbar-autofit-switch');
const taskbarCenterEl = document.getElementById('taskbar-center');
const taskbarAlignSwitch = mainContent.querySelector('#taskbar-align-switch');
    const timeFormatSwitch = mainContent.querySelector('#time-format-switch');
    const showDateSwitch = mainContent.querySelector('#show-date-switch');
    const showSpotlightSwitch = mainContent.querySelector('#show-spotlight-switch');
    const appBarSortableList = mainContent.querySelector('#app-bar-sortable-list');
    taskbarAutofitSwitch.addEventListener('input', () => {
    taskbarAutoFitIcons = taskbarAutofitSwitch.selected;
    saveTaskbarAutoFitIcons();
    if (taskbarCenterEl) {
        taskbarCenterEl.classList.toggle('auto-fit-icons', taskbarAutoFitIcons);
    }
    checkTaskbarScroll();
});
taskbarAlignSwitch.addEventListener('input', () => {
    taskbarCenterAlign = taskbarAlignSwitch.selected;
    saveTaskbarCenterAlign();
    applyTaskbarAlignment(); 
});
    iconSizeSlider.addEventListener('input', () => {
        appIconSize = parseInt(iconSizeSlider.value);
        iconSizeFill.style.width = `${((appIconSize - 30) / 20 * 100)}%`;
        mainContent.querySelector('.setting-item span').textContent = ` (${appIconSize}px)`;
        saveAppIconSize();
        applyAppIconSize();
    });
    taskbarVisibleSwitch.addEventListener('input', () => {
        taskbarAlwaysVisible = taskbarVisibleSwitch.selected;
        saveTaskbarAlwaysVisible();
        updateTaskbarAppStatus();
    });
    timeFormatSwitch.addEventListener('input', () => {
        timeFormat24Hour = timeFormatSwitch.selected;
        saveTimeFormat24Hour();
        updateTime();
    });
    showDateSwitch.addEventListener('input', () => {
        showDateOnTaskbar = showDateSwitch.selected;
        saveShowDateOnTaskbar();
        updateTime();
    });
    showSpotlightSwitch.addEventListener('input', () => {
        showSpotlightButton = showSpotlightSwitch.selected;
        saveShowSpotlightButton();
        applySpotlightButtonVisibility();
    });
    const renderSortableList = () => {
        appBarSortableList.innerHTML = '';
        pinnedApps.forEach((appId, index) => {
            const app = apps.find(a => a.id === appId);
            if (app && app.installed) {
                const listItem = document.createElement('div');
                listItem.classList.add('flex', 'items-center', 'p-2', 'my-1', 'rounded-lg', 'cursor-move');
                listItem.style.backgroundColor = isDarkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.03)';
                listItem.draggable = true;
                listItem.dataset.appId = appId;
                listItem.dataset.index = index;
                listItem.innerHTML = `<i class="${app.icon} mr-3"></i><span>${app.name}</span>`;
                listItem.addEventListener('dragstart', handleSortableDragStart);
                listItem.addEventListener('dragover', handleSortableDragOver);
                listItem.addEventListener('drop', handleSortableDrop);
                listItem.addEventListener('dragend', handleSortableDragEnd);
                appBarSortableList.appendChild(listItem);
            }
        });
    };
    renderSortableList();
} else if (category === 'device-info') {
    mainContent.innerHTML = `
        <h4 class="text-xl font-semibold mb-3"></h4>
        <div class="setting-item"><span>OS</span><span>Rivift OS</span></div>
        <div class="setting-item"><span></span><span>4.9.3</span></div>
        <div class="setting-item"><span></span><span>DANGOKYOUDAI</span></div>
        <div class="setting-item"><span></span><span>202511</span></div>
        <hr class="border-white/10 my-4">
        <h4 class="text-xl font-semibold mb-3"></h4>
        <div class="setting-item">
            <span></span>
            <span id="proxy-stats-display">...</span>
        </div>
    `;
    const display = mainContent.querySelector('#proxy-stats-display');
    if (display) {
        display.textContent = '';
    }
} else if (category === 'system-update') {
                            mainContent.innerHTML = `
                                <h4 class="text-xl font-semibold mb-3"></h4>
                                <p class="mb-4"></p>
                                <button id="check-for-updates" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-search"></i> </button>
                                <p id="update-status" class="text-gray-400 text-sm mt-3"></p>
                                <button id="install-updates" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition mt-4 hidden"><i class="fas fa-download"></i> </button>
                            `;
                            const checkForUpdatesButton = mainContent.querySelector('#check-for-updates');
                            const updateStatus = mainContent.querySelector('#update-status');
                            const installUpdatesButton = mainContent.querySelector('#install-updates');
                            checkForUpdatesButton.addEventListener('click', () => {
                                updateStatus.textContent = '...';
                                installUpdatesButton.classList.add('hidden');
                                setTimeout(() => {
                                    const hasUpdate = Math.random() > 0.5;
                                    if (hasUpdate) { updateStatus.textContent = ''; installUpdatesButton.classList.remove('hidden'); }
                                    else { updateStatus.textContent = ''; installUpdatesButton.classList.add('hidden'); }
                                }, 2000);
                            });
                            installUpdatesButton.addEventListener('click', async () => {
                                updateStatus.textContent = '...';
                                installUpdatesButton.classList.add('hidden');
                                createNotification('', '', 'info', 0);
                                await showMessageBox('', '', false);
                                location.reload();
                            });
                        }
            applyTheme();
        };
        renderCategory(params.category || 'account');
        sidebar.querySelectorAll('li').forEach(item => {
            item.addEventListener('click', () => renderCategory(item.dataset.category));
        });
        applyTheme();
    }
},
            {
                id: 'calculator', name: '', icon: 'fas fa-calculator', installed: true,
                launcher: () => {
                    const content = `
                        <div class="calculator-display" id="calc-display">0</div>
                        <div class="calculator-buttons">
                            <button class="clear">C</button><button class="operator">+/-</button><button class="operator">%</button><button class="operator">/</button>
                            <button>7</button><button>8</button><button>9</button><button class="operator">*</button>
                            <button>4</button><button>5</button><button>6</button><button class="operator">-</button>
                            <button>1</button><button>2</button><button>3</button><button class="operator">+</button>
                            <button class="span-2">0</button><button>.</button><button class="equals">=</button>
                        </div>
                    `;
                    createWindow('app-window-calculator', '', content, 300, 400, false);
                    const calcWindow = document.getElementById('app-window-calculator');
                    const display = calcWindow.querySelector('#calc-display');
                    let currentInput = '0', operator = null, firstOperand = null, waitingForSecondOperand = false, displayValue = '0';
                    function updateCalcDisplay() { display.textContent = displayValue; }
                    calcWindow.querySelectorAll('.calculator-buttons button').forEach(button => {
                        button.addEventListener('click', () => {
                            const value = button.textContent;
                            if (button.classList.contains('clear')) { currentInput = '0'; operator = null; firstOperand = null; waitingForSecondOperand = false; displayValue = '0'; }
                            else if (button.classList.contains('operator')) {
                                if (value === '+/-') { currentInput = (parseFloat(currentInput) * -1).toString(); displayValue = currentInput; }
                                else if (value === '%') { currentInput = (parseFloat(currentInput) / 100).toString(); displayValue = currentInput; }
                                else {
                                    if (operator && waitingForSecondOperand) { operator = value; displayValue = firstOperand + ' ' + operator; updateCalcDisplay(); return; }
                                    if (firstOperand === null) firstOperand = parseFloat(currentInput);
                                    else if (operator) { const result = operateCalc(firstOperand, parseFloat(currentInput), operator); currentInput = parseFloat(result.toFixed(7)).toString(); firstOperand = parseFloat(currentInput); }
                                    operator = value; waitingForSecondOperand = true; displayValue = currentInput + ' ' + operator;
                                }
                            } else if (button.classList.contains('equals')) {
                                if (firstOperand === null || operator === null) return;
                                const result = operateCalc(firstOperand, parseFloat(currentInput), operator); currentInput = parseFloat(result.toFixed(7)).toString(); displayValue = currentInput; firstOperand = null; operator = null; waitingForSecondOperand = false;
                            } else {
                                if (waitingForSecondOperand) { currentInput = value; waitingForSecondOperand = false; }
                                else currentInput = currentInput === '0' ? value : currentInput + value;
                                if (value === '.' && currentInput.includes('.') && currentInput.indexOf('.') !== currentInput.length - 1) return;
                                displayValue = currentInput;
                            }
                            updateCalcDisplay();
                        });
                    });
                    function operateCalc(n1, n2, op) { switch (op) { case '+': return n1 + n2; case '-': return n1 - n2; case '*': return n1 * n2; case '/': return n2 === 0 ? (displayValue = 'Error', NaN) : n1 / n2; default: return n2; } }
                    applyTheme();
                }
            },
{
    id: 'notepad', name: '', icon: 'fas fa-file-alt', installed: true,
    launcher: (params = {}) => {
        const windowId = `app-window-notepad-${Date.now()}`;
        const content = `
            <div class="h-full flex flex-col">
                <div class="notepad-toolbar flex items-center gap-2 p-2 border-b" style="border-color: var(--border-color-dark);">
                    <button data-command="bold" title="" class="w-7 h-7 rounded hover:bg-white/10"><i class="fas fa-bold"></i></button>
                    <button data-command="italic" title="" class="w-7 h-7 rounded hover:bg-white/10"><i class="fas fa-italic"></i></button>
                    <button data-command="underline" title="" class="w-7 h-7 rounded hover:bg-white/10"><i class="fas fa-underline"></i></button>
                    <div class="flex-grow"></div>
                    <button data-action="open" class="bg-gray-600 text-white px-3 py-1 rounded-md text-sm"></button>
                    <button data-action="save" class="bg-blue-600 text-white px-3 py-1 rounded-md text-sm"></button>
                </div>
                <div class="editor p-4 flex-grow w-full h-full text-base focus:outline-none overflow-y-auto" contenteditable="true"></div>
            </div>
        `;
        const notepadWindow = createWindow(windowId, '', content, 500, 400);
        const editor = notepadWindow.querySelector('.editor');
        const toolbar = notepadWindow.querySelector('.notepad-toolbar');
        let currentFilePath = null;
                let isDirty = false;
        editor.addEventListener('input', () => {
            isDirty = true;
            if (!notepadWindow.querySelector('.window-header span').textContent.endsWith('*')) {
                notepadWindow.querySelector('.window-header span').textContent += '*';
            }
        });
        const appData = openApps.get(windowId);
        if (appData) {
            appData.hasUnsavedChanges = () => isDirty;
        }
        const loadFile = async (path) => {
            try {
                const fileData = await readFileWithWorker(path);
                if (fileData && fileData.content) {
                    const response = await fetch(fileData.content);
                    const blob = await response.blob();
                    const text = await blob.text();
                    if (fileData.type === 'text/html') {
                        editor.innerHTML = text;
                    } else {
                        editor.textContent = text;
                    }
                    currentFilePath = path;
                    isDirty = false;
                    notepadWindow.querySelector('.window-header span').textContent = fileData.name;
                }
            } catch (err) {
                createNotification('', `: ${err.message}`, 'error');
            }
        };
        if(params.path) {
            loadFile(params.path);
        }
        toolbar.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const command = button.dataset.command;
            const action = button.dataset.action;
            if (command) {
                document.execCommand(command, false, null);
                editor.focus();
                return;
            }
if (action === 'save') {
    const defaultName = currentFilePath ? currentFilePath.substring(currentFilePath.lastIndexOf('/') + 1) : '.txt';
    const target = await showFilePicker({ mode: 'save', title: '', defaultName: defaultName });
    if (target) {
        const blob = new Blob([editor.innerText], { type: 'text/plain' });
        const reader = new FileReader();
        reader.onload = async (event) => {
            try {
                const parentPath = target.path.substring(0, target.path.lastIndexOf('/')) || '/';
                const fileName = target.name;
                await VFS.writeFile(parentPath, fileName, 'text/plain', event.target.result);
                createNotification('', `${fileName}`, 'info');
                currentFilePath = target.path;
                isDirty = false;
                notepadWindow.querySelector('.window-header span').textContent = fileName;
            } catch(err) {
                createNotification('', `: ${err.message}`, 'error');
            }
        };
        reader.readAsDataURL(blob);
    }
} else if (action === 'open') {
                const filePath = await showFilePicker({ mode: 'open', title: '', acceptTypes: ['text/html', 'text/plain'] });
                if (filePath) {
                    loadFile(filePath);
                }
            }
        });
        applyTheme();
    }
},
{ 
    id: 'clock', name: '', icon: 'fas fa-clock', installed: true, 
    launcher: () => {
        const content = `
            <style>
                #clock-app-container { font-family: 'Inter', sans-serif; height: 100%; display: flex; flex-direction: column; background-color: var(--bg-color-dark); color: var(--text-color-dark); }
                body.light-mode #clock-app-container { background-color: var(--bg-color-light); color: var(--text-color-light); }
                .clock-menubar { flex-shrink: 0; display: flex; justify-content: space-around; padding: 0.5rem; background-color: rgba(0,0,0,0.2); }
                .clock-menubar button { color: #9aa0a6; padding: 0.5rem 0; border-bottom: 2px solid transparent; transition: all 0.2s; flex-grow: 1; font-size: 1.25rem; }
                .clock-menubar button:hover { color: white; }
                body.light-mode .clock-menubar button:hover { color: black; }
                .clock-menubar button.active { color: #8ab4f8; border-bottom-color: #8ab4f8; }
                .clock-page { flex-grow: 1; display: none; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; padding: 1.5rem; }
                .clock-page.active { display: flex; }
                .clock-page h2 { font-size: 5rem; font-weight: 200; margin: 0; letter-spacing: 2px; }
                #digital-clock-display { font-size: 4em; }
                #date-display-clock { font-size: 1.2em; margin-bottom: 0.5em; color: #9aa0a6; }
                #world-clock-controls { display: flex; gap: 1rem; margin-top: 2rem; }
                .alarm-list { width: 100%; max-width: 350px; margin-top: 2rem; flex-grow: 1; overflow-y: auto; }
                .alarm-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
                body.light-mode .alarm-item { border-bottom-color: rgba(0,0,0,0.1); }
                .timer-controls button, .stopwatch-controls button { width: 80px; height: 80px; border-radius: 50%; font-size: 1.1rem; transition: background-color 0.2s; }
                .start-btn { background-color: rgba(48, 209, 88, 0.3); color: #30d158; }
                .stop-btn { background-color: rgba(255, 59, 48, 0.3); color: #ff3b30; }
                .lap-reset-btn { background-color: #3c4043; color: white; }
                body.light-mode .lap-reset-btn { background-color: #e5e5ea; color: black; }
                .lap-list { font-family: monospace; width: 100%; max-width: 300px; margin-top: 2rem; flex-grow: 1; overflow-y: auto; font-size: 1.1rem; }
                .lap-item { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
                body.light-mode .lap-item { border-bottom-color: rgba(0,0,0,0.1); }
                .time-picker { display: flex; align-items: center; justify-content: center; font-size: 5rem; font-weight: 200; }
                .time-picker-col { display: flex; flex-direction: column; align-items: center; }
                .time-picker-arrow { cursor: pointer; opacity: 0.5; transition: opacity 0.2s; user-select: none; }
                .time-picker-arrow:hover { opacity: 1; }
    </style>
    <div id="clock-app-container">
        <div class="clock-menubar">
            <button data-page="world-clock" class="active" title=""><i class="fas fa-globe"></i></button>
            <button data-page="alarm" title=""><i class="fas fa-bell"></i></button>
            <button data-page="timer" title=""><i class="fas fa-hourglass-half"></i></button>
            <button data-page="stopwatch" title=""><i class="fas fa-stopwatch"></i></button>
        </div>
        <div id="world-clock-page" class="clock-page active">
            <div id="date-display-clock"></div>
            <div id="digital-clock-display"></div>
            <canvas id="analog-clock-canvas" width="300" height="300" class="hidden"></canvas>
            <div id="world-clock-controls">
                <div class="clock-view-switcher">
                    <button class="clock-view-btn active" data-view="digital"><i class="fas fa-font"></i></button>
                    <button class="clock-view-btn" data-view="analog"><i class="far fa-clock"></i></button>
                </div>
            </div>
        </div>
        <div id="alarm-page" class="clock-page">
            <button id="add-alarm-btn" class="absolute top-20 right-5 text-3xl text-[#8ab4f8]">+</button>
            <div class="alarm-list"></div>
        </div>
        <div id="timer-page" class="clock-page">
            <h2 id="timer-display" class="hidden">00:00:00</h2>
            <div id="timer-picker" class="time-picker">
                <div class="time-picker-col">
                    <i class="fas fa-chevron-up time-picker-arrow" data-unit="h" data-dir="1"></i>
                    <span id="timer-h">00</span>
                    <i class="fas fa-chevron-down time-picker-arrow" data-unit="h" data-dir="-1"></i>
                </div>
                <span>:</span>
                <div class="time-picker-col">
                    <i class="fas fa-chevron-up time-picker-arrow" data-unit="m" data-dir="1"></i>
                    <span id="timer-m">05</span>
                    <i class="fas fa-chevron-down time-picker-arrow" data-unit="m" data-dir="-1"></i>
                </div>
                <span>:</span>
                <div class="time-picker-col">
                    <i class="fas fa-chevron-up time-picker-arrow" data-unit="s" data-dir="1"></i>
                    <span id="timer-s">00</span>
                    <i class="fas fa-chevron-down time-picker-arrow" data-unit="s" data-dir="-1"></i>
                </div>
            </div>
            <div class="flex gap-4 mt-8 timer-controls">
                <button id="reset-timer-btn" class="lap-reset-btn"></button>
                <button id="start-timer-btn" class="start-btn"></button>
            </div>
        </div>
                <div id="stopwatch-page" class="clock-page">
                    <h2 id="stopwatch-display">00:00.00</h2>
                    <div class="flex gap-4 mt-8 stopwatch-controls">
                        <button id="lap-btn" class="lap-reset-btn" disabled></button>
                        <button id="start-stopwatch-btn" class="start-btn"></button>
                    </div>
                    <div class="lap-list"></div>
                </div>
            </div>
        `;
        const clockWindow = createWindow('app-window-clock', '', content, 400, 550);
        initializeClockApp(clockWindow);
    }
},
{
    id: 'music-player', name: 'Music Player', icon: 'fas fa-headphones', installed: true,
    launcher: (params = {}) => {
        const windowId = `app-window-music-player-${Date.now()}`;
        const content = `
            <style>
                .music-player-container { font-family: 'Inter', sans-serif; }
                .playlist-library-item, .playlist-song-item { transition: background-color 0.2s; }
                .playlist-library-item:hover, .playlist-song-item:hover { background-color: rgba(255, 255, 255, 0.05); }
                .playlist-library-item.playing .playlist-name, .playlist-song-item.playing .song-title { color: #007bff; font-weight: 500; }
                .control-btn, .action-btn { color: rgba(255, 255, 255, 0.7); transition: all 0.2s; }
                .control-btn:hover, .action-btn:hover { color: #fff; transform: scale(1.1); }
                .control-btn.active { color: #007bff; }
                .drop-indicator { height: 2px; background-color: #007bff; margin: -1px 0; }
                #music-progress { -webkit-appearance: none; appearance: none; background: transparent; cursor: pointer; width: 100%; }
                #music-progress::-webkit-slider-thumb {
                    -webkit-appearance: none; appearance: none;
                    width: 14px; height: 14px; background: #fff; border-radius: 50%;
                    margin-top: -6px;
                    opacity: 0; transition: opacity 0.2s;
                }
                .progress-bar-wrapper:hover #music-progress::-webkit-slider-thumb { opacity: 1; }
            </style>
            <div class="music-player-container flex h-full text-white bg-transparent">
                <div id="music-sidebar" class="w-2/5 h-full flex flex-col p-2 border-r border-white/10 bg-black/20">
                    <div class="flex-shrink-0 p-2 flex justify-between items-center">
                        <h3 class="font-semibold text-lg"></h3>
                        <div>
                            <button id="add-music-btn" class="control-btn" title=""><i class="fas fa-plus"></i></button>
                            <button id="create-playlist-btn" class="control-btn ml-2" title=""><i class="fas fa-folder-plus"></i></button>
                        </div>
                    </div>
                    <ul id="playlist-library" class="list-none p-0 m-0 flex-grow overflow-y-auto"></ul>
                </div>
                <div id="music-main" class="w-3/5 h-full flex flex-col items-center justify-between p-6">
                    <div class="artwork-wrapper relative w-48 h-48 flex-shrink-0 mt-4 flex items-center justify-center rounded-lg bg-transparent">
                        <canvas id="visualizer-canvas" class="absolute w-full h-full"></canvas>
                        <i id="music-icon-placeholder" class="fas fa-music text-6xl text-gray-400 z-10 transition-opacity duration-300" style="position: relative; left: -3px;"></i>
                    </div>
                    <div class="w-full flex flex-col items-center gap-3">
                        <div>
                            <p id="current-song-display" class="text-xl font-bold text-center"></p>
                            <p id="current-artist-display" class="text-sm text-gray-400 text-center"></p>
                        </div>
                        <div class="progress-bar-wrapper w-full pt-2 pb-2">
                             <div class="relative h-2 flex items-center">
                                <div class="w-full h-1 absolute rounded-full bg-white/10"></div>
                                <div id="progress-bar-fg" class="h-1 absolute rounded-full bg-white w-0"></div>
                                <input type="range" id="music-progress" min="0" max="100" value="0">
                            </div>
                            <div class="flex justify-between text-xs mt-1 text-gray-400">
                                <span id="music-current-time">0:00</span>
                                <span id="music-duration">0:00</span>
                            </div>
                        </div>
                    </div>
                    <div class="controls flex items-center justify-center gap-6 w-full mb-4">
                        <button id="shuffle-btn" class="control-btn" title=""><i class="fas fa-random"></i></button>
                        <button id="prev-music-btn" class="control-btn text-2xl"><i class="fas fa-step-backward"></i></button>
                        <button id="play-pause-btn" class="p-4 w-14 h-14 text-xl rounded-full bg-blue-500 text-white flex items-center justify-center hover:bg-blue-600 transform hover:scale-105 transition-transform" title=""><i class="fas fa-play"></i></button>
                        <button id="next-music-btn" class="control-btn text-2xl"><i class="fas fa-step-forward"></i></button>
                        <button id="repeat-btn" class="control-btn" title=""><i class="fas fa-repeat"></i></button>
                    </div>
                </div>
            </div>
        `;
window.globalMusicState = window.globalMusicState || { 
    isPlaying: false, 
    track: null, 
    audioElement: null,
    isShuffle: false, 
    repeatMode: 'normal',
    play: () => {}, 
    pause: () => {}, 
    next: () => {},
    prev: () => {},
    toggleShuffle: () => {},
    toggleRepeat: () => {} 
};
        const musicWindow = createWindow(windowId, 'Music Player', content, 680, 520);
        const audio = new Audio();
        audio.crossOrigin = "anonymous";
        audio.volume = systemVolume / 100;
        const appData = openApps.get(windowId);
        if (appData) appData.audio = audio;
        let playlists = {}; let expandedPlaylists = new Set();
        let playQueue = []; let currentQueueIndex = -1;
        let currentPlaybackContext = null;
        let playbackMode = 'normal'; let isShuffle = false;
        const VFS_PLAYLIST_PATH = '/Documents/playlists.json';
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioCtx.createAnalyser(); analyser.fftSize = 256;
        const source = audioCtx.createMediaElementSource(audio);
        source.connect(analyser); analyser.connect(audioCtx.destination);
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        const dom = { container: musicWindow.querySelector('.music-player-container'), display: musicWindow.querySelector('#current-song-display'), artist: musicWindow.querySelector('#current-artist-display'), iconPlaceholder: musicWindow.querySelector('#music-icon-placeholder'), playPauseBtn: musicWindow.querySelector('#play-pause-btn'), playPauseIcon: musicWindow.querySelector('#play-pause-btn i'), progressBar: musicWindow.querySelector('.progress-bar-wrapper'), progressFg: musicWindow.querySelector('#progress-bar-fg'), progressInput: musicWindow.querySelector('#music-progress'), currentTimeEl: musicWindow.querySelector('#music-current-time'), durationEl: musicWindow.querySelector('#music-duration'), playlistLibrary: musicWindow.querySelector('#playlist-library'), addMusicBtn: musicWindow.querySelector('#add-music-btn'), createPlaylistBtn: musicWindow.querySelector('#create-playlist-btn'), nextBtn: musicWindow.querySelector('#next-music-btn'), prevBtn: musicWindow.querySelector('#prev-music-btn'), shuffleBtn: musicWindow.querySelector('#shuffle-btn'), repeatBtn: musicWindow.querySelector('#repeat-btn'), visualizerCanvas: musicWindow.querySelector('#visualizer-canvas') };
        const canvasCtx = dom.visualizerCanvas.getContext('2d');
        let lastVisualizerAvg = 0;
const visualizerWorker = new Worker(visualizerWorkerUrl);
visualizerWorker.onmessage = (e) => {
    lastVisualizerAvg = e.data.avg || 0;
};
        let animationFrameId;
function drawVisualizer() {
    animationFrameId = requestAnimationFrame(drawVisualizer);
    canvasCtx.clearRect(0, 0, dom.visualizerCanvas.width, dom.visualizerCanvas.height);
    const radius = dom.visualizerCanvas.width / 3.8;
    const centerX = dom.visualizerCanvas.width / 2;
    const centerY = dom.visualizerCanvas.height / 2;
    const scale = 1 + (lastVisualizerAvg / 255) * 0.5;
    canvasCtx.beginPath();
    canvasCtx.arc(centerX, centerY, radius * scale, 0, 2 * Math.PI);
    canvasCtx.strokeStyle = `rgba(0, 123, 255, ${0.2 + (lastVisualizerAvg/255)*0.8})`;
    canvasCtx.lineWidth = 2 + (lastVisualizerAvg / 255) * 8;
    canvasCtx.stroke();
    analyser.getByteFrequencyData(dataArray);
    visualizerWorker.postMessage(dataArray);
}
    const dropZones = [musicWindow.querySelector('#music-sidebar'), musicWindow.querySelector('#music-main')];
    dropZones.forEach(zone => {
        const overlay = document.createElement('div');
        overlay.className = 'drop-target-overlay';
        overlay.innerHTML = `<i class="fas fa-plus"></i>`;
        zone.style.position = 'relative';
        zone.appendChild(overlay);
        let dragCounter = 0;
        zone.addEventListener('dragenter', (e) => {
            e.preventDefault();
            e.stopPropagation(); 
            dragCounter++;
            if (e.dataTransfer.types.includes('text/plain')) {
                overlay.classList.add('visible');
            }
        });
        zone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dragCounter--;
            if (dragCounter === 0) {
                overlay.classList.remove('visible');
            }
        });
        zone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation(); 
        });
        zone.addEventListener('drop', async (e) => {
            e.preventDefault();
            e.stopPropagation(); 
            dragCounter = 0;
            overlay.classList.remove('visible');
            const filePath = e.dataTransfer.getData('text/plain');
            if (filePath) {
                try {
                    const fileData = await VFS.readFile(filePath);
                    if (fileData && fileData.type.startsWith('audio/')) {
                        if(!playlists['all-music']) playlists['all-music'] = {name: '', tracks: []};
                        playlists['all-music'].tracks.push(fileData);
                        await savePlaylists();
                        renderPlaylistLibrary();
                        createNotification('', `${fileData.name}`, 'info');
                    } else {
                        createNotification('', '', 'warning');
                    }
                } catch (err) {
                    createNotification('', `: ${err.message}`, 'error');
                }
            }
        });
    });
        const formatTime = (s) => isNaN(s) ? "0:00" : `${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`;
        const savePlaylists = async () => { try { const blob = new Blob([JSON.stringify(playlists, null, 2)], {type:'application/json'}); const reader = new FileReader(); reader.onload = async (e) => await VFS.writeFile('/Documents', 'playlists.json', 'application/json', e.target.result); reader.readAsDataURL(blob); } catch (err) { console.error('Failed to save playlists:', err); } };
        const loadPlaylists = async () => { try { const fileData = await VFS.readFile(VFS_PLAYLIST_PATH); const response = await fetch(fileData.content); playlists = await response.json(); } catch (err) { playlists = { 'all-music': { name: '', tracks: [] } }; } renderPlaylistLibrary(); };
        const renderPlaylistLibrary = () => {
            dom.playlistLibrary.innerHTML = '';
            Object.entries(playlists).forEach(([id, pl]) => {
                const li = document.createElement('li');
                li.dataset.playlistId = id;
                const isExpanded = expandedPlaylists.has(id);
                const isPlaylistPlaying = currentPlaybackContext?.type === 'playlist' && currentPlaybackContext.id === id && !audio.paused;
                li.innerHTML = `
                    <div class="playlist-library-item p-2 rounded-md flex justify-between items-center">
                        <div class="flex items-center gap-2 cursor-pointer expand-btn flex-grow truncate">
                            <i class="fas fa-chevron-right transition-transform ${isExpanded ? 'rotate-90' : ''}"></i>
                            <span class="font-medium truncate playlist-name ${isPlaylistPlaying ? 'playing' : ''}">${pl.name}</span>
                        </div>
                        <div class="flex items-center">
                            <button class="action-btn play-playlist-btn text-xs"><i class="fas ${isPlaylistPlaying ? 'fa-pause' : 'fa-play'}"></i></button>
                        </div>
                    </div>
                    <ul class="song-list list-none pl-6 ${isExpanded ? '' : 'hidden'}"></ul>
                `;
                if (isExpanded) {
                    const songListUl = li.querySelector('.song-list');
                    if(pl.tracks.length > 0) {
                        pl.tracks.forEach((track, index) => {
                            const isSongPlayingFromSingle = currentPlaybackContext?.type === 'song' && currentPlaybackContext.id === track.path && !audio.paused;
                            const isSongPlayingFromPlaylist = currentPlaybackContext?.type === 'playlist' && playQueue[currentQueueIndex]?.path === track.path && !audio.paused;
                            const isPlaying = isSongPlayingFromSingle || isSongPlayingFromPlaylist;
                            const songLi = document.createElement('li');
                            songLi.className = `playlist-song-item p-1 rounded-md flex items-center justify-between`;
                            songLi.innerHTML = `<span class="song-title truncate flex-grow ${isPlaying ? 'playing' : ''}">${track.name}</span> <button class="action-btn play-song-btn text-xs ml-2"><i class="fas ${isPlaying ? 'fa-pause' : 'fa-play'}"></i></button>`;
                            songLi.draggable = true;
                            songLi.dataset.playlistId = id;
                            songLi.dataset.trackIndex = index;
                            songLi.dataset.trackPath = track.path;
                            songListUl.appendChild(songLi);
                        });
                    } else {
                        songListUl.innerHTML = `<li class="text-xs text-gray-500 p-1"></li>`;
                    }
                }
                dom.playlistLibrary.appendChild(li);
            });
        };
        const setQueueFromPlaylist = (playlistId) => { if (!playlists[playlistId]) return; currentPlaybackContext = { type: 'playlist', id: playlistId }; playQueue = [...playlists[playlistId].tracks]; if (isShuffle) shuffleQueue(); };
        const setQueueFromSingleSong = (playlistId, trackIndex) => { const track = playlists[playlistId].tracks[trackIndex]; if(!track) return; currentPlaybackContext = {type: 'song', id: track.path }; playQueue = [track]; };
        const shuffleQueue = () => { for (let i=playQueue.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [playQueue[i],playQueue[j]]=[playQueue[j],playQueue[i]]; } };
const loadTrack = (index) => {
    if (index < 0 || index >= playQueue.length) {
        pauseTrack();
        window.globalMusicState.isPlaying = false;
        window.globalMusicState.track = null;
        window.globalMusicState.audioElement = null;
        updateQuickSettingsMusicPlayer();
        return;
    }
    currentQueueIndex = index;
    const trackData = playQueue[index];
    audio.src = trackData.content;
    dom.display.textContent = trackData.name;
    window.globalMusicState.track = trackData;
    window.globalMusicState.audioElement = audio; 
    updateQuickSettingsMusicPlayer();
    renderPlaylistLibrary();
};      
const playTrack = () => {
    if (playQueue.length > 0) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        audio.play().catch(console.error);
        window.globalMusicState.isPlaying = true;
        updateQuickSettingsMusicPlayer();
    }
};
const pauseTrack = () => {
    audio.pause();
    window.globalMusicState.isPlaying = false;
    updateQuickSettingsMusicPlayer();
};
        const playTrackByIndex = (index) => { loadTrack(index); playTrack(); };
        const playNext = () => { if (playQueue.length > 0) playTrackByIndex((currentQueueIndex + 1) % playQueue.length); };
        const playPrev = () => { if (playQueue.length > 0) playTrackByIndex((currentQueueIndex - 1 + playQueue.length) % playQueue.length); };
        window.globalMusicState.play = playTrack;
        window.globalMusicState.pause = pauseTrack;
        window.globalMusicState.next = playNext;
        window.globalMusicState.prev = playPrev;
        window.globalMusicState.toggleShuffle = () => {
    dom.shuffleBtn.click();
};
window.globalMusicState.toggleRepeat = () => {
    dom.repeatBtn.click();
};
        dom.playPauseBtn.addEventListener('click', () => (audio.paused && playQueue.length > 0) ? playTrack() : pauseTrack());
        dom.nextBtn.addEventListener('click', playNext);
        dom.prevBtn.addEventListener('click', playPrev);
dom.shuffleBtn.addEventListener('click', () => { 
    isShuffle = !isShuffle; 
    dom.shuffleBtn.classList.toggle('active', isShuffle); 
    window.globalMusicState.isShuffle = isShuffle;
    updateQuickSettingsMusicPlayer();
    if(currentPlaybackContext?.type === 'playlist') { setQueueFromPlaylist(currentPlaybackContext.id); playTrackByIndex(0); }
});
dom.repeatBtn.addEventListener('click', () => { 
    const modes = ['normal', 'repeat-all', 'repeat-one']; 
    playbackMode = modes[(modes.indexOf(playbackMode) + 1) % modes.length]; 
    dom.repeatBtn.innerHTML = playbackMode === 'repeat-one' ? '<i class="fas fa-1"></i>' : '<i class="fas fa-repeat"></i>'; 
    dom.repeatBtn.classList.toggle('active', playbackMode !== 'normal');
    window.globalMusicState.repeatMode = playbackMode;
    updateQuickSettingsMusicPlayer();
});
        dom.createPlaylistBtn.addEventListener('click', async () => { const name = await showMessageBox('', '', {showCancel:true, input:{placeholder:'My Mix'}}); if (name) { const id = `pl_${Date.now()}`; playlists[id] = { name, tracks:[] }; await savePlaylists(); renderPlaylistLibrary(); }});
dom.addMusicBtn.addEventListener('click', async () => {
    const filePaths = await showFilePicker({ 
        mode: 'open', 
        title: '', 
        acceptTypes: ['audio/'],
        multiple: true
    }); 
    if (filePaths && filePaths.length > 0) {
        let addedCount = 0;
        for (const filePath of filePaths) {
            const fileData = await VFS.readFile(filePath);
            if (fileData) {
                if(!playlists['all-music']) playlists['all-music'] = {name: '', tracks: []};
                playlists['all-music'].tracks.push(fileData);
                addedCount++;
            }
        }
        if (addedCount > 0) {
            await savePlaylists();
            renderPlaylistLibrary();
            createNotification('', `${addedCount}`, 'info');
        }
    }
});
dom.playlistLibrary.addEventListener('contextmenu', (e) => {
    const songItem = e.target.closest('.playlist-song-item');
    if (!songItem) return;
    e.preventDefault();
    e.stopPropagation();
    const playlistId = songItem.dataset.playlistId;
    const trackIndex = parseInt(songItem.dataset.trackIndex);
    const trackData = playlists[playlistId]?.tracks[trackIndex];
    if (!trackData) return;
    const menuItems = [
        {
            label: '',
            icon: 'fas fa-trash',
            action: async () => {
                const confirmDelete = await showMessageBox(
                    '', 
                    `${trackData.name}`, 
                    { showCancel: true }
                );
                if (confirmDelete) {
                    if (playQueue[currentQueueIndex]?.path === trackData.path) {
                        pauseTrack();
                    }
                    playlists[playlistId].tracks.splice(trackIndex, 1);
                    await savePlaylists();
                    renderPlaylistLibrary();
                    createNotification('', `${trackData.name}`, 'info');
                }
            }
        },
    ];
    showContextMenu(menuItems, e);
});
        dom.playlistLibrary.addEventListener('click', async e => {
            const expandBtn = e.target.closest('.expand-btn');
            const playPlaylistBtn = e.target.closest('.play-playlist-btn');
            const playSongBtn = e.target.closest('.play-song-btn');
            if (expandBtn) {
                const playlistId = expandBtn.closest('[data-playlist-id]').dataset.playlistId;
                if (expandedPlaylists.has(playlistId)) expandedPlaylists.delete(playlistId); else expandedPlaylists.add(playlistId);
                renderPlaylistLibrary();
            } else if (playPlaylistBtn) {
                const playlistId = playPlaylistBtn.closest('[data-playlist-id]').dataset.playlistId;
                if (currentPlaybackContext?.type === 'playlist' && currentPlaybackContext.id === playlistId && !audio.paused) {
                    pauseTrack();
                } else {
                    setQueueFromPlaylist(playlistId);
                    playTrackByIndex(0);
                }
            } else if (playSongBtn) {
                const songLi = playSongBtn.closest('.playlist-song-item');
                const playlistId = songLi.dataset.playlistId;
                const trackIndex = parseInt(songLi.dataset.trackIndex);
                const trackPath = songLi.dataset.trackPath;
                if ((currentPlaybackContext?.type === 'song' && currentPlaybackContext.id === trackPath && !audio.paused) || (currentPlaybackContext?.type === 'playlist' && playQueue[currentQueueIndex]?.path === trackPath && !audio.paused)) {
                    pauseTrack();
                } else {
                    setQueueFromSingleSong(playlistId, trackIndex);
                    playTrackByIndex(0);
                }
            }
        });
        dom.playlistLibrary.addEventListener('contextmenu', e => {
            e.preventDefault();
            const playlistItem = e.target.closest('.playlist-library-item');
            if (playlistItem) {
                const playlistId = playlistItem.closest('[data-playlist-id]').dataset.playlistId;
                showContextMenu([
                    { label: '', icon: 'fas fa-pen', action: async () => {
                        const newName = await showMessageBox('', '', { showCancel: true, input: { value: playlists[playlistId].name } });
                        if (newName) { playlists[playlistId].name = newName; await savePlaylists(); renderPlaylistLibrary(); }
                    }},
                    { label: '', icon: 'fas fa-trash', action: async () => {
                        const confirm = await showMessageBox('', `${playlists[playlistId].name}`, { showCancel: true });
                        if (confirm) { delete playlists[playlistId]; await savePlaylists(); renderPlaylistLibrary(); }
                    }}
                ], e);
            }
        });
        let draggedItem = null;
        dom.playlistLibrary.addEventListener('dragstart', e => { const song = e.target.closest('.playlist-song-item'); if(song){ e.dataTransfer.effectAllowed = 'move'; draggedItem = song; }});
        dom.playlistLibrary.addEventListener('dragover', e => { e.preventDefault(); const target = e.target.closest('.playlist-song-item, .playlist-library-item'); if(target && target !== draggedItem){ const rect = target.getBoundingClientRect(); const isAfter = e.clientY > rect.top + rect.height / 2; document.querySelectorAll('.drop-indicator').forEach(i => i.remove()); const indicator = document.createElement('div'); indicator.className = 'drop-indicator'; if (target.classList.contains('playlist-library-item')) { target.after(indicator); } else { if (isAfter) target.after(indicator); else target.before(indicator); } }});
        dom.playlistLibrary.addEventListener('drop', async e => { e.preventDefault(); document.querySelectorAll('.drop-indicator').forEach(i => i.remove()); const target = e.target.closest('.playlist-song-item, .playlist-library-item'); if(!draggedItem || !target) return; const fromPlId = draggedItem.dataset.playlistId, fromIndex = parseInt(draggedItem.dataset.trackIndex); const trackToMove = playlists[fromPlId].tracks[fromIndex]; let toPlId, toIndex; if(target.classList.contains('playlist-song-item')){ toPlId = target.dataset.playlistId; toIndex = parseInt(target.dataset.trackIndex); } else { toPlId = target.closest('[data-playlist-id]').dataset.playlistId; toIndex = playlists[toPlId].tracks.length; } playlists[fromPlId].tracks.splice(fromIndex, 1); playlists[toPlId].tracks.splice(toIndex, 0, trackToMove); await savePlaylists(); renderPlaylistLibrary(); });
        dom.progressInput.addEventListener('input', () => { audio.currentTime = dom.progressInput.value; dom.progressFg.style.width = `${(dom.progressInput.value / audio.duration) * 100}%`; });
        audio.addEventListener('play', () => { dom.playPauseIcon.className = 'fas fa-pause'; dom.iconPlaceholder.style.opacity = '0.3'; renderPlaylistLibrary(); });
        audio.addEventListener('pause', () => { dom.playPauseIcon.className = 'fas fa-play'; dom.iconPlaceholder.style.opacity = '1'; renderPlaylistLibrary(); });
        audio.addEventListener('loadedmetadata', () => { dom.durationEl.textContent = formatTime(audio.duration); dom.progressInput.max = audio.duration; });
audio.addEventListener('timeupdate', () => {
    dom.currentTimeEl.textContent = formatTime(audio.currentTime);
    if (!audio.paused) {
        dom.progressInput.value = audio.currentTime;
        dom.progressFg.style.width = `${(audio.currentTime / audio.duration) * 100}%`;
    }
    updateQuickSettingsMusicPlayer();
});
        audio.addEventListener('ended', () => { if (playbackMode==='repeat-one') playTrackByIndex(currentQueueIndex); else if (playbackMode==='repeat-all' || isShuffle) playNext(); else if (currentQueueIndex < playQueue.length-1) playNext(); else pauseTrack(); });
        (async () => {
            await loadPlaylists();
            if (params.path) {
                const fileData = await VFS.readFile(params.path);
                if (fileData) {
                    playQueue = [fileData];
                    currentPlaybackContext = {type: 'song', id: fileData.path};
                    playTrackByIndex(0);
                }
            }
        })();
        const resizeCanvas = () => { dom.visualizerCanvas.width = dom.visualizerCanvas.offsetWidth; dom.visualizerCanvas.height = dom.visualizerCanvas.offsetHeight; };
        resizeCanvas();
        new ResizeObserver(resizeCanvas).observe(dom.visualizerCanvas);
        drawVisualizer();
        const originalCloseHandler = musicWindow.querySelector('.close').onclick;
musicWindow.querySelector('.close').onclick = () => {
    if (originalCloseHandler) originalCloseHandler();
    cancelAnimationFrame(animationFrameId);
    visualizerWorker.terminate();
    if (window.globalMusicState) {
        window.globalMusicState.isPlaying = false;
        window.globalMusicState.track = null;
        if(window.globalMusicState.audioElement) {
            window.globalMusicState.audioElement.pause();
            window.globalMusicState.audioElement.src = '';
            window.globalMusicState.audioElement = null;
        }
    }
    updateQuickSettingsMusicPlayer();
};
    }
},
{ 
    id: 'files', name: '', icon: 'fas fa-folder', installed: true,
launcher: (params = {}) => {
    const content = `
        <div class="flex h-full">
            <div id="files-sidebar" class="w-1/4 p-2 border-r" style="border-color: var(--border-color-dark);">
                <h4 class="font-semibold mb-2 p-2"></h4>
                <ul>
                    <li data-path="/" class="p-2 rounded-lg hover:bg-white/10 cursor-pointer flex items-center"><i class="fas fa-desktop mr-2 w-4"></i> OS ()</li>
                    <li data-path="/Documents" class="p-2 rounded-lg hover:bg-white/10 cursor-pointer flex items-center"><i class="fas fa-file-alt mr-2 w-4"></i> Documents</li>
                    <li data-path="/Pictures" class="p-2 rounded-lg hover:bg-white/10 cursor-pointer flex items-center"><i class="fas fa-image mr-2 w-4"></i> Pictures</li>
                    <li data-path="/Music" class="p-2 rounded-lg hover:bg-white/10 cursor-pointer flex items-center"><i class="fas fa-music mr-2 w-4"></i> Music</li>
                    <li data-path="/Apps" class="p-2 rounded-lg hover:bg-white/10 cursor-pointer flex items-center"><i class="fas fa-th-large mr-2 w-4"></i> </li>
                    <li data-path="/Trash" class="p-2 rounded-lg hover:bg-white/10 cursor-pointer flex items-center"><i class="fas fa-trash mr-2 w-4"></i> </li>
                </ul>
            </div>
            <div class="w-3/4 p-2 flex flex-col">
                <div id="files-header-container" class="flex items-center p-2 border-b mb-2" style="border-color: var(--border-color-dark);"></div>
                <div id="files-grid" class="flex-grow overflow-y-auto"></div>
            </div>
        </div>
    `;
    const filesWindow = createWindow('app-window-files', '', content, 700, 500);
    const grid = filesWindow.querySelector('#files-grid');
    const headerContainer = filesWindow.querySelector('#files-header-container');
    const sidebar = filesWindow.querySelector('#files-sidebar');
    let currentPath = '/';
    let selectedFiles = new Set();
    let viewMode = 'grid';
   const setupHeader = (path, customTitle = null) => {
    const isInfoView = customTitle === '';
    const isTrashView = path === '/Trash';
    const pathToShow = customTitle || (path === '/' ? 'OS ()' : path);
    headerContainer.innerHTML = `
        <button id="files-back-btn" class="mr-2 p-2 rounded-full hover:bg-white/10"><i class="fas fa-arrow-left"></i></button>
        <span class="font-mono text-sm">${pathToShow}</span>
        ${isInfoView ? '' : `
            <div id="view-mode-switcher" class="ml-auto flex items-center bg-black/20 rounded-lg p-1">
                <button data-view="grid" class="view-mode-btn w-7 h-7 rounded-md grid place-items-center"><i class="fas fa-th-large"></i></button>
                <button data-view="list" class="view-mode-btn w-7 h-7 rounded-md grid place-items-center"><i class="fas fa-list"></i></button>
            </div>
            ${isTrashView ? `
                <button id="empty-trash-btn" class="ml-2 bg-red-600 text-white px-3 py-1 rounded-md text-sm"></button>
            ` : `
                <input type="file" id="files-upload-input" class="hidden" multiple>
                <button id="files-upload-btn" class="ml-2 bg-blue-600 text-white px-3 py-1 rounded-md text-sm"></button>
            `}
        `}
    `;
    headerContainer.querySelector('#files-back-btn').onclick = () => {
        const targetPath = isInfoView ? currentPath : (path === '/' ? '/' : path.substring(0, path.lastIndexOf('/')) || '/');
        renderFiles(targetPath);
    };
    if (!isInfoView) {
        const viewSwitcher = headerContainer.querySelector('#view-mode-switcher');
        if(viewSwitcher) {
            viewSwitcher.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === viewMode);
                btn.onclick = () => {
                    viewMode = btn.dataset.view;
                    renderFiles(currentPath);
                };
            });
        }
        if(isTrashView) {
            const emptyTrashBtn = headerContainer.querySelector('#empty-trash-btn');
            if(emptyTrashBtn) {
                emptyTrashBtn.onclick = async () => {
                    const confirm = await showMessageBox('', '', { showCancel: true });
                    if (confirm) {
                        try {
                            const trashItems = await VFS.listFiles('/Trash');
                            for (const item of trashItems) {
                                await VFS.delete(item.path, true);
                            }
                            await renderFiles('/Trash');
                        } catch (err) {
                            createNotification('', `: ${err.message}`, 'error');
                        }
                    }
                };
            }
        } else {
            const uploadInput = headerContainer.querySelector('#files-upload-input');
            const uploadBtn = headerContainer.querySelector('#files-upload-btn');
            if(uploadBtn && uploadInput) {
                uploadBtn.onclick = () => uploadInput.click();
                uploadInput.onchange = async (e) => {
                    const files = e.target.files;
                    if (!files || files.length === 0) return;
                    createNotification('', `${files.length}...`, 'info');
                    await Promise.all(Array.from(files).map(file => {
                        return new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = async (event) => {
                                try { await VFS.writeFile(currentPath, file.name, file.type, event.target.result); resolve(); } catch (err) { reject(err); }
                            };
                            reader.readAsDataURL(file);
                        });
                    }));
                    createNotification('', '', 'info');
                    await renderFiles(currentPath);
                };
            }
        }
    }
};
const renderMoveTarget = async (targetPath) => {
    setupHeader(currentPath, '');
    grid.className = 'p-2';
    grid.innerHTML = '<p>...</p>';
    try {
        const folders = (await VFS.listFiles(targetPath)).filter(f => f.type === 'folder' && f.special !== 'trash');
        let listHtml = '';
        if (targetPath !== '/') {
            const parentPath = targetPath.substring(0, targetPath.lastIndexOf('/')) || '/';
            listHtml += `<li data-path="${parentPath}" class="p-2 rounded hover:bg-white/10 cursor-pointer flex items-center gap-2"><i class="fas fa-arrow-up w-4 text-center"></i> ...</li>`;
        }
        listHtml += folders.map(f => `<li data-path="${f.path}" class="p-2 rounded hover:bg-white/10 cursor-pointer flex items-center gap-2"><i class="fas fa-folder w-4 text-center"></i> ${f.name}</li>`).join('');
        grid.innerHTML = `
            <div class="flex flex-col h-full">
                <ul class="flex-grow max-h-full overflow-y-auto">${listHtml}</ul>
                <div class="p-2 mt-auto text-right border-t border-white/10">
                    <button id="move-confirm-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg"></button>
                </div>
            </div>`;
        grid.querySelectorAll('li[data-path]').forEach(li => {
            li.addEventListener('click', () => renderMoveTarget(li.dataset.path));
        });
grid.querySelector('#move-confirm-btn').onclick = async () => {
    createNotification('...', `${selectedFiles.size} `, 'info');
    let successCount = 0;
    let errorCount = 0;
    let skippedCount = 0;
    for (const filePath of selectedFiles) {
        try {
            const itemToMove = await VFS.readFile(filePath);
            if (itemToMove.type === 'folder') {
                console.log(`Skipping folder: ${filePath}`);
                skippedCount++;
                continue; 
            }
            if (targetPath.startsWith(filePath + '/')) {
                throw new Error('');
            }
            await VFS.move(filePath, targetPath);
            successCount++;
        } catch (err) {
            console.error(`Error moving ${filePath}:`, err);
            errorCount++;
        }
    }
    if (errorCount > 0) {
        createNotification('', `${errorCount} `, 'error');
    }
    if (skippedCount > 0) {
        createNotification('', `${skippedCount} `, 'info');
    }
    if (successCount > 0) {
        createNotification('', `${successCount} `, 'info');
    }
    await renderFiles(currentPath);
};
    } catch (err) {
        grid.innerHTML = `<p class="text-red-500">: ${err.message}</p>`;
    }
};
const renderFileInfo = async (filePath) => {
    setupHeader(currentPath, '');
    grid.className = 'p-4';
    grid.innerHTML = '<p>...</p>';
    try {
        const fileInfo = await VFS.readFile(filePath);
        if (!fileInfo) throw new Error("");
        const formatBytes = (bytes, decimals = 2) => {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
        const infoHtml = `
            <div class="flex items-center gap-4">
                ${fileInfo.type.startsWith('image/') && fileInfo.content
                    ? `<img src="${fileInfo.content}" class="w-24 h-24 object-contain bg-black/20 rounded-lg">`
                    : `<i class="${getIconForType(fileInfo.type)} text-6xl w-24 text-center"></i>`
                }
                <h3 class="text-2xl font-bold truncate">${fileInfo.name}</h3>
            </div>
            <div class="mt-6 space-y-3 text-sm">
                <div class="flex"><p class="w-32 text-gray-400"></p><p>${fileInfo.type === 'folder' ? '' : fileInfo.type}</p></div>
                <div class="flex"><p class="w-32 text-gray-400"></p><p>${formatBytes(fileInfo.content?.length)}</p></div>
                <div class="flex"><p class="w-32 text-gray-400"></p><p class="font-mono">${fileInfo.parent}</p></div>
                <hr class="border-white/10 my-3">
                <div class="flex"><p class="w-32 text-gray-400"></p><p>${new Date(fileInfo.ctime).toLocaleString()}</p></div>
                <div class="flex"><p class="w-32 text-gray-400"></p><p>${new Date(fileInfo.mtime).toLocaleString()}</p></div>
            </div>
        `;
        grid.innerHTML = infoHtml;
    } catch (err) {
        grid.innerHTML = `<p class="text-red-500">: ${err.message}</p>`;
    }
};
const renderFiles = async (path) => {
    currentPath = path;
    setupHeader(path);
    const viewSwitcher = headerContainer.querySelector('#view-mode-switcher');
    if (viewSwitcher) {
        viewSwitcher.querySelectorAll('.view-mode-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === viewMode);
            btn.onclick = () => {
                viewMode = btn.dataset.view;
                renderFiles(currentPath);
            };
        });
    }
    grid.className = `p-2 flex-grow overflow-y-auto ${viewMode === 'grid' ? 'grid grid-cols-[repeat(auto-fill,minmax(96px,1fr))] gap-4 content-start' : 'list-view'}`;
    grid.innerHTML = `<div class="col-span-full text-center p-4"><p class="text-gray-500 mb-2">...</p><div class="w-full bg-gray-700 rounded-full h-1.5"><div id="file-load-progress" class="bg-blue-500 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div></div></div>`;
    const progressBar = grid.querySelector('#file-load-progress');
    if (progressBar) setTimeout(() => progressBar.style.width = '30%', 10);
    if (path === '/Apps') {
         if (progressBar) progressBar.style.width = '100%';
         setTimeout(() => {
            grid.innerHTML = '';
            apps.filter(app => app.installed).forEach(app => {
                const itemDiv = document.createElement('div');
                itemDiv.className = "file-item-grid text-center p-2 rounded-lg cursor-pointer flex flex-col items-center justify-between h-24 relative";
                itemDiv.draggable = true;
                itemDiv.dataset.path = `/Apps/${app.id}`;
                itemDiv.innerHTML = `<div class="desktop-icon-img"><i class="${app.icon} text-4xl"></i></div><p class="text-sm break-all w-full truncate">${app.name}</p>`;
                itemDiv.addEventListener('dragstart', (e) => e.dataTransfer.setData('text/plain', `/Apps/${app.id}`));
                itemDiv.addEventListener('dblclick', () => launchApp(app.id));
                grid.appendChild(itemDiv);
            });
         }, 300);
        return;
    }
    try {
        let items = await listFilesWithWorker(path);
        if (path !== '/Trash') {
            items = items.filter(item => !item.special);
        }
        if (progressBar) progressBar.style.width = '100%';
        setTimeout(() => {
            grid.innerHTML = '';
            if (items.length === 0) grid.innerHTML = `<p class="text-center text-gray-500 ${viewMode === 'grid' ? 'col-span-full' : ''}"></p>`;
            items.forEach(item => {
                if (item.special === 'trash') return;
                const itemDiv = document.createElement('div');
                const isSelected = selectedFiles.has(item.path);
                if (viewMode === 'grid') {
                    itemDiv.className = "file-item-grid text-center p-2 rounded-lg cursor-pointer flex flex-col items-center justify-between h-24 relative";
                    const iconContainer = document.createElement('div');
                    iconContainer.className = "w-full h-12 flex items-center justify-center mb-1";
                    if (item.type.startsWith('image/') && item.content) {
                        iconContainer.innerHTML = `<img src="${item.content}" class="max-w-full max-h-full object-contain">`;
                    } else {
                        iconContainer.innerHTML = `<i class="${getIconForType(item.type)} text-4xl"></i>`;
                    }
                    const p = document.createElement('p');
                    p.className = "text-sm break-all w-full truncate";
                    p.textContent = path === '/Trash' ? item.name.replace(/_\d+$/, '') : item.name;
                    itemDiv.appendChild(iconContainer);
                    itemDiv.appendChild(p);
                } else {
                    itemDiv.className = "file-item-list";
                    itemDiv.innerHTML = `
                        <i class="${getIconForType(item.type)} text-lg text-center"></i>
                        <span class="file-name">${path === '/Trash' ? item.name.replace(/_\d+$/, '') : item.name}</span>
                        <span class="file-meta">${new Date(item.mtime).toLocaleString()}</span>
                        <span class="file-meta">${item.type === 'folder' ? '' : item.type}</span>
                    `;
                }
                itemDiv.title = item.name;
                itemDiv.dataset.path = item.path;
                itemDiv.classList.toggle('selected', isSelected);                            
                    const dblclickHandler = () => {
                        if (item.type === 'folder') {
                            renderFiles(item.path);
                        } else {
                            const appMap = {
    'image/': 'image-viewer',
    'audio/': 'music-player',
    'video/': 'media-player',
    'text/plain': 'text-reader', 
    'text/html': 'html-editor' 
};
                            for (const [typePrefix, appId] of Object.entries(appMap)) {
                                if (item.type.startsWith(typePrefix)) return launchApp(appId, { path: item.path });
                            }
                            createNotification('', `${item.name}`, 'error');
                        }
                    };
                itemDiv.addEventListener('dblclick', dblclickHandler);
                itemDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const itemPath = itemDiv.dataset.path;
                    if (!e.ctrlKey && !e.metaKey && !e.shiftKey) {
                        selectedFiles.clear();
                        selectedFiles.add(itemPath);
                    } else if (e.ctrlKey || e.metaKey) {
                        if (selectedFiles.has(itemPath)) {
                            selectedFiles.delete(itemPath);
                        } else {
                            selectedFiles.add(itemPath);
                        }
                    }
                    grid.querySelectorAll('[data-path]').forEach(el => {
                        el.classList.toggle('selected', selectedFiles.has(el.dataset.path));
                    });
                });
                    if (path !== '/Trash') {
                        itemDiv.draggable = true;
                        itemDiv.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', item.path); e.dataTransfer.effectAllowed = 'move'; setTimeout(() => itemDiv.style.opacity = '0.5', 0); });
                        itemDiv.addEventListener('dragend', () => { itemDiv.style.opacity = '1'; });
                        if (item.type === 'folder') {
                            itemDiv.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; itemDiv.style.backgroundColor = 'rgba(0, 123, 255, 0.3)'; });
                            itemDiv.addEventListener('dragleave', () => { itemDiv.style.backgroundColor = ''; });
                            itemDiv.addEventListener('drop', async (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                itemDiv.style.backgroundColor = '';
                                const sourcePath = e.dataTransfer.getData('text/plain');
                                if (sourcePath && item.path && sourcePath !== item.path && !item.path.startsWith(sourcePath + '/')) {
                                    try {
                                        await VFS.move(sourcePath, item.path);
                                        await renderFiles(currentPath);
                                    } catch (err) {
                                        console.error(`Failed to move file:`, err);
                                        createNotification('', `: ${err.message}`, 'error');
                                    }
                                }
                            });
                        }
                    }
itemDiv.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    e.stopPropagation();
    if (!selectedFiles.has(item.path)) {
        selectedFiles.clear();
        selectedFiles.add(item.path);
        grid.querySelectorAll('[data-path]').forEach(el => {
            el.classList.toggle('selected', selectedFiles.has(el.dataset.path));
        });
    }
    const isInTrash = currentPath === '/Trash';
    let menuItems = [];
    const singleSelectedItemPath = selectedFiles.values().next().value;
    const singleSelectedItem = items.find(i => i.path === singleSelectedItemPath);
    if (!singleSelectedItem) return;
    const renameAction = () => {
        const elToRename = grid.querySelector(`[data-path="${singleSelectedItem.path}"]`);
        if (!elToRename) return;
        const p = elToRename.querySelector(viewMode === 'grid' ? 'p' : '.file-name');
        if (!p) return;
        p.innerHTML = `<input type="text" class="w-full text-center bg-transparent border border-blue-500 rounded outline-none" style="color: ${document.body.classList.contains('dark-mode') ? 'white' : 'black'};" value="${singleSelectedItem.name}">`;
        const input = p.querySelector('input');
        input.focus();
        input.select();
        const saveName = async () => {
            const newName = input.value.trim();
            if (newName && newName !== singleSelectedItem.name) {
                try { 
                    await VFS.rename(singleSelectedItem.path, newName); 
                } catch (err) { 
                    createNotification('', `: ${err.message}`, 'error'); 
                }
            }
            await renderFiles(currentPath);
        };
        input.addEventListener('blur', saveName);
        input.addEventListener('keydown', (ev) => { 
            if (ev.key === 'Enter') input.blur();
            if (ev.key === 'Escape') renderFiles(currentPath);
        });
    };
    const deleteAction = async () => {
        try {
            await VFS.delete(singleSelectedItem.path);
            await renderFiles(currentPath);
        } catch (err) {
            createNotification('', `: ${err.message}`, 'error');
        }
    };
    if (isInTrash) {
        menuItems = [
            { label: '', icon: 'fas fa-undo', action: async () => { try { await VFS.restore(singleSelectedItem.path); await renderFiles(currentPath); } catch (err) { createNotification('', `: ${err.message}`, 'error'); } } },
            { separator: true },
            { label: '', icon: 'fas fa-bomb', action: async () => { const confirm = await showMessageBox('', `${singleSelectedItem.name}`, { showCancel: true }); if (confirm) { try { await VFS.delete(singleSelectedItem.path, true); await renderFiles(currentPath); } catch (err) { createNotification('', `: ${err.message}`, 'error'); } } } }
        ];
    } else {
        if (singleSelectedItem.type === 'folder') {
            menuItems = [
                { label: '', icon: 'fas fa-folder-open', action: () => renderFiles(singleSelectedItem.path) },
                { label: '', icon: 'fas fa-pen', action: renameAction },
                { separator: true },
                { label: '', icon: 'fas fa-info-circle', action: () => renderFileInfo(singleSelectedItem.path) },
                { label: '', icon: 'fas fa-trash', action: deleteAction }
            ];
        } else {
const compatibleApps = [
    { appId: 'text-reader', name: '', types: ['text/', 'application/json'] },
    { appId: 'notepad', name: '', types: ['text/', 'application/json'] },
    { appId: 'html-editor', name: 'HTML', types: ['text/html', 'text/css', 'text/javascript', 'application/json'] }, 
    { appId: 'image-viewer', name: '', types: ['image/'] },
    { appId: 'media-player', name: '', types: ['video/'] },
    { appId: 'music-player', name: 'Music Player', types: ['audio/'] },
    { appId: 'code-runner', name: '', types: ['text/html'] }
].filter(appDef => {
    const appInfo = apps.find(a => a.id === appDef.appId);
                return appInfo && appInfo.installed && appDef.types.some(typePrefix => singleSelectedItem.type.startsWith(typePrefix));
            });
            menuItems = [
                {
                    label: '',
                    icon: 'fas fa-folder-open',
                    submenu: compatibleApps.map(appDef => ({
                        label: appDef.name,
                        icon: apps.find(a => a.id === appDef.appId)?.icon || 'fas fa-window-maximize',
                        action: () => launchApp(appDef.appId, { path: singleSelectedItem.path })
                    }))
                },
                { separator: true },
                { label: '', icon: 'fas fa-pen', action: renameAction },
                { label: '', icon: 'fas fa-info-circle', action: () => renderFileInfo(singleSelectedItem.path) },
                { label: '', icon: 'fas fa-trash', action: deleteAction }
            ];
        }
    }
    showContextMenu(menuItems, e);
});
                    grid.appendChild(itemDiv);
                });
            if (params.select) {
                const itemToSelect = grid.querySelector(`[data-path="${params.select}"]`);
                if (itemToSelect) {
                    itemToSelect.click();
                    itemToSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            }, 300);
        } catch (err) {
            grid.innerHTML = `<p class="col-span-full text-center text-red-500"></p>`;
            console.error("Error rendering files:", err);
        }
    };
    sidebar.addEventListener('click', (e) => {
        const li = e.target.closest('li[data-path]');
        if (li) renderFiles(li.dataset.path);
    });
    sidebar.addEventListener('dragover', (e) => { const li = e.target.closest('li[data-path]'); if(li) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; li.style.backgroundColor = 'rgba(0, 123, 255, 0.3)'; } });
    sidebar.addEventListener('dragleave', (e) => { const li = e.target.closest('li[data-path]'); if(li) { li.style.backgroundColor = ''; } });
    sidebar.addEventListener('drop', async (e) => { const li = e.target.closest('li[data-path]'); if(li) { e.preventDefault(); e.stopPropagation(); li.style.backgroundColor = ''; const sourcePath = e.dataTransfer.getData('text/plain'); const destFolderPath = li.dataset.path; if (sourcePath && destFolderPath && sourcePath !== destFolderPath && !destFolderPath.startsWith(sourcePath + '/')) { try { if (destFolderPath === '/Trash') { await VFS.delete(sourcePath); } else { await VFS.move(sourcePath, destFolderPath); } if (currentPath === sourcePath.substring(0, sourcePath.lastIndexOf('/'))) { await renderFiles(currentPath); } } catch (err) { createNotification('', `: ${err.message}`, 'error'); } } } });
grid.addEventListener('contextmenu', (e) => {
    if (e.target.closest('[data-path]')) return;
    e.preventDefault();
    const pathForMenu = currentPath;
    showContextMenu([{ 
        label: '', 
        icon: 'fas fa-folder-plus', 
action: async () => { 
    const folderName = await showMessageBox('', '', { showCancel: true, input: { placeholder: '' } }); 
    if (typeof folderName === 'string' && folderName.trim() !== '') { 
        try { 
            await VFS.createFolder(pathForMenu, folderName.trim()); 
            await renderFiles(pathForMenu); 
        } catch (err) { 
            createNotification('', `: ${err.message}`, 'error'); 
        } 
    } 
}
    }], e);
});
    renderFiles('/');
    applyTheme();
}
},
{
                id: 'command', name: '', icon: 'fas fa-terminal', installed: true,
                launcher: () => {
const content = `
    <div class="h-full bg-black text-green-400 font-mono p-2 overflow-y-auto flex flex-col">
        <div id="command-output">
            <div>Rivift OS [Version 2.0.0]</div>
            <div>(c) DANGOKYOUDAI. All rights reserved.</div>
            <br>
        </div>
        <div class="flex mt-auto">
            <span id="command-prompt" class="text-green-400"></span>
            <input type="text" id="command-input" class="bg-black text-green-400 border-none outline-none flex-grow ml-2" autofocus />
        </div>
    </div>
`;
const commandWindow = createWindow('app-window-command', '', content, 600, 400);
const commandInput = commandWindow.querySelector('#command-input');
const commandOutput = commandWindow.querySelector('#command-output');
const commandContentArea = commandWindow.querySelector('.font-mono');
const promptSpan = commandWindow.querySelector('#command-prompt');
let terminalCWD = '/';
let commandHistory = [];
let historyIndex = -1;
const updatePrompt = () => {
    promptSpan.textContent = `RiviftOS:${terminalCWD}$`;
};
const appendOutput = (htmlContent, isError = false) => {
    const div = document.createElement('div');
    if (isError) {
        div.innerHTML = `<span class="text-red-500">${htmlContent}</span>`;
    } else {
        div.innerHTML = htmlContent.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, '<br>');
    }
    commandOutput.appendChild(div);
    commandContentArea.scrollTop = commandContentArea.scrollHeight;
};
const resolvePath = (path) => {
    if (path.startsWith('/')) return path;
    const parts = (terminalCWD + (terminalCWD.endsWith('/') ? '' : '/') + path).split('/');
    const newParts = [];
    for (const part of parts) {
        if (part === '..') {
            if (newParts.length > 0) newParts.pop();
        } else if (part !== '.' && part !== '') {
            newParts.push(part);
        }
    }
    return '/' + newParts.join('/');
};
const commandHandlers = {
    help: async (args) => {
        const commandDetails = {
            'ls': 'ls [path] - ',
            'cd': 'cd [path] -  ".." ',
            'mkdir': 'mkdir [name] - ',
            'touch': 'touch [filename] - ',
            'rm': 'rm [path] - ',
            'cp': 'cp [source] [destination] - ',
            'mv': 'mv [source] [destination] - ',
            'cat': 'cat [filename] - ',
            'echo': 'echo [text] > [filename] - ',
            'open': 'open [appId | path] - ',
            'ps': 'ps - ',
            'kill': 'kill [appId] - ',
            'theme': 'theme [dark|light] - OS',
            'wallpaper': 'wallpaper [image_url] - URL',
            'ping': 'ping [host] -  (: ping google.com)',
            'curl': 'curl [url] - URL',
            'connect': 'connect [email] - Connect',
            'date': 'date - ',
            'calc': 'calc "[expression]" -  (: calc "10 * (5 + 2)")',
            'clear': 'clear - ',
            'pwd': 'pwd - ',
            'grep': '[command] | grep [pattern] - ',
            'time set': 'time set [HH:MM] -  (: time set 14:30)',
            'time sync': 'time sync - ',
            'time': 'time - ',
        };
        if (args[0]) {
            const command = args[0].toLowerCase();
            if (commandDetails[command]) {
                return commandDetails[command];
            } else {
                return `help: : ${command}`;
            }
        } else {
            let output = 'Rivift OS .  "help []" \n\n';
            const commands = Object.keys(commandDetails).sort();
            const maxLength = Math.max(...commands.map(cmd => cmd.length));
            for (let i = 0; i < Math.ceil(commands.length / 2); i++) {
                const cmd1 = commands[i];
                const cmd2 = commands[i + Math.ceil(commands.length / 2)];
                output += cmd1.padEnd(maxLength + 4, ' ');
                if (cmd2) {
                    output += cmd2;
                }
                output += '\n';
            }
            return output;
        }
    },    clear: async () => { commandOutput.innerHTML = ''; return ''; },
    pwd: async () => terminalCWD,
    ls: async (args) => {
        const targetPath = args[0] ? resolvePath(args[0]) : terminalCWD;
        const items = await VFS.listFiles(targetPath);
        return items.map(item => item.type === 'folder' ? `[${item.name}]` : item.name).join('\n');
    },
    cd: async (args) => {
        const targetPath = args[0] || '/';
        const newPath = resolvePath(targetPath);
        const item = await VFS.readFile(newPath);
        if (item && item.type === 'folder') {
            terminalCWD = newPath;
            updatePrompt();
            return '';
        } else {
            throw new Error(`cd: Directory not found: ${targetPath}`);
        }
    },
    mkdir: async (args) => {
        const folderName = args[0];
        if (!folderName) throw new Error("mkdir: Missing operand");
        await VFS.createFolder(terminalCWD, folderName);
        return ``;
    },
    touch: async (args) => {
        const fileName = args[0];
        if (!fileName) throw new Error("touch: Missing operand");
        const blob = new Blob([''], { type: 'text/plain' });
        const reader = new FileReader();
        await new Promise(resolve => {
            reader.onload = async (e) => {
                await VFS.writeFile(terminalCWD, fileName, 'text/plain', e.target.result);
                resolve();
            };
            reader.readAsDataURL(blob);
        });
        return '';
    },
    rm: async (args) => {
        const targetName = args[0];
        if (!targetName) throw new Error("rm: Missing operand");
        const targetPath = resolvePath(targetName);
        await VFS.delete(targetPath);
        return '';
    },
    cp: async (args) => {
        const [source, dest] = args;
        if (!source || !dest) throw new Error("cp: Missing operand");
        const sourcePath = resolvePath(source);
        const destPath = resolvePath(dest);
        const sourceItem = await VFS.readFile(sourcePath);
        if (!sourceItem) throw new Error(`cp: Cannot stat '${source}': No such file or directory`);
        const blob = await (await fetch(sourceItem.content)).blob();
        const reader = new FileReader();
        await new Promise(resolve => {
            reader.onload = async (e) => {
                await VFS.writeFile(destPath.substring(0, destPath.lastIndexOf('/')) || '/', destPath.substring(destPath.lastIndexOf('/') + 1), sourceItem.type, e.target.result);
                resolve();
            };
            reader.readAsDataURL(blob);
        });
        return '';
    },
    mv: async (args) => {
        const [source, dest] = args;
        if (!source || !dest) throw new Error("mv: Missing operand");
        const sourcePath = resolvePath(source);
        const destPath = resolvePath(dest);
        await VFS.move(sourcePath, destPath);
        return '';
    },
    cat: async (args) => {
        const fileName = args[0];
        if (!fileName) throw new Error("cat: Missing operand");
        const path = resolvePath(fileName);
        const fileData = await readFileWithWorker(path);
        if (!fileData) throw new Error(`cat: ${fileName}: No such file or directory`);
        if (!fileData.type.startsWith('text/')) throw new Error(`cat: ${fileName}: Cannot display non-text file`);
        const response = await fetch(fileData.content);
        return await response.text();
    },
    echo: async (args) => { return args.join(' '); },
    open: async (args) => {
        const target = args[0];
        if (!target) throw new Error("open: Missing operand");
        const app = apps.find(a => a.id === target);
        if (app) {
            launchApp(target);
            return `Opening app: ${target}`;
        }
        const path = resolvePath(target);
        const item = await readFileWithWorker(path);
        if (item) {
            const dblClickHandler = () => {  };
            dblClickHandler(item);
            return `Opening file: ${target}`;
        }
        throw new Error(`open: Cannot find file or app: ${target}`);
    },
    ps: async () => {
        let output = 'APP_ID\t\t\tSTATE\n';
        output += '-------------------------------------\n';
        openApps.forEach((appData, windowId) => {
            const appId = windowId.replace('app-window-', '').replace(/-\d+$/, '');
            output += `${appId.padEnd(20, ' ')}\t${appData.state}\n`;
        });
        return output;
    },
    kill: async (args) => {
        const appId = args[0];
        if (!appId) throw new Error("kill: Missing operand");
        const instances = Array.from(openApps.keys()).filter(key => key.startsWith(`app-window-${appId}`));
        if (instances.length === 0) throw new Error(`kill: Process not found: ${appId}`);
        instances.forEach(id => openApps.get(id).windowElement.querySelector('.close').click());
        return `Terminated process: ${appId}`;
    },
    theme: async (args) => {
        const mode = args[0];
        if (mode === 'dark' || mode === 'light') {
            isDarkMode = (mode === 'dark');
            saveIsDarkMode();
            applyTheme();
            return `Theme set to ${mode}`;
        }
        throw new Error("theme: Invalid mode. Use 'dark' or 'light'");
    },
    wallpaper: async (args) => {
        const url = args[0];
        if (!url) throw new Error("wallpaper: Missing URL");
        osContainer.style.backgroundImage = `url('${url}')`;
        currentWallpaper = url;
        saveCurrentWallpaper();
        return `Wallpaper updated.`;
    },
    ping: async (args) => {
        const host = args[0];
        if (!host) throw new Error("ping: Missing host");
        const startTime = Date.now();
        try {
            await fetch(`https://${host}`, { mode: 'no-cors' });
            return `Pong! Response from ${host} in ${Date.now() - startTime}ms`;
        } catch (e) {
            return `Ping request could not find host ${host}. Please check the name and try again.`;
        }
    },
    curl: async (args) => {
        const url = args[0];
        if (!url) throw new Error("curl: Missing URL");
        const response = await fetch(url);
        return await response.text();
    },
    connect: async (args) => {
        const email = args[0];
        if (!email) throw new Error("connect: Missing email");
        launchApp('connect', { targetEmail: email });
        return `Opening Connect with ${email}...`;
    },
    date: async () => new Date().toLocaleString(),
    calc: async (args) => {
        const expression = args.join(' ');
        try {
            return String(new Function(`return ${expression}`)());
        } catch (e) {
            throw new Error(`calc: Invalid expression`);
        }
    },
    grep: async (args, input) => {
        const pattern = args[0];
        if (!pattern) throw new Error("grep: Missing pattern");
        if (!input) throw new Error("grep: Missing input from pipe");
        return input.split('\n').filter(line => line.includes(pattern)).join('\n');
    },
        time: async (args) => {
        const action = args[0];
        const value = args[1];
        if (!action) {
            return `OS: ${new Date().toLocaleTimeString()}\n: ${dynamicWallpaperFixedTime ? dynamicWallpaperFixedTime.toLocaleTimeString() + ' ()' : ''}`;
        }
        if (action === 'set') {
            if (!value || !/^\d{2}:\d{2}$/.test(value)) {
                throw new Error("time set:  HH:MM  (: time set 15:00)");
            }
            const [hour, minute] = value.split(':').map(Number);
            const newTime = new Date();
            newTime.setHours(hour, minute, 0, 0);
            dynamicWallpaperFixedTime = newTime;
            if (dynamicWallpaperContainer.style.display === 'none') {
                setDynamicWallpaperActive(true);
            } else {
                updateDynamicWallpaper(dynamicWallpaperFixedTime);
            }
            return ` ${value} `;
        }
        if (action === 'sync') {
            dynamicWallpaperFixedTime = null;
            setDynamicWallpaperActive(true);
            return ``;
        }
        throw new Error(`time:  '${action}' 'set'  'sync' `);
    },
};
const executePipeline = async (pipeline) => {
    let input = null;
    let finalOutput = null;
    for (const commandData of pipeline) {
        const handler = commandHandlers[commandData.command];
        if (!handler) {
            finalOutput = { error: `Command not found: ${commandData.command}` };
            break;
        }
        try {
            const output = await handler(commandData.args, input);
            input = output;
            finalOutput = { result: output };
        } catch (e) {
            finalOutput = { error: e.message };
            break;
        }
    }
    return finalOutput;
};
const parseCommand = (fullCommand) => {
    const pipelines = fullCommand.split('|').map(p => p.trim());
    const parsedPipeline = [];
    for (const part of pipelines) {
        const [command, ...args] = part.split(/\s+/).filter(Boolean);
        const redirectionMatch = args.join(' ').match(/>\s*(.+)/);
        let redirectTo = null;
        let finalArgs = args;
        if (redirectionMatch) {
            redirectTo = redirectionMatch[1].trim();
            finalArgs = args.join(' ').replace(/>\s*.+/, '').split(/\s+/).filter(Boolean);
        }
        parsedPipeline.push({ command: command.toLowerCase(), args: finalArgs, redirectTo });
    }
    return parsedPipeline;
};
commandInput.addEventListener('keypress', async (e) => {
    if (e.key === 'Enter') {
        const fullCommand = commandInput.value.trim();
        if (fullCommand === '') return;
        appendOutput(`<span style="color: #8ab4f8;">RiviftOS:${terminalCWD}$</span> ${fullCommand.replace(/</g, "&lt;").replace(/>/g, "&gt;")}`);
        commandHistory.unshift(fullCommand);
        historyIndex = -1;
        commandInput.value = '';
        const parsedPipeline = parseCommand(fullCommand);
        const finalOutput = await executePipeline(parsedPipeline);
        const lastCommand = parsedPipeline[parsedPipeline.length - 1];
        if (lastCommand.redirectTo && !finalOutput.error) {
            const filePath = resolvePath(lastCommand.redirectTo);
            const blob = new Blob([finalOutput.result], { type: 'text/plain' });
            const reader = new FileReader();
            reader.onload = async (event) => {
                await VFS.writeFile(filePath.substring(0, filePath.lastIndexOf('/')) || '/', filePath.substring(filePath.lastIndexOf('/') + 1), 'text/plain', event.target.result);
                appendOutput(`Output redirected to ${lastCommand.redirectTo}`);
            };
            reader.readAsDataURL(blob);
        } else if (finalOutput.error) {
            appendOutput(finalOutput.error, true);
        } else if (finalOutput.result) {
            appendOutput(finalOutput.result);
        }
    }
});
commandInput.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (historyIndex < commandHistory.length - 1) {
            historyIndex++;
            commandInput.value = commandHistory[historyIndex];
        }
    } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (historyIndex > 0) {
            historyIndex--;
            commandInput.value = commandHistory[historyIndex];
        } else {
            historyIndex = -1;
            commandInput.value = '';
        }
    }
});
updatePrompt();
commandInput.focus();
applyTheme();
                }
            },
            {
    id: 'calendar', name: '', icon: 'fas fa-calendar-alt', installed: true,
    launcher: () => {
const content = `
    <style>
        .calendar-app-container { font-family: 'Inter', sans-serif; display: flex; height: 100%; }
        .calendar-sidebar { width: 280px; flex-shrink: 0; padding: 1rem; border-right: 1px solid var(--border-color-dark); display: flex; flex-direction: column; }
        body.light-mode .calendar-sidebar { border-right-color: var(--border-color-light); }
        .month-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .month-header h4 { font-size: 1.1rem; font-weight: 600; }
        .month-nav-btn { background: none; border: none; cursor: pointer; width: 32px; height: 32px; border-radius: 50%; }
        .month-nav-btn:hover { background-color: rgba(255,255,255,0.1); }
        body.light-mode .month-nav-btn:hover { background-color: rgba(0,0,0,0.05); }
        .calendar-grid-mini { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; }
        .weekday-mini { font-size: 0.75rem; color: #9aa0a6; padding-bottom: 0.5rem; }
        .day-mini { font-size: 0.8rem; height: 32px; display: grid; place-items: center; border-radius: 50%; cursor: pointer; position: relative; }
        .day-mini.other-month { color: #5f6368; }
        .day-mini:not(.selected):hover { background-color: rgba(255,255,255,0.1); }
        body.light-mode .day-mini:not(.selected):hover { background-color: rgba(0,0,0,0.05); }
        .day-mini.today { font-weight: bold; background-color: rgba(138, 180, 248, 0.5); color: inherit; }
        .day-mini.selected { background-color: #007bff; color: white; font-weight: bold; }
        .day-mini.has-event::after { content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; border-radius: 50%; background-color: #007bff; }
        .day-mini.selected.has-event::after { background-color: white; }
        .calendar-main { flex-grow: 1; display: flex; flex-direction: column; }
        .main-header { padding: 1rem; border-bottom: 1px solid var(--border-color-dark); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        body.light-mode .main-header { border-bottom-color: var(--border-color-light); }
        .main-header h3 { font-size: 1.5rem; font-weight: 700; }
        .add-event-btn { background-color: #007bff; color: white; padding: 8px 16px; border-radius: 8px; font-weight: 500; cursor: pointer; }
        .timeline-wrapper { flex-grow: 1; overflow-y: auto; position: relative; }
        .timeline-hours { position: absolute; top: 0; left: 0; width: 60px; height: 100%; font-size: 0.75rem; color: #9aa0a6; }
        .hour-label { height: 60px; text-align: right; padding-right: 10px; border-top: 1px solid var(--border-color-dark); user-select: none; }
        body.light-mode .hour-label { border-top-color: var(--border-color-light); }
        .timeline-events { margin-left: 60px; position: relative; height: 1440px; }
        .hour-line { height: 60px; border-top: 1px solid var(--border-color-dark); box-sizing: border-box; }
        body.light-mode .hour-line { border-top-color: var(--border-color-light); }
        .event-block { position: absolute; left: 5px; right: 5px; background-color: #007bff; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; overflow: hidden; cursor: pointer; border-left: 4px solid #8ab4f8; }
    </style>
    <div class="calendar-app-container">
        <div class="calendar-sidebar">
            <div class="month-header">
                <button id="cal-prev-month" class="month-nav-btn"><i class="fas fa-chevron-left"></i></button>
                <h4 id="cal-month-year"></h4>
                <button id="cal-next-month" class="month-nav-btn"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="calendar-grid-mini">
                <div class="weekday-mini"></div><div class="weekday-mini"></div><div class="weekday-mini"></div><div class="weekday-mini"></div><div class="weekday-mini"></div><div class="weekday-mini"></div><div class="weekday-mini"></div>
            </div>
            <div id="cal-days-grid" class="calendar-grid-mini"></div>
        </div>
        <div class="calendar-main">
            <div class="main-header">
                <h3 id="cal-main-date"></h3>
                <button id="cal-add-event-btn" class="add-event-btn"><i class="fas fa-plus mr-2"></i> </button>
            </div>
            <div class="timeline-wrapper">
                <div class="timeline-hours"></div>
                <div class="timeline-events"></div>
            </div>
        </div>
    </div>
`;
const calendarWindow = createWindow('app-window-calendar', '', content, 950, 650);
        const query = (selector) => calendarWindow.querySelector(selector);
        const monthYearDisplay = query('#cal-month-year');
        const daysGrid = query('#cal-days-grid');
        const prevMonthBtn = query('#cal-prev-month');
        const nextMonthBtn = query('#cal-next-month');
        const mainDateDisplay = query('#cal-main-date');
        const timelineHours = query('.timeline-hours');
        const timelineEvents = query('.timeline-events');
        const addEventBtn = query('#cal-add-event-btn');
        let currentDate = new Date();
        let selectedDate = new Date();
        let events = {};
        const VFS_EVENTS_PATH = '/System/Calendar/events.json';
        const formatDate = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };
const saveEventsToVFS = async () => {
    try {
        const blob = new Blob([JSON.stringify(events)], { type: 'application/json' });
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                await VFS.writeFile('/System/Calendar', 'events.json', 'application/json', e.target.result);
            } catch (err) {
                if (err.message.includes("An item named \"Calendar\" already exists")) {
                } else if (err.message.includes("An item named \"System\" already exists")) {
                    await VFS.createFolder('/System', 'Calendar');
                    await saveEventsToVFS();
                } else {
                    await VFS.createFolder('/', 'System');
                    await VFS.createFolder('/System', 'Calendar');
                    await saveEventsToVFS();
                }
            }
            if(window.setupCalendarReminders) window.setupCalendarReminders();
        };
        reader.readAsDataURL(blob);
    } catch (e) {
        console.error("Failed to save events:", e);
    }
};
        const loadEventsFromVFS = async () => {
            try {
                const fileData = await VFS.readFile(VFS_EVENTS_PATH);
                if (fileData && fileData.content) {
                    const res = await fetch(fileData.content);
                    const text = await res.text();
                    events = JSON.parse(text);
                } else {
                    events = {};
                    await saveEventsToVFS();
                }
            } catch (e) {
                console.warn("Could not load calendar events, initializing.", e);
                events = {};
                await saveEventsToVFS();
            }
        };
const renderTimeline = () => {
            mainDateDisplay.textContent = selectedDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            timelineHours.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                timelineHours.innerHTML += `<div class="hour-label">${i}:00</div>`;
            }
            timelineEvents.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                timelineEvents.innerHTML += `<div class="hour-line"></div>`;
            }
            const dateStr = formatDate(selectedDate);
            if (events[dateStr]) {
                events[dateStr].forEach(event => {
                    const start = new Date(event.start);
                    const end = new Date(event.end);
                    const localStart = new Date(start.getUTCFullYear(), start.getUTCMonth(), start.getUTCDate(), start.getUTCHours(), start.getUTCMinutes());
                    const localEnd = new Date(end.getUTCFullYear(), end.getUTCMonth(), end.getUTCDate(), end.getUTCHours(), end.getUTCMinutes());
                    const top = localStart.getHours() * 60 + localStart.getMinutes();
                    const height = Math.max(15, (localEnd - localStart) / 60000);
                    const eventBlock = document.createElement('div');
                    eventBlock.className = 'event-block';
                    eventBlock.style.top = `${top}px`;
                    eventBlock.style.height = `${height}px`;
                    if (event.color) {
                        eventBlock.style.backgroundColor = event.color;
                        eventBlock.style.borderColor = event.color;
                    }
                    eventBlock.innerHTML = `<strong>${event.title}</strong>`;
                    timelineEvents.appendChild(eventBlock);
                });
            }
        };
const renderMiniCalendar = () => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    monthYearDisplay.textContent = `${year} ${month + 1}`;
    daysGrid.innerHTML = '';
    const firstDayOfMonth = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const selectedDay = new Date(selectedDate);
    selectedDay.setHours(0, 0, 0, 0);
    for (let i = 0; i < firstDayOfMonth; i++) {
        daysGrid.innerHTML += `<div></div>`;
    }
    for (let i = 1; i <= daysInMonth; i++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'day-mini';
        dayDiv.textContent = i;
        const date = new Date(year, month, i);
        const dateStr = formatDate(date);
        dayDiv.dataset.date = dateStr;
        if (date.getTime() === today.getTime()) {
            dayDiv.classList.add('today');
        }
        if (date.getTime() === selectedDay.getTime()) {
            dayDiv.classList.add('selected');
        }
        if (events[dateStr] && events[dateStr].length > 0) {
            dayDiv.classList.add('has-event');
        }
        daysGrid.appendChild(dayDiv);
    }
};
const renderAll = () => {
    renderMiniCalendar();
    renderTimeline();
};
const showEventModal = async (eventData = null) => {
    const isNew = eventData === null;
    let baseDate;
    if (isNew) {
        baseDate = new Date(selectedDate);
    } else {
        baseDate = new Date(eventData.start);
        baseDate = new Date(baseDate.getUTCFullYear(), baseDate.getUTCMonth(), baseDate.getUTCDate());
    }
    if (isNaN(baseDate.getTime())) {
        baseDate = new Date();
    }
    baseDate.setHours(0, 0, 0, 0);
    const defaultDate = formatDate(baseDate);
    let defaultStart, defaultEnd;
    if (isNew) {
        const now = new Date();
        now.setMinutes(Math.ceil(now.getMinutes() / 30) * 30);
        now.setSeconds(0);
        defaultStart = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        now.setHours(now.getHours() + 1);
        defaultEnd = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    } else {
        const startDate = new Date(eventData.start);
        const endDate = new Date(eventData.end);
        defaultStart = `${String(startDate.getUTCHours()).padStart(2, '0')}:${String(startDate.getUTCMinutes()).padStart(2, '0')}`;
        defaultEnd = `${String(endDate.getUTCHours()).padStart(2, '0')}:${String(endDate.getUTCMinutes()).padStart(2, '0')}`;
    }
    const data = isNew ? {
        id: Date.now(), title: '', date: defaultDate,
        start: defaultStart, end: defaultEnd,
        description: '', color: '#007bff'
    } : {
        ...eventData, date: defaultDate,
        start: defaultStart, end: defaultEnd
    };
    const modalContent = `
        <div class="flex flex-col gap-4">
            <input type="text" id="event-title" placeholder="" value="${data.title || ''}" class="w-full p-2 text-lg font-semibold bg-transparent border-b-2 outline-none">
            <div class="grid grid-cols-2 gap-4">
                <input type="date" id="event-date" value="${data.date}">
                <select id="event-color" class="w-full p-2 rounded-lg" style="background-color: var(--input-bg-dark); color: var(--text-color-dark); border: 1px solid var(--input-border-dark);">
                    <option value="#007bff" ${data.color === '#007bff' ? 'selected' : ''}></option>
                    <option value="#28a745" ${data.color === '#28a745' ? 'selected' : ''}></option>
                    <option value="#dc3545" ${data.color === '#dc3545' ? 'selected' : ''}></option>
                    <option value="#ffc107" ${data.color === '#ffc107' ? 'selected' : ''}></option>
                </select>
            </div>
            <div class="flex items-center gap-2">
                <input type="time" id="event-start-time" value="${data.start}" step="1800" class="w-full p-2 rounded-lg" style="background-color: var(--input-bg-dark); color: var(--text-color-dark); border: 1px solid var(--input-border-dark);">
                <span>-</span>
                <input type="time" id="event-end-time" value="${data.end}" step="1800" class="w-full p-2 rounded-lg" style="background-color: var(--input-bg-dark); color: var(--text-color-dark); border: 1px solid var(--input-border-dark);">
            </div>
            <textarea id="event-description" placeholder="" rows="3" class="w-full p-2 bg-transparent border rounded">${data.description || ''}</textarea>
        </div>
    `;
    const result = await showMessageBox(isNew ? '' : '', '', {
        customHtmlContent: modalContent,
        showCancel: true,
        okText: ''
    });
    if (result && typeof result === 'object' && result.title !== undefined) {
        const { title, date, startTime, endTime, description, color } = result;
        if (!title) {
            createNotification('', '', 'error');
            return;
        }
        if (!date || !startTime || !endTime) {
            createNotification('', '', 'error');
            return;
        }
        const startDateTime = new Date(`${date}T${startTime}:00`);
        const endDateTime = new Date(`${date}T${endTime}:00`);
        if (isNaN(startDateTime.getTime()) || isNaN(endDateTime.getTime())) {
            createNotification('', '', 'error');
            return;
        }
        const newEvent = {
            id: data.id, title, description, color,
            start: startDateTime.toISOString(),
            end: endDateTime.toISOString(),
        };
        if (!isNew) {
            const originalDate = formatDate(new Date(eventData.start));
            if (events[originalDate]) {
                events[originalDate] = events[originalDate].filter(e => e.id !== eventData.id);
                if (events[originalDate].length === 0) delete events[originalDate];
            }
        }
        const newDateStr = formatDate(startDateTime);
        if (!events[newDateStr]) events[newDateStr] = [];
        events[newDateStr].push(newEvent);
        events[newDateStr].sort((a, b) => new Date(a.start) - new Date(b.start));
        await saveEventsToVFS();
        renderAll();
    }
};
addEventBtn.addEventListener('click', showEventModal);
prevMonthBtn.addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderMiniCalendar();
});
nextMonthBtn.addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderMiniCalendar();
});
        daysGrid.addEventListener('click', (e) => {
            const dayDiv = e.target.closest('.day-mini');
            if (dayDiv && dayDiv.dataset.date) {
                const parts = dayDiv.dataset.date.split('-');
                const clickedDate = new Date(parts[0], parts[1] - 1, parts[2]);
                selectedDate = clickedDate;
                currentDate = new Date(clickedDate); 
                renderAll();
            }
        });
const initializeCalendar = async () => {
    if (!document.body.contains(calendarWindow)) return;
    await loadEventsFromVFS();
    renderAll();
    applyTheme();
};
initializeCalendar();
    }
},
    { 
        id: 'app-store', name: 'Rivift App Store', icon: 'fas fa-store', installed: true, 
        launcher: async () => {
            if (!isWifiOn) { 
                await showMessageBox('', 'Rivift App StoreWi-Fi', { isNetworkError: true }); 
                return; 
            }
            const content = `
                <h4 class="text-xl font-semibold mt-2 mb-4 text-center"></h4>
                <div id="available-apps-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 p-4 overflow-y-auto" style="max-height: calc(100% - 60px);"></div>
            `;
            const appStoreWindow = createWindow('app-window-app-store', 'Rivift App Store', content, 600, 450);
            const availableAppsList = appStoreWindow.querySelector('#available-apps-list');
            const renderAvailableApps = () => {
                availableAppsList.innerHTML = '';
                apps.filter(app => !app.installed).forEach(app => {
                    const appItem = document.createElement('div');
                    appItem.classList.add('flex', 'flex-col', 'items-center', 'p-3', 'rounded-lg', 'cursor-pointer', 'transition');
                    appItem.style.backgroundColor = isDarkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.03)';
                    appItem.innerHTML = `
                        <div class="icon-box w-16 h-16 bg-blue-500 rounded-xl flex items-center justify-center mb-2"><i class="${app.icon} text-3xl text-white"></i></div>
                        <span>${app.name}</span>
                        <button class="install-app-button mt-2 bg-green-600 text-white px-3 py-1 rounded-md hover:bg-green-700 transition" data-app-id="${app.id}"></button>
                    `;
                    availableAppsList.appendChild(appItem);
                });
                availableAppsList.querySelectorAll('.install-app-button').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const appIdToInstall = e.target.dataset.appId;
                        const appToInstall = apps.find(a => a.id === appIdToInstall);
                        if (appToInstall) {
                            const confirmInstall = await showMessageBox('', `${appToInstall.name}`, { showCancel: true });
                            if (confirmInstall) {
                                appToInstall.installed = true;
                                createNotification('', `${appToInstall.name}`, 'info');
                                populateAllApps();
                                renderAvailableApps();
                            }
                        }
                    });
                });
            };
            renderAvailableApps();
            applyTheme();
        } 
    },
{
    id: 'pingpong', name: '', icon: 'fas fa-table-tennis', installed: true,
launcher: () => {
    const content = `
        <div id="pingpong-game-area" class="w-full h-full bg-black relative rounded-b-lg overflow-hidden">
            <div id="pingpong-score" class="absolute top-2 left-1/2 -translate-x-1/2 text-white text-2xl font-bold">0 | 0</div>
            <div id="pingpong-paddle-player" class="absolute bg-white" style="left: 10px;"></div>
            <div id="pingpong-paddle-ai" class="absolute bg-white" style="right: 10px;"></div>
            <div id="pingpong-ball" class="absolute bg-white rounded-full"></div>
            <button id="pingpong-start-button" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-green-500 text-white px-6 py-3 rounded-lg text-xl"></button>
        </div>`;
    const pingpongWindow = createWindow('app-window-pingpong', '', content, 600, 400, false);
    const gameArea = pingpongWindow.querySelector('#pingpong-game-area');
    const playerPaddle = pingpongWindow.querySelector('#pingpong-paddle-player');
    const aiPaddle = pingpongWindow.querySelector('#pingpong-paddle-ai');
    const ball = pingpongWindow.querySelector('#pingpong-ball');
    const scoreDisplay = pingpongWindow.querySelector('#pingpong-score');
    const startButton = pingpongWindow.querySelector('#pingpong-start-button');
    const paddleHeight = 80;
    const worker = new Worker(pingpongWorkerUrl);
    worker.onmessage = (e) => {
        const { type, playerY, aiY, ballX, ballY, playerScore, aiScore } = e.data;
        if (type === 'update') {
            requestAnimationFrame(() => {
                playerPaddle.style.top = `${playerY}px`;
                aiPaddle.style.top = `${aiY}px`;
                ball.style.left = `${ballX}px`;
                ball.style.top = `${ballY}px`;
                scoreDisplay.textContent = `${playerScore} | ${aiScore}`;
            });
        }
    };
    startButton.addEventListener('click', () => {
        startButton.style.display = 'none';
        worker.postMessage({ 
            command: 'start',
            payload: {
                width: gameArea.offsetWidth,
                height: gameArea.offsetHeight
            }
        });
    });
    pingpongWindow.addEventListener('mousemove', (e) => {
        const rect = gameArea.getBoundingClientRect();
        let newPlayerY = e.clientY - rect.top - (paddleHeight / 2);
        newPlayerY = Math.max(0, Math.min(newPlayerY, gameArea.offsetHeight - paddleHeight));
        worker.postMessage({ command: 'updatePlayer', payload: { y: newPlayerY } });
    });
    const originalClose = pingpongWindow.querySelector('.close').onclick;
    pingpongWindow.querySelector('.close').onclick = () => {
        worker.postMessage({ command: 'stop' });
        worker.terminate();
        if(originalClose) originalClose();
    };
}
},
{ 
    id: 'drawing-tool', name: '', icon: 'fas fa-paint-brush', installed: true, 
launcher: () => {
    const content = `
        <style>
            #simple-paint-container { display: flex; height: 100%; background-color: #3c4043; }
            #simple-paint-toolbar { width: 90px; background-color: #2c2d30; padding: 10px; display: flex; flex-direction: column; align-items: center; gap: 12px; flex-shrink: 0; }
            #simple-paint-canvas-area { touch-action: none; flex-grow: 1; position: relative; overflow: hidden; }
            #simple-paint-canvas-area:active { cursor: grabbing; }
            .paint-tool-btn { width: 48px; height: 48px; border-radius: 12px; display: grid; place-items: center; cursor: pointer; transition: background-color 0.2s; color: #e8eaed; font-size: 20px; }
            .paint-tool-btn:hover { background-color: #4a4d50; }
            .paint-tool-btn.active { background-color: #8ab4f8; color: #202124; }
            #simple-paint-canvas { position: absolute; top: 0; left: 0; }
            .paint-option-group { width: 100%; padding: 8px; background-color: #3c4043; border-radius: 8px; }
            .paint-option-group label { font-size: 11px; color: #9aa0a6; margin-bottom: 4px; display: block; }
            .paint-option-group input[type=number] { width: 100%; text-align: center; background-color: #202124; color: white; border: 1px solid #5f6368; border-radius: 4px; padding: 4px; }
            .color-control { text-align: center; }
            .color-control input[type=color] { width: 100%; height: 28px; border: 2px solid #5f6368; border-radius: 4px; padding: 2px; background-color: transparent; transition: opacity 0.2s; }
            .color-control.disabled input[type=color] { opacity: 0.3; }
            .color-none-toggle-btn { margin-top: 4px; background: none; border: none; color: #9aa0a6; cursor: pointer; font-size: 18px; }
            .color-none-toggle-btn.disabled { color: #8ab4f8; }
            #brush-preview { 
    position: absolute; 
        top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: black; 
    border-radius: 50%; 
    pointer-events: none; 
    opacity: 0; 
    transition: opacity 0.2s; 
    border: 1px solid white; 
}
#brush-preview.visible { 
    opacity: 0.7; 
}
    .paint-tool-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}
        #layer-panel {
            width: 200px;
            background-color: #2c2d30;
            padding: 10px;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #444;
        }
        .layer-item {
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            background-color: #3c4043;
            color: #e8eaed;
            font-size: 14px;
        }
        .layer-item.active {
            border-color: #8ab4f8;
            background-color: #4a4d50;
        }
        #layer-controls {
            margin-top: auto;
            display: flex;
            justify-content: space-around;
        }
        #layer-controls button {
            background: none;
            border: none;
            color: #9aa0a6;
            cursor: pointer;
            font-size: 18px;
        }
                #simple-paint-container.layers-hidden #layer-panel {
        display: none;
    }
    .layer-item.hidden-layer {
        opacity: 0.5;
    }
    .layer-visibility-btn {
        margin-right: 8px;
        opacity: 0.6;
    }
    .layer-visibility-btn:hover {
        opacity: 1;
    }
    </style>
    <div id="simple-paint-container">
<div id="simple-paint-toolbar" class="w-16">
            <button id="undo-btn" class="paint-tool-btn text-base" title="" disabled><i class="fas fa-undo"></i></button>
            <button id="redo-btn" class="paint-tool-btn text-base" title="" disabled><i class="fas fa-redo"></i></button>
            <hr class="w-full border-t border-gray-600">
            <button class="paint-tool-btn active" data-tool="pen" title=""><i class="fas fa-pen"></i></button>
                <button class="paint-tool-btn" data-tool="eraser" title=""><i class="fas fa-eraser"></i></button>
                <button class="paint-tool-btn" data-tool="line" title=""><i class="fas fa-minus"></i></button>
                <button class="paint-tool-btn" data-tool="rect" title=""><i class="far fa-square"></i></button>
                <button class="paint-tool-btn" data-tool="circle" title=""><i class="far fa-circle"></i></button>
                <hr class="w-full border-t border-gray-600">
                    <button id="toggle-layers-panel-btn" class="paint-tool-btn active" title=""><i class="fas fa-layer-group"></i></button>
                <div id="shape-options" class="w-full space-y-2 hidden">
                    <div class="paint-option-group color-control">
                        <label></label>
                        <input type="color" id="fill-color-picker" value="#9966FF">
                        <button class="color-none-toggle-btn" data-for="fill" title=""><i class="fas fa-times"></i></button>
                    </div>
                    <div class="paint-option-group color-control">
                        <label></label>
                        <input type="color" id="stroke-color-picker" value="#000000">
                        <button class="color-none-toggle-btn" data-for="stroke" title=""><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="paint-option-group">
                    <label></label>
                    <input type="number" id="simple-brush-size" min="1" max="500" value="5">
                </div>
                <div id="rect-options" class="paint-option-group hidden">
                    <label></label>
                    <input type="number" id="rect-border-radius" min="0" max="100" value="0">
                </div>
                <div class="mt-auto flex flex-col gap-2">
                    <button id="simple-paint-open" class="paint-tool-btn" title=""><i class="fas fa-folder-open"></i></button>
                    <button id="simple-paint-save" class="paint-tool-btn" title=""><i class="fas fa-save"></i></button>
                </div>
            </div>
        <div id="simple-paint-canvas-area">
            <!-- canvas -->
            <div id="brush-preview"></div>
        </div>
        <!--    -->
        <div id="layer-panel">
            <h4 class="text-sm font-bold mb-2 text-gray-400"></h4>
            <div id="layer-list" class="flex-grow">
                <!-- JS -->
            </div>
            <div id="layer-controls">
                <button id="add-layer-btn" title=""><i class="fas fa-plus-square"></i></button>
                <button id="delete-layer-btn" title=""><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>
    </div>
    `;
    const drawWindow = createWindow('app-window-drawing-tool', '', content, 900, 600);
    initializeSimplePaint(drawWindow);
}
},
{
    id: 'weather', name: '', icon: 'fas fa-cloud-sun', installed: true,
    launcher: () => {
        const content = `
            <div class="flex flex-col h-full text-white relative">
                <div id="weather-bg" class="absolute inset-0 transition-opacity duration-1000 -z-10"></div>
                <div class="p-2 border-b border-white/20 flex items-center gap-2 flex-shrink-0">
                    <input type="text" id="city-search" placeholder=" (: Tokyo)" class="flex-grow p-1 rounded bg-black/30 border border-white/20 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    <button id="search-btn" class="px-2 py-1 rounded bg-blue-600/70 hover:bg-blue-500"><i class="fas fa-search"></i></button>
                </div>
                <div id="weather-content" class="p-4 flex-grow flex flex-col overflow-y-auto">
                    <p class="text-center my-auto"></p>
                </div>
            </div>
        `;
        const weatherWindow = createWindow('app-window-weather', '', content, 800, 620);
        const weatherContent = weatherWindow.querySelector('#weather-content');
        const weatherBg = weatherWindow.querySelector('#weather-bg');
        const searchInput = weatherWindow.querySelector('#city-search');
        const searchBtn = weatherWindow.querySelector('#search-btn');
                const getWeatherIcon = (code, isDay = 1) => {
            const isDayTime = isDay === 1;
            const icons = { 0: isDayTime ? 'fas fa-sun text-yellow-300' : 'fas fa-moon text-blue-200', 1: isDayTime ? 'fas fa-cloud-sun text-yellow-300' : 'fas fa-cloud-moon text-blue-300', 2: 'fas fa-cloud text-gray-300', 3: 'fas fa-cloud text-gray-400', 45: 'fas fa-smog text-gray-500', 48: 'fas fa-smog text-gray-500', 51: 'fas fa-cloud-rain text-blue-300', 53: 'fas fa-cloud-rain text-blue-400', 55: 'fas fa-cloud-showers-heavy text-blue-500', 61: 'fas fa-cloud-rain text-blue-400', 63: 'fas fa-cloud-rain text-blue-500', 65: 'fas fa-cloud-showers-heavy text-blue-600', 71: 'fas fa-snowflake text-blue-200', 73: 'fas fa-snowflake text-blue-200', 75: 'fas fa-snowflake text-blue-300', 80: 'fas fa-cloud-showers-heavy text-blue-500', 81: 'fas fa-cloud-showers-heavy text-blue-500', 82: 'fas fa-cloud-showers-heavy text-blue-600', 95: 'fas fa-bolt text-yellow-400', 96: 'fas fa-bolt text-yellow-400', 99: 'fas fa-bolt text-yellow-400' };
            return icons[code] || 'fas fa-question-circle text-gray-400';
        };
        let fullWeatherData = null;
        let selectedDayIndex = 0;
        let selectedGraphMode = 'temperature';;
        const getWeatherDescription = (code) => {
            const descriptions = { 0: '', 1: '', 2: '', 3: '', 45: '', 48: '', 51: '', 53: '', 55: '', 61: '', 63: '', 65: '', 71: '', 73: '', 75: '', 80: '', 81: '', 82: '', 95: '', 96: '', 99: '' };
            return descriptions[code] || '';
        };
        const renderUI = () => {
            if (!fullWeatherData) return;
            const { city, data } = fullWeatherData;
            const { current, hourly, daily } = data;
            const weatherCode = selectedDayIndex === 0 ? current.weather_code : daily.weather_code[selectedDayIndex];
            const isDay = selectedDayIndex === 0 ? current.is_day : 1;
            let bgGradient = 'linear-gradient(to top, #0f172a, #334155)';
            if (isDay) {
                if ([0,1].includes(weatherCode)) bgGradient = 'linear-gradient(to top, #3b82f6, #60a5fa)';
                if ([2,3].includes(weatherCode)) bgGradient = 'linear-gradient(to top, #64748b, #94a3b8)';
                if (weatherCode >= 51 && weatherCode <= 82) bgGradient = 'linear-gradient(to top, #4b5563, #6b7280)';
            }
            weatherBg.style.background = bgGradient;
            const displayData = selectedDayIndex === 0 ? {
                isToday: true, icon: getWeatherIcon(current.weather_code, current.is_day), temp: Math.round(current.temperature_2m), desc: getWeatherDescription(current.weather_code), date: new Date(current.time),
                details: [
                    { label: '', value: `${current.precipitation_probability}%`, icon: 'fas fa-cloud-showers-heavy' },
                    { label: '', value: `${current.relative_humidity_2m}%`, icon: 'fas fa-tint' },
                    { label: '', value: `${current.wind_speed_10m} m/s`, icon: 'fas fa-wind' },
                    { label: 'UV', value: `${daily.uv_index_max[0]}`, icon: 'fas fa-sun' }
                ]
            } : {
                isToday: false, icon: getWeatherIcon(daily.weather_code[selectedDayIndex], 1), temp: Math.round(daily.temperature_2m_max[selectedDayIndex]), desc: getWeatherDescription(daily.weather_code[selectedDayIndex]), date: new Date(daily.time[selectedDayIndex]),
                details: [
                    { label: '/', value: `${Math.round(daily.temperature_2m_max[selectedDayIndex])} / ${Math.round(daily.temperature_2m_min[selectedDayIndex])}`, icon: 'fas fa-thermometer-half' },
                    { label: '', value: new Date(daily.sunrise[selectedDayIndex]).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }), icon: 'fas fa-sunrise' },
                    { label: '', value: new Date(daily.sunset[selectedDayIndex]).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }), icon: 'fas fa-sunset' },
                    { label: 'UV', value: `${daily.uv_index_max[selectedDayIndex]}`, icon: 'fas fa-sun' }
                ]
            };
            const dayStart = new Date(displayData.date); dayStart.setHours(0,0,0,0);
            const dayEnd = new Date(dayStart); dayEnd.setDate(dayStart.getDate() + 1);
            const hourlyForecastForDay = hourly.time.map((t, i) => ({ time: new Date(t), temp: hourly.temperature_2m[i], precip: hourly.precipitation_probability[i], wind: hourly.wind_speed_10m[i], code: hourly.weather_code[i] })).filter(h => h.time >= dayStart && h.time < dayEnd);
            let graphData, unit, color, gradientColor;
            switch(selectedGraphMode){
                case 'precipitation': graphData = hourlyForecastForDay.map(h => h.precip); unit = '%'; color = '#60a5fa'; gradientColor = 'rgba(96, 165, 250, 0.4)'; break;
                case 'wind': graphData = hourlyForecastForDay.map(h => h.wind); unit = 'm/s'; color = '#34d399'; gradientColor = 'rgba(52, 211, 153, 0.4)'; break;
                default: graphData = hourlyForecastForDay.map(h => h.temp); unit = ''; color = '#facc15'; gradientColor = 'rgba(250, 204, 21, 0.4)'; break;
            }
            const maxVal = Math.max(...graphData, 0); const minVal = Math.min(...graphData, 0); const range = Math.max(1, maxVal - minVal);
            const points = graphData.map((val, i) => `${(i / (hourlyForecastForDay.length - 1)) * 100},${100 - ((val - minVal) / range) * 80 - 10}`).join(' ');
            const areaPoints = `0,100 ${points} 100,100`;
            const hourlyIconsHtml = hourlyForecastForDay.filter((_,i) => i % 2 === 0).map(h => `<div class="flex-1 text-center"><i class="${getWeatherIcon(h.code, 1)} text-lg"></i></div>`).join('');
            const timeLabelsHtml = hourlyForecastForDay.filter((_, i) => i % 2 === 0).map(h => `<div class="flex-1 text-center text-xs text-gray-400">${h.time.getHours()}:00</div>`).join('');
            const graphLabelsHtml = hourlyForecastForDay.filter((_, i) => i % 2 === 0).map((h, index) => {
                const dataIndex = index * 2;
                const value = graphData[dataIndex];
                const yPosition = 100 - ((value - minVal) / range) * 80 - 10;
                const paddingBottom = Math.max(0, 100 - yPosition - 20); 
                return `<div class="flex-1 text-center text-xs" style="padding-bottom: ${paddingBottom}px;">${Math.round(value)}${unit}</div>`;
            }).join('');
            weatherContent.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-4">
                        <i class="${displayData.icon} text-6xl"></i>
                        <div><p class="text-6xl font-light">${displayData.temp}</p></div>
                        <div class="text-sm">${displayData.details.map(d => `<p><span>${d.label}:</span> ${d.value}</p>`).join('')}</div>
                    </div>
                    <div class="text-right"><p class="text-3xl font-bold">${city}</p><p>${displayData.date.toLocaleDateString('ja-JP', { weekday: 'long' })}</p><p class="text-sm text-gray-400">${displayData.desc}</p></div>
                </div>
                <div class="mb-4">
                    <div class="flex items-center gap-4 text-sm mb-2">
                        <button class="graph-mode-btn pb-1 ${selectedGraphMode==='temperature' ? 'font-bold border-b-2 border-yellow-400' : ''}" data-mode="temperature"></button>
                        <button class="graph-mode-btn pb-1 ${selectedGraphMode==='precipitation' ? 'font-bold border-b-2 border-blue-400' : ''}" data-mode="precipitation"></button>
                        <button class="graph-mode-btn pb-1 ${selectedGraphMode==='wind' ? 'font-bold border-b-2 border-green-400' : ''}" data-mode="wind"></button>
                    </div>
                    <div class="relative h-40">
                        <div class="flex justify-between h-full absolute top-0 left-0 w-full" style="padding-top: 1rem;">${graphLabelsHtml}</div>
                        <svg viewBox="0 0 100 100" class="w-full h-full absolute top-0 left-0" preserveAspectRatio="none">
                            <defs><linearGradient id="area-gradient" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${gradientColor}" /><stop offset="100%" stop-color="rgba(0,0,0,0)" /></linearGradient></defs>
                            <polyline fill="url(#area-gradient)" points="${areaPoints}" />
                            <polyline fill="none" stroke="${color}" stroke-width="1" points="${points}" />
                        </svg>
                    </div>
                    <div class="flex justify-between mt-1 pt-2 border-t border-white/10">${hourlyIconsHtml}</div>
                    <div class="flex justify-between mt-1">${timeLabelsHtml}</div>
                </div>
                <div class="grid grid-cols-8 gap-2 mt-auto">
                     ${daily.time.slice(0, 8).map((day, i) => `<div class="daily-forecast-item p-3 rounded-lg text-center cursor-pointer ${selectedDayIndex === i ? 'bg-white/20' : 'bg-black/20 hover:bg-white/10'}" data-index="${i}"><p class="font-semibold">${i === 0 ? '' : new Date(day).toLocaleDateString('ja-JP', { weekday: 'short' })}</p><i class="${getWeatherIcon(daily.weather_code[i], 1)} text-3xl my-2"></i><p class="text-sm">${Math.round(daily.temperature_2m_max[i])} <span class="text-gray-400">${Math.round(daily.temperature_2m_min[i])}</span></p></div>`).join('')}
                </div>
            `;
            weatherContent.querySelectorAll('.daily-forecast-item').forEach(item => item.addEventListener('click', () => { selectedDayIndex = parseInt(item.dataset.index); renderUI(); }));
            weatherContent.querySelectorAll('.graph-mode-btn').forEach(btn => btn.addEventListener('click', () => { selectedGraphMode = btn.dataset.mode; renderUI(); }));
        };
        const fetchWeather = (city) => {
            weatherContent.innerHTML = '<p class="text-center my-auto">...</p>';
            const geoParams = new URLSearchParams({ name: city, count: 1, language: 'en', format: 'json' });
            fetch(`https://geocoding-api.open-meteo.com/v1/search?${geoParams.toString()}`)
                .then(res => res.json())
                .then(geoData => {
                    if (!geoData.results) throw new Error(`${city}`);
                    const { latitude, longitude, timezone } = geoData.results[0];
                    const forecastParams = new URLSearchParams({ latitude, longitude, timezone,
                        current: 'temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation_probability,weather_code,wind_speed_10m',
                        hourly: 'temperature_2m,precipitation_probability,wind_speed_10m,weather_code',
                        daily: 'weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,uv_index_max'
                    });
                    return fetch(`https://api.open-meteo.com/v1/forecast?${forecastParams.toString()}`);
                })
                .then(async (res) => {
                    if (!res.ok) { const errorJson = await res.json(); throw new Error(errorJson.reason || ''); }
                    return res.json();
                })
                .then(weatherData => {
                    fullWeatherData = { city: searchInput.value || city, data: weatherData };
                    selectedDayIndex = 0;
                    renderUI();
                })
                .catch(err => {
                    console.error("Weather App Error:", err);
                    weatherContent.innerHTML = `<p class="text-center my-auto text-red-500">${err.message}</p>`;
                });
        };
        searchBtn.addEventListener('click', () => { if (searchInput.value) fetchWeather(searchInput.value); });
        searchInput.addEventListener('keypress', e => { if (e.key === 'Enter' && searchInput.value) fetchWeather(searchInput.value); });
        fetchWeather('Tokyo');
    }
},
{ 
id: 'image-viewer', name: '', icon: 'fas fa-image', installed: true, 
    launcher: (params = {}) => {
        const content = `
            <div class="w-full h-full flex flex-col items-center justify-center p-2 bg-black/20">
                <div id="image-viewer-placeholder" class="text-center">
                    <i class="fas fa-image text-5xl text-gray-500"></i>
                    <p class="mt-2 text-gray-400"></p>
                    <button id="open-image-btn" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"></button>
                </div>
                <img id="image-viewer-img" class="max-w-full max-h-full object-contain hidden">
            </div>`;
        const windowId = `app-window-image-viewer-${Date.now()}`;
        const viewerWindow = createWindow(windowId, '', content, 600, 450);
        const imgEl = viewerWindow.querySelector('#image-viewer-img');
        const placeholder = viewerWindow.querySelector('#image-viewer-placeholder');
        const openBtn = viewerWindow.querySelector('#open-image-btn');
        const loadImage = async (path) => {
            try {
                const fileData = await readFileWithWorker(path);
                if (fileData) {
                    imgEl.src = fileData.content;
                    imgEl.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    viewerWindow.querySelector('.window-header span').textContent = fileData.name;
                }
            } catch (err) {
                createNotification('', '', 'error');
            }
        };
        if (params.path) {
            loadImage(params.path);
        }
        openBtn.addEventListener('click', async () => {
            const filePath = await showFilePicker(['image/jpeg', 'image/png', 'image/gif', 'image/webp']);
            if (filePath) {
                loadImage(filePath);
            }
        });
    } 
},
{ 
    id: 'text-reader', name: '', icon: 'fas fa-book-open', installed: true, 
    launcher: (params = {}) => {
    const content = `<pre class="w-full h-full p-4 whitespace-pre-wrap break-words overflow-y-auto"></pre>`;
    const windowId = `app-window-text-reader-${Date.now()}`;
    const readerWindow = createWindow(windowId, '', content, 550, 400);
    const loadTextFile = async (path) => {
        const preEl = readerWindow.querySelector('pre');
        try {
            const fileData = await readFileWithWorker(path);
            if (fileData && fileData.type === 'text/plain' && fileData.content.startsWith('data:')) {
                const response = await fetch(fileData.content);
                const blob = await response.blob();
                const textContent = await blob.text();
                preEl.textContent = textContent;
                readerWindow.querySelector('.window-header span').textContent = fileData.name;
            }
        } catch (err) {
            preEl.textContent = "";
            console.error(err);
        }
    };
    if (params.path) {
        loadTextFile(params.path);
    }
}},
    {
        id: 'media-player', name: '', icon: 'fas fa-video', installed: true, 
    launcher: (params = {}) => {
        const content = `
            <div class="w-full h-full flex flex-col items-center justify-center bg-black">
                 <div id="video-viewer-placeholder" class="text-center">
                    <i class="fas fa-video text-5xl text-gray-500"></i>
                    <p class="mt-2 text-gray-400"></p>
                    <button id="open-video-btn" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"></button>
                </div>
                <video controls class="w-full h-full hidden"></video>
            </div>`;
        const windowId = `app-window-media-player-${Date.now()}`;
        const playerWindow = createWindow(windowId, '', content, 600, 450);
        const videoEl = playerWindow.querySelector('video');
        const placeholder = playerWindow.querySelector('#video-viewer-placeholder');
        const openBtn = playerWindow.querySelector('#open-video-btn');
        const loadVideo = async (path) => {
             try {
                const fileData = await readFileWithWorker(path);
                if (fileData) {
                    videoEl.src = fileData.content;
                    videoEl.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    playerWindow.querySelector('.window-header span').textContent = fileData.name;
                    videoEl.play();
                }
            } catch (err) {
                createNotification('', '', 'error');
            }
        };
        if (params.path) {
            loadVideo(params.path);
        }
        openBtn.addEventListener('click', async () => {
            const filePath = await showFilePicker(['video/mp4', 'video/webm']);
            if(filePath) {
                loadVideo(filePath);
            }
        });
    } 
},
{ 
    id: 'html-editor', name: 'HTML', icon: 'fas fa-code', installed: true,
    launcher: (params = {}) => {
        const windowId = `app-window-html-editor-${Date.now()}`;
        const content = `
<style>
    #html-editor-container { display: flex; flex-direction: column; height: 100%; }
    .editor-toolbar {
        flex-shrink: 0; display: flex; align-items: center; gap: 8px; padding: 8px;
        transition: background-color 0.3s;
    }
    .editor-btn { transition: background-color 0.2s; }
    #monaco-editor-container { flex-grow: 1; width: 100%; }
    body.dark-mode .editor-toolbar { background-color: var(--header-bg-dark); border-bottom: 1px solid var(--border-color-dark); }
    body.dark-mode .editor-btn { background-color: #3c4043; color: white; padding: 6px 12px; border-radius: 6px; }
    body.dark-mode .editor-btn:hover { background-color: #4a4d50; }
    body.dark-mode #html-editor-container .monaco-editor .monaco-editor-background,
    body.dark-mode #html-editor-container .monaco-editor .margin {
        background-color: var(--window-bg-dark) !important;
    }
    body.light-mode .editor-toolbar { background-color: var(--header-bg-light); border-bottom: 1px solid var(--border-color-light); }
    body.light-mode .editor-btn { background-color: #e0e0e0; color: #333; padding: 6px 12px; border-radius: 6px; }
    body.light-mode .editor-btn:hover { background-color: #d1d1d1; }
    body.light-mode #html-editor-container .monaco-editor .monaco-editor-background,
    body.light-mode #html-editor-container .monaco-editor .margin {
        background-color: var(--window-bg-light) !important;
    }
    body.aero-enabled #html-editor-container .monaco-editor .monaco-editor-background,
    body.aero-enabled #html-editor-container .monaco-editor .margin {
        background-color: transparent !important;
    }
    body.aero-enabled.dark-mode .editor-toolbar { background-color: transparent; }
    body.aero-enabled.light-mode .editor-toolbar { background-color: transparent; }
</style>
<div id="html-editor-container">
    <div class="editor-toolbar">
                    <button id="html-open-btn" class="editor-btn"><i class="fas fa-folder-open mr-2"></i></button>
                    <button id="html-save-btn" class="editor-btn"><i class="fas fa-save mr-2"></i></button>
        <button id="html-search-btn" class="editor-btn"><i class="fas fa-search"></i></button>
        <div class="flex-grow"></div>
        <button id="html-preview-btn" class="editor-btn bg-blue-600 hover:bg-blue-700"><i class="fas fa-eye mr-2"></i></button>
    </div>
    <div id="monaco-editor-container"></div>
</div>
        `;
        const editorWindow = createWindow(windowId, 'HTML', content, 800, 600);
        const editorContainer = editorWindow.querySelector('#monaco-editor-container');
        const openBtn = editorWindow.querySelector('#html-open-btn');
        const saveBtn = editorWindow.querySelector('#html-save-btn');
        const previewBtn = editorWindow.querySelector('#html-preview-btn');
        const searchBtn = editorWindow.querySelector('#html-search-btn'); 
        let currentFilePath = null;
        let monacoEditor;
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs' }});
require(['vs/editor/editor.main'], function() {
            monacoEditor = monaco.editor.create(editorContainer, {
                value: '<html>\n  <head>\n    <title>Hello!</title>\n  </head>\n  <body>\n    <h1>Hello, Rivift OS!</h1>\n  </body>\n</html>',
                language: 'html',
                theme: isDarkMode ? 'vs-dark' : 'vs',
                automaticLayout: true,
                fontSize: 14,
                scrollbar: {
                    verticalScrollbarSize: 8,
                    horizontalScrollbarSize: 8
                },
                minimap: { enabled: true }
            });
            if (params.path) {
                loadFile(params.path);
            }
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.attributeName === 'class') {
                        const newIsDarkMode = document.body.classList.contains('dark-mode');
                        monaco.editor.setTheme(newIsDarkMode ? 'vs-dark' : 'vs');
                    }
                });
            });
            observer.observe(document.body, { attributes: true });
            const originalCloseHandler = editorWindow.querySelector('.close').onclick;
            editorWindow.querySelector('.close').onclick = () => {
                observer.disconnect();
                if (originalCloseHandler) originalCloseHandler();
            };
        });
        const loadFile = async (path) => {
            try {
                const fileData = await readFileWithWorker(path);
                if (fileData && (fileData.type === 'text/html' || fileData.type.startsWith('text/'))) {
                    const response = await fetch(fileData.content);
                    const text = await response.text();
                    if (monacoEditor) monacoEditor.setValue(text);
                    currentFilePath = path;
                    editorWindow.querySelector('.window-header span').textContent = fileData.name;
                } else {
                    createNotification('', '', 'error');
                }
            } catch (err) {
                createNotification('', `: ${err.message}`, 'error');
            }
        };
        if (params.path) {
            loadFile(params.path);
        }
        openBtn.addEventListener('click', async () => {
            const filePath = await showFilePicker({ mode: 'open', title: 'HTML', acceptTypes: ['text/html', 'text/plain'] });
            if (filePath) {
                const path = Array.isArray(filePath) ? filePath[0] : filePath;
                if (path) loadFile(path);
            }
        });
        saveBtn.addEventListener('click', async () => {
            const defaultName = currentFilePath ? currentFilePath.substring(currentFilePath.lastIndexOf('/') + 1) : 'untitled.html';
            const target = await showFilePicker({ mode: 'save', title: '', defaultName: defaultName });
            if (target && monacoEditor) {
                const blob = new Blob([monacoEditor.getValue()], { type: 'text/html' });
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const parentPath = target.path.substring(0, target.path.lastIndexOf('/')) || '/';
                        const fileName = target.name;
                        await VFS.writeFile(parentPath, fileName, 'text/html', event.target.result);
                        createNotification('', `${fileName}`, 'info');
                        currentFilePath = target.path;
                        editorWindow.querySelector('.window-header span').textContent = fileName;
                    } catch(err) {
                        createNotification('', `: ${err.message}`, 'error');
                    }
                };
                reader.readAsDataURL(blob);
            }
        });
        previewBtn.addEventListener('click', () => {
            if (monacoEditor) {
                const htmlContent = monacoEditor.getValue();
                launchApp('code-runner', { htmlContent: htmlContent });
            }
        });
        searchBtn.addEventListener('click', () => {
            if (monacoEditor) {
                monacoEditor.trigger('anyString', 'actions.find');
            }
        });
    }
},
{ 
    id: 'code-runner', name: '', icon: 'fas fa-play-circle', installed: true, 
    launcher: (params = {}) => {
        const content = `
            <div class="flex flex-col h-full">
                <div class="p-2 border-b border-gray-700 flex items-center gap-2">
                    <button id="upload-html-btn" class="bg-blue-600 text-white px-3 py-1 rounded-md text-sm">HTML</button>
                    <span id="html-filename" class="text-sm text-gray-400 truncate"></span>
                </div>
                <iframe id="html-preview-frame" class="w-full h-full border-none bg-white"></iframe>
            </div>
        `;
        const runnerWindow = createWindow(`app-window-code-runner-${Date.now()}`, '', content, 800, 600);
        const iframe = runnerWindow.querySelector('#html-preview-frame');
        const filenameSpan = runnerWindow.querySelector('#html-filename');
        if (params.htmlContent) {
            iframe.srcdoc = params.htmlContent;
            runnerWindow.querySelector('.window-header span').textContent = ``;
            filenameSpan.textContent = 'HTML';
        }
        runnerWindow.querySelector('#upload-html-btn').addEventListener('click', async () => {
            const filePath = await showFilePicker({ mode: 'open', title: 'HTML', acceptTypes: ['text/html'] });
            if(filePath) {
                const path = Array.isArray(filePath) ? filePath[0] : filePath;
                if (!path) return;
                try {
                    const fileData = await readFileWithWorker(path);
                    if (fileData && fileData.content) {
                        const response = await fetch(fileData.content);
                        const htmlText = await response.text();
                        iframe.srcdoc = htmlText;
                        runnerWindow.querySelector('.window-header span').textContent = `: ${fileData.name}`;
                        filenameSpan.textContent = fileData.name;
                    }
                } catch (err) {
                    createNotification('', `: ${err.message}`, 'error');
                }
            }
        });
    }
},
    { id: 'game-sudoku', name: '', icon: 'fas fa-border-all', installed: false, launcher: () => {
        let gridHtml = Array(81).fill('<input type="text" maxlength="1" class="w-full h-full text-center text-lg bg-transparent border border-gray-600">').join('');
        createPopup('sudoku-game', '', `<div class="grid grid-cols-9 grid-rows-9 gap-px w-64 h-64 mx-auto">${gridHtml}</div>`, 300, 350);
    }},
    { id: 'tool-converter', name: '', icon: 'fas fa-exchange-alt', installed: false, launcher: () => {
        const content = `
            <div class="p-2 space-y-2">
                <input type="number" id="unit-input" class="w-full p-1 bg-transparent border rounded">
                <select id="unit-select" class="w-full p-1 bg-transparent border rounded">
                    <option value="kg_to_lb">kg  lb</option><option value="lb_to_kg">lb  kg</option>
                    <option value="km_to_mi">km  mi</option><option value="mi_to_km">mi  km</option>
                </select>
                <p>: <span id="unit-result"></span></p>
            </div>`;
        const popup = createPopup('converter-tool', '', content, 250, 180);
        const input = popup.querySelector('#unit-input'), select = popup.querySelector('#unit-select'), result = popup.querySelector('#unit-result');
        const convert = () => {
            const val = parseFloat(input.value);
            if(isNaN(val)) { result.textContent = ''; return; }
            switch(select.value) {
                case 'kg_to_lb': result.textContent = (val * 2.20462).toFixed(2) + ' lb'; break;
                case 'lb_to_kg': result.textContent = (val / 2.20462).toFixed(2) + ' kg'; break;
                case 'km_to_mi': result.textContent = (val * 0.621371).toFixed(2) + ' mi'; break;
                case 'mi_to_km': result.textContent = (val / 0.621371).toFixed(2) + ' km'; break;
            }
        };
        input.oninput = convert;
        select.onchange = convert;
    }},
    { id: 'social-chirp', name: 'Chirp', icon: 'fab fa-twitter', installed: false, launcher: () => { 
        createPopup('chirp-social', 'Chirp', '<textarea class="w-full h-20 p-2 bg-transparent border rounded" placeholder=""></textarea><button class="w-full mt-2 bg-blue-500 text-white py-1 rounded"></button>', 300, 200);
    }},
    { id: 'finance-tracker', name: '', icon: 'fas fa-yen-sign', installed: false, launcher: () => { 
        createPopup('finance-app', '', '<p class="text-center"></p>')
    }},
    { id: 'health-monitor', name: '', icon: 'fas fa-heartbeat', installed: false, launcher: () => { 
        createPopup('health-app', '', '<p class="text-center text-4xl"><i class="fas fa-heart-pulse text-red-500"></i> 75 bpm</p>')
    }},
    { id: 'education-stars', name: '', icon: 'fas fa-star', installed: false, launcher: () => {
        const content = `<canvas class="w-full h-full bg-black rounded-b-lg"></canvas>`;
        const popup = createWindow('stars-app', '', content, 400, 300);
        const canvas = popup.querySelector('canvas');
        const ctx = canvas.getContext('2d');
        const resize = () => { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; };
        resize();
        ctx.fillRect(0,0,canvas.width, canvas.height);
        for(let i=0; i<200; i++) {
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, Math.random() * 1.5, 0, Math.PI * 2);
            ctx.fill();
        }
    }},
    { id: 'utility-archive', name: '', icon: 'fas fa-file-archive', installed: false, launcher: () => { 
         createPopup('archive-tool', '', '<p class="text-center"></p>')
    }},
    { id: 'drawing-pixel', name: '', icon: 'fas fa-th', installed: false, launcher: () => {
        const size = 16, pixelSize = 16;
        let gridHtml = '';
        for(let i=0; i<size*size; i++) { gridHtml += `<div class="bg-gray-700 hover:bg-gray-500"></div>`; }
        const content = `<div class="grid gap-px bg-gray-900 border border-gray-600" style="grid-template-columns: repeat(${size}, ${pixelSize}px); grid-template-rows: repeat(${size}, ${pixelSize}px);">${gridHtml}</div>`;
        const popup = createWindow('pixel-editor', '', content, 300, 340);
        popup.querySelectorAll('.grid > div').forEach(cell => {
            cell.addEventListener('mousedown', (e) => { e.target.style.backgroundColor = e.ctrlKey ? '' : '#fff'; });
            cell.addEventListener('mouseover', (e) => { if(e.buttons === 1) e.target.style.backgroundColor = e.ctrlKey ? '' : '#fff'; });
        });
    }},
    { id: 'music-synth', name: '', icon: 'fas fa-wave-square', installed: false, launcher: () => { 
        createPopup('synth-app', '', '<p class="text-center"></p>')
    }},
    { id: 'tool-whiteboard', name: '', icon: 'fas fa-chalkboard', installed: false, launcher: () => { 
        createPopup('whiteboard-app', '', '<p class="text-center"></p>')
    }},
{
    id: 'docs',
    name: 'Rivift Docs',
    icon: 'fas fa-file-word',
    installed: true,
    launcher: (params = {}) => {
        const windowId = `app-window-docs-${Date.now()}`;
        const content = `
            <style>
                .tiptap-container { background-color: #f1f3f4; }
                body.dark-mode .tiptap-container { background-color: #202124; }
                .docs-toolbar { background-color: #ffffff; border-color: #dadce0; }
                body.dark-mode .docs-toolbar { background-color: #2d2d2d; border-color: #5f6368; }
                .docs-toolbar-btn:hover { background-color: #f1f3f4; }
                body.dark-mode .docs-toolbar-btn:hover { background-color: #3c4043; }
                .docs-toolbar-select { background-color: transparent; border: 1px solid transparent; -webkit-appearance: none; appearance: none; padding: 4px 8px; border-radius: 4px; }
                .docs-toolbar-select:hover { background-color: #f1f3f4; }
                body.dark-mode .docs-toolbar-select { color: white; }
                body.dark-mode .docs-toolbar-select:hover { background-color: #3c4043; }
                .tiptap { 
                    padding: 2rem; margin: 1rem auto; width: 100%; max-width: 8.5in; min-height: 11in; 
                    background-color: white; color: black; box-shadow: 0 1px 3px 1px rgba(0,0,0,0.1);
                    outline: none; 
                }
                body.dark-mode .tiptap { background-color: #35363a; color: var(--text-color-dark); }
                .tiptap > p.is-editor-empty:first-child::before { content: attr(data-placeholder); float: left; color: #adb5bd; pointer-events: none; height: 0; }
            </style>
<div id="docs-toolbar" class="docs-toolbar flex items-center flex-wrap gap-1 p-2 border-b">
    <!--  -->
    <button data-action="new" title="" class="p-2 rounded docs-toolbar-btn"><i class="fas fa-file-circle-plus"></i></button>
    <button data-action="open" title="" class="p-2 rounded docs-toolbar-btn"><i class="fas fa-folder-open"></i></button>
    <button data-action="save" title="" class="p-2 rounded docs-toolbar-btn"><i class="fas fa-save"></i></button>
    <div class="h-6 border-l mx-2 border-gray-300 dark:border-gray-600"></div>
    <!--  -->
    <select data-command="heading" class="p-1 rounded docs-toolbar-select">
        <option value="p"></option>
        <option value="h1"> 1</option>
        <option value="h2"> 2</option>
        <option value="h3"> 3</option>
    </select>
    <div class="h-6 border-l mx-2 border-gray-300 dark:border-gray-600"></div>
    <!--  -->
    <select data-command="font-family" class="p-1 rounded docs-toolbar-select">
        <option value="Inter"></option>
        <option value="serif"></option>
        <option value="monospace"></option>
    </select>
    <!--  -->
    <input type="number" data-command="font-size" value="16" min="8" max="72" class="w-16 p-1 text-center rounded bg-transparent hover:bg-gray-200 dark:hover:bg-gray-700">
    <div class="h-6 border-l mx-2 border-gray-300 dark:border-gray-600"></div>
    <!--  -->
    <button data-command="bold" title="" class="p-2 rounded docs-toolbar-btn"><i class="fas fa-bold"></i></button>
    <button data-command="italic" title="" class="p-2 rounded docs-toolbar-btn"><i class="fas fa-italic"></i></button>
    <button data-command="underline" title="" class="p-2 rounded docs-toolbar-btn"><i class="fas fa-underline"></i></button>
    <div class="relative p-2 rounded docs-toolbar-btn">
        <i class="fas fa-palette"></i>
        <input type="color" data-command="color" class="absolute inset-0 opacity-0 cursor-pointer">
    </div>
    <div class="h-6 border-l mx-2 border-gray-300 dark:border-gray-600"></div>
    <!--  -->
    <button data-command="align" data-value="left" title="" class="p-2 rounded docs-toolbar-btn"><i class="fas fa-align-left"></i></button>
    <button data-command="align" data-value="center" title="" class="p-2 rounded docs-toolbar-btn"><i class="fas fa-align-center"></i></button>
    <button data-command="align" data-value="right" title="" class="p-2 rounded docs-toolbar-btn"><i class="fas fa-align-right"></i></button>
    <div class="h-6 border-l mx-2 border-gray-300 dark:border-gray-600"></div>
    <!--  -->
    <button data-command="bulletList" title="" class="p-2 rounded docs-toolbar-btn"><i class="fas fa-list-ul"></i></button>
    <button data-command="orderedList" title="" class="p-2 rounded docs-toolbar-btn"><i class="fas fa-list-ol"></i></button>
    <div id="docs-editor-wrapper" class="flex-grow overflow-y-auto">
        <div id="docs-editor"></div>
    </div>
</div>
        `;
const docsWindow = createWindow(windowId, ' - Rivift Docs', content, 800, 600);
setTimeout(() => {
    if (!document.body.contains(docsWindow)) return;
    const { Editor, StarterKit, Placeholder, TextAlign, TextStyle, Color, FontFamily, Underline } = window.Tiptap;
    const FontSize = window.Tiptap.core.Extension.create({
        name: 'fontSize',
        addOptions() { return { types: ['textStyle'] }; },
        addGlobalAttributes() {
            return [{
                types: this.options.types,
                attributes: {
                    fontSize: {
                        default: null,
                        parseHTML: element => element.style.fontSize.replace(/px$/, ''),
                        renderHTML: attributes => {
                            if (!attributes.fontSize) { return {}; }
                            return { style: `font-size: ${attributes.fontSize}px` };
                        },
                    },
                },
            }];
        },
        addCommands() {
            return {
                setFontSize: (fontSize) => ({ chain }) => {
                    return chain().setMark('textStyle', { fontSize: fontSize }).run();
                },
                unsetFontSize: () => ({ chain }) => {
                    return chain().setMark('textStyle', { fontSize: null }).removeEmptyTextStyle().run();
                },
            };
        },
    });
    const editorElement = docsWindow.querySelector('#docs-editor');
    const toolbarElement = docsWindow.querySelector('#docs-toolbar');
    const windowTitle = docsWindow.querySelector('.window-header span');
    let currentFilePath = null;
    let isDocumentSaved = true;
    const editor = new Editor({
        element: editorElement,
        extensions: [
            StarterKit.configure({ heading: { levels: [1, 2, 3] } }),
            Underline,
            Placeholder.configure({ placeholder: '' }),
            TextAlign.configure({ types: ['heading', 'paragraph'] }),
            TextStyle,
            Color,
            FontFamily.configure({ types: ['textStyle'] }),
            FontSize
        ],
        content: `<h1> Rivift Docs </h1><p></p>`,
        onUpdate: () => {
            isDocumentSaved = false;
            if (!windowTitle.textContent.endsWith('*')) windowTitle.textContent += '*';
        },
    });
            const saveFile = async () => {
                let targetPath = currentFilePath;
                if (!targetPath) {
                    const target = await showFilePicker({ mode: 'save', title: '', defaultName: '.rdoc' });
                    if (!target) return;
                    targetPath = target.path;
                }
                try {
                    const parentPath = targetPath.substring(0, targetPath.lastIndexOf('/')) || '/';
                    const fileName = targetPath.substring(targetPath.lastIndexOf('/') + 1);
                    const contentJson = editor.getJSON();
                    const blob = new Blob([JSON.stringify(contentJson)], { type: 'application/json' });
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        await VFS.writeFile(parentPath, fileName, 'application/rivift-doc', event.target.result);
                        currentFilePath = targetPath;
                        isDocumentSaved = true;
                        windowTitle.textContent = fileName.replace('.rdoc', '');
                        createNotification('', `${fileName}`, 'info');
                    };
                    reader.readAsDataURL(blob);
                } catch (err) {
                    createNotification('', `: ${err.message}`, 'error');
                }
            };
            const openFile = async (filePathToOpen) => {
                const filePath = filePathToOpen;
                if (!filePath) return;
                try {
                    const fileData = await VFS.readFile(filePath);
                    if (!fileData || !fileData.content) throw new Error("");
                    const response = await fetch(fileData.content);
                    const blob = await response.blob();
                    const text = await blob.text();
                    const contentJson = JSON.parse(text);
                    editor.commands.setContent(contentJson, false);
                    currentFilePath = filePath;
                    isDocumentSaved = true;
                    windowTitle.textContent = fileData.name.replace('.rdoc', '');
                } catch (err) {
                    createNotification('', `: ${err.message}`, 'error');
                }
            };
            const openFilePicker = async () => {
                 const selectedPath = await showFilePicker({ mode: 'open', title: '', acceptTypes: ['application/rivift-doc'] });
                 if (selectedPath) {
                    if (!isDocumentSaved) {
                        const result = await showMessageBox('', '', { showCancel: true });
                        if (!result) return;
                    }
                    openFile(selectedPath);
                 }
            };
            const newFile = async () => {
                if (!isDocumentSaved) {
                    const result = await showMessageBox('', '', { showCancel: true });
                    if (!result) return;
                }
                editor.commands.clearContent(true);
                currentFilePath = null;
                isDocumentSaved = true;
                windowTitle.textContent = ' - Rivift Docs';
            };
    const handleToolbarAction = (e) => {
        const target = e.target.closest('button, select, input');
        if (!target) return;
        const command = target.dataset.command;
        if (!command) return;
        const chain = editor.chain().focus();
        switch (command) {
            case 'heading':
                const level = target.value;
                if (level === 'p') {
                    chain.setParagraph().run();
                } else {
                    chain.toggleHeading({ level: parseInt(level.replace('h', '')) }).run();
                }
                break;
            case 'font-family':
                chain.setFontFamily(target.value).run();
                break;
            case 'font-size':
                chain.setFontSize(target.value).run();
                break;
            case 'bold': chain.toggleBold().run(); break;
            case 'italic': chain.toggleItalic().run(); break;
            case 'underline': chain.toggleUnderline().run(); break;
            case 'color':
                if (e.type === 'input') {
                    chain.setColor(target.value).run();
                }
                break;
            case 'align':
                chain.setTextAlign(target.dataset.value).run();
                break;
            case 'bulletList': chain.toggleBulletList().run(); break;
            case 'orderedList': chain.toggleOrderedList().run(); break;
        }
    };
    toolbarElement.addEventListener('click', (e) => {
        const button = e.target.closest('button');
        if (button && button.dataset.action) {
            const action = button.dataset.action;
            if(action === 'new') newFile();
            if(action === 'open') openFilePicker();
            if(action === 'save') saveFile();
        }
        handleToolbarAction(e);
    });
    toolbarElement.addEventListener('change', handleToolbarAction);
    toolbarElement.addEventListener('input', (e) => {
        const command = e.target.dataset.command;
        if (command === 'color' || command === 'font-size') {
            handleToolbarAction(e);
        }
    });
    editor.on('transaction', () => {
        const toolbar = toolbarElement;
        toolbar.querySelectorAll('button[data-command]').forEach(btn => btn.classList.remove('active'));
        for (let i = 1; i <= 3; i++) {
            if (editor.isActive('heading', { level: i })) {
                toolbar.querySelector('[data-command="heading"]').value = `h${i}`;
                break;
            } else {
                toolbar.querySelector('[data-command="heading"]').value = 'p';
            }
        }
        const activeFont = ['Inter', 'serif', 'monospace'].find(font => editor.isActive('textStyle', { fontFamily: font })) || 'Inter';
        toolbar.querySelector('[data-command="font-family"]').value = activeFont;
        ['bold', 'italic', 'underline', 'bulletList', 'orderedList'].forEach(cmd => {
            const btn = toolbar.querySelector(`[data-command="${cmd}"]`);
            if(btn && editor.isActive(cmd)) btn.classList.add('active');
        });
        ['left', 'center', 'right'].forEach(align => {
            const btn = toolbar.querySelector(`[data-command="align"][data-value="${align}"]`);
            if(btn && editor.isActive({ textAlign: align })) btn.classList.add('active');
        });
    });
    const originalCloseHandler = docsWindow.querySelector('.close').onclick;            docsWindow.querySelector('.close').onclick = async () => {
                if (!isDocumentSaved) {
                    const result = await showMessageBox('', '', { showCancel: true });
                    if (!result) return;
                }
                editor.destroy();
                if (originalCloseHandler) originalCloseHandler();
            };
            if (params && params.path) {
                openFile(params.path);
            }
        }, 100);
    }
},
{
    id: 'cell',
    name: 'Rivift Cell',
    icon: 'fas fa-table',
    installed: true,
    launcher: (params = {}) => {
const windowId = `app-window-cell-${Date.now()}`;
const content = `
    <div id="cell-container">
        <div class="cell-toolbar">
            <button data-action="save" title="" class="cell-toolbar-btn"><i class="fas fa-save"></i></button>
            <button data-action="open" title="" class="cell-toolbar-btn"><i class="fas fa-folder-open"></i></button>
            <div class="cell-toolbar-separator"></div>
            <button data-format="bold" title="" class="cell-toolbar-btn"><i class="fas fa-bold"></i></button>
            <button data-format="italic" title="" class="cell-toolbar-btn"><i class="fas fa-italic"></i></button>
            <div class="cell-toolbar-separator"></div>
            <button data-format="align" data-value="left" title="" class="cell-toolbar-btn active"><i class="fas fa-align-left"></i></button>
            <button data-format="align" data-value="center" title="" class="cell-toolbar-btn"><i class="fas fa-align-center"></i></button>
            <button data-format="align" data-value="right" title="" class="cell-toolbar-btn"><i class="fas fa-align-right"></i></button>
        </div>
        <div class="cell-formula-bar">
            <input type="text" id="cell-address-input" readonly>
            <span class="px-2 text-gray-400">fx</span>
            <input type="text" id="cell-formula-input">
        </div>
        <div class="cell-grid-container">
            <canvas id="cell-grid-canvas"></canvas>
            <div id="cell-selection"></div>
            <div id="cell-editor" style="display: none;">
                <textarea id="cell-editor-textarea" spellcheck="false"></textarea>
            </div>
        </div>
    </div>
`;
const cellWindow = createWindow(windowId, ' - Rivift Cell', content, 800, 600);
setTimeout(() => {
    if (!document.body.contains(cellWindow)) return;
    const gridContainer = cellWindow.querySelector('.cell-grid-container');
    const canvas = cellWindow.querySelector('#cell-grid-canvas');
    const ctx = canvas.getContext('2d');
    const selectionDiv = cellWindow.querySelector('#cell-selection');
    const editorDiv = cellWindow.querySelector('#cell-editor');
    const editorTextarea = cellWindow.querySelector('#cell-editor-textarea');
    const addressInput = cellWindow.querySelector('#cell-address-input');
    const formulaInput = cellWindow.querySelector('#cell-formula-input');
    const toolbar = cellWindow.querySelector('.cell-toolbar');
    const ROW_HEIGHT = 20;
    const COL_WIDTH = 80;
    const HEADER_HEIGHT = 20;
    const HEADER_WIDTH = 40;
    const NUM_ROWS = 100;
    const NUM_COLS = 26;
    let sheetData = {};
    let currentSelection = { row: 0, col: 0, row2: 0, col2: 0 };
    const colToLetter = (col) => String.fromCharCode(65 + col);
    const formulaParser = {
        parseCellRef: (ref) => {
            const match = String(ref).match(/^([A-Z]+)(\d+)$/i);
            if (!match) return null;
            const colName = match[1].toUpperCase();
            const row = parseInt(match[2], 10) - 1;
            let col = 0;
            for (let i = 0; i < colName.length; i++) {
                col = col * 26 + (colName.charCodeAt(i) - 65);
            }
            return { row, col };
        },
        parseCellRange: (range) => {
            const parts = String(range).split(':');
            if (parts.length !== 2) return null;
            const start = formulaParser.parseCellRef(parts[0]);
            const end = formulaParser.parseCellRef(parts[1]);
            return (start && end) ? { start, end } : null;
        },
        evaluate: (formula, data, visited = new Set()) => {
            const formulaStr = String(formula || '');
            if (!formulaStr.startsWith('=')) return { value: formula, error: null };
            const expr = formulaStr.substring(1).toUpperCase();
            if (visited.has(expr)) return { value: null, error: '#REF!' };
            visited.add(expr);
            const funcMatch = expr.match(/^([A-Z]+)\((.+)\)$/i);
            if (funcMatch) {
                const funcName = funcMatch[1].toUpperCase();
                const arg = funcMatch[2];
                const range = formulaParser.parseCellRange(arg);
                if (range) {
                    let values = [];
                    for (let r = Math.min(range.start.row, range.end.row); r <= Math.max(range.start.row, range.end.row); r++) {
                        for (let c = Math.min(range.start.col, range.end.col); c <= Math.max(range.start.col, range.end.col); c++) {
                            const cellId = colToLetter(c) + (r + 1);
                            const cellData = data[cellId];
                            if (cellData) {
                                const result = formulaParser.evaluate(cellData.formula || cellData.value, data, new Set(visited));
                                const num = parseFloat(result.value);
                                if (!isNaN(num)) values.push(num);
                            }
                        }
                    }
                    switch (funcName) {
                        case 'SUM': return { value: values.reduce((a, b) => a + b, 0), error: null };
                        case 'AVERAGE': return { value: values.length ? values.reduce((a, b) => a + b, 0) / values.length : 0, error: null };
                        default: return { value: null, error: `#NAME?` };
                    }
                }
            }
            const tokens = expr.split(/(\+|-|\*|\/)/);
            if (tokens.length === 3) {
                const val1Ref = tokens[0].trim();
                const operator = tokens[1];
                const val2Ref = tokens[2].trim();
                const getVal = (refStr) => {
                    const cellRef = formulaParser.parseCellRef(refStr);
                    if(cellRef) {
                        const cell = data[refStr];
                        return cell ? parseFloat(formulaParser.evaluate(cell.formula || cell.value, data, new Set(visited)).value) : 0;
                    }
                    return parseFloat(refStr);
                };
                const val1 = getVal(val1Ref);
                const val2 = getVal(val2Ref);
                if (isNaN(val1) || isNaN(val2)) return { value: null, error: `#VALUE!` };
                switch (operator) {
                    case '+': return { value: val1 + val2, error: null };
                    case '-': return { value: val1 - val2, error: null };
                    case '*': return { value: val1 * val2, error: null };
                    case '/': return { value: val2 === 0 ? null : val1 / val2, error: val2 === 0 ? `#DIV/0!` : null };
                }
            }
            return { value: expr, error: `#ERROR!` };
        }
    };
    const drawGrid = () => {
        const isDark = document.body.classList.contains('dark-mode');
        const totalWidth = HEADER_WIDTH + NUM_COLS * COL_WIDTH;
        const totalHeight = HEADER_HEIGHT + NUM_ROWS * ROW_HEIGHT;
        canvas.width = totalWidth;
        canvas.height = totalHeight;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = isDark ? '#444' : '#e0e0e0';
        ctx.font = '10pt Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = isDark ? '#2d2d2d' : '#f8f9fa';
        ctx.fillRect(0, 0, canvas.width, HEADER_HEIGHT);
        ctx.fillRect(0, 0, HEADER_WIDTH, canvas.height);
        ctx.beginPath();
        for (let i = 0; i < NUM_COLS; i++) {
            const x = HEADER_WIDTH + i * COL_WIDTH;
            ctx.moveTo(x + 0.5, 0);
            ctx.lineTo(x + 0.5, canvas.height);
            ctx.fillStyle = isDark ? '#9e9e9e' : '#5f6368';
            ctx.fillText(colToLetter(i), x + COL_WIDTH / 2, HEADER_HEIGHT / 2);
        }
        for (let i = 0; i < NUM_ROWS; i++) {
            const y = HEADER_HEIGHT + i * ROW_HEIGHT;
            ctx.moveTo(0, y + 0.5);
            ctx.lineTo(canvas.width, y + 0.5);
            ctx.fillStyle = isDark ? '#9e9e9e' : '#5f6368';
            ctx.fillText(i + 1, HEADER_WIDTH / 2, y + ROW_HEIGHT / 2);
        }
        ctx.stroke();
        Object.keys(sheetData).forEach(cellId => {
            const cell = sheetData[cellId];
            const ref = formulaParser.parseCellRef(cellId);
            if (!ref) return;
            const { value, error } = formulaParser.evaluate(cell.formula || cell.value, sheetData);
            const x = HEADER_WIDTH + ref.col * COL_WIDTH;
            const y = HEADER_HEIGHT + ref.row * ROW_HEIGHT;
            ctx.fillStyle = cell.style?.bgColor || 'transparent';
            if (ctx.fillStyle !== 'transparent') ctx.fillRect(x + 1, y + 1, COL_WIDTH - 1, ROW_HEIGHT - 1);
            let font = '';
            if (cell.style?.italic) font += 'italic ';
            if (cell.style?.bold) font += 'bold ';
            font += '10pt Arial';
            ctx.font = font;
            ctx.fillStyle = error ? 'red' : (cell.style?.color || (isDark ? '#e8eaed' : '#202124'));
            ctx.textAlign = cell.style?.align || 'left';
            const padding = 5;
            let textX = x + padding;
            if (ctx.textAlign === 'center') textX = x + COL_WIDTH / 2;
            if (ctx.textAlign === 'right') textX = x + COL_WIDTH - padding;
            if (error || (value !== null && value !== undefined)) {
                 ctx.fillText(String(error || value), textX, y + ROW_HEIGHT / 2);
            }
        });
    };
    const updateSelectionUI = () => {
        const minRow = Math.min(currentSelection.row, currentSelection.row2);
        const maxRow = Math.max(currentSelection.row, currentSelection.row2);
        const minCol = Math.min(currentSelection.col, currentSelection.col2);
        const maxCol = Math.max(currentSelection.col, currentSelection.col2);
        const startX = HEADER_WIDTH + minCol * COL_WIDTH;
        const startY = HEADER_HEIGHT + minRow * ROW_HEIGHT;
        const endX = HEADER_WIDTH + (maxCol + 1) * COL_WIDTH;
        const endY = HEADER_HEIGHT + (maxRow + 1) * ROW_HEIGHT;
        selectionDiv.style.left = `${startX}px`;
        selectionDiv.style.top = `${startY}px`;
        selectionDiv.style.width = `${endX - startX - 1}px`;
        selectionDiv.style.height = `${endY - startY - 1}px`;
        const cellId = colToLetter(currentSelection.col) + (currentSelection.row + 1);
        addressInput.value = cellId;
        const cellData = sheetData[cellId];
        formulaInput.value = cellData?.formula || cellData?.value || '';
    };
    const getCoordsFromEvent = (e) => {
        const rect = gridContainer.getBoundingClientRect();
        const x = e.clientX - rect.left + gridContainer.scrollLeft;
        const y = e.clientY - rect.top + gridContainer.scrollTop;
        const col = Math.floor((x - HEADER_WIDTH) / COL_WIDTH);
        const row = Math.floor((y - HEADER_HEIGHT) / ROW_HEIGHT);
        return { col, row };
    };
    const startEditing = () => {
        const { row, col } = currentSelection;
        const cellId = colToLetter(col) + (row + 1);
        const cellData = sheetData[cellId];
        editorDiv.style.display = 'block';
        const x = HEADER_WIDTH + col * COL_WIDTH;
        const y = HEADER_HEIGHT + row * ROW_HEIGHT;
        editorDiv.style.left = `${x}px`;
        editorDiv.style.top = `${y}px`;
        editorDiv.style.width = `${COL_WIDTH}px`;
        editorDiv.style.height = `${ROW_HEIGHT}px`;
        editorTextarea.value = cellData?.formula || cellData?.value || '';
        let font = '';
        if(cellData?.style?.italic) font += 'italic ';
        if(cellData?.style?.bold) font += 'bold ';
        font += '10pt Arial';
        editorTextarea.style.font = font;
        editorTextarea.style.textAlign = cellData?.style?.align || 'left';
        editorTextarea.focus();
        editorTextarea.select();
    };
    const stopEditing = (save = true) => {
        if (editorDiv.style.display === 'none') return;
        if (save) {
            const text = editorTextarea.value;
            const { row, col } = currentSelection;
            const cellId = colToLetter(col) + (row + 1);
            if (!sheetData[cellId]) sheetData[cellId] = { style: {} };
            if (text.startsWith('=')) {
                sheetData[cellId].formula = text;
                sheetData[cellId].value = '';
            } else {
                sheetData[cellId].formula = '';
                sheetData[cellId].value = text;
            }
            drawGrid();
            updateSelectionUI();
        }
        editorDiv.style.display = 'none';
        gridContainer.focus();
    };
    gridContainer.addEventListener('mousedown', (e) => {
        stopEditing();
        const { col, row } = getCoordsFromEvent(e);
        if (col < 0 || row < 0 || col >= NUM_COLS || row >= NUM_ROWS) return;
        currentSelection = { row, col, row2: row, col2: col };
        updateSelectionUI();
        const onMouseMove = (moveEvent) => {
            const { col: moveCol, row: moveRow } = getCoordsFromEvent(moveEvent);
            currentSelection.row2 = Math.min(NUM_ROWS - 1, Math.max(0, moveRow));
            currentSelection.col2 = Math.min(NUM_COLS - 1, Math.max(0, moveCol));
            updateSelectionUI();
        };
        const onMouseUp = () => {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    });
    gridContainer.addEventListener('dblclick', (e) => {
        const { col, row } = getCoordsFromEvent(e);
        if (col < 0 || row < 0) return;
        startEditing();
    });
    editorTextarea.addEventListener('blur', stopEditing);
    editorTextarea.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            stopEditing();
            const nextRow = Math.min(NUM_ROWS - 1, currentSelection.row + 1);
            currentSelection = { row: nextRow, col: currentSelection.col, row2: nextRow, col2: currentSelection.col };
            updateSelectionUI();
        } else if (e.key === 'Escape') {
            stopEditing(false);
        }
    });
    formulaInput.addEventListener('keydown', (e) => {
        if(e.key === 'Enter') {
            const text = formulaInput.value;
            const { row, col } = currentSelection;
            const cellId = colToLetter(col) + (row + 1);
            if (!sheetData[cellId]) sheetData[cellId] = { style: {} };
            if (text.startsWith('=')) {
                sheetData[cellId].formula = text;
                sheetData[cellId].value = '';
            } else {
                sheetData[cellId].formula = '';
                sheetData[cellId].value = text;
            }
            drawGrid();
            gridContainer.focus();
        }
    });
    gridContainer.setAttribute('tabindex', '0');
    gridContainer.addEventListener('keydown', (e) => {
        let { row, col } = currentSelection;
        if (editorDiv.style.display !== 'none') return;
        let moved = false;
        switch (e.key) {
            case 'ArrowUp': row = Math.max(0, row - 1); moved = true; break;
            case 'ArrowDown': row = Math.min(NUM_ROWS - 1, row + 1); moved = true; break;
            case 'ArrowLeft': col = Math.max(0, col - 1); moved = true; break;
            case 'ArrowRight': col = Math.min(NUM_COLS - 1, col + 1); moved = true; break;
            case 'Enter': startEditing(); e.preventDefault(); break;
            case 'Delete': case 'Backspace':
                for (let r = Math.min(currentSelection.row, currentSelection.row2); r <= Math.max(currentSelection.row, currentSelection.row2); r++) {
                    for (let c = Math.min(currentSelection.col, currentSelection.col2); c <= Math.max(currentSelection.col, currentSelection.col2); c++) {
                        const cellId = colToLetter(c) + (r + 1);
                        delete sheetData[cellId];
                    }
                }
                drawGrid();
                updateSelectionUI();
                e.preventDefault();
                break;
            default: 
                if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
                    startEditing();
                }
                return;
        }
        if (moved) {
            currentSelection = { row, col, row2: row, col2: col };
            updateSelectionUI();
            e.preventDefault();
        }
    });
    toolbar.addEventListener('click', (e) => {
        const button = e.target.closest('button[data-format]');
        if (!button) return;
        const format = button.dataset.format;
        const value = button.dataset.value;
        if (format === 'align') {
            toolbar.querySelectorAll('button[data-format="align"]').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        } else {
            button.classList.toggle('active');
        }
        for (let r = Math.min(currentSelection.row, currentSelection.row2); r <= Math.max(currentSelection.row, currentSelection.row2); r++) {
            for (let c = Math.min(currentSelection.col, currentSelection.col2); c <= Math.max(currentSelection.col, currentSelection.col2); c++) {
                const cellId = colToLetter(c) + (r + 1);
                if (!sheetData[cellId]) sheetData[cellId] = {};
                if (!sheetData[cellId].style) sheetData[cellId].style = {};
                if (format === 'align') {
                    sheetData[cellId].style.align = value;
                } else {
                    sheetData[cellId].style[format] = !sheetData[cellId].style[format];
                }
            }
        }
        drawGrid();
    });
    const themeObserver = new MutationObserver(() => drawGrid());
    themeObserver.observe(document.body, { attributes: true, attributeFilter: ['class']});
    const resizeObserver = new ResizeObserver(drawGrid);
    resizeObserver.observe(gridContainer);
    const originalCloseHandler = cellWindow.querySelector('.close').onclick;
    cellWindow.querySelector('.close').onclick = () => {
        resizeObserver.disconnect();
        themeObserver.disconnect();
        if(originalCloseHandler) originalCloseHandler();
    };
    drawGrid();
    updateSelectionUI();
}, 100);
    }
},
{
    id: 'present',
    name: 'Rivift Present',
    icon: 'fas fa-file-powerpoint',
    installed: true,
    launcher: (params = {}) => {
        const windowId = `app-window-present-${Date.now()}`;
const content = `
<style>
    #present-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: #f1f3f4;
        color: #202124;
    }
    body.dark-mode #present-container {
        background-color: #202124;
        color: #e8eaed;
    }
    .present-toolbar {
        flex-shrink: 0;
        display: flex;
        align-items: center;
        flex-wrap: wrap; 
        gap: 4px;
        padding: 4px 8px;
        background-color: #ffffff;
        border-bottom: 1px solid #dadce0;
    }
    body.dark-mode .present-toolbar {
        background-color: #2d2d2d;
        border-color: #5f6368;
    }
    .present-toolbar-btn {
        background: none; border: 1px solid transparent;
        min-width: 32px; height: 32px;
        padding: 0 8px; border-radius: 4px;
        color: #5f6368; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        gap: 4px;
    }
    body.dark-mode .present-toolbar-btn { color: #bdc1c6; }
    .present-toolbar-btn:hover { background-color: #e8eaed; }
    body.dark-mode .present-toolbar-btn:hover { background-color: #3c4043; }
    .present-toolbar-btn.active {
        background-color: #d2e3fc; 
        color: #1967d2;
    }
    body.dark-mode .present-toolbar-btn.active {
        background-color: #a8c7fa; 
        color: #202124;
    }
    .present-toolbar-separator {
        width: 1px; height: 20px;
        background-color: #dadce0;
        margin: 0 8px; 
    }
    body.dark-mode .present-toolbar-separator { background-color: #5f6368; }
    .toolbar-input {
        background-color: transparent;
        border: 1px solid #dadce0;
        border-radius: 4px;
        padding: 4px 6px;
        height: 32px;
    }
    body.dark-mode .toolbar-input {
        background-color: #3c4043;
        border-color: #5f6368;
        color: #e8eaed;
    }
    .color-picker-wrapper {
        position: relative;
        width: 32px; height: 32px;
    }
    .color-picker-wrapper i {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none; 
    }
    .color-picker-wrapper input[type="color"] {
        position: absolute;
        inset: 0;
        opacity: 0;
        width: 100%; height: 100%;
        cursor: pointer;
    }
    #present-main-area {
        display: flex;
        flex-grow: 1;
        overflow: hidden;
    }
#present-thumbnails-pane {
    width: 20%; 
    flex-shrink: 0;
            background-color: #f8f9fa;
            border-right: 1px solid #dadce0;
            overflow-y: auto;
            padding: 8px;
        }
        body.dark-mode #present-thumbnails-pane {
            background-color: #2d2d2d;
            border-color: #5f6368;
        }
        .thumbnail-item {
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            border: 2px solid transparent;
            border-radius: 4px;
            background-color: #ffffff;
        }
        body.dark-mode .thumbnail-item {
            background-color: #3c4043;
        }
        .thumbnail-item.active {
            border-color: #1a73e8;
        }
        .thumbnail-index {
            font-size: 10px;
            color: #5f6368;
            text-align: center;
            width: 20px;
            flex-shrink: 0;
        }
        body.dark-mode .thumbnail-index {
            color: #9aa0a6;
        }
        .thumbnail-canvas {
            width: 100%;
            aspect-ratio: 16 / 9; 
            cursor: pointer;
        }
#present-editor-pane {
    flex-grow: 1; 
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    padding: 16px;
}
        #present-slide-wrapper {
            position: relative;
            background-color: white;
            box-shadow: 0 1px 3px 1px rgba(60,64,67,0.15);
        }
        body.dark-mode #present-slide-wrapper {
            background-color: #35363a;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.6), 0 1px 3px 1px rgba(0,0,0,0.3);
        }
        #present-fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            z-index: 5000;
            display: none; 
            align-items: center;
            justify-content: center;
        }
        #present-fullscreen-slide {
            max-width: 100%;
            max-height: 100%;
        }
        #present-editor-pane {
    width: 80%; 
    flex-grow: 1;
    display: flex; 
    align-items: center;
    justify-content: center;
    overflow: hidden; 
    padding: 16px;
}
    </style>
<div id="present-container">
    <!--  -->
    <div class="present-toolbar">
        <!--  -->
        <button data-action="newSlide" title="" class="present-toolbar-btn"><i class="fas fa-plus"></i></button>
        <button data-action="deleteSlide" title="" class="present-toolbar-btn"><i class="fas fa-trash"></i></button>
        <!-- /
        <div class="present-toolbar-separator"></div>
        <button data-action="save" title="" class="present-toolbar-btn"><i class="fas fa-save"></i></button>
        <button data-action="open" title="" class="present-toolbar-btn"><i class="fas fa-folder-open"></i></button>
        -->
        <div class="present-toolbar-separator"></div>
        <!--  -->
        <button data-action="addText" title="" class="present-toolbar-btn"><i class="fas fa-font"></i></button>
        <button data-action="addRect" title="" class="present-toolbar-btn"><i class="far fa-square"></i></button>
        <button data-action="addCircle" title="" class="present-toolbar-btn"><i class="far fa-circle"></i></button>
        <div id="contextual-toolbar" class="hidden items-center gap-4">
            <div class="present-toolbar-separator"></div>
            <!--  -->
            <div id="shape-tools" class="hidden items-center gap-2">
                <div class="color-picker-wrapper present-toolbar-btn" title="">
                    <i class="fas fa-fill-drip"></i>
                    <input type="color" data-prop="fill">
                </div>
                <div class="color-picker-wrapper present-toolbar-btn" title="">
                    <i class="fas fa-border-style"></i>
                    <input type="color" data-prop="stroke">
                </div>
            </div>
            <!--  -->
            <div id="text-tools" class="hidden items-center gap-2">
                <select data-prop="fontFamily" class="toolbar-input" title="">
                    <option value="Arial">Arial</option>
                    <option value="serif"></option>
                    <option value="monospace"></option>
                </select>
                <input type="number" data-prop="fontSize" class="toolbar-input" style="width: 70px;" title="">
                <select data-prop="fontWeight" class="toolbar-input" title="">
                    <option value="100"></option>
                    <option value="300"></option>
                    <option value="400"></option>
                    <option value="700"></option>
                    <option value="900"></option>
                </select>
                <div class="color-picker-wrapper present-toolbar-btn" title="">
                    <i class="fas fa-palette"></i>
                    <input type="color" data-prop="fontColor">
                </div>
                <button data-prop="fontStyle" data-value="italic" class="present-toolbar-btn" title=""><i class="fas fa-italic"></i></button>
                <!--  -->
            </div>
        </div>
        <div class="flex-grow"></div>
        <button data-action="present" title="" class="present-toolbar-btn" style="background-color: #4285f4; color: white;"><i class="fas fa-play"></i></button>
    </div>
    <!--  (HTML) -->
    <div id="present-main-area">
        <div id="present-thumbnails-pane"></div>
        <div id="present-editor-pane">
            <div id="present-slide-wrapper"></div>
        </div>
    </div>
    <!--  -->
    <div id="present-fullscreen-overlay">
        <img id="present-fullscreen-slide">
    </div>
`;
    const presentWindow = createWindow(windowId, ' - Rivift Present', content, 1000, 700);
    presentWindow.querySelector('.window-content').style.padding = '0';
    let clipboard = null;
    const query = (selector) => presentWindow.querySelector(selector);
    const toolbar = query('.present-toolbar');
    const thumbnailsPane = query('#present-thumbnails-pane');
    const editorPane = query('#present-editor-pane');
    const slideWrapper = query('#present-slide-wrapper');
    const fullscreenOverlay = query('#present-fullscreen-overlay');
    const fullscreenSlide = query('#present-fullscreen-slide');
    let presentation = {
        slides: [
            {
                id: Date.now(),
                backgroundColor: '#FFFFFF',
                objects: []
            }
        ],
        activeSlideIndex: 0
    };
    let selectedObjectId = null;
    let scale = 1;
    const SLIDE_WIDTH = 1280;
    const SLIDE_HEIGHT = 720;
    const interactionDiv = document.createElement('div');
    interactionDiv.style.position = 'absolute';
    interactionDiv.style.width = `${SLIDE_WIDTH}px`;
    interactionDiv.style.height = `${SLIDE_HEIGHT}px`;
    interactionDiv.style.transformOrigin = 'top left';
    interactionDiv.style.boxSizing = 'border-box';
    slideWrapper.appendChild(interactionDiv);
const renderThumbnails = () => {
    thumbnailsPane.innerHTML = '';
    if (presentation.slides.length === 0) {
        thumbnailsPane.innerHTML = `<p style="text-align: center; font-size: 12px; color: #9aa0a6;"></p>`;
        return;
    }
    presentation.slides.forEach((slide, index) => {
        const item = document.createElement('div');
        item.className = `thumbnail-item ${index === presentation.activeSlideIndex ? 'active' : ''}`;
        item.innerHTML = `<div class="thumbnail-index">${index + 1}</div>`;
        const thumbCanvas = document.createElement('canvas');
        thumbCanvas.className = 'thumbnail-canvas';
        const canvasWidth = 240;
        thumbCanvas.width = canvasWidth;
        thumbCanvas.height = canvasWidth * (9 / 16);
        item.appendChild(thumbCanvas);
        const thumbCtx = thumbCanvas.getContext('2d');
        const scaleFactor = canvasWidth / SLIDE_WIDTH;
        drawSlideOnCanvas(thumbCtx, slide, scaleFactor);
        item.addEventListener('click', () => {
            if (presentation.activeSlideIndex === index) return;
            presentation.activeSlideIndex = index;
            selectedObjectId = null;
            renderAll();
        });
        thumbnailsPane.appendChild(item);
    });
};
const drawSlideOnCanvas = (ctx, slide, scale = 1) => {
    ctx.save();
    ctx.scale(scale, scale);
    ctx.fillStyle = slide.backgroundColor || 'white';
    ctx.fillRect(0, 0, SLIDE_WIDTH, SLIDE_HEIGHT);
    slide.objects.forEach(obj => {
        ctx.save();
        if (obj.type === 'text') {
            ctx.fillStyle = obj.fontColor || 'black';
            ctx.font = `${obj.fontSize || 16}px ${obj.fontFamily || 'Arial'}`;
            ctx.textBaseline = 'top';
            ctx.fillText(obj.text || '', obj.x + 5, obj.y + 5, obj.width - 10);
        } else if (obj.type === 'rect' || obj.type === 'circle') {
            ctx.fillStyle = obj.fill || 'transparent';
            ctx.strokeStyle = obj.stroke || 'transparent';
            ctx.lineWidth = obj.strokeWidth || 0;
            ctx.beginPath();
            if (obj.type === 'rect') {
                ctx.rect(obj.x, obj.y, obj.width, obj.height);
            } else {
                ctx.ellipse(obj.x + obj.width / 2, obj.y + obj.height / 2, obj.width / 2, obj.height / 2, 0, 0, 2 * Math.PI);
            }
            if (obj.fill !== 'transparent') ctx.fill();
            if (obj.strokeWidth > 0 && obj.stroke !== 'transparent') ctx.stroke();
        }
        ctx.restore();
    });
    ctx.restore();
};
const fitSlideToPane = () => {
    if (!editorPane.offsetParent) return;
    const paneRect = editorPane.getBoundingClientRect();
    const panePadding = 32;
    const availableWidth = paneRect.width - panePadding;
    const availableHeight = paneRect.height - panePadding;
    const scaleX = availableWidth / SLIDE_WIDTH;
    const scaleY = availableHeight / SLIDE_HEIGHT;
    scale = Math.min(scaleX, scaleY);
    slideWrapper.style.transform = `scale(${scale})`;
    slideWrapper.style.width = `${SLIDE_WIDTH}px`;
    slideWrapper.style.height = `${SLIDE_HEIGHT}px`;
};
const renderSlide = () => {
    const activeSlide = presentation.slides[presentation.activeSlideIndex];
    if (!activeSlide) {
        interactionDiv.innerHTML = '<p></p>';
        return;
    }
    interactionDiv.innerHTML = '';
    interactionDiv.style.backgroundColor = activeSlide.backgroundColor || 'white';
    activeSlide.objects.forEach(obj => {
        const el = document.createElement('div');
        el.dataset.objectId = obj.id;
        el.style.position = 'absolute';
        el.style.left = `${obj.x}px`;
        el.style.top = `${obj.y}px`;
        el.style.width = `${obj.width}px`;
        el.style.height = `${obj.height}px`;
        el.style.backgroundColor = obj.fill || 'transparent';
        el.style.border = `${obj.strokeWidth || 0}px solid ${obj.stroke || 'transparent'}`;
        el.style.cursor = 'move';
        el.style.boxSizing = 'border-box';
        el.style.borderRadius = (obj.type === 'circle') ? '50%' : '0';
        if (obj.type === 'text') {
            el.textContent = obj.text || '';
            el.style.fontSize = `${obj.fontSize || 16}px`;
            el.style.color = obj.fontColor || 'black';
            el.style.fontFamily = obj.fontFamily || 'Arial';
            el.style.padding = '5px';
            el.style.whiteSpace = 'pre-wrap';
            el.style.wordBreak = 'break-word';
        }
        if (obj.id === selectedObjectId) {
            el.style.outline = '2px solid #1a73e8';
            el.style.outlineOffset = '2px';
            ['nw', 'ne', 'sw', 'se'].forEach(dir => {
                const handle = document.createElement('div');
                handle.className = 'resize-handle';
                handle.dataset.direction = dir;
                handle.style.position = 'absolute';
                handle.style.width = '10px';
                handle.style.height = '10px';
                handle.style.backgroundColor = '#1a73e8';
                handle.style.border = '1px solid white';
                handle.style.zIndex = '10';
                if (dir.includes('n')) handle.style.top = '-6px'; else handle.style.bottom = '-6px';
                if (dir.includes('w')) handle.style.left = '-6px'; else handle.style.right = '-6px';
                handle.style.cursor = `${dir}-resize`;
                el.appendChild(handle);
            });
        }
        interactionDiv.appendChild(el);
    });
};
    const resizeObserver = new ResizeObserver(fitSlideToPane);
    resizeObserver.observe(editorPane);
const mainArea = query('#present-main-area');
const mainAreaResizeObserver = new ResizeObserver(() => {
    fitSlideToPane();
});
mainAreaResizeObserver.observe(mainArea);
const originalCloseHandler = presentWindow.querySelector('.close').onclick;
presentWindow.querySelector('.close').onclick = () => {
    resizeObserver.disconnect();
    mainAreaResizeObserver.disconnect();
    if(originalCloseHandler) originalCloseHandler();
};
    setTimeout(() => {
        fitSlideToPane();
        renderAll();
    }, 50);
toolbar.addEventListener('click', (e) => {
    const button = e.target.closest('button[data-action]');
    if (!button) return;
    const action = button.dataset.action;
const activeSlide = presentation.slides[presentation.activeSlideIndex];
    if (!activeSlide) return;
    const objects = activeSlide.objects;
    if (action === 'addText') {
        const newText = { 
            id: Date.now(), 
            type: 'text', 
            text: '', 
            x: 50, y: 50, width: 200, height: 50,
            fontSize: 24, 
            fontColor: '#000000', 
            fontFamily: 'Arial'
        };
        objects.push(newText); 
        selectedObjectId = newText.id;
        renderAll();
    } else if (action === 'addRect') {
        const newRect = {
            id: Date.now(),
            type: 'rect',
            x: 60, y: 60, width: 150, height: 100,
            fill: '#4285F4',
            strokeWidth: 0,
            stroke: '#000000'
        };
        objects.push(newRect);
        selectedObjectId = newRect.id;
        renderAll();
    } else if (action === 'bringForward' || action === 'sendBackward') {
        if (selectedObjectId === null) return;
        const currentIndex = objects.findIndex(obj => obj.id === selectedObjectId);
        if (currentIndex === -1) return;
        if (action === 'bringForward') {
            if (currentIndex < objects.length - 1) {
                const [item] = objects.splice(currentIndex, 1);
                objects.splice(currentIndex + 1, 0, item);
            }
        } else {
            if (currentIndex > 0) {
                const [item] = objects.splice(currentIndex, 1);
                objects.splice(currentIndex - 1, 0, item);
            }
        }
        renderAll();
    } else if (action === 'addCircle') {
        const newCircle = {
            id: Date.now(),
            type: 'circle',
            x: 70, y: 70, width: 120, height: 120,
            fill: '#34A853',
            strokeWidth: 0,
            stroke: '#000000'
        };
        objects.push(newCircle);
        selectedObjectId = newCircle.id;
        renderAll();
    } else if (action === 'newSlide') {
        const newSlide = {
            id: Date.now(),
            backgroundColor: '#FFFFFF',
            objects: []
        };
        presentation.slides.splice(presentation.activeSlideIndex + 1, 0, newSlide);
        presentation.activeSlideIndex++;
        selectedObjectId = null;
        renderAll();
    } else if (action === 'deleteSlide') {
        if (presentation.slides.length <= 1) return;
        presentation.slides.splice(presentation.activeSlideIndex, 1);
        presentation.activeSlideIndex = Math.max(0, presentation.activeSlideIndex - 1);
        selectedObjectId = null;
        renderAll();
    }
});
let clickStartTime = 0;
let clickStartPoint = { x: 0, y: 0 };
let lastClick = { time: 0, objectId: null };
interactionDiv.setAttribute('tabindex', '-1');
interactionDiv.addEventListener('mousedown', (e) => {
    interactionDiv.focus();
    const targetObject = e.target.closest('[data-object-id]');
    const handle = e.target.closest('.resize-handle');
    if (handle && targetObject) {
        e.stopPropagation();
        e.preventDefault();
        const objectId = parseInt(targetObject.dataset.objectId);
        const obj = presentation.slides[presentation.activeSlideIndex].objects.find(o => o.id === objectId);
        if (!obj) return;
        const dir = handle.dataset.direction;
        const startX = e.clientX;
        const startY = e.clientY;
        const initial = { x: obj.x, y: obj.y, width: obj.width, height: obj.height };
        const onMouseMove = (moveEvent) => {
            const dx = (moveEvent.clientX - startX) / scale;
            const dy = (moveEvent.clientY - startY) / scale;
            if (dir.includes('n')) { obj.y = initial.y + dy; obj.height = Math.max(20, initial.height - dy); }
            if (dir.includes('s')) { obj.height = Math.max(20, initial.height + dy); }
            if (dir.includes('w')) { obj.x = initial.x + dx; obj.width = Math.max(20, initial.width - dx); }
            if (dir.includes('e')) { obj.width = Math.max(20, initial.width + dx); }
            renderSlide();
        };
        const onMouseUp = () => {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            renderThumbnails();
        };
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
        return;
    }
    const now = Date.now();
    const objectId = targetObject ? parseInt(targetObject.dataset.objectId) : null;
    if (now - lastClick.time < 500 && objectId !== null && objectId === lastClick.objectId) {
        const obj = presentation.slides[presentation.activeSlideIndex].objects.find(o => o.id === objectId);
        if (obj && obj.type === 'text') {
            e.stopPropagation();
            targetObject.setAttribute('contenteditable', 'true');
            targetObject.style.cursor = 'text';
            targetObject.focus();
            const range = document.createRange();
            range.selectNodeContents(targetObject);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            const onBlur = () => {
                if (obj.text !== targetObject.textContent) {
                    obj.text = targetObject.textContent;
                    renderThumbnails();
                }
                targetObject.setAttribute('contenteditable', 'false');
                targetObject.style.cursor = 'move';
                targetObject.removeEventListener('blur', onBlur);
            };
            targetObject.addEventListener('blur', onBlur);
            lastClick = { time: 0, objectId: null };
            return;
        }
    }
    lastClick = { time: now, objectId: objectId };
    if (targetObject) {
        e.stopPropagation();
        if (selectedObjectId !== objectId) {
            selectedObjectId = objectId;
            renderAll();
        }
        const obj = presentation.slides[presentation.activeSlideIndex].objects.find(o => o.id === objectId);
        if (!obj) return;
        const startX = e.clientX;
        const startY = e.clientY;
        const initial = { x: obj.x, y: obj.y };
        const onMouseMove = (moveEvent) => {
            const dx = (moveEvent.clientX - startX) / scale;
            const dy = (moveEvent.clientY - startY) / scale;
            obj.x = initial.x + dx;
            obj.y = initial.y + dy;
            renderSlide();
        };
        const onMouseUp = () => {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            renderThumbnails();
        };
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    } else {
        selectedObjectId = null;
        renderAll();
    }
});
interactionDiv.addEventListener('keydown', (e) => {
    if (e.target.closest('[contenteditable="true"]')) {
        return;
    }
    if (e.key === 'Delete' || e.key === 'Backspace') {
        if (selectedObjectId !== null) {
            e.preventDefault();
            const activeSlide = presentation.slides[presentation.activeSlideIndex];
            activeSlide.objects = activeSlide.objects.filter(obj => obj.id !== selectedObjectId);
            selectedObjectId = null;
            renderAll();
        }
    }
});
interactionDiv.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    e.stopPropagation();
    const targetObject = e.target.closest('[data-object-id]');
    let menuItems = [];
    if (targetObject) {
        const objectId = parseInt(targetObject.dataset.objectId);
        if (selectedObjectId !== objectId) {
            selectedObjectId = objectId;
            renderAll();
        }
        menuItems = [
            {
                label: '',
                icon: 'fas fa-copy',
                action: () => {
                    const activeSlide = presentation.slides[presentation.activeSlideIndex];
                    const objectToCopy = activeSlide.objects.find(obj => obj.id === selectedObjectId);
                    if (objectToCopy) {
                        clipboard = JSON.stringify(objectToCopy);
                    }
                }
            },
            { separator: true },
            {
                label: '',
                icon: 'fas fa-angle-double-up',
                action: () => {
                    const objects = presentation.slides[presentation.activeSlideIndex].objects;
                    const currentIndex = objects.findIndex(obj => obj.id === selectedObjectId);
                    if (currentIndex < objects.length - 1) {
                        const [item] = objects.splice(currentIndex, 1);
                        objects.push(item);
                        renderAll();
                    }
                }
            },
            {
                label: '',
                icon: 'fas fa-arrow-up',
                action: () => {
                    const objects = presentation.slides[presentation.activeSlideIndex].objects;
                    const currentIndex = objects.findIndex(obj => obj.id === selectedObjectId);
                    if (currentIndex < objects.length - 1) {
                        const [item] = objects.splice(currentIndex, 1);
                        objects.splice(currentIndex + 1, 0, item);
                        renderAll();
                    }
                }
            },
            {
                label: '',
                icon: 'fas fa-arrow-down',
                action: () => {
                    const objects = presentation.slides[presentation.activeSlideIndex].objects;
                    const currentIndex = objects.findIndex(obj => obj.id === selectedObjectId);
                    if (currentIndex > 0) {
                        const [item] = objects.splice(currentIndex, 1);
                        objects.splice(currentIndex - 1, 0, item);
                        renderAll();
                    }
                }
            },
            {
                label: '',
                icon: 'fas fa-angle-double-down',
                action: () => {
                    const objects = presentation.slides[presentation.activeSlideIndex].objects;
                    const currentIndex = objects.findIndex(obj => obj.id === selectedObjectId);
                    if (currentIndex > 0) {
                        const [item] = objects.splice(currentIndex, 1);
                        objects.unshift(item);
                        renderAll();
                    }
                }
            },
            { separator: true },
            {
                label: '',
                icon: 'fas fa-trash',
                action: () => {
                    const activeSlide = presentation.slides[presentation.activeSlideIndex];
                    activeSlide.objects = activeSlide.objects.filter(obj => obj.id !== selectedObjectId);
                    selectedObjectId = null;
                    renderAll();
                }
            }
        ];
            } else {
        if (clipboard) {
            menuItems.push({
                label: '',
                icon: 'fas fa-paste',
                action: () => {
                    const activeSlide = presentation.slides[presentation.activeSlideIndex];
                    const objectToPaste = JSON.parse(clipboard);
                    objectToPaste.id = Date.now();
                    objectToPaste.x += 20;
                    objectToPaste.y += 20;
                    activeSlide.objects.push(objectToPaste);
                    selectedObjectId = objectToPaste.id;
                    renderAll();
                }
            });
        }
    }
    if (menuItems.length > 0) {
        showContextMenu(menuItems, e);
    }
});
const contextualToolbar = query('#contextual-toolbar');
const shapeTools = query('#shape-tools');
const textTools = query('#text-tools');
const updateToolbar = () => {
    const selectedObject = presentation.slides[presentation.activeSlideIndex]?.objects.find(o => o.id === selectedObjectId);
    if (!selectedObject) {
        contextualToolbar.classList.add('hidden');
        return;
    }
    contextualToolbar.classList.remove('hidden');
    contextualToolbar.style.display = 'flex';
if (selectedObject.type === 'text') {
    shapeTools.style.display = 'none';
    textTools.style.display = 'flex';
    textTools.querySelector('[data-prop="fontFamily"]').value = selectedObject.fontFamily || 'Arial';
    textTools.querySelector('[data-prop="fontSize"]').value = selectedObject.fontSize || 24;
    textTools.querySelector('[data-prop="fontWeight"]').value = selectedObject.fontWeight || '400';
    textTools.querySelector('[data-prop="fontColor"]').value = selectedObject.fontColor || '#000000';
    textTools.querySelector('[data-prop="fontStyle"]').classList.toggle('active', selectedObject.fontStyle === 'italic');
} else {
        textTools.style.display = 'none';
        shapeTools.style.display = 'flex';
        shapeTools.querySelector('[data-prop="fill"]').value = selectedObject.fill || '#FFFFFF';
        shapeTools.querySelector('[data-prop="stroke"]').value = selectedObject.stroke || '#000000';
    }
};
contextualToolbar.addEventListener('input', (e) => {
    const target = e.target;
    const prop = target.dataset.prop;
    const selectedObject = presentation.slides[presentation.activeSlideIndex]?.objects.find(o => o.id === selectedObjectId);
    if (!selectedObject || !prop) return;
    selectedObject[prop] = target.value;
    renderSlide();
    renderThumbnails();
});
contextualToolbar.addEventListener('click', (e) => {
    const button = e.target.closest('button[data-prop]');
    if (!button) return;
    const prop = button.dataset.prop;
    const value = button.dataset.value;
    const selectedObject = presentation.slides[presentation.activeSlideIndex]?.objects.find(o => o.id === selectedObjectId);
    if (!selectedObject) return;
    if (selectedObject[prop] === value) {
        selectedObject[prop] = null;
    } else {
        selectedObject[prop] = value;
    }
    updateToolbar();
    renderSlide();
    renderThumbnails();
});
const renderAll = () => {
    renderThumbnails();
    renderSlide();
    updateToolbar();
    const deleteButton = toolbar.querySelector('[data-action="deleteSlide"]');
    if (deleteButton) {
        deleteButton.disabled = presentation.slides.length <= 1;
    }
};
    }
},
{
    id: 'web-studio',
    name: 'Web Studio',
    icon: 'icons/program.svg',
    installed: true,
launcher: (params = {}) => {
    const windowId = `app-window-web-studio-${Date.now()}`;
const content = `
    <div id="studio-container">
        <div id="studio-palette">
            <div id="studio-palette-header"><input type="text" id="studio-palette-search" placeholder="..."></div>
            <div id="studio-palette-content"></div>
        </div>
        <div id="studio-workspace-area">
            <div class="studio-controls">
                <button id="undo-button" class="studio-btn" title="" disabled><i class="fa-solid fa-rotate-left"></i></button>
                <button id="redo-button" class="studio-btn" title="" disabled><i class="fa-solid fa-rotate-right"></i></button>
                <div class="studio-toolbar-separator"></div>
                <button id="save-button" class="studio-btn" title=""><i class="fa-solid fa-floppy-disk"></i></button>
                <button id="load-button" class="studio-btn" title=""><i class="fa-solid fa-folder-open"></i></button>
                <div class="flex-grow"></div>
                <button id="run-stop-button" class="studio-btn bg-green-500 text-white hover:bg-green-600"><i class="fa-solid fa-play"></i> </button>
            </div>
            <div id="studio-workspace-wrapper" style="position: relative;">
                <div id="studio-workspace"><p class="text-center text-gray-500"></p></div>
                <div id="studio-context-menu" style="display: none; position: absolute;"></div>
            </div>
        </div>
        <div id="studio-preview-area">
            <div class="studio-controls"><h2 class="text-lg font-bold"></h2></div>
            <div id="studio-preview-container"><iframe id="studio-preview-iframe"></iframe></div>
            <div class="p-2 border-t border-gray-200 dark:border-gray-700"><button id="toggle-html-display" class="studio-btn text-xs w-full justify-center">HTML</button></div>
            <div id="studio-html-display-area"><pre></pre></div>
        </div>
    </div>
`;
    const studioWindow = createWindow(windowId, 'Web Studio', content, 1200, 700);
    studioWindow.querySelector('.window-content').style.padding = '0';
setTimeout(() => {
        if (!document.body.contains(studioWindow)) return;
        const query = (selector) => studioWindow.querySelector(selector);
        const palette = query('#studio-palette');
        const paletteContent = query('#studio-palette-content');
        const paletteSearch = query('#studio-palette-search');
        const workspace = query('#studio-workspace');
        const runStopButton = query('#run-stop-button');
        const previewContainer = query('#studio-preview-container');
        let previewFrame = query('#studio-preview-iframe');
        const undoButton = query('#undo-button');
        const redoButton = query('#redo-button');
        const saveButton = query('#save-button');
        const loadButton = query('#load-button');
        const htmlDisplayArea = query('#studio-html-display-area');
        const toggleHtmlDisplayButton = query('#toggle-html-display');
        const contextMenu = query('#studio-context-menu');
        let declaredVariables = new Set();
        let draggedItem = null;
        let isDraggingFromPalette = false;
        let historyStack = [];
        let redoStack = [];
        let isRestoringState = false;
        let isExecuting = false;
        let contextTarget = null;
        let myBlocks = JSON.parse(localStorage.getItem('myBlocks') || '{}');
        const webStudioBlockDefinitions = {
            html: {
                title: 'HTML', color: 'html',
                blocks: [
                    { type: 'html-container', text: '<i class="fa-solid fa-code"></i> HTML', isContainer: true },
                    { type: 'div-container', text: '<i class="fa-solid fa-box-archive"></i> (div) ID:<input type="text" data-prop="id" data-id-type="all">', isContainer: true },
                    { type: 'text-element', text: '<i class="fa-solid fa-font"></i> <select data-prop="tag"><option value="h1">1</option><option value="h2">2</option><option value="p"></option><option value="span"></option></select> ID:<input type="text" data-prop="id" data-id-type="text">  <input type="text" data-prop="text" class="variable-input-target"> ' },
                    { type: 'shape', text: '<i class="fa-solid fa-shapes"></i>  <select data-prop="type"><option value="rect"></option><option value="circle"></option><option value="triangle"></option></select> ID:<input type="text" data-prop="id" data-id-type="all"> ' },
                    { type: 'image', text: '<i class="fa-solid fa-image"></i>  ID:<input type="text" data-prop="id" data-id-type="all"> URL:<input type="text" data-prop="src"> :<input type="text" data-prop="alt">' },
                    { type: 'link', text: '<i class="fa-solid fa-link"></i>  ID:<input type="text" data-prop="id" data-id-type="all"> URL:<input type="text" data-prop="href"> :<input type="text" data-prop="text" class="variable-input-target">' },
                    { type: 'text-input', text: '<i class="fa-solid fa-i-cursor"></i>  ID:<input type="text" data-prop="id" data-id-type="text"> :<input type="text" data-prop="value" class="variable-input-target">' },
                    { type: 'button', text: '<i class="fa-solid fa-computer-mouse"></i>  ID:<input type="text" data-prop="id" data-id-type="button"> :<input type="text" data-prop="text" class="variable-input-target">' },
                    { type: 'dropdown', text: '<i class="fa-solid fa-caret-down"></i>  ID:<input type="text" data-prop="id" data-id-type="dropdown">' },
                    { type: 'br', text: '<i class="fa-solid fa-turn-down"></i> ' },
                    { type: 'hr', text: '<i class="fa-solid fa-minus"></i> ' },
                    { type: 'list-container', text: '<i class="fa-solid fa-list-ul"></i> <select data-prop="tag"><option value="ul"></option><option value="ol"></option></select> ID:<input type="text" data-prop="id" data-id-type="all">', isContainer: true },
                    { type: 'list-item', text: '<i class="fa-solid fa-list-check"></i>  :<input type="text" data-prop="text" class="variable-input-target">' },
                    { type: 'table-container', text: '<i class="fa-solid fa-table"></i>  ID:<input type="text" data-prop="id" data-id-type="all">', isContainer: true },
                    { type: 'table-row', text: '<i class="fa-solid fa-grip-lines"></i> ', isContainer: true },
                    { type: 'table-cell', text: '<i class="fa-solid fa-table-cells"></i>  :<input type="text" data-prop="text" class="variable-input-target">' },
                    { type: 'form-container', text: '<i class="fa-solid fa-file-lines"></i>  ID:<input type="text" data-prop="id" data-id-type="all">', isContainer: true },
                    { type: 'textarea-input', text: '<i class="fa-solid fa-paragraph"></i>  ID:<input type="text" data-prop="id" data-id-type="text"> :<textarea data-prop="value" class="variable-input-target"></textarea>' },
                    { type: 'video', text: '<i class="fa-solid fa-video"></i>  ID:<input type="text" data-prop="id" data-id-type="all"> URL:<input type="text" data-prop="src">' },
                    { type: 'audio', text: '<i class="fa-solid fa-volume-high"></i>  ID:<input type="text" data-prop="id" data-id-type="all"> URL:<input type="text" data-prop="src">' },
                    { type: 'canvas', text: '<i class="fa-solid fa-palette"></i>  ID:<input type="text" data-prop="id" data-id-type="all"> :<input type="number" data-prop="width" value="300"> :<input type="number" data-prop="height" value="150">' }
                ]
            },
            layout: {
                title: 'CSS', color: 'layout',
                blocks: [
                    { type: 'flex-container', text: '<i class="fa-solid fa-layer-group"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select> Flexbox', isContainer: true },
                    { type: 'flex-direction', text: '<i class="fa-solid fa-arrow-right-arrow-left"></i> : <select data-prop="direction"><option value="row"></option><option value="column"></option><option value="row-reverse"></option><option value="column-reverse"></option></select>' },
                    { type: 'flex-justify-content', text: '<i class="fa-solid fa-align-justify"></i> : <select data-prop="justify"><option value="flex-start"></option><option value="center"></option><option value="flex-end"></option><option value="space-between"></option><option value="space-around">()</option><option value="space-evenly">()</option></select>' },
                    { type: 'flex-align-items', text: '<i class="fa-solid fa-align-center"></i> : <select data-prop="align"><option value="stretch"></option><option value="flex-start"></option><option value="center"></option><option value="flex-end"></option></select>' },
                    { type: 'media-query', text: '<i class="fa-solid fa-mobile-screen-button"></i>  <input type="number" data-prop="width" value="768">px ', isContainer: true }
                ]
            },
            css: {
                title: 'CSS', color: 'css',
                blocks: [
                    { type: 'css-container', text: '<i class="fa-brands fa-css3-alt"></i> CSS', isContainer: true },
                    { type: 'set-body-background-color', text: '<i class="fa-solid fa-palette"></i>  <input type="color" data-prop="color" value="#f0f2f5"> ' },
                    { type: 'background-color', text: '<i class="fa-solid fa-fill-drip"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="color" data-prop="color" value="#1e90ff"> ' },
                    { type: 'color', text: '<i class="fa-solid fa-font"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="color" data-prop="color" value="#ffffff"> ' },
                    { type: 'font-size', text: '<i class="fa-solid fa-text-height"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="number" data-prop="size" value="16" class="variable-input-target">px' },
                    { type: 'font-family', text: '<i class="fa-solid fa-font"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <select data-prop="family"><option value="sans-serif"></option><option value="serif"></option><option value="monospace"></option></select> ' },
                    { type: 'size', text: '<i class="fa-solid fa-arrows-up-down-left-right"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>   <input type="number" data-prop="width" value="100" class="variable-input-target">px,  <input type="number" data-prop="height" value="50" class="variable-input-target">px ' },
                    { type: 'opacity', text: '<i class="fa-solid fa-star-half-stroke"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="number" data-prop="value" value="100" min="0" max="100" class="variable-input-target">%' },
                    { type: 'border-radius', text: '<i class="fa-solid fa-vector-square"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="number" data-prop="radius" value="8" class="variable-input-target">px' },
                    { type: 'border', text: '<i class="fa-solid fa-border-all"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="number" data-prop="width" value="1" min="0">px <select data-prop="style"><option value="solid"></option><option value="dashed"></option><option value="double"></option></select> <input type="color" data-prop="color" value="#000000"> ' },
                    { type: 'border-color', text: '<i class="fa-solid fa-border-top-left"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="color" data-prop="color" value="#000000"> ' },
                    { type: 'border-width', text: '<i class="fa-solid fa-arrows-left-right-to-line"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="number" data-prop="width" value="1" min="0"> px' },
                    { type: 'text-align', text: '<i class="fa-solid fa-align-center"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <select data-prop="align"><option value="left"></option><option value="center"></option><option value="right"></option></select> ' },
                    { type: 'box-shadow', text: '<i class="fa-solid fa-clone"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  X:<input type="number" data-prop="x" value="2"> Y:<input type="number" data-prop="y" value="2"> :<input type="number" data-prop="blur" value="4"> :<input type="color" data-prop="color" value="#888888">' },
                    { type: 'cursor', text: '<i class="fa-solid fa-arrow-pointer"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <select data-prop="cursor"><option value="pointer"></option><option value="text"></option><option value="move"></option><option value="not-allowed"></option></select> ' },
                    { type: 'element-position', text: '<i class="fa-solid fa-arrows-to-dot"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <select data-prop="position"><option value="left"></option><option value="center"></option><option value="right"></option></select> ' },
                    { type: 'set-x-css', text: '<i class="fa-solid fa-arrows-left-right"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select> X <input type="number" data-prop="value" value="0" class="variable-input-target">px ' },
                    { type: 'set-y-css', text: '<i class="fa-solid fa-arrows-up-down"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select> Y <input type="number" data-prop="value" value="0" class="variable-input-target">px ' },
                    { type: 'transition', text: '<i class="fa-solid fa-wand-magic-sparkles"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="number" data-prop="duration" value="0.5" step="0.1">' },
                ]
            },
            js: {
                title: 'JS', color: 'js',
                blocks: [
                    { type: 'js-container', text: '<i class="fa-brands fa-js"></i> JS', isContainer: true },
                    { type: 'onclick', text: '<i class="fa-solid fa-hand-pointer"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select> ', isContainer: true },
                    { type: 'on-key-press', text: '<i class="fa-solid fa-keyboard"></i> <select data-prop="key"><option value="Enter"></option><option value=" "></option><option value="ArrowUp"></option><option value="ArrowDown"></option><option value="ArrowLeft"></option><option value="ArrowRight"></option></select> ', isContainer: true },
                    { type: 'if-condition', text: '<i class="fa-solid fa-code-branch"></i>  <input type="text" data-prop="val1" class="variable-input-target"> <select data-prop="op"><option value="==="></option><option value="!=="></option><option value=">"></option><option value="<"></option><option value=">="></option><option value="<="></option></select> <input type="text" data-prop="val2" class="variable-input-target"> ', isContainer: true, hasElse: true },
                    { type: 'loop-forever', text: '<i class="fa-solid fa-infinity"></i>  (:<input type="number" data-prop="interval" value="1000" min="100">)', isContainer: true },
                    { type: 'loop-times', text: '<i class="fa-solid fa-repeat"></i> <input type="number" data-prop="times" value="10" min="1" class="variable-input-target"> ', isContainer: true },
                    { type: 'wait-seconds', text: '<i class="fa-solid fa-clock"></i> <input type="number" data-prop="seconds" value="1" min="0" class="variable-input-target"> ' },
                    { type: 'alert', text: '<i class="fa-solid fa-triangle-exclamation"></i> <input type="text" data-prop="message" class="variable-input-target"> ' },
                    { type: 'go-to-url', text: '<i class="fa-solid fa-paper-plane"></i> URL <input type="text" data-prop="url" class="variable-input-target"> ' },
                    { type: 'while-loop', text: '<i class="fa-solid fa-arrows-rotate"></i> <input type="text" data-prop="val1" class="variable-input-target"> <select data-prop="op"><option value="==="></option><option value="!=="></option><option value=">"></option><option value="<"></option></select> <input type="text" data-prop="val2" class="variable-input-target"> ', isContainer: true },
                    { type: 'switch-case', text: '<i class="fa-solid fa-shuffle"></i>  <select data-prop="var" class="variable-select"></select> ', isContainer: true },
                    { type: 'case-block', text: '<i class="fa-solid fa-check"></i>  <input type="text" data-prop="value" class="variable-input-target"> ', isContainer: true },
                    { type: 'local-storage-save', text: '<i class="fa-solid fa-cloud-arrow-down"></i>  :<input type="text" data-prop="key">  :<input type="text" data-prop="value" class="variable-input-target"> ' },
                    { type: 'local-storage-load', text: '<i class="fa-solid fa-cloud-arrow-up"></i>  :<input type="text" data-prop="key">  :<select data-prop="var" class="variable-select"></select> ' },
                ]
            },
            array: {
                title: 'JS', color: 'array',
                blocks: [
                    { type: 'variable-declare', text: '<i class="fa-solid fa-square-plus"></i>  <input type="text" data-prop="name" class="variable-creation-input"> ' },
                    { type: 'variable-set', text: '<i class="fa-solid fa-equals"></i>  <select data-prop="name" class="variable-select"></select>  <input type="text" data-prop="value" class="variable-input-target"> ' },
                    { type: 'variable-value', text: '<i class="fa-solid fa-right-left"></i>  <select data-prop="source" class="variable-select"></select>  <select data-prop="dest" class="variable-select"></select> ' },
                    { type: 'variable-change', text: '<i class="fa-solid fa-plus-minus"></i>  <select data-prop="name" class="variable-select"></select>  <input type="number" data-prop="value" value="1"> ' },
                    { type: 'operator', text: '<i class="fa-solid fa-calculator"></i>  <select data-prop="var" class="variable-select"></select>  <input type="text" data-prop="val1" class="variable-input-target"> <select data-prop="op"><option value="+">+</option><option value="-">-</option><option value="*"></option><option value="/"></option><option value="%"></option></select> <input type="text" data-prop="val2" class="variable-input-target"> ' },
                    { type: 'text-join', text: '<i class="fa-solid fa-link"></i>  <select data-prop="var" class="variable-select"></select>  <span class="join-items-container"><span class="join-item">[<input type="text" data-prop="val0" class="variable-input-target">]</span><span class="join-item"> [<input type="text" data-prop="val1" class="variable-input-target">]</span></span> <span class="join-controls"><button data-action="add">+</button><button data-action="remove">-</button></span> ' },
                    { type: 'set-element-text', text: '<i class="fa-solid fa-pen-to-square"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="text" data-prop="text" class="variable-input-target"> ' },
                    { type: 'get-element-value', text: '<i class="fa-solid fa-arrow-down-a-z"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select> / <select data-prop="var" class="variable-select"></select> ' },
                    { type: 'show-element', text: '<i class="fa-solid fa-eye"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select> ' },
                    { type: 'hide-element', text: '<i class="fa-solid fa-eye-slash"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select> ' },
                    { type: 'toggle-class', text: '<i class="fa-solid fa-toggle-on"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <input type="text" data-prop="class"> ' },
                    { type: 'set-style-js', text: '<i class="fa-solid fa-paintbrush"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select>  <select data-prop="prop"><option value="backgroundColor"></option><option value="color"></option><option value="width">(px)</option><option value="height">(px)</option><option value="opacity">(0-1)</option><option value="transform">(deg)</option></select>  <input type="text" data-prop="value" class="variable-input-target"> ' },
                    { type: 'dropdown-add-item', text: '<i class="fa-solid fa-square-plus"></i> ID:<select data-prop="id" data-id-filter="dropdown" class="id-select"></select> :<input type="text" data-prop="text"> :<input type="text" data-prop="value"> ' },
                    { type: 'change-x-js', text: '<i class="fa-solid fa-arrow-right-long"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select> X <input type="number" data-prop="value" value="10" class="variable-input-target"> ' },
                    { type: 'change-y-js', text: '<i class="fa-solid fa-arrow-down-long"></i> ID:<select data-prop="id" data-id-filter="all" class="id-select"></select> Y <input type="number" data-prop="value" value="10" class="variable-input-target"> ' },
                    { type: 'get-random-number', text: '<i class="fa-solid fa-dice"></i>  <select data-prop="var" class="variable-select"></select>  <input type="number" data-prop="min" value="1" class="variable-input-target">  <input type="number" data-prop="max" value="100" class="variable-input-target"> ' },
                    { type: 'get-time', text: '<i class="fa-solid fa-calendar-days"></i>  <select data-prop="var" class="variable-select"></select>  <select data-prop="unit"><option value="getFullYear"></option><option value="getMonth">(1-12)</option><option value="getDate"></option><option value="getHours"></option><option value="getMinutes"></option><option value="getSeconds"></option></select> ' },
                    { type: 'array-create', text: '<i class="fa-solid fa-folder-plus"></i>  <input type="text" data-prop="name" class="variable-creation-input"> ' },
                    { type: 'array-add', text: '<i class="fa-solid fa-plus"></i>  <select data-prop="name" class="variable-select"></select>  <input type="text" data-prop="value" class="variable-input-target"> ' },
                    { type: 'array-get', text: '<i class="fa-solid fa-arrow-down-1-9"></i>  <select data-prop="var" class="variable-select"></select>   <select data-prop="name" class="variable-select"></select>  <input type="number" data-prop="index" value="0" min="0" class="variable-input-target"> ' },
                    { type: 'array-set', text: '<i class="fa-solid fa-pen"></i>  <select data-prop="name" class="variable-select"></select>  <input type="number" data-prop="index" value="0" min="0" class="variable-input-target">  <input type="text" data-prop="value" class="variable-input-target"> ' },
                    { type: 'array-loop', text: '<i class="fa-solid fa-diagram-next"></i>  <select data-prop="name" class="variable-select"></select>  <input type="text" data-prop="itemVar" class="variable-creation-input"> ', isContainer: true },
                    { type: 'fetch-api', text: '<i class="fa-solid fa-cloud-download-alt"></i> URL <input type="text" data-prop="url">  <select data-prop="var" class="variable-select"></select> JSON' },
                ]
            },
            myblock: {
                title: '', color: 'myblock', blocks: []
            }
        };
        const placeholder = document.createElement('div');
        placeholder.className = 'studio-drop-placeholder';
        const emptyImage = new Image();
        emptyImage.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
        const styleVariableInputs = () => { workspace.querySelectorAll('.variable-input-target').forEach(input => { input.classList.toggle('is-variable', declaredVariables.has(input.value)); }); };
        let currentVariableInput = null, suggestionList = null;
        const showVariableSuggestions = (inputElement) => {
            currentVariableInput = inputElement; hideVariableSuggestions();
            if (declaredVariables.size === 0 || inputElement.classList.contains('variable-creation-input')) return;
            suggestionList = document.createElement('div'); suggestionList.className = 'variable-suggestion-list';
            const filterText = inputElement.value.toLowerCase(); let hasSuggestions = false;
            declaredVariables.forEach(variable => {
                if (variable.toLowerCase().includes(filterText)) {
                    const div = document.createElement('div'); div.textContent = variable;
                    div.addEventListener('mousedown', e => { e.preventDefault(); inputElement.value = variable; inputElement.dispatchEvent(new Event('input', { bubbles: true })); inputElement.dispatchEvent(new Event('change', { bubbles: true })); hideVariableSuggestions(); inputElement.focus(); });
                    suggestionList.appendChild(div); hasSuggestions = true;
                }
            });
            if (hasSuggestions) { const rect = inputElement.getBoundingClientRect(); Object.assign(suggestionList.style, { top: `${rect.bottom + window.scrollY}px`, left: `${rect.left + window.scrollX}px`, minWidth: `${rect.width}px` }); document.body.appendChild(suggestionList); }
        };
        const hideVariableSuggestions = () => { if (suggestionList) { suggestionList.remove(); suggestionList = null; } };
        const checkWorkspaceEmpty = () => {
            const workspaceBlocks = workspace.querySelectorAll('.workspace-block');
            const emptyMessage = workspace.querySelector('p');
            if (workspaceBlocks.length === 0 && !emptyMessage) {
                workspace.innerHTML = '<p class="text-center text-gray-500"></p>';
            } else if (workspaceBlocks.length > 0 && emptyMessage) {
                emptyMessage.remove();
            }
        };
        const saveState = () => {
            if (isRestoringState) return;
            const state = workspace.innerHTML;
            if (historyStack.length === 0 || state !== historyStack[historyStack.length - 1]) {
                historyStack.push(state);
                if (historyStack.length > 50) historyStack.shift();
                redoStack = [];
                updateUndoRedoButtons();
            }
        };
        const restoreState = (state, saveToHistory = false) => {
            isRestoringState = true;
            workspace.innerHTML = state;
            workspace.querySelectorAll('.workspace-block').forEach(block => {
                setupWorkspaceBlockInteractions(block);
            });
            updateAll();
            checkWorkspaceEmpty();
            isRestoringState = false;
            if (saveToHistory) {
                saveState();
            }
        };
        const undo = () => { if (historyStack.length > 1) { redoStack.push(historyStack.pop()); restoreState(historyStack[historyStack.length - 1]); updateUndoRedoButtons(); } };
        const redo = () => { if (redoStack.length > 0) { const nextState = redoStack.pop(); historyStack.push(nextState); restoreState(nextState); updateUndoRedoButtons(); } };
        const updateUndoRedoButtons = () => { undoButton.disabled = historyStack.length <= 1; redoButton.disabled = redoStack.length === 0; };
        const handleDragStart = (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') { e.preventDefault(); return; }
            draggedItem = e.target.closest('.studio-block');
            if (!draggedItem) return;
            isDraggingFromPalette = palette.contains(draggedItem);
            e.dataTransfer.setDragImage(emptyImage, 0, 0);
            e.dataTransfer.effectAllowed = "move";
            setTimeout(() => { if (!isDraggingFromPalette) draggedItem.classList.add('dragging'); }, 0);
            contextMenu.style.display = 'none';
        };
        const handleDragEnd = (e) => {
            placeholder.remove();
            if (draggedItem) draggedItem.classList.remove('dragging');
            draggedItem = null;
        };
        const createBlockFromDefinition = (blockDef, color) => {
            const newBlock = document.createElement('div');
            newBlock.className = `studio-block studio-workspace-block ${color}`;
            const datasetDef = { ...blockDef };
            delete datasetDef.text;
            Object.entries(datasetDef).forEach(([key, value]) => { newBlock.dataset[key] = JSON.stringify(value); });
            newBlock.dataset.color = color;
            newBlock.innerHTML = blockDef.text;
            if (blockDef.isContainer) {
                newBlock.classList.add('container-block');
                const header = document.createElement('div');
                header.className = 'block-header';
                header.innerHTML = newBlock.innerHTML;
                newBlock.innerHTML = '';
                const content = document.createElement('div');
                content.className = 'block-content';
                newBlock.appendChild(header);
                newBlock.appendChild(content);
            }
            setupWorkspaceBlockInteractions(newBlock);
            return newBlock;
        };
        const createBlockFromPalette = (paletteBlock) => {
            const blockType = paletteBlock.dataset.type;
            const blockColor = paletteBlock.dataset.color;
            if (blockType.startsWith('myblock_')) {
                const myBlockName = blockType.replace('myblock_', '');
                return createBlockFromDefinition(myBlocks[myBlockName], blockColor);
            } else {
                const category = Object.values(webStudioBlockDefinitions).find(cat => cat.color === blockColor);
                const blockDef = category?.blocks.find(b => b.type === blockType);
                if (!blockDef) return null;
                return createBlockFromDefinition(blockDef, blockColor);
            }
        };
        const setupWorkspaceBlockInteractions = (blockEl) => {
            blockEl.setAttribute('draggable', true);
            blockEl.addEventListener('dragstart', handleDragStart);
            blockEl.addEventListener('contextmenu', e => {
                e.preventDefault();
                e.stopPropagation();
                contextTarget = blockEl;
                const wrapperRect = query('#studio-workspace-wrapper').getBoundingClientRect();
                const x = e.clientX - wrapperRect.left;
                const y = e.clientY - wrapperRect.top;
                showStudioContextMenu(x, y);
            });
            blockEl.querySelectorAll('input, select, textarea').forEach(input => {
                input.addEventListener('change', updateAllAndSaveState);
                input.addEventListener('keyup', e => { if (e.key === 'Enter' && input.tagName !== 'TEXTAREA') e.preventDefault(); updateAll(); });
                input.addEventListener('input', e => { updateAll(); if (e.target.classList.contains('variable-input-target')) showVariableSuggestions(e.target); });
                input.addEventListener('blur', e => { saveState(); if (e.target.classList.contains('variable-input-target')) setTimeout(hideVariableSuggestions, 150); });
                if (input.classList.contains('variable-input-target') || input.classList.contains('variable-creation-input')) {
                    input.addEventListener('focus', e => showVariableSuggestions(e.target));
                }
            });
            const type = JSON.parse(blockEl.dataset.type || '""');
            if (type === 'text-join') {
                const controls = blockEl.querySelector('.join-controls');
                if (controls && !controls.dataset.listenerAttached) {
                    controls.addEventListener('click', e => {
                        e.stopPropagation();
                        const action = e.target.closest('button')?.dataset.action;
                        const container = blockEl.querySelector('.join-items-container');
                        if (action === 'add') {
                            const itemCount = container.querySelectorAll('.join-item').length;
                            const newItem = document.createElement('span');
                            newItem.className = 'join-item';
                            newItem.innerHTML = ` [<input type="text" data-prop="val${itemCount}" class="variable-input-target">]`;
                            container.appendChild(newItem);
                            setupWorkspaceBlockInteractions(newItem);
                        } else if (action === 'remove' && container.children.length > 1) {
                            container.lastElementChild.remove();
                        }
                        updateAllAndSaveState();
                    });
                    controls.dataset.listenerAttached = 'true';
                }
            }
        };
        const updateAll = () => { updateElementIds(); updateDeclaredVariables(); styleVariableInputs(); };
        const updateAllAndSaveState = () => { updateAll(); saveState(); };
        const updateElementIds = () => {
            const ids = { buttons: [], texts: [], dropdowns: [], all: [] };
            workspace.querySelectorAll('.workspace-block [data-prop="id"]').forEach(input => {
                const id = input.value.trim();
                if (!id) return;
                const block = input.closest('.workspace-block');
                if (!block) return;
                const idType = JSON.parse(block.dataset.idType || 'null');
                if (!ids.all.includes(id)) ids.all.push(id);
                if (idType === 'button') ids.buttons.push(id);
                if (idType === 'text') ids.texts.push(id);
                if (idType === 'dropdown') ids.dropdowns.push(id);
            });
            workspace.querySelectorAll('select.id-select').forEach(select => {
                const currentVal = select.value;
                const filter = select.dataset.idFilter;
                const idList = (filter === 'all' || !filter) ? ids.all : [...new Set(ids[filter + 's'] || [])];
                select.innerHTML = '<option value="">ID</option>' + idList.map(id => `<option value="${id}" ${id === currentVal ? 'selected' : ''}>${id}</option>`).join('');
            });
        };
        const updateDeclaredVariables = () => {
            const newVars = new Set();
            workspace.querySelectorAll('.workspace-block').forEach(block => {
                const type = JSON.parse(block.dataset.type || '""');
                if (type === 'variable-declare' || type === 'array-create') {
                    const name = block.querySelector('[data-prop="name"]')?.value.trim(); if (name) newVars.add(name);
                } else if (type === 'array-loop') {
                    const name = block.querySelector('[data-prop="itemVar"]')?.value.trim(); if (name) newVars.add(name);
                }
            });
            declaredVariables = newVars;
            workspace.querySelectorAll('select.variable-select').forEach(select => {
                const currentVal = select.value;
                select.innerHTML = '<option value=""></option>' + [...declaredVariables].map(v => `<option value="${v}" ${v === currentVal ? 'selected' : ''}>${v}</option>`).join('');
            });
        };
        const renderPalette = () => {
            paletteContent.innerHTML = '';
            const allCategories = { ...webStudioBlockDefinitions };
            allCategories.myblock.blocks = Object.entries(myBlocks).map(([name, def]) => ({ type: `myblock_${name}`, text: `<i class="fa-solid fa-star"></i> ${name}` }));
            Object.values(allCategories).forEach(category => {
                const categoryTitle = document.createElement('h3');
                categoryTitle.className = `category-title cat-${category.color}`;
                categoryTitle.textContent = category.title;
                paletteContent.appendChild(categoryTitle);
                const contentDiv = document.createElement('div');
                paletteContent.appendChild(contentDiv);
                category.blocks.forEach(blockDef => {
                    const block = document.createElement('div');
                    block.className = `studio-block ${category.color}`;
                    block.setAttribute('draggable', true);
                    block.dataset.type = blockDef.type;
                    block.dataset.color = category.color;
                    block.innerHTML = blockDef.text;
                    block.addEventListener('dragstart', handleDragStart);
                    contentDiv.appendChild(block);
                });
            });
        };
        const stopPreview = () => {
            previewContainer.innerHTML = '<iframe id="studio-preview-iframe"></iframe>';
            previewFrame = query('#studio-preview-iframe');
            isExecuting = false;
            runStopButton.innerHTML = '<i class="fa-solid fa-play"></i> ';
            runStopButton.classList.remove('bg-red-500', 'hover:bg-red-600');
            runStopButton.classList.add('bg-green-500', 'hover:bg-green-600');
        };
        const generateAndPreview = () => {
            stopPreview();
            isExecuting = true;
            runStopButton.innerHTML = '<i class="fa-solid fa-stop"></i> ';
            runStopButton.classList.remove('bg-green-500', 'hover:bg-green-600');
            runStopButton.classList.add('bg-red-500', 'hover:bg-red-600');
            previewFrame.style.opacity = 0;
            setTimeout(() => {
                updateAll();
                const htmlContainer = workspace.querySelector('[data-type*="html-container"] .block-content');
                const cssContainer = workspace.querySelector('[data-type*="css-container"] .block-content');
                const jsContainer = workspace.querySelector('[data-type*="js-container"] .block-content');
                const html = htmlContainer ? Array.from(htmlContainer.children).map(b => generateCode(b, 'html')).join('\n') : '';
                const css = cssContainer ? Array.from(cssContainer.children).map(b => generateCode(b, 'css')).join('\n') : '';
                const js = jsContainer ? Array.from(jsContainer.children).map(b => generateCode(b, 'js')).join('\n') : '';
                updatePreview(html, css, js);
            }, 100);
        };
        const getBlockProps = (block) => {
            const props = {};
            if (!block.dataset.uniqueId) {
                block.dataset.uniqueId = `block_${Math.random().toString(36).substr(2, 9)}`;
            }
            props.id = block.dataset.uniqueId;
            const inputs = block.querySelectorAll(':scope > [data-prop], :scope > .block-header [data-prop]');
            inputs.forEach(el => {
                if (el.dataset.prop !== 'id') {
                    props[el.dataset.prop] = el.type === 'checkbox' ? el.checked : el.value;
                } else {
                    props.elementId = el.value;
                }
            });
            if (props.elementId) {
                props.id = props.elementId;
            }
            return props;
        };
        const formatJsValue = (value) => {
            if (typeof value !== 'string') return String(value);
            if (declaredVariables.has(value)) {
                return `V['${value}']`;
            }
            if (value.trim() !== '' && !isNaN(value) && !/^\s/.test(value) && !/\s$/.test(value)) {
                return value;
            }
            return JSON.stringify(value);
        };
        const generateCode = (block, context) => {
            if (!block || !block.classList.contains('workspace-block') || block.classList.contains('commented')) return '';
            const type = JSON.parse(block.dataset.type || '""');
            const props = getBlockProps(block);
            const generateInnerCode = (b, innerContext, contentIndex = 0) => {
                const contentAreas = b.querySelectorAll(':scope > .block-content');
                if (!contentAreas[contentIndex]) return '';
                return Array.from(contentAreas[contentIndex].children).map(child => generateCode(child, innerContext)).join('\n');
            };
            const idAttr = props.id ? `id="${props.id}"` : '';
            switch (context) {
                case 'html':
                    switch (type) {
                        case 'html-container': return generateInnerCode(block, 'html');
                        case 'div-container': return `<div ${idAttr}>${generateInnerCode(block, 'html')}</div>`;
                        case 'text-element': return `<${props.tag} ${idAttr}>${props.text || ''}</${props.tag}>`;
                        case 'image': return `<img ${idAttr} src="${props.src || ''}" alt="${props.alt || ''}">`;
                        case 'link': return `<a ${idAttr} href="${props.href || '#'}">${props.text || ''}</a>`;
                        case 'text-input': return `<input type="text" ${idAttr} value="${props.value || ''}">`;
                        case 'button': return `<button ${idAttr}>${props.text || ''}</button>`;
                        case 'dropdown': return `<select ${idAttr}></select>`;
                        case 'br': return '<br>';
                        case 'hr': return '<hr>';
                        case 'list-container': return `<${props.tag} ${idAttr}>${generateInnerCode(block, 'html')}</${props.tag}>`;
                        case 'list-item': return `<li id="${props.id || ''}">${props.text || ''}</li>`;
                        case 'table-container': return `<table ${idAttr}>${generateInnerCode(block, 'html')}</table>`;
                        case 'table-row': return `<tr>${generateInnerCode(block, 'html')}</tr>`;
                        case 'table-cell': return `<td id="${props.id || ''}">${props.text || ''}</td>`;
                        case 'form-container': return `<form ${idAttr}>${generateInnerCode(block, 'html')}</form>`;
                        case 'textarea-input': return `<textarea ${idAttr}>${props.value || ''}</textarea>`;
                        case 'shape': return `<div ${idAttr} class="shape shape-${props.type}"></div>`;
                        case 'video': return `<video ${idAttr} src="${props.src || ''}" controls></video>`;
                        case 'audio': return `<audio ${idAttr} src="${props.src || ''}" controls></audio>`;
                        case 'canvas': return `<canvas ${idAttr} width="${props.width}" height="${props.height}"></canvas>`;
                        default: return '';
                    }
                case 'css':
                    let css = '';
                    if (type === 'css-container') return generateInnerCode(block, 'css');
                    if (type === 'set-body-background-color') return `body { background-color: ${props.color}; }`;
                    if (type === 'flex-container') {
                        return `#${props.id} { display: flex; ${generateInnerCode(block, 'css')} }`;
                    }
                    if (type === 'media-query') {
                        return `@media (max-width: ${props.width || 768}px) { ${generateInnerCode(block, 'css')} }`;
                    }
                    if (!props.id && !block.closest('[data-type*="flex-container"]')) return '';
                    switch (type) {
                        case 'background-color': css += `background-color: ${props.color};`; break;
                        case 'color': css += `color: ${props.color};`; break;
                        case 'font-size': css += `font-size: ${props.size}px;`; break;
                        case 'font-family': css += `font-family: ${props.family};`; break;
                        case 'size': css += `width: ${props.width}px; height: ${props.height}px;`; break;
                        case 'opacity': css += `opacity: ${props.value / 100};`; break;
                        case 'border-radius': css += `border-radius: ${props.radius}px;`; break;
                        case 'border': css += `border: ${props.width}px ${props.style} ${props.color};`; break;
                        case 'border-color': css += `border-color: ${props.color};`; break;
                        case 'border-width': css += `border-width: ${props.width}px;`; break;
                        case 'text-align': css += `text-align: ${props.align};`; break;
                        case 'box-shadow': css += `box-shadow: ${props.x}px ${props.y}px ${props.blur}px ${props.color};`; break;
                        case 'cursor': css += `cursor: ${props.cursor};`; break;
                        case 'element-position': css += 'display: block;'; if (props.position === 'center') css += 'margin-left: auto; margin-right: auto;'; else if (props.position === 'right') css += 'margin-left: auto; margin-right: 0;'; else css += 'margin-left: 0; margin-right: auto;'; break;
                        case 'set-x-css': css += `position: relative; left: ${props.value}px;`; break;
                        case 'set-y-css': css += `position: relative; top: ${props.value}px;`; break;
                        case 'transition': css += `transition: all ${props.duration}s ease;`; break;
                        case 'flex-direction': return `flex-direction: ${props.direction};`;
                        case 'flex-justify-content': return `justify-content: ${props.justify};`;
                        case 'flex-align-items': return `align-items: ${props.align};`;
                        default: return '';
                    }
                    return props.id ? `#${props.id} { ${css} }` : '';
                case 'js':
                    if (type === 'js-container') return generateInnerCode(block, 'js');
                    const elExists = (id) => `const el = document.getElementById(${formatJsValue(id)}); if(el){\n`;
                    const elEnd = `\n}`;
                    switch (type) {
                        case 'variable-declare': return '';
                        case 'array-create': return `${formatJsValue(props.name)} = [];`;
                        case 'variable-set': return `${formatJsValue(props.name)} = ${formatJsValue(props.value)};`;
                        case 'variable-value': return `${formatJsValue(props.dest)} = ${formatJsValue(props.source)};`;
                        case 'variable-change': return `${formatJsValue(props.name)} = (Number(${formatJsValue(props.name)}) || 0) + (${formatJsValue(props.value)});`;
                        case 'operator': return `${formatJsValue(props.var)} = Number(${formatJsValue(props.val1)}) ${props.op} Number(${formatJsValue(props.val2)});`;
                        case 'text-join': const values = Object.keys(props).filter(k => k.startsWith('val')).sort((a, b) => parseInt(a.slice(3)) - parseInt(b.slice(3))).map(k => `String(${formatJsValue(props[k])})`).join(' + '); return `${formatJsValue(props.var)} = ${values || '""'};`;
                        case 'get-element-value': return `${elExists(props.id)}${formatJsValue(props.var)} = ('value' in el) ? el.value : el.textContent;${elEnd}`;
                        case 'get-random-number': return `${formatJsValue(props.var)} = Math.floor(Math.random() * (Number(${formatJsValue(props.max)}) - Number(${formatJsValue(props.min)}) + 1)) + Number(${formatJsValue(props.min)});`;
                        case 'get-time': if (props.unit === 'getMonth') return `${formatJsValue(props.var)} = (new Date()).getMonth() + 1;`; return `${formatJsValue(props.var)} = (new Date()).${props.unit}();`;
                        case 'local-storage-load': return `${formatJsValue(props.var)} = localStorage.getItem(${formatJsValue(props.key)});`;
                        case 'array-add': return `${formatJsValue(props.name)}.push(${formatJsValue(props.value)});`;
                        case 'array-get': return `${formatJsValue(props.var)} = ${formatJsValue(props.name)}[${formatJsValue(props.index)}];`;
                        case 'array-set': return `${formatJsValue(props.name)}[${formatJsValue(props.index)}] = ${formatJsValue(props.value)};`;
                        case 'array-loop': return `for (const ${props.itemVar} of ${formatJsValue(props.name)} || []) { await (async () => {\n${generateInnerCode(block, 'js')}\n})(); }`;
                        case 'fetch-api': return `${formatJsValue(props.var)} = await (await fetch(${formatJsValue(props.url)})).json();`;
                        case 'switch-case': return `switch(${formatJsValue(props.var)}) { ${generateInnerCode(block, 'js')} }`;
                        case 'case-block': return `case ${formatJsValue(props.value)}:\n${generateInnerCode(block, 'js')}\nbreak;`;
                        case 'set-element-text': return `${elExists(props.id)}el.textContent = ${formatJsValue(props.text)};${elEnd}`;
                        case 'if-condition': const ifContent = generateInnerCode(block, 'js', 0); const elseContent = JSON.parse(block.dataset.hasElse) ? `} else {\n${generateInnerCode(block, 'js', 1)}\n}` : '}'; return `if (${formatJsValue(props.val1)} ${props.op} ${formatJsValue(props.val2)}) {\n${ifContent}\n${elseContent}`;
                        case 'onclick': return `${elExists(props.id)}el.addEventListener('click', async () => {\n${generateInnerCode(block, 'js')}\n});${elEnd}`;
                        case 'on-key-press': return `document.addEventListener('keydown', async (e) => { if(e.key === ${formatJsValue(props.key)}) { \n${generateInnerCode(block, 'js')}\n } });`;
                        case 'loop-forever': const loopId = props.id.replace(/-/g, '_'); return `let isLoopRunning_${loopId} = false; setInterval(async () => { if (isLoopRunning_${loopId}) return; isLoopRunning_${loopId} = true; try { ${generateInnerCode(block, 'js')} } catch(e) { console.error(e); } finally { isLoopRunning_${loopId} = false; } }, ${formatJsValue(props.interval)});`;
                        case 'loop-times': return `for (let i = 0; i < ${formatJsValue(props.times)}; i++) { await (async () => {\n${generateInnerCode(block, 'js')}\n})(); }`;
                        case 'dropdown-add-item': return `${elExists(props.id)}el.add(new Option(${formatJsValue(props.text)}, ${formatJsValue(props.value)}));${elEnd}`;
                        case 'set-style-js': let styleValue = formatJsValue(props.value); if (props.prop === 'transform') styleValue = `'rotate(' + ${styleValue} + 'deg)'`; else if (['width', 'height'].includes(props.prop)) styleValue = `${styleValue} + 'px'`; return `${elExists(props.id)}el.style.${props.prop} = ${styleValue};${elEnd}`;
                        case 'show-element': return `${elExists(props.id)}el.style.display = '';${elEnd}`;
                        case 'hide-element': return `${elExists(props.id)}el.style.display = 'none';${elEnd}`;
                        case 'change-x-js': return `${elExists(props.id)}if(window.getComputedStyle(el).position === 'static') el.style.position = 'relative'; el.style.left = (parseInt(el.style.left,10)||0) + Number(${formatJsValue(props.value)}) + 'px';${elEnd}`;
                        case 'change-y-js': return `${elExists(props.id)}if(window.getComputedStyle(el).position === 'static') el.style.position = 'relative'; el.style.top = (parseInt(el.style.top,10)||0) + Number(${formatJsValue(props.value)}) + 'px';${elEnd}`;
                        case 'wait-seconds': return `await new Promise(resolve => setTimeout(resolve, Number(${formatJsValue(props.seconds)}) * 1000));`;
                        case 'alert': return `alert(${formatJsValue(props.message)});`;
                        case 'go-to-url': return `window.location.href = ${formatJsValue(props.url)};`;
                        case 'local-storage-save': return `localStorage.setItem(${formatJsValue(props.key)}, ${formatJsValue(props.value)});`;
                        default: return '';
                    }
                default: return '';
            }
        };
        const updatePreview = (html, css, js) => {
            const initialDisplayJs = Array.from(workspace.querySelectorAll('.workspace-block:not(.commented)'))
                .map(block => {
                    const type = JSON.parse(block.dataset.type || '""');
                    const props = getBlockProps(block);
                    if (!props.id) return '';
                    if (['text-element', 'link', 'button', 'list-item', 'table-cell'].includes(type) && props.text) {
                        return `try { const el = document.getElementById('${props.id}'); if (el) el.textContent = ${formatJsValue(props.text)}; } catch(e) {}`;
                    }
                    if (['text-input', 'textarea-input'].includes(type) && props.value) {
                        return `try { const el = document.getElementById('${props.id}'); if (el) el.value = ${formatJsValue(props.value)}; } catch(e) {}`;
                    }
                    return '';
                })
                .filter(line => line).join('\n');
            const previewContent = `<!DOCTYPE html><html><head><style>
            body { font-family: sans-serif; padding: 15px; margin: 0; }
            .shape { width: 100px; height: 100px; display: inline-block; } .shape-rect { background-color: #888; }
            .shape-circle { background-color: #888; border-radius: 50%; }
            .shape-triangle { width: 0; height: 0; background-color: transparent; border-left: 50px solid transparent; border-right: 50px solid transparent; border-bottom: 100px solid #888; }
            ${css}
        </style></head><body>${html}
        <script>
            window.onerror = (m,s,l,c,e) => { window.parent.postMessage({type:'preview_error', message:m, stack:e?.stack}, '*') };
            document.addEventListener('DOMContentLoaded', async () => {
                try {
                    const V = {};
                    ${initialDisplayJs}
                    ${js}
                } catch (e) {
                    window.onerror(e.message, '', '', '', e);
                }
            });
        <\/script></body></html>`;
            previewFrame.srcdoc = previewContent;
            previewFrame.onload = () => { previewFrame.style.opacity = 1; };
            if (htmlDisplayArea.classList.contains('visible')) {
                htmlDisplayArea.querySelector('pre').textContent = formatHtml(previewContent);
            }
        };
        const showStudioContextMenu = (x, y) => {
            contextMenu.innerHTML = `
    <button data-action="duplicate"><i class="fa-solid fa-copy"></i> </button>
    <button data-action="comment"><i class="fa-solid fa-comment-slash"></i> </button>
    <button data-action="delete"><i class="fa-solid fa-trash"></i> </button>
`;
            const commented = contextTarget.classList.contains('commented');
            contextMenu.querySelector('[data-action="comment"]').innerHTML = commented
                ? '<i class="fa-solid fa-comment"></i> '
                : '<i class="fa-solid fa-comment-slash"></i> ';
            contextMenu.style.display = 'block';
            const wrapper = query('#studio-workspace-wrapper');
            const finalX = x + wrapper.scrollLeft;
            const finalY = y + wrapper.scrollTop;
            contextMenu.style.left = `${finalX}px`;
            contextMenu.style.top = `${finalY}px`;
            document.addEventListener('click', hideStudioContextMenu, { once: true });
        };
        const hideStudioContextMenu = () => {
            contextMenu.style.display = 'none';
        };
        contextMenu.addEventListener('click', e => {
            const action = e.target.closest('button')?.dataset.action;
            if (!action || !contextTarget) return;
            if (action === 'duplicate') {
                const clone = contextTarget.cloneNode(true);
                setupWorkspaceBlockInteractions(clone);
                contextTarget.after(clone);
            } else if (action === 'comment') {
                contextTarget.classList.toggle('commented');
            } else if (action === 'delete') {
                contextTarget.remove();
                checkWorkspaceEmpty();
            }
            updateAllAndSaveState();
            hideStudioContextMenu();
        });
        const initialize = () => {
            renderPalette();
            saveButton.onclick = async () => {
                const target = await showFilePicker({ mode: 'save', title: '', defaultName: 'web-project.rstudio' });
                if (target) {
                    const data = JSON.stringify({ workspace: workspace.innerHTML, myBlocks });
                    const blob = new Blob([data], { type: 'application/json' });
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        await VFS.writeFile(target.path.substring(0, target.path.lastIndexOf('/')) || '/', target.name, 'application/rstudio-project', e.target.result);
                        createNotification('', `${target.name}`, 'info');
                    };
                    reader.readAsDataURL(blob);
                }
            };
            loadButton.onclick = async () => {
                const path = await showFilePicker({ mode: 'open', title: '', acceptTypes: ['application/rstudio-project'] });
                if (path) {
                    const fileData = await readFileWithWorker(path);
                    const res = await fetch(fileData.content);
                    const text = await res.text();
                    const data = JSON.parse(text);
                    if (data.workspace) {
                        myBlocks = data.myBlocks || {};
                        localStorage.setItem('myBlocks', JSON.stringify(myBlocks));
                        renderPalette();
                        restoreState(data.workspace, true);
                    }
                }
            };
            workspace.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (!draggedItem) return;
                const targetElement = e.target;
                const dropZone = targetElement.closest('.block-content, #studio-workspace');
                if (!dropZone) {
                    placeholder.remove();
                    return;
                }
                if (dropZone.classList.contains('block-content')) {
                    const containerBlock = dropZone.closest('.container-block');
                    if (containerBlock && containerBlock.contains(draggedItem)) {
                        return;
                    }
                }
                const afterElement = Array.from(dropZone.children).find(child => {
                    if (child === placeholder || child === draggedItem) return false;
                    const rect = child.getBoundingClientRect();
                    return e.clientY < rect.top + rect.height / 2;
                });
                dropZone.insertBefore(placeholder, afterElement || null);
            });
            workspace.addEventListener('drop', (e) => {
                e.preventDefault();
                if (!placeholder.parentElement) return;
                const blockToInsert = isDraggingFromPalette ? createBlockFromPalette(draggedItem) : draggedItem;
                placeholder.parentElement.insertBefore(blockToInsert, placeholder);
                placeholder.remove();
                if (workspace.querySelector('p')) workspace.querySelector('p').remove();
                saveState();
            });
            document.addEventListener('dragend', handleDragEnd);
            runStopButton.addEventListener('click', () => isExecuting ? stopPreview() : generateAndPreview());
            undoButton.addEventListener('click', undo);
            redoButton.addEventListener('click', redo);
            toggleHtmlDisplayButton.addEventListener('click', () => {
                htmlDisplayArea.classList.toggle('visible');
                toggleHtmlDisplayButton.textContent = htmlDisplayArea.classList.contains('visible') ? 'HTML' : 'HTML';
                if (htmlDisplayArea.classList.contains('visible')) {
                    const htmlContainer = workspace.querySelector('[data-type*="html-container"] .block-content');
                    const cssContainer = workspace.querySelector('[data-type*="css-container"] .block-content');
                    const jsContainer = workspace.querySelector('[data-type*="js-container"] .block-content');
                    const html = htmlContainer ? Array.from(htmlContainer.children).map(b => generateCode(b, 'html')).join('\n') : '';
                    const css = cssContainer ? Array.from(cssContainer.children).map(b => generateCode(b, 'css')).join('\n') : '';
                    const js = jsContainer ? Array.from(jsContainer.children).map(b => generateCode(b, 'js')).join('\n') : '';
                    const previewContent = `<!DOCTYPE html><html><head><style>
body { font-family: sans-serif; padding: 15px; margin: 0; }
.shape { width: 100px; height: 100px; display: inline-block; } .shape-rect { background-color: #888; }
.shape-circle { background-color: #888; border-radius: 50%; }
.shape-triangle { width: 0; height: 0; background-color: transparent; border-left: 50px solid transparent; border-right: 50px solid transparent; border-bottom: 100px solid #888; }
${css}
</style></head><body>${html}
<script>
window.onerror = (m,s,l,c,e) => { window.parent.postMessage({type:'preview_error', message:m, stack:e?.stack}, '*') };
document.addEventListener('DOMContentLoaded', async () => {
try {
const V = {};
${js}
} catch (e) {
window.onerror(e.message, '', '', '', e);
}
});
<\/script></body></html>`;
htmlDisplayArea.querySelector('pre').textContent = formatHtml(previewContent);
}
});
saveState();
updateUndoRedoButtons();
checkWorkspaceEmpty();
};
runStopButton.addEventListener('click', () => {
if (isExecuting) {
stopPreview();
} else {
generateAndPreview();
}
});
toggleHtmlDisplayButton.addEventListener('click', () => {
htmlDisplayArea.classList.toggle('visible');
const isVisible = htmlDisplayArea.classList.contains('visible');
toggleHtmlDisplayButton.textContent = isVisible ? 'HTML' : 'HTML';
if (isVisible) {
updateAll();
const htmlContainer = workspace.querySelector('[data-type*="html-container"] .block-content');
const cssContainer = workspace.querySelector('[data-type*="css-container"] .block-content');
const jsContainer = workspace.querySelector('[data-type*="js-container"] .block-content');
const html = htmlContainer ? Array.from(htmlContainer.children).map(b => generateCode(b, 'html')).join('\n') : '';
const css = cssContainer ? Array.from(cssContainer.children).map(b => generateCode(b, 'css')).join('\n') : '';
const js = jsContainer ? Array.from(jsContainer.children).map(b => generateCode(b, 'js')).join('\n') : '';
const previewContent = `<!DOCTYPE html><html><head><style>
body { font-family: sans-serif; padding: 15px; margin: 0; }
.shape { width: 100px; height: 100px; display: inline-block; } .shape-rect { background-color: #888; }
.shape-circle { background-color: #888; border-radius: 50%; }
.shape-triangle { width: 0; height: 0; background-color: transparent; border-left: 50px solid transparent; border-right: 50px solid transparent; border-bottom: 100px solid #888; }
${css}
</style></head><body>${html}
<script>
window.onerror = (m,s,l,c,e) => { window.parent.postMessage({type:'preview_error', message:m, stack:e?.stack}, '*') };
document.addEventListener('DOMContentLoaded', async () => {
try {
const V = {};
${js}
} catch (e) {
window.onerror(e.message, '', '', '', e);
}
});
<\/script></body></html>`;
htmlDisplayArea.querySelector('pre').textContent = formatHtml(previewContent);
}
});
const formatHtml = (html) => {
let indent = 0; let formatted = '';
html.split(/(?=<)/).forEach(line => {
if (line.match(/^<\//)) indent = Math.max(0, indent - 1);
const trimmedLine = line.trim();
if (trimmedLine) formatted += ' '.repeat(indent) + trimmedLine + '\n';
if (trimmedLine.match(/^<[^\/][^>]*[^\/]>$/) && !['<br>', '<hr>', '<img>', '<input>'].some(tag => trimmedLine.startsWith(tag))) indent++;
});
return formatted.trim();
};
initialize();
}, 100);
}
},
{
    id: 'video-editor',
    name: '',
    icon: 'fas fa-film',
    installed: true,
launcher: (params = {}) => {
    const windowId = `app-window-video-editor-${Date.now()}`;
    const content = `
<style>
    #video-editor-container { display: grid; grid-template-rows: auto 1fr; height: 100%; background-color: var(--window-bg-dark); color: var(--text-color-dark); }
    #editor-main-area { display: grid; grid-template-columns: 25% 1fr; grid-template-rows: 60% 1fr; overflow: hidden; }
    #editor-assets-panel { grid-column: 1 / 2; grid-row: 1 / 2; }
    #editor-properties-panel { grid-column: 1 / 2; grid-row: 2 / 2; }
    #editor-preview-area { grid-column: 2 / 3; grid-row: 1 / 2; }
    #editor-timeline-area { grid-column: 2 / 3; grid-row: 2 / 2; }
    .editor-panel { display: flex; flex-direction: column; border: 1px solid var(--border-color-dark); overflow: hidden; }
    .panel-header { padding: 8px; font-weight: 600; background-color: var(--header-bg-dark); border-bottom: 1px solid var(--border-color-dark); flex-shrink: 0; display: flex; align-items: center; gap: 8px; }
    .panel-content { padding: 8px; flex-grow: 1; overflow-y: auto; }
    #timeline-tracks { display: flex; flex-direction: column; gap: 4px; padding: 8px; background-color: #2c2d30; min-height: 100%; position: relative; }
    #timeline-playhead { position: absolute; top: 0; bottom: 0; left: 0; width: 2px; background-color: red; z-index: 20; pointer-events: none; will-change: transform; }
    .timeline-track { display: flex; align-items: stretch; background-color: var(--sidebar-bg-dark); border-radius: 4px; min-height: 50px; }
    .track-header { width: 150px; padding: 8px; flex-shrink: 0; display: flex; align-items: center; gap: 8px; border-right: 1px solid var(--border-color-dark); font-size: 0.9em; }
    .track-content { flex-grow: 1; position: relative; border-left: 1px solid var(--border-color-dark); }
    #timeline-drop-zone.drag-over { border: 2px dashed #007bff; background-color: rgba(0, 123, 255, 0.1); }
    .asset-item { padding: 4px; border-radius: 4px; cursor: grab; display: flex; align-items: center; gap: 8px; }
    .asset-item:hover { background-color: rgba(255,255,255,0.1); }
    .asset-item.dragging { opacity: 0.5; }
    .timeline-clip { position: absolute; height: 40px; background-color: #007bff; border-radius: 4px; padding: 4px 8px; color: white; cursor: grab; user-select: none; display: flex; align-items: center; border-left: 3px solid #66b0ff; box-shadow: 0 2px 4px rgba(0,0,0,0.3); overflow: hidden; will-change: transform, width; }
    .timeline-clip.selected { box-shadow: 0 0 0 2px #66b0ff; }
    .timeline-clip:active { cursor: grabbing; z-index: 10; }
    .timeline-clip span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block; width: 100%; }
    #preview-interaction-overlay { position: absolute; inset: 0; pointer-events: none; }
    .preview-object { position: absolute; pointer-events: auto; cursor: move; will-change: transform, opacity; }
    .selection-box { position: absolute; border: 2px solid #007bff; pointer-events: auto; cursor: move; }
    .resize-handle { position: absolute; width: 10px; height: 10px; background-color: #007bff; border: 1px solid white; z-index: 1; }
    .resize-handle.nw { top: -5px; left: -5px; cursor: nwse-resize; }
    .resize-handle.ne { top: -5px; right: -5px; cursor: nesw-resize; }
    .resize-handle.sw { bottom: -5px; left: -5px; cursor: nesw-resize; }
    .resize-handle.se { bottom: -5px; right: -5px; cursor: nwse-resize; }
    .property-input { background-color: var(--input-bg-dark); color: var(--text-color-dark); border: 1px solid var(--input-border-dark); border-radius: 4px; padding: 2px 4px; width: 100%; }
</style>
<div id="video-editor-container">
    <div id="editor-toolbar" class="panel-header" style="flex-direction: row; gap: 10px;">
        <button id="proj-open-btn" title=""><i class="fas fa-folder-open"></i></button>
        <button id="proj-save-btn" title=""><i class="fas fa-save"></i></button>
        <div class="h-6 border-l mx-2 border-gray-600"></div>
        <button id="clip-cut-btn" title=""><i class="fas fa-cut"></i></button>
        <button id="clip-copy-btn" title=""><i class="fas fa-copy"></i></button>
        <button id="clip-paste-btn" title=""><i class="fas fa-paste"></i></button>
        <button id="clip-merge-btn" title=""><i class="fas fa-link"></i></button>
        <div style="flex-grow: 1;"></div>
        <button id="proj-export-btn" style="background-color: #007bff; padding: 4px 12px; border-radius: 5px;">
            <i class="fas fa-file-export"></i> 
        </button>
    </div>
    <div id="editor-main-area">
        <div id="editor-assets-panel" class="editor-panel">
            <div class="panel-header">
                <button id="add-asset-btn" title=""><i class="fas fa-plus"></i> </button>
            </div>
            <div id="assets-list" class="panel-content">
                <p class="text-xs text-gray-500"></p>
            </div>
        </div>
        <div id="editor-properties-panel" class="editor-panel">
             <div class="panel-header"><span></span></div>
             <div id="properties-content" class="panel-content text-sm">
                <p class="text-xs text-gray-500"></p>
             </div>
        </div>
        <div id="editor-preview-area" class="editor-panel">
            <div class="panel-content" style="padding:0; position:relative; display:flex; align-items:center; justify-content:center; background-color:#000;">
                <video id="preview-video" style="max-width:100%; max-height:100%; position: absolute;"></video>
                <div id="preview-interaction-overlay"></div>
            </div>
            <div class="panel-header" style="display: flex; justify-content: center; align-items: center; gap: 10px;">
                <button id="vid-rewind-btn" title=""><i class="fas fa-fast-backward"></i></button>
                <button id="vid-step-back-btn" title="1"><i class="fas fa-step-backward"></i></button>
                <button id="vid-play-pause-btn" title="/" style="width: 40px; height: 40px; border-radius: 50%;"><i class="fas fa-play"></i></button>
                <button id="vid-step-forward-btn" title="1"><i class="fas fa-step-forward"></i></button>
                <span id="vid-time-display" class="text-sm font-mono">00:00.0 / 00:00.0</span>
                <div style="flex-grow: 1;"></div>
                <button id="vid-fullscreen-btn" title=""><i class="fas fa-expand"></i></button>
            </div>
        </div>
        <div id="editor-timeline-area" class="editor-panel">
            <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                <span></span>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <button id="add-text-btn" class="px-3 py-1 rounded bg-gray-600 hover:bg-gray-500 text-xs"><i class="fas fa-font"></i> </button>
                    <button id="zoom-out-btn" class="p-1 w-7 h-7 rounded hover:bg-white/10"><i class="fas fa-search-minus"></i></button>
                    <span id="zoom-level-display" class="text-sm w-12 text-center">100%</span>
                    <button id="zoom-in-btn" class="p-1 w-7 h-7 rounded hover:bg-white/10"><i class="fas fa-search-plus"></i></button>
                </div>
            </div>
            <div id="timeline-drop-zone" class="panel-content" style="padding: 0; background-color: #2c2d30; overflow: auto;">
                <div id="timeline-tracks">
                    <div id="timeline-playhead"></div>
                    <p id="timeline-placeholder" class="text-center text-gray-500 p-8"></p>
                </div>
            </div>
        </div>
    </div>
</div>
`;
        const editorWindow = createWindow(windowId, ' - ', content, 1000, 700);
        const windowContent = editorWindow.querySelector('.window-content');
        if (windowContent) { windowContent.style.padding = '0'; windowContent.style.overflow = 'hidden'; }
        const assetsList = editorWindow.querySelector('#assets-list');
        const addAssetBtn = editorWindow.querySelector('#add-asset-btn');
        const timelineDropZone = editorWindow.querySelector('#timeline-drop-zone');
        const timelineTracksContainer = editorWindow.querySelector('#timeline-tracks');
        const timelinePlaceholder = editorWindow.querySelector('#timeline-placeholder');
        const addTextBtn = editorWindow.querySelector('#add-text-btn');
        const propertiesContent = editorWindow.querySelector('#properties-content');
        let assets = [];
        let timelineData = { clips: {}, tracks: { video: [], audio: [], text: [] }, totalDuration: 0 };
        let nextClipId = 0;
        let PIXELS_PER_SECOND = 50;
        let draggedAssetId = null;
        let selectedClipId = null;
        let copiedClip = null;
        const audioElements = new Map();
        const zoomInBtn = editorWindow.querySelector('#zoom-in-btn');
        const zoomOutBtn = editorWindow.querySelector('#zoom-out-btn');
        const zoomLevelDisplay = editorWindow.querySelector('#zoom-level-display');
        const cutBtn = editorWindow.querySelector('#clip-cut-btn');
        const copyBtn = editorWindow.querySelector('#clip-copy-btn');
        const pasteBtn = editorWindow.querySelector('#clip-paste-btn');
        const mergeBtn = editorWindow.querySelector('#clip-merge-btn');
        const updateZoom = (newZoomValue) => { PIXELS_PER_SECOND = Math.max(10, Math.min(200, newZoomValue)); zoomLevelDisplay.textContent = `${Math.round(PIXELS_PER_SECOND / 50 * 100)}%`; renderTimeline(); };
        zoomInBtn.addEventListener('click', () => updateZoom(PIXELS_PER_SECOND + 10));
        zoomOutBtn.addEventListener('click', () => updateZoom(PIXELS_PER_SECOND - 10));
        addAssetBtn.addEventListener('click', async () => {
            const filePaths = await showFilePicker({ mode: 'open', title: '', acceptTypes: ['video/mp4', 'video/webm', 'image/jpeg', 'image/png', 'audio/mpeg', 'audio/wav'], multiple: true });
            if (filePaths && filePaths.length > 0) {
                for (const path of filePaths) {
                    const fileData = await readFileWithWorker(path);
                    if (fileData) { assets.push({ id: `asset-${Date.now()}-${Math.random()}`, ...fileData }); }
                }
                renderAssets();
            }
        });
        const renderAssets = () => {
            assetsList.innerHTML = assets.length === 0 ? '<p class="text-xs text-gray-500"></p>' : '';
            assets.forEach(asset => {
                const item = document.createElement('div');
                item.className = 'asset-item';
                item.draggable = true;
                item.dataset.assetId = asset.id;
                let icon = 'fas fa-file';
                if (asset.type.startsWith('video')) icon = 'fas fa-video';
                if (asset.type.startsWith('image')) icon = 'fas fa-image';
                if (asset.type.startsWith('audio')) icon = 'fas fa-music';
                item.innerHTML = `<i class="${icon} w-4 text-center"></i><span class="text-sm truncate">${asset.name}</span>`;
                assetsList.appendChild(item);
            });
        };
        assetsList.addEventListener('dragstart', (e) => { const item = e.target.closest('.asset-item'); if (item) { draggedAssetId = item.dataset.assetId; e.dataTransfer.effectAllowed = 'copy'; setTimeout(() => item.classList.add('dragging'), 0); } });
        assetsList.addEventListener('dragend', (e) => { const item = e.target.closest('.asset-item'); if (item) item.classList.remove('dragging'); draggedAssetId = null; });
        const videoEl = editorWindow.querySelector('#preview-video');
        const playPauseBtn = editorWindow.querySelector('#vid-play-pause-btn');
        const playPauseIcon = playPauseBtn.querySelector('i');
        const rewindBtn = editorWindow.querySelector('#vid-rewind-btn');
        const stepBackBtn = editorWindow.querySelector('#vid-step-back-btn');
        const stepForwardBtn = editorWindow.querySelector('#vid-step-forward-btn');
        const timeDisplay = editorWindow.querySelector('#vid-time-display');
        const timelinePlayhead = editorWindow.querySelector('#timeline-playhead');
        const previewInteractionOverlay = editorWindow.querySelector('#preview-interaction-overlay');
        const fullscreenBtn = editorWindow.querySelector('#vid-fullscreen-btn');
        const previewArea = editorWindow.querySelector('#editor-preview-area');
        const FRAME_RATE = 30;
        let isPlaying = false;
        let currentTime = 0;
        const formatVideoTime = (time) => { if (isNaN(time) || time < 0) return '00:00.0'; const m = Math.floor(time / 60); const s = Math.floor(time % 60); const ms = Math.floor((time * 10) % 10); return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}.${ms}`; };
        const updateTotalDuration = () => { let maxTime = 0; for (const id in timelineData.clips) { maxTime = Math.max(maxTime, timelineData.clips[id].start + timelineData.clips[id].duration); } timelineData.totalDuration = maxTime; };
        const updateTime = () => { timeDisplay.textContent = `${formatVideoTime(currentTime)} / ${formatVideoTime(timelineData.totalDuration)}`; timelinePlayhead.style.transform = `translateX(${currentTime * PIXELS_PER_SECOND}px)`; };
        let animationLoopId = null;
        const play = () => { if (!isPlaying) { isPlaying = true; playPauseIcon.classList.replace('fa-play', 'fa-pause'); lastTime = performance.now(); animationLoopId = requestAnimationFrame(animationLoop); } };
        const pause = () => { if (isPlaying) { isPlaying = false; playPauseIcon.classList.replace('fa-pause', 'fa-play'); cancelAnimationFrame(animationLoopId); Object.values(Object.fromEntries(audioElements)).forEach(audio => audio.pause()); videoEl.pause(); } };
        playPauseBtn.addEventListener('click', () => { if (isPlaying) pause(); else play(); });
        rewindBtn.addEventListener('click', () => { currentTime = 0; updateAnimation(); });
        stepBackBtn.addEventListener('click', () => { currentTime = Math.max(0, currentTime - (1 / FRAME_RATE)); updateAnimation(); });
        stepForwardBtn.addEventListener('click', () => { currentTime = Math.min(timelineData.totalDuration, currentTime + (1 / FRAME_RATE)); updateAnimation(); });
        timelineTracksContainer.addEventListener('click', (e) => { if (e.target.closest('.timeline-clip')) return; const rect = timelineTracksContainer.getBoundingClientRect(); const x = e.clientX - rect.left + timelineTracksContainer.parentElement.scrollLeft; currentTime = x / PIXELS_PER_SECOND; updateAnimation(); });
        fullscreenBtn.addEventListener('click', () => { if (document.fullscreenElement) document.exitFullscreen(); else previewArea.requestFullscreen(); });
        timelineDropZone.addEventListener('dragover', (e) => { e.preventDefault(); timelineDropZone.classList.add('drag-over'); });
        timelineDropZone.addEventListener('dragleave', () => timelineDropZone.classList.remove('drag-over'));
        const getMediaDuration = (src) => new Promise(resolve => { if (!src.startsWith('data:video') && !src.startsWith('data:audio')) { resolve(5); return; } const media = document.createElement(src.startsWith('data:video') ? 'video' : 'audio'); media.src = src; media.onloadedmetadata = () => resolve(media.duration); media.onerror = () => resolve(5); });
        const addClipToTimeline = (clipData) => { const id = nextClipId++; timelineData.clips[id] = { id, ...clipData }; let placed = false; for (let i = 0; i < timelineData.tracks[clipData.type].length; i++) { const row = timelineData.tracks[clipData.type][i]; if (row.every(cid => { const c = timelineData.clips[cid]; return (clipData.start + clipData.duration <= c.start) || (clipData.start >= c.start + c.duration); })) { timelineData.clips[id].trackIndex = i; row.push(id); placed = true; break; } } if (!placed) { timelineData.clips[id].trackIndex = timelineData.tracks[clipData.type].length; timelineData.tracks[clipData.type].push([id]); } updateTotalDuration(); renderTimeline(); updateAnimation(); };
        timelineDropZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            timelineDropZone.classList.remove('drag-over');
            if (!draggedAssetId) return;
            const asset = assets.find(a => a.id === draggedAssetId);
            if (!asset) return;
            const rect = timelineTracksContainer.getBoundingClientRect();
            const x = e.clientX - rect.left + timelineTracksContainer.parentElement.scrollLeft;
            const start = Math.max(0, x / PIXELS_PER_SECOND);
            const duration = await getMediaDuration(asset.content);
            if (asset.type.startsWith('video') || asset.type.startsWith('image')) {
                addClipToTimeline({ assetId: asset.id, type: 'video', start, duration, transform: { x: 0.5, y: 0.5, scale: 1, rotation: 0 } });
                const video = document.createElement('video'); video.src = asset.content;
                video.onloadedmetadata = () => { if (video.mozHasAudio || video.webkitAudioDecodedByteCount > 0 || video.audioTracks?.length > 0) { addClipToTimeline({ assetId: asset.id, type: 'audio', start, duration, transform: {} }); } };
            } else if (asset.type.startsWith('audio')) {
                addClipToTimeline({ assetId: asset.id, type: 'audio', start, duration, transform: {} });
            }
        });
        addTextBtn.addEventListener('click', () => addClipToTimeline({ assetId: null, type: 'text', start: currentTime, duration: 5, text: '', fontSize: 48, color: '#FFFFFF', fontFamily: 'sans-serif', strokeColor: '#000000', strokeWidth: 2, inAnimation: 'fadeIn', outAnimation: 'fadeOut', transform: { x: 0.5, y: 0.5, scale: 1, rotation: 0 } }));
        const renderTimeline = () => {
            requestAnimationFrame(() => {
                timelineTracksContainer.innerHTML = `<div id="timeline-playhead"></div>`;
                if (Object.keys(timelineData.clips).length === 0) { timelineTracksContainer.appendChild(timelinePlaceholder); return; }
                Object.entries(timelineData.tracks).forEach(([type, rows]) => {
                    rows.forEach((ids, index) => {
                        if (ids.length === 0) return;
                        const track = createTrack(type, index);
                        const content = track.querySelector('.track-content');
                        ids.forEach(id => {
                            const clip = timelineData.clips[id];
                            const asset = clip.assetId ? assets.find(a => a.id === clip.assetId) : null;
                            if (clip) {
                                const el = document.createElement('div');
                                el.className = 'timeline-clip';
                                if (clip.id === selectedClipId) el.classList.add('selected');
                                el.dataset.clipId = clip.id;
                                el.style.transform = `translateX(${clip.start * PIXELS_PER_SECOND}px)`;
                                el.style.width = `${clip.duration * PIXELS_PER_SECOND}px`;
                                const span = document.createElement('span');
                                if (clip.type === 'text') { span.textContent = clip.text; el.style.backgroundColor = '#28a745'; }
                                else if (asset) { span.textContent = asset.name; }
                                el.appendChild(span);
                                makeClipDraggable(el);
                                content.appendChild(el);
                            }
                        });
                        timelineTracksContainer.appendChild(track);
                    });
                });
            });
        };
        const createTrack = (type, index) => { const track = document.createElement('div'); track.className = 'timeline-track'; track.dataset.trackType = type; track.dataset.trackIndex = index; let i = 'fas fa-layer-group', n = ''; if (type === 'video') { i = 'fas fa-video'; n = ''; } if (type === 'audio') { i = 'fas fa-music'; n = ''; } if (type === 'text') { i = 'fas fa-font'; n = ''; } track.innerHTML = `<div class="track-header"><i class="${i}"></i><span>${n} ${index + 1}</span></div><div class="track-content"></div>`; return track; };
        const makeClipDraggable = (el) => {
            el.addEventListener('dblclick', async () => { const id = parseInt(el.dataset.clipId); const clip = timelineData.clips[id]; if (clip?.type === 'text') { const newText = await showMessageBox('', '', { showCancel: true, input: { value: clip.text } }); if (typeof newText === 'string') { clip.text = newText; renderTimeline(); renderPropertiesPanel(); updateAnimation(); } } });
            el.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return; e.stopPropagation();
                selectedClipId = parseInt(el.dataset.clipId);
                renderTimeline(); renderPropertiesPanel(); updateAnimation();
                const id = selectedClipId, clip = timelineData.clips[id], startX = e.clientX, initialLeft = parseFloat(el.style.transform.match(/translateX\((.+)px\)/)?.[1] || 0);
                if (!clip) return;
                const onMove = (me) => { const dx = me.clientX - startX; const newLeft = Math.max(0, initialLeft + dx); el.style.transform = `translateX(${newLeft}px)`; clip.start = newLeft / PIXELS_PER_SECOND; updateAnimation(); };
                const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); updateTotalDuration(); renderTimeline(); };
                document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp);
            });
        };
        let lastTime = 0;
        const animationLoop = (timestamp) => {
            if (!isPlaying) return;
            const delta = (timestamp - lastTime) / 1000;
            lastTime = timestamp;
            currentTime = Math.min(timelineData.totalDuration, currentTime + delta);
            updateAnimation();
            if (currentTime >= timelineData.totalDuration) pause();
            animationLoopId = requestAnimationFrame(animationLoop);
        };
        const updateAnimation = () => {
            if (!document.body.contains(editorWindow)) { cancelAnimationFrame(animationLoopId); return; }
            updateTime();
            previewInteractionOverlay.innerHTML = '';
            const toShow = Object.values(timelineData.clips).filter(c => currentTime >= c.start && currentTime <= (c.start + c.duration));
            const videoToShow = toShow.filter(c => c.type === 'video' || c.type === 'image').sort((a, b) => b.trackIndex - a.trackIndex)[0];
            if (videoToShow) {
                const asset = assets.find(a => a.id === videoToShow.assetId);
                if (asset) {
                    if (asset.type.startsWith('video')) { if (videoEl.src !== asset.content) videoEl.src = asset.content; videoEl.style.display = 'block'; const expectedTime = currentTime - videoToShow.start; if (Math.abs(videoEl.currentTime - expectedTime) > 0.15) videoEl.currentTime = expectedTime; if (isPlaying && videoEl.paused) videoEl.play().catch(()=>{}); else if (!isPlaying && !videoEl.paused) videoEl.pause(); }
                    else if (asset.type.startsWith('image')) { videoEl.src = ''; videoEl.style.display = 'block'; videoEl.poster = asset.content; }
                    const rect = videoEl.getBoundingClientRect();
                    videoEl.style.transform = `translate(${(videoToShow.transform.x - 0.5) * rect.width}px, ${(videoToShow.transform.y - 0.5) * rect.height}px) scale(${videoToShow.transform.scale}) rotate(${videoToShow.transform.rotation}deg)`;
                }
            } else { videoEl.style.display = 'none'; videoEl.pause(); }
            const audioToShow = new Set(toShow.filter(c => c.type === 'audio').map(c => c.id));
            audioToShow.forEach(id => { if (!audioElements.has(id)) { const asset = assets.find(a => a.id === timelineData.clips[id].assetId); if(asset) audioElements.set(id, new Audio(asset.content)); } const audio = audioElements.get(id); if (audio) { const expectedTime = currentTime - timelineData.clips[id].start; if (Math.abs(audio.currentTime - expectedTime) > 0.5) audio.currentTime = expectedTime; if (isPlaying && audio.paused) audio.play().catch(()=>{}); } });
            audioElements.forEach((audio, id) => { if (!audioToShow.has(id) && !audio.paused) { audio.pause(); audio.currentTime = 0; } });
            toShow.filter(c => c.type === 'text').forEach(clip => {
                const el = document.createElement('div');
                el.dataset.clipId = clip.id;
                el.className = 'preview-object';
                el.textContent = clip.text;
                el.style.cssText = `color:${clip.color};font-family:${clip.fontFamily};-webkit-text-stroke:${clip.strokeWidth}px ${clip.strokeColor};font-size:${clip.fontSize * clip.transform.scale}px;`;
                const rect = previewInteractionOverlay.getBoundingClientRect();
                const inDur = 0.5, outDur = 0.5, timeIn = currentTime - clip.start, inProg = Math.min(1, timeIn / inDur), outProg = Math.min(1, Math.max(0, clip.duration - timeIn) / outDur);
                let inStyle = { o: 1, t: '' }, outStyle = { o: 1, t: '' };
                if (clip.inAnimation === 'fadeIn') inStyle.o = inProg; if (clip.inAnimation === 'slideInUp') { inStyle.o = inProg; inStyle.t = `translateY(${(1 - inProg) * 30}px)`; }
                if (clip.outAnimation === 'fadeOut') outStyle.o = outProg; if (clip.outAnimation === 'slideOutDown') { outStyle.o = outProg; outStyle.t = `translateY(${(1 - outProg) * 30}px)`; }
                el.style.opacity = inStyle.o * outStyle.o;
                el.style.transform = `translate(calc(-50% + ${clip.transform.x * rect.width}px), calc(-50% + ${clip.transform.y * rect.height}px)) scale(${clip.transform.scale}) rotate(${clip.transform.rotation}deg) ${inStyle.t} ${outStyle.t}`;
                previewInteractionOverlay.appendChild(el);
            });
            if (selectedClipId !== null && toShow.some(c => c.id === selectedClipId)) {
                const clip = timelineData.clips[selectedClipId];
                let selectedEl = previewInteractionOverlay.querySelector(`[data-clip-id="${selectedClipId}"]`) || ( (clip.type === 'video' || clip.type === 'image') ? videoEl : null );
                if (selectedEl) {
                    const box = document.createElement('div'); box.className = 'selection-box'; const rect = selectedEl.getBoundingClientRect(); const overlayRect = previewInteractionOverlay.getBoundingClientRect();
                    box.style.left = `${rect.left - overlayRect.left}px`; box.style.top = `${rect.top - overlayRect.top}px`; box.style.width = `${rect.width}px`; box.style.height = `${rect.height}px`; box.style.transform = `rotate(${clip.transform.rotation}deg)`;
                    ['nw', 'ne', 'sw', 'se'].forEach(dir => { const h = document.createElement('div'); h.className = `resize-handle ${dir}`; box.appendChild(h); });
                    previewInteractionOverlay.appendChild(box);
                    setupInteraction(box, clip);
                }
            }
        };
        const renderPropertiesPanel = () => {
            if (selectedClipId === null || !timelineData.clips[selectedClipId]) { propertiesContent.innerHTML = `<p class="text-xs text-gray-500"></p>`; return; }
            const clip = timelineData.clips[selectedClipId]; let content = `<div class="grid grid-cols-2 gap-2 p-2">`;
            content += `<div>X</div><div><input type="number" class="property-input" data-prop="x" value="${(clip.transform.x * 100).toFixed(0)}"></div>`;
            content += `<div>Y</div><div><input type="number" class="property-input" data-prop="y" value="${(clip.transform.y * 100).toFixed(0)}"></div>`;
            content += `<div></div><div><input type="number" class="property-input" step="0.01" data-prop="scale" value="${clip.transform.scale.toFixed(2)}"></div>`;
            content += `<div></div><div><input type="number" class="property-input" data-prop="rotation" value="${clip.transform.rotation.toFixed(0)}"></div>`;
            if (clip.type === 'text') { const fonts = ['sans-serif', 'serif', 'monospace', 'cursive', 'fantasy']; const inAnims = {none: '', fadeIn: '', slideInUp: '()'}; const outAnims = {none: '', fadeOut: '', slideOutDown: '()'};
                content += `<div class="col-span-2 mt-2 pt-2 border-t border-gray-600"></div><div class="col-span-2"><input type="text" class="property-input" data-prop="text" value="${clip.text}"></div>`;
                content += `<div></div><div><input type="number" class="property-input" data-prop="fontSize" value="${clip.fontSize}"></div>`;
                content += `<div></div><div style="position: relative; height: 26px;"><input type="color" class="property-input" data-prop="color" value="${clip.color}" style="position: absolute; width: 100%; height: 100%; padding: 2px;"></div>`;
                content += `<div></div><div><select class="property-input" data-prop="fontFamily">${fonts.map(f => `<option value="${f}" ${clip.fontFamily === f ? 'selected' : ''}>${f}</option>`).join('')}</select></div>`;
                content += `<div></div><div style="position: relative; height: 26px;"><input type="color" class="property-input" data-prop="strokeColor" value="${clip.strokeColor}" style="position: absolute; width: 100%; height: 100%; padding: 2px;"></div>`;
                content += `<div></div><div><input type="number" class="property-input" data-prop="strokeWidth" value="${clip.strokeWidth}"></div>`;
                content += `<div></div><div><select class="property-input" data-prop="inAnimation">${Object.entries(inAnims).map(([v, n]) => `<option value="${v}" ${clip.inAnimation === v ? 'selected' : ''}>${n}</option>`).join('')}</select></div>`;
                content += `<div></div><div><select class="property-input" data-prop="outAnimation">${Object.entries(outAnims).map(([v, n]) => `<option value="${v}" ${clip.outAnimation === v ? 'selected' : ''}>${n}</option>`).join('')}</select></div>`;
            }
            propertiesContent.innerHTML = content + `</div>`;
        };
        propertiesContent.addEventListener('input', (e) => { const clip = timelineData.clips[selectedClipId]; if (!clip) return; const p = e.target.dataset.prop, v = e.target.type === 'number' ? parseFloat(e.target.value) : e.target.value; if (['x', 'y'].includes(p)) clip.transform[p] = v / 100; else if (['scale', 'rotation'].includes(p)) clip.transform[p] = v; else clip[p] = v; if (clip.type === 'text' && p === 'text') renderTimeline(); updateAnimation(); });
        const setupInteraction = (box, clip) => { let startX, startY, startT; const rect = previewInteractionOverlay.getBoundingClientRect(); box.addEventListener('mousedown', (e) => { e.stopPropagation(); startT = { ...clip.transform }; startX = e.clientX; startY = e.clientY; document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onEnd); }); const onMove = (e) => { clip.transform.x = startT.x + (e.clientX - startX) / rect.width; clip.transform.y = startT.y + (e.clientY - startY) / rect.height; updateAnimation(); renderPropertiesPanel(); }; const onEnd = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onEnd); }; box.querySelectorAll('.resize-handle').forEach(h => { h.addEventListener('mousedown', (e) => { e.stopPropagation(); startT = { ...clip.transform }; startX = e.clientX; document.addEventListener('mousemove', onResize); document.addEventListener('mouseup', onResizeEnd); }); }); const onResize = (e) => { const dx = e.clientX - startX; clip.transform.scale = Math.max(0.1, startT.scale + dx / 100); updateAnimation(); renderPropertiesPanel(); }; const onResizeEnd = () => { document.removeEventListener('mousemove', onResize); document.removeEventListener('mouseup', onResizeEnd); }; };
        cutBtn.onclick = () => { if (selectedClipId === null) return; copiedClip = JSON.parse(JSON.stringify(timelineData.clips[selectedClipId])); delete timelineData.clips[selectedClipId]; for (const t in timelineData.tracks) timelineData.tracks[t].forEach(r => { const i = r.indexOf(selectedClipId); if (i > -1) r.splice(i, 1); }); selectedClipId = null; renderTimeline(); renderPropertiesPanel(); updateAnimation(); updateTotalDuration(); };
        copyBtn.onclick = () => { if (selectedClipId !== null) copiedClip = JSON.parse(JSON.stringify(timelineData.clips[selectedClipId])); };
        pasteBtn.onclick = () => { if (!copiedClip) return; const newData = { ...copiedClip }; delete newData.id; newData.start = currentTime; addClipToTimeline(newData); };
        mergeBtn.onclick = () => createNotification("", "", "info");
        const originalCloseHandler = editorWindow.querySelector('.close').onclick;
        editorWindow.querySelector('.close').onclick = () => {
            pause();
            audioElements.forEach(audio => { audio.src = ''; });
            audioElements.clear();
            if (originalCloseHandler) originalCloseHandler();
        };
        renderTimeline();
    }
},
{
    id: 'camera', 
    name: '', 
    icon: 'fas fa-camera-retro', 
    installed: true, 
    launcher: () => {
const windowId = `app-window-camera-${Date.now()}`;
const content = `
<style>
    #camera-app-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        background-color: #111;
        color: white;
        overflow: hidden;
    }
    #camera-preview-wrapper {
        flex-grow: 1;
        position: relative;
        display: grid;
        place-items: center;
        min-height: 0; 
    }
    #camera-video-preview {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    #camera-controls {
        flex-shrink: 0; 
        padding: 15px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: #000;
        gap: 15px;
    }
    #camera-mode-switcher {
        background-color: rgba(255,255,255,0.1);
        border-radius: 20px;
        padding: 5px;
        display: flex;
        gap: 5px;
    }
    .mode-btn {
        padding: 5px 15px;
        border-radius: 15px;
        background-color: transparent;
        color: #aaa;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }
    .mode-btn.active {
        background-color: rgba(255,255,255,0.3);
        color: white;
    }
    #camera-shutter-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: white;
        border: 4px solid #555;
        cursor: pointer;
        transition: all 0.2s;
    }
    #camera-shutter-btn:active {
        transform: scale(0.9);
    }
    #record-timer {
        position: absolute;
        top: 15px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(255, 59, 48, 0.8);
        color: white;
        padding: 3px 10px;
        border-radius: 8px;
        font-family: monospace;
    }
        #camera-error-message {
            text-align: center;
            color: #ff5f56;
        }
        #camera-flash-effect {
            position: absolute;
            inset: 0;
            background-color: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }
        #camera-flash-effect.flash {
            opacity: 1;
        }
</style>
<div id="camera-app-container">
    <div id="camera-preview-wrapper">
        <video id="camera-video-preview" autoplay playsinline></video>
        <p id="camera-error-message" class="hidden"></p>
        <div id="camera-flash-effect"></div>
        <div id="record-timer" class="hidden">00:00</div>
    </div>
    <div id="camera-controls">
        <div id="camera-mode-switcher">
            <button class="mode-btn active" data-mode="photo"></button>
            <button class="mode-btn" data-mode="video"></button>
        </div>
        <button id="camera-shutter-btn"></button>
    </div>
</div>
`;
const cameraWindow = createWindow(windowId, '', content, 640, 550);
cameraWindow.querySelector('.window-content').style.padding = '0';
const video = cameraWindow.querySelector('#camera-video-preview');
const shutterBtn = cameraWindow.querySelector('#camera-shutter-btn');
const errorMessage = cameraWindow.querySelector('#camera-error-message');
const flashEffect = cameraWindow.querySelector('#camera-flash-effect');
const modeSwitcher = cameraWindow.querySelector('#camera-mode-switcher');
const recordTimer = cameraWindow.querySelector('#record-timer');
let cameraStream = null;
let currentMode = 'photo';
let mediaRecorder = null;
let recordedChunks = [];
let isRecording = false;
let timerInterval = null;
const startCamera = async () => {
    try {
        if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); }
        cameraStream = await navigator.mediaDevices.getUserMedia({
            video: { width: { ideal: 1280 }, height: { ideal: 720 } },
            audio: true
        });
        video.srcObject = cameraStream;
        errorMessage.classList.add('hidden');
    } catch (err) {
        console.error(":", err);
        errorMessage.textContent = err.name === 'NotAllowedError' ? "" : "";
        errorMessage.classList.remove('hidden');
        shutterBtn.disabled = true;
    }
};
modeSwitcher.addEventListener('click', (e) => {
    const btn = e.target.closest('.mode-btn');
    if (!btn || isRecording) return;
    currentMode = btn.dataset.mode;
    modeSwitcher.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    shutterBtn.style.backgroundColor = currentMode === 'video' ? '#ff3b30' : 'white';
});
shutterBtn.addEventListener('click', () => {
    if (currentMode === 'photo') {
        takePhoto();
    } else {
        if (isRecording) {
            stopRecording();
        } else {
            startRecording();
        }
    }
});
const takePhoto = async () => {
    if (!video.srcObject) return;
    flashEffect.classList.add('flash');
    setTimeout(() => { flashEffect.classList.remove('flash'); }, 300);
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageDataUrl = canvas.toDataURL('image/jpeg');
    try {
        const timestamp = new Date().toISOString().replace(/[-:.]/g, '');
        const fileName = `IMG_${timestamp}.jpg`;
        await VFS.writeFile('/Pictures', fileName, 'image/jpeg', imageDataUrl);
        createNotification('', `${fileName} /Pictures `, 'info', 5, null, null, 'camera');
    } catch (err) {
        createNotification('', '', 'error', 5, null, null, 'camera');
    }
};
const startRecording = () => {
    if (!cameraStream) return;
    isRecording = true;
    recordedChunks = [];
    shutterBtn.style.borderRadius = '20%';
    shutterBtn.style.transform = 'scale(0.8)';
    mediaRecorder = new MediaRecorder(cameraStream, { mimeType: 'video/webm; codecs=vp9' });
    mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
            recordedChunks.push(event.data);
        }
    };
    mediaRecorder.onstop = async () => {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const reader = new FileReader();
        reader.onload = async () => {
            try {
                const timestamp = new Date().toISOString().replace(/[-:.]/g, '');
                const fileName = `VID_${timestamp}.webm`;
                await VFS.writeFile('/Videos', fileName, 'video/webm', reader.result);
                createNotification('', `${fileName} /Videos `, 'info', 5, null, null, 'camera');
            } catch (err) {
                createNotification('', '', 'error', 5, null, null, 'camera');
            }
        };
        reader.readAsDataURL(blob);
    };
    mediaRecorder.start();
    startTimer();
};
const stopRecording = () => {
    if (mediaRecorder) {
        mediaRecorder.stop();
    }
    isRecording = false;
    shutterBtn.style.borderRadius = '50%';
    shutterBtn.style.transform = 'scale(1)';
    stopTimer();
};
const startTimer = () => {
    let seconds = 0;
    recordTimer.textContent = '00:00';
    recordTimer.classList.remove('hidden');
    timerInterval = setInterval(() => {
        seconds++;
        const min = String(Math.floor(seconds / 60)).padStart(2, '0');
        const sec = String(seconds % 60).padStart(2, '0');
        recordTimer.textContent = `${min}:${sec}`;
    }, 1000);
};
const stopTimer = () => {
    clearInterval(timerInterval);
    recordTimer.classList.add('hidden');
};
const originalCloseHandler = cameraWindow.querySelector('.close').onclick;
cameraWindow.querySelector('.close').onclick = () => {
    if (isRecording) {
        stopRecording();
    }
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
    }
    stopTimer();
    if (originalCloseHandler) originalCloseHandler();
};
startCamera();
    }
},
{
    id: 'system-monitor',
    name: '',
    icon: 'fas fa-chart-line',
    installed: true,
    launcher: () => {
const windowId = `app-window-system-monitor-${Date.now()}`;
const content = `
    <style>
        #sys-monitor-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
            font-family: 'Inter', sans-serif;
        }
        .monitor-card {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
        }
        .monitor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .monitor-title {
            font-weight: 600;
        }
        .monitor-value {
            font-family: monospace;
            font-size: 1.2em;
            font-weight: 500;
        }
        .monitor-graph-wrapper {
            width: 100%;
            height: 60px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            padding: 5px;
        }
        #cpu-graph-canvas, #mem-graph-canvas {
            width: 100%;
            height: 100%;
        }
    </style>
    <div id="sys-monitor-container">
        <!-- CPU -->
        <div class="monitor-card">
            <div class="monitor-header">
                <span class="monitor-title">CPU ()</span>
                <span id="cpu-value" class="monitor-value">-- %</span>
            </div>
            <div class="monitor-graph-wrapper">
                <canvas id="cpu-graph-canvas"></canvas>
            </div>
        </div>
        <!--  -->
        <div class="monitor-card">
            <div class="monitor-header">
                <span class="monitor-title"> (JS)</span>
                <span id="mem-value" class="monitor-value">-- MB</span>
            </div>
            <div class="monitor-graph-wrapper">
                <canvas id="mem-graph-canvas"></canvas>
            </div>
        </div>
        <!--  -->
        <div class="monitor-card" style="font-size: 0.9em;">
            <div class="setting-item"><span></span><span id="open-apps-count">--</span></div>
            <div class="setting-item"><span></span><span id="proxy-stats-display">-- MB</span></div>
        </div>
    </div>
`;
const monitorWindow = createWindow(windowId, '', content, 400, 480);
const windowContent = monitorWindow.querySelector('.window-content');
windowContent.style.backgroundColor = 'var(--window-bg-dark)';
if (!isDarkMode) {
    windowContent.style.backgroundColor = 'var(--window-bg-light)';
}
const cpuValue = monitorWindow.querySelector('#cpu-value');
const memValue = monitorWindow.querySelector('#mem-value');
const openAppsCount = monitorWindow.querySelector('#open-apps-count');
const proxyStats = monitorWindow.querySelector('#proxy-stats-display');
const cpuCanvas = monitorWindow.querySelector('#cpu-graph-canvas');
const memCanvas = monitorWindow.querySelector('#mem-graph-canvas');
let monitorInterval = null;
const createGraph = (canvas, color) => {
    const ctx = canvas.getContext('2d');
    const dataPoints = new Array(50).fill(0);
    const resize = () => {
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
    };
    resize();
    new ResizeObserver(resize).observe(canvas);
    const addData = (value) => {
        dataPoints.shift();
        dataPoints.push(value);
        draw();
    };
    const draw = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        const maxValue = Math.max(100, ...dataPoints);
        dataPoints.forEach((point, i) => {
            const x = (i / (dataPoints.length - 1)) * canvas.width;
            const y = canvas.height - (point / maxValue) * canvas.height;
            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });
        ctx.stroke();
    };
    return { addData, draw };
};
const cpuGraph = createGraph(cpuCanvas, '#ef4444');
const memGraph = createGraph(memCanvas, '#3b82f6');
let lastTime = performance.now();
let lastIdle = 0;
let lastTotal = 0;
const updateMonitor = async () => {
    const startTime = performance.now();
    requestAnimationFrame(() => {
        const endTime = performance.now();
        const duration = endTime - startTime;
        const usage = Math.min(100, (duration / 16.7) * 100);
        cpuValue.textContent = `${usage.toFixed(1)} %`;
        cpuGraph.addData(usage);
    });
    if (performance.memory) {
        const memory = performance.memory;
        const usedMB = (memory.usedJSHeapSize / (1024 * 1024)).toFixed(1);
        memValue.textContent = `${usedMB} MB`;
        memGraph.addData(parseFloat(usedMB));
    } else {
        memValue.textContent = "N/A";
    }
    openAppsCount.textContent = openApps.size;
    if (proxyStats) proxyStats.textContent = '';
};
monitorInterval = setInterval(updateMonitor, 1000);
updateMonitor();
const originalCloseHandler = monitorWindow.querySelector('.close').onclick;
monitorWindow.querySelector('.close').onclick = () => {
    clearInterval(monitorInterval);
    if (originalCloseHandler) originalCloseHandler();
};
    }
},
{
    id: 'app-creator',
    name: 'App Creator',
    icon: 'fas fa-box',
    installed: true,
    launcher: () => {
const windowId = `app-window-app-creator-${Date.now()}`;
const content = `
    <style>
        .creator-container { display: flex; flex-direction: column; height: 100%; gap: 1rem; padding: 1rem; }
        .creator-section { background-color: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.75rem; }
        .creator-section h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.75rem; }
        .creator-input-group { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; }
        .creator-input-group label { font-size: 0.9rem; color: #aaa; }
        .creator-input { width: 100%; padding: 0.5rem; border-radius: 0.5rem; background-color: #111; border: 1px solid #444; color: #eee; }
        .creator-btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; border: none; }
    </style>
    <div class="creator-container">
        <div class="creator-section">
            <h3>Web</h3>
            <p class="text-sm text-gray-400 mb-4">HTMLRivift OS</p>
            <div class="creator-input-group">
                <label for="app-file-path">HTML</label>
                <div class="flex gap-2">
                    <input type="text" id="app-file-path" class="creator-input" readonly placeholder="...">
                    <button id="select-file-btn" class="creator-btn" style="background-color: #444;"></button>
                </div>
            </div>
            <div class="creator-input-group">
                <label for="app-name-input"></label>
                <input type="text" id="app-name-input" class="creator-input">
            </div>
            <div class="creator-input-group">
                <label for="app-icon-input"> (Font Awesome)</label>
                <input type="text" id="app-icon-input" class="creator-input" value="fas fa-window-maximize">
            </div>
            <button id="create-app-btn" class="creator-btn w-full mt-4" style="background-color: #007bff;"></button>
        </div>
    </div>
`;
const creatorWindow = createWindow(windowId, 'App Creator', content, 500, 450);
const dom = {
    filePathInput: creatorWindow.querySelector('#app-file-path'),
    selectFileBtn: creatorWindow.querySelector('#select-file-btn'),
    appNameInput: creatorWindow.querySelector('#app-name-input'),
    appIconInput: creatorWindow.querySelector('#app-icon-input'),
    createBtn: creatorWindow.querySelector('#create-app-btn'),
};
let selectedFilePath = null;
dom.selectFileBtn.addEventListener('click', async () => {
    const path = await showFilePicker({ mode: 'open', title: 'HTML', acceptTypes: ['text/html'] });
    if (path) {
        selectedFilePath = Array.isArray(path) ? path[0] : path;
        dom.filePathInput.value = selectedFilePath;
        const fileName = selectedFilePath.split('/').pop();
        dom.appNameInput.value = fileName.replace(/\.html?$/i, '');
    }
});
dom.createBtn.addEventListener('click', async () => {
    const appName = dom.appNameInput.value.trim();
    const appIcon = dom.appIconInput.value.trim();
    if (!selectedFilePath || !appName || !appIcon) {
        createNotification('', '', 'error');
        return;
    }
    const appId = `webapp-${appName.toLowerCase().replace(/[^a-z0-9]/g, '-')}`;
    if (apps.some(app => app.id === appId)) {
        createNotification('', '', 'error');
        return;
    }
    try {
        const fileData = await VFS.readFile(selectedFilePath);
        if (!fileData || !fileData.content) throw new Error("");
        const newWebApp = {
            id: appId,
            name: appName,
            icon: appIcon,
            installed: true,
            isWebApp: true,
            htmlContent: fileData.content,
            launcher: () => {
                const webAppWindow = createWindow(`app-window-${appId}`, appName, '', 800, 600);
                webAppWindow.querySelector('.window-content').style.padding = '0';
                webAppWindow.querySelector('.window-content').style.overflow = 'hidden';
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.sandbox = "allow-scripts allow-forms allow-modals allow-popups";
                iframe.src = fileData.content; 
                webAppWindow.querySelector('.window-content').appendChild(iframe);
            }
        };
        apps.push(newWebApp);
        saveCustomWebApps();
        createNotification('', `${appName}`, 'info');
        if (allAppsFullscreen.classList.contains('active')) {
            populateAllApps();
        }
        creatorWindow.querySelector('.close').click();
    } catch (err) {
        console.error("Web:", err);
        createNotification('', `: ${err.message}`, 'error');
    }
});
    }
},
{
    id: 'code-assistant',
    name: ' (Worker)',
    icon: 'fas fa-robot',
    installed: true,
launcher: async () => {
    const windowId = `app-window-code-assistant-${Date.now()}`;
    if (!navigator.gpu) {
        await showMessageBox(
            '', 
            'WebGPU\nChromeEdge',
            { showCancel: false }
        );
        return;
    }
    let CreateMLCEngine, prebuiltAppConfig;
    try {
        const module = await import("https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.46/+esm");
        CreateMLCEngine = module.CreateMLCEngine;
        prebuiltAppConfig = module.prebuiltAppConfig;
    } catch (e) {
        await showMessageBox('', 'AI\n', { isNetworkError: true });
        return;
    }
    const selectedModel = "Phi-3-mini-4k-instruct-q4f16_1-MLC";
    const content = `
        <style>
            .code-assistant-container { display: grid; grid-template-rows: 1fr auto; height: 100%; position: relative; }
            .chat-area { 
                flex-grow: 1; 
                background-color: var(--input-bg-dark); 
                padding: 15px; 
                overflow-y: auto; 
                font-family: 'Consolas', 'Monaco', monospace; 
                white-space: pre-wrap; 
                color: var(--text-color-dark); 
                font-size: 0.95rem;
                line-height: 1.6;
            }
            .input-area-wrapper { padding: 10px; background-color: var(--header-bg-dark); border-top: 1px solid var(--border-color-dark); }
            .input-area { display: flex; gap: 10px; }
            #ai-prompt-input { flex-grow: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color-dark); background-color: rgba(0,0,0,0.3); color: white; resize: none; height: 60px; outline: none; }
            #ai-generate-btn { width: 80px; border-radius: 8px; background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; }
            #ai-generate-btn:disabled { background-color: #555; cursor: not-allowed; }
            .ai-msg { margin-bottom: 15px; padding: 10px 14px; border-radius: 10px; max-width: 90%; }
            .ai-msg.user { background-color: #007bff; color: white; margin-left: auto; border-bottom-right-radius: 2px; }
            .ai-msg.bot { background-color: rgba(255, 255, 255, 0.1); color: #e0e0e0; margin-right: auto; border-bottom-left-radius: 2px; }
            #ai-loading-overlay { position: absolute; inset: 0; background-color: rgba(20, 20, 20, 0.95); backdrop-filter: blur(5px); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
            #ai-loading-overlay.hidden { opacity: 0; pointer-events: none; }
            .progress-percent { font-size: 2rem; font-weight: bold; color: #007bff; margin-bottom: 10px; }
            .progress-bar-bg { width: 300px; height: 6px; background-color: #333; border-radius: 3px; overflow: hidden; }
            .progress-bar-fill { height: 100%; background-color: #007bff; width: 0%; transition: width 0.1s linear; }
            .progress-status { margin-top: 15px; color: #aaa; font-size: 0.9rem; text-align: center; white-space: pre-wrap; }
        </style>
        <div class="code-assistant-container">
            <div id="ai-loading-overlay">
                <div id="ai-progress-percent" class="progress-percent">0%</div>
                <div class="progress-bar-bg"><div id="ai-progress-fill" class="progress-bar-fill"></div></div>
                <div id="ai-progress-status" class="progress-status">AI...</div>
            </div>
            <div id="ai-chat-output" class="chat-area">
                <div class="ai-msg bot">AI (Phi-3) <br></div>
            </div>
            <div class="input-area-wrapper">
                <div class="input-area">
                    <textarea id="ai-prompt-input" placeholder="..." disabled></textarea>
                    <button id="ai-generate-btn" disabled><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    `;
    const assistantWindow = createWindow(windowId, '', content, 650, 550);
    const outputDiv = assistantWindow.querySelector('#ai-chat-output');
    const inputTx = assistantWindow.querySelector('#ai-prompt-input');
    const sendBtn = assistantWindow.querySelector('#ai-generate-btn');
    const loadingOverlay = assistantWindow.querySelector('#ai-loading-overlay');
    const percentText = assistantWindow.querySelector('#ai-progress-percent');
    const progressFill = assistantWindow.querySelector('#ai-progress-fill');
    const statusText = assistantWindow.querySelector('#ai-progress-status');
    let engine = null;
    const appendMessage = (role, text) => {
        const msg = document.createElement('div');
        msg.className = `ai-msg ${role}`;
        msg.textContent = text;
        outputDiv.appendChild(msg);
        outputDiv.scrollTop = outputDiv.scrollHeight;
        return msg;
    };
    const translateStatus = (text) => {
        if (text.includes("Fetching")) return "...\n(GB)";
        if (text.includes("Loading model")) return "...";
        if (text.includes("Loading param")) return "...";
        if (text.includes("Finish")) return "";
        return text;
    };
    const initEngine = async () => {
        try {
            const initProgressCallback = (report) => {
                const progress = report.progress || 0;
                const percent = Math.round(progress * 100);
                percentText.textContent = `${percent}%`;
                progressFill.style.width = `${percent}%`;
                statusText.textContent = translateStatus(report.text);
            };
            engine = await CreateMLCEngine(
                selectedModel,
                { 
                    appConfig: prebuiltAppConfig,
                    initProgressCallback: initProgressCallback,
                    appConfig: { useIndexedDBCache: true, ...prebuiltAppConfig }
                }
            );
            loadingOverlay.classList.add('hidden');
            inputTx.disabled = false;
            sendBtn.disabled = false;
            inputTx.focus();
            setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500);
        } catch (err) {
            console.error(err);
            percentText.style.color = '#ff5f56';
            percentText.textContent = "";
            statusText.textContent = `\n${err.message}`;
        }
    };
    sendBtn.addEventListener('click', async () => {
        const prompt = inputTx.value.trim();
        if (!prompt) return;
        appendMessage('user', prompt);
        inputTx.value = '';
        const botMsgDiv = appendMessage('bot', "");
        sendBtn.disabled = true;
        try {
            const chunks = await engine.chat.completions.create({
                messages: [{ role: "user", content: prompt }],
                temperature: 0.7,
                stream: true,
            });
            let fullReply = "";
            let counter = 0;
            for await (const chunk of chunks) {
                const content = chunk.choices[0]?.delta?.content || "";
                fullReply += content;
                botMsgDiv.textContent = fullReply;
                if (counter++ % 5 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 0));
                    outputDiv.scrollTop = outputDiv.scrollHeight;
                }
            }
            outputDiv.scrollTop = outputDiv.scrollHeight;
        } catch (err) {
            botMsgDiv.textContent += "\n[]";
            console.error(err);
        } finally {
            sendBtn.disabled = false;
        }
    });
    inputTx.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendBtn.click();
        }
    });
    const originalClose = assistantWindow.querySelector('.close').onclick;
    assistantWindow.querySelector('.close').onclick = async () => {
        if (engine) {
            await engine.unload();
            console.log("Local LLM unloaded.");
        }
        if (originalClose) originalClose();
    };
    setTimeout(initEngine, 100);
}
},
{
    id: 'system-panel',
    name: '',
    icon: 'fas fa-sliders-h',
    installed: true,
    launcher: () => {
        const windowId = `app-window-system-panel-${Date.now()}`;
        const content = `
            <style>
                .system-panel-container { display: flex; height: 100%; }
                .system-panel-sidebar {
                    width: 180px;
                    flex-shrink: 0;
                    padding: 10px;
                    border-right: 1px solid var(--border-color-dark);
                    background-color: var(--sidebar-bg-dark);
                }
                .sidebar-item {
                    padding: 10px 15px;
                    border-radius: 8px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    margin-bottom: 5px;
                    transition: background-color 0.2s;
                }
                .sidebar-item:hover { background-color: rgba(255,255,255,0.05); }
                .sidebar-item.active { background-color: #007bff; color: white; }
                .system-panel-main { flex-grow: 1; padding: 15px; overflow-y: auto; }
                .panel-page { display: none; }
                .panel-page.active { display: block; }
                h3 { font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color-dark); padding-bottom: 0.5rem;}
                .dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
                .dashboard-card { background-color: var(--input-bg-dark); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; }
                .card-title { font-weight: 500; color: #aaa; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
                .card-content { flex-grow: 1; display: flex; align-items: center; justify-content: center; }
                .performance-graph { height: 60px; position: relative; }
                .performance-graph canvas { position: absolute; width: 100%; height: 100%; }
                .performance-value { font-size: 1.8rem; font-weight: 500; text-align: right; }
                .storage-chart { position: relative; width: 100px; height: 100px; }
                .storage-chart svg { width: 100%; height: 100%; transform: rotate(-90deg); }
                .storage-chart circle { fill: none; stroke-width: 10; }
                .storage-info { font-size: 0.9rem; }
                .col-span-2 { grid-column: span 2; }
                #log-view-area { background-color: #111; border-radius: 8px; padding: 10px; height: 300px; overflow-y: scroll; font-family: monospace; font-size: 0.8rem; }
                .log-entry { padding: 2px 0; border-bottom: 1px solid #333; }
                .log-info { color: #eee; }
                .log-warn { color: #facc15; }
                .log-error { color: #ef4444; }
                #storage-analyzer-list li { display: flex; justify-content: space-between; padding: 5px; border-radius: 4px; }
                #storage-analyzer-list li:nth-child(odd) { background-color: rgba(255,255,255,0.03); }
            </style>
            <div class="system-panel-container">
                <div class="system-panel-sidebar">
                    <div class="sidebar-item active" data-page="dashboard"><i class="fas fa-tachometer-alt fa-fw"></i><span></span></div>
                    <div class="sidebar-item" data-page="performance"><i class="fas fa-chart-line fa-fw"></i><span></span></div>
                    <div class="sidebar-item" data-page="storage"><i class="fas fa-hdd fa-fw"></i><span></span></div>
                    <div class="sidebar-item" data-page="logs"><i class="fas fa-clipboard-list fa-fw"></i><span></span></div>
                </div>
                <div class="system-panel-main">
                    <!--  -->
                    <div id="dashboard-page" class="panel-page active">
                        <h3></h3>
                        <div class="dashboard-grid">
                            <div class="dashboard-card col-span-2">
                                <div class="card-title"><i class="fas fa-tachometer-alt"></i> </div>
                                <div class="card-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div>
                                        <div style="display: flex; justify-content: space-between; align-items: baseline;"><span>CPU</span><span id="sys-panel-cpu-value" class="performance-value">-- %</span></div>
                                        <div class="performance-graph"><canvas id="sys-panel-cpu-canvas"></canvas></div>
                                    </div>
                                    <div>
                                        <div style="display: flex; justify-content: space-between; align-items: baseline;"><span></span><span id="sys-panel-mem-value" class="performance-value">-- MB</span></div>
                                        <div class="performance-graph"><canvas id="sys-panel-mem-canvas"></canvas></div>
                                    </div>
                                </div>
                            </div>
                            <div class="dashboard-card">
                                <div class="card-title"><i class="fas fa-hdd"></i> </div>
                                <div class="card-content" style="gap: 20px;">
                                    <div class="storage-chart">
                                        <svg viewBox="0 0 36 36"><circle cx="18" cy="18" r="15.915" stroke="#444"></circle><circle id="sys-panel-storage-circle" cx="18" cy="18" r="15.915" stroke="#007bff" stroke-dasharray="0, 100"></circle></svg>
                                    </div>
                                    <div id="sys-panel-storage-info" class="storage-info"><p>: -- GB</p><p>: -- GB</p></div>
                                </div>
                            </div>
                            <div class="dashboard-card">
                                <div class="card-title"><i class="fas fa-globe"></i> </div>
                                <div class="card-content" style="flex-direction: column; gap: 10px;">
                                    <p style="font-size: 0.9rem; color: #aaa;"></p>
                                    <p id="sys-panel-network-total" style="font-size: 2.5rem; font-weight: 600;">-- MB</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--  -->
                    <div id="performance-page" class="panel-page">
                        <h3></h3>
                        <div id="process-list"></div>
                    </div>
                    <!--  -->
                    <div id="storage-page" class="panel-page">
                        <h3></h3>
                        <button id="analyze-storage-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg mb-4"></button>
                        <ul id="storage-analyzer-list"></ul>
                    </div>
                    <!--  -->
                    <div id="logs-page" class="panel-page">
                        <h3></h3>
                        <div id="log-view-area"></div>
                    </div>
                </div>
            </div>
        `;
        const panelWindow = createWindow(windowId, '', content, 750, 550);
        const sidebarItems = panelWindow.querySelectorAll('.sidebar-item');
        const pages = panelWindow.querySelectorAll('.panel-page');
        const cpuValue = panelWindow.querySelector('#sys-panel-cpu-value');
        const memValue = panelWindow.querySelector('#sys-panel-mem-value');
        const storageCircle = panelWindow.querySelector('#sys-panel-storage-circle');
        const storageInfo = panelWindow.querySelector('#sys-panel-storage-info');
        const networkTotal = panelWindow.querySelector('#sys-panel-network-total');
        const processListDiv = panelWindow.querySelector('#process-list');
        const analyzeStorageBtn = panelWindow.querySelector('#analyze-storage-btn');
        const storageAnalyzerList = panelWindow.querySelector('#storage-analyzer-list');
        const logViewArea = panelWindow.querySelector('#log-view-area');
        if (!window.RiviftOS_Logs) {
            window.RiviftOS_Logs = [{level: 'info', msg: '', time: new Date()}];
        }
        const originalCreateNotification = window.createNotification;
        window.createNotification = function(title, message, type = 'info', ...args) {
            const level = (type === 'error') ? 'error' : (type === 'warning') ? 'warn' : 'info';
            window.RiviftOS_Logs.push({level, msg: `${title}: ${message}`, time: new Date()});
            if (window.RiviftOS_Logs.length > 100) window.RiviftOS_Logs.shift();
            return originalCreateNotification(title, message, type, ...args);
        };
        sidebarItems.forEach(item => {
            item.addEventListener('click', () => {
                sidebarItems.forEach(i => i.classList.remove('active'));
                pages.forEach(p => p.classList.remove('active'));
                item.classList.add('active');
                panelWindow.querySelector(`#${item.dataset.page}-page`).classList.add('active');
            });
        });
        const createGraph = (canvasId, color) => {
            const canvas = panelWindow.querySelector(`#${canvasId}`);
            if (!canvas) return { addData: () => {}, draw: () => {} };
            const ctx = canvas.getContext('2d');
            const dataPoints = new Array(50).fill(0);
            const resize = () => { if(canvas.isConnected) { canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; } };
            resize();
            new ResizeObserver(resize).observe(canvas.parentElement);
            const addData = (value) => { dataPoints.shift(); dataPoints.push(value); draw(); };
            const draw = () => {
                if(!canvas.isConnected) return;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                const maxValue = Math.max(100, ...dataPoints);
                dataPoints.forEach((p, i) => {
                    const x = (i / 49) * canvas.width;
                    const y = canvas.height - (p / maxValue) * canvas.height;
                    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                });
                ctx.stroke();
            };
            return { addData, draw };
        };
        const cpuGraph = createGraph('sys-panel-cpu-canvas', '#007bff');
        const memGraph = createGraph('sys-panel-mem-canvas', '#28a745');
        const updateDashboard = async () => {
            const startTime = performance.now();
            requestAnimationFrame(() => {
                const usage = Math.min(100, (performance.now() - startTime) / 16.7 * 100);
                if (cpuValue) cpuValue.textContent = `${usage.toFixed(1)} %`;
                cpuGraph.addData(usage);
            });
            if (performance.memory) {
                const usedMB = (performance.memory.usedJSHeapSize / (1024 * 1024)).toFixed(1);
                if (memValue) memValue.textContent = `${usedMB} MB`;
                memGraph.addData(parseFloat(usedMB));
            }
            try {
                const allFiles = await VFS.search('');
                let totalSize = 0;
                allFiles.forEach(f => totalSize += f.content ? (f.content.split(',')[1] || '').length * 0.75 : 0);
                const totalSizeGB = (totalSize / (1024**3)).toFixed(2);
                const capacityGB = 10;
                const usagePercent = Math.min(100, (totalSizeGB / capacityGB) * 100);
                if (storageCircle) storageCircle.style.strokeDasharray = `${usagePercent}, 100`;
                if (storageInfo) storageInfo.innerHTML = `<p>: ${totalSizeGB} GB</p><p>: ${capacityGB} GB</p>`;
            } catch(e) { console.error("Storage update failed:", e); }
            if (networkTotal) networkTotal.textContent = '';
        };
        const updatePerformancePage = () => {
            let html = '<table class="w-full text-left text-sm"><thead><tr class="border-b border-gray-600"><th class="p-2"></th><th></th><th>CPU()</th><th>()</th><th></th></tr></thead><tbody>';
            openApps.forEach((appData, windowId) => {
                const appName = windowId.replace('app-window-', '').replace(/-\d+$/, '');
                html += `<tr class="border-b border-gray-700">
                    <td class="p-2">${appName}</td>
                    <td>${appData.state}</td>
                    <td>${(Math.random()*5).toFixed(1)}%</td>
                    <td>${(20 + Math.random()*50).toFixed(1)}MB</td>
                    <td><button data-kill="${windowId}" class="text-red-500 hover:text-red-400"></button></td>
                </tr>`;
            });
            html += '</tbody></table>';
            if (processListDiv) processListDiv.innerHTML = html;
        };
        const analyzeStorage = async () => {
            storageAnalyzerList.innerHTML = '<li>... <i class="fas fa-spinner fa-spin ml-auto"></i></li>';
            try {
                const allFiles = await VFS.search('');
                const folderSizes = {};
                const getFolderPath = (path) => path.substring(0, path.lastIndexOf('/')) || '/';
                allFiles.forEach(file => {
                    if (file.type !== 'folder') {
                        const size = file.content ? (file.content.split(',')[1] || '').length * 0.75 : 0;
                        let currentPath = getFolderPath(file.path);
                        while(true) {
                            folderSizes[currentPath] = (folderSizes[currentPath] || 0) + size;
                            if (currentPath === '/') break;
                            currentPath = getFolderPath(currentPath);
                        }
                    }
                });
                const sortedFolders = Object.entries(folderSizes).sort((a, b) => b[1] - a[1]);
                const formatBytes = (bytes) => {
                    if (bytes === 0) return '0 B';
                    const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'], i = Math.floor(Math.log(bytes) / Math.log(k));
                    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
                };
                storageAnalyzerList.innerHTML = sortedFolders.map(([path, size]) => `<li><span>${path}</span><span>${formatBytes(size)}</span></li>`).join('');
            } catch(e) { storageAnalyzerList.innerHTML = '<li></li>'; }
        };
        const updateLogs = () => {
            if (!logViewArea) return;
            logViewArea.innerHTML = window.RiviftOS_Logs.map(log => {
                const time = log.time.toLocaleTimeString();
                return `<div class="log-entry log-${log.level}">[${time}] ${log.msg}</div>`;
            }).join('');
            logViewArea.scrollTop = logViewArea.scrollHeight;
        };
        analyzeStorageBtn.addEventListener('click', analyzeStorage);
        processListDiv.addEventListener('click', e => {
            const killId = e.target.dataset.kill;
            if (killId && openApps.has(killId)) {
                openApps.get(killId).windowElement.querySelector('.close').click();
            }
        });
        const intervalId = setInterval(() => {
            if (!document.body.contains(panelWindow)) { clearInterval(intervalId); return; }
            if (panelWindow.querySelector('#dashboard-page').classList.contains('active')) updateDashboard();
            if (panelWindow.querySelector('#performance-page').classList.contains('active')) updatePerformancePage();
            if (panelWindow.querySelector('#logs-page').classList.contains('active')) updateLogs();
        }, 1500);
        updateDashboard();
        updatePerformancePage();
        updateLogs();
        analyzeStorage();
        const originalCloseHandler = panelWindow.querySelector('.close').onclick;
        panelWindow.querySelector('.close').onclick = () => {
            clearInterval(intervalId);
            window.createNotification = originalCreateNotification;
            if (originalCloseHandler) originalCloseHandler();
        };
    }
},
{
    id: 'animation-studio',
    name: '',
    icon: 'fas fa-film',
    installed: true,
    launcher: () => {
        const windowId = `app-window-animation-studio-${Date.now()}`;
        const content = `
            <style>
                .anim-studio-container { display: grid; grid-template-rows: auto 1fr auto auto; height: 100%; background-color: #333; }
                .anim-toolbar { display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; padding: 0.5rem; background-color: var(--header-bg-dark); border-bottom: 1px solid var(--border-color-dark); }
                .tool-group { display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem; background-color: var(--input-bg-dark); border-radius: 6px; }
                .tool-btn { width: 32px; height: 32px; border: none; border-radius: 4px; background-color: transparent; color: #ccc; cursor: pointer; transition: background-color 0.2s; }
                .tool-btn:hover { background-color: rgba(255,255,255,0.1); }
                .tool-btn:disabled { opacity: 0.3; cursor: not-allowed; }
                .tool-btn.active { background-color: #007bff; color: white; }
                .anim-canvas-wrapper { touch-action: none; position: relative; overflow: hidden; background-color: #282c34; cursor: default; }
                .anim-canvas-wrapper.panning { cursor: grabbing; }
                #anim-canvas-container { position: absolute; transform-origin: 0 0; will-change: transform; }
                #anim-canvas { background-color: white; box-shadow: 0 0 10px rgba(0,0,0,0.5); display: block; image-rendering: pixelated; }
                #onion-skin-canvas { position: absolute; pointer-events: none; top: 0; left: 0; image-rendering: pixelated; }
                .anim-timeline { padding: 0.5rem; background-color: var(--header-bg-dark); border-top: 1px solid var(--border-color-dark); display: flex; flex-direction: column; }
                .timeline-controls { display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem; }
                #frame-list { display: flex; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.5rem; min-height: 72px; align-items: center; }
                .frame-thumbnail { width: 100px; height: 60px; border: 2px solid #555; border-radius: 4px; background-color: #444; flex-shrink: 0; cursor: pointer; position: relative; }
                .frame-thumbnail img { width: 100%; height: 100%; object-fit: contain; }
                .frame-thumbnail.active { border-color: #007bff; box-shadow: 0 0 5px #007bff; }
                .frame-thumbnail.dragging { opacity: 0.5; }
                .frame-number { position: absolute; bottom: 2px; right: 4px; font-size: 0.7rem; color: white; background-color: rgba(0,0,0,0.5); padding: 1px 3px; border-radius: 2px; }
                .anim-statusbar { background-color: var(--sidebar-bg-dark); padding: 2px 8px; font-size: 0.75rem; color: #aaa; display: flex; justify-content: space-between; }
            </style>
            <div class="anim-studio-container">
                <div class="anim-toolbar">
                    <div class="tool-group">
                        <button class="tool-btn" data-action="newProject" title=""><i class="fas fa-file"></i></button>
                        <button class="tool-btn" data-action="saveProject" title=""><i class="fas fa-save"></i></button>
                        <button class="tool-btn" data-action="openProject" title=""><i class="fas fa-folder-open"></i></button>
                    </div>
                    <div class="tool-group">
                        <button class="tool-btn" data-action="undo" title=" (Ctrl+Z)" disabled><i class="fas fa-undo"></i></button>
                        <button class="tool-btn" data-action="redo" title=" (Ctrl+Y)" disabled><i class="fas fa-redo"></i></button>
                    </div>
                    <div class="tool-group">
                        <button class="tool-btn active" data-tool="pen" title=""><i class="fas fa-pen"></i></button>
                        <button class="tool-btn" data-tool="eraser" title=""><i class="fas fa-eraser"></i></button>
                        <button class="tool-btn" data-tool="fill" title=""><i class="fas fa-fill-drip"></i></button>
                        <button class="tool-btn" data-tool="eyedropper" title=""><i class="fas fa-eye-dropper"></i></button>
                        <button class="tool-btn" data-tool="rect" title=""><i class="far fa-square"></i></button>
                        <button class="tool-btn" data-tool="circle" title=""><i class="far fa-circle"></i></button>
                    </div>
                    <div class="tool-group">
                        <input type="color" id="anim-color-picker" title="" value="#000000" style="width:32px; height:32px; border:none; padding:2px; background-color:transparent; border-radius: 50%;">
                        <label class="text-sm">:</label>
                        <input type="range" id="anim-size-slider" min="1" max="100" value="5" title="" style="width: 80px;">
                        <input type="number" id="anim-size-input" min="1" max="100" value="5" style="width: 50px; background-color: var(--input-bg-dark); border: 1px solid #555; color: white; text-align: center; border-radius: 4px;">
                    </div>
                    <div class="tool-group">
                        <button class="tool-btn active" data-onion-mode="off" title=": "><i class="fas fa-eye-slash"></i></button>
                        <button class="tool-btn" data-onion-mode="trace" title=": "><i class="fas fa-layer-group"></i></button>
                        <button class="tool-btn" data-onion-mode="edit" title=": "><i class="fas fa-copy"></i></button>
                    </div>
                    <div class="flex-grow"></div>
                    <button class="bg-blue-600 text-white px-3 py-1 rounded-md text-sm" data-action="canvasSettings"></button>
                    <button class="bg-green-600 text-white px-4 py-1 rounded-md" data-action="exportGif">GIF</button>
                </div>
                <div class="anim-canvas-wrapper">
                    <div id="anim-canvas-container">
                        <canvas id="anim-canvas"></canvas>
                        <canvas id="onion-skin-canvas"></canvas>
                    </div>
                </div>
                <div class="anim-timeline">
                    <div class="timeline-controls">
                        <button class="tool-btn" data-action="play"><i class="fas fa-play"></i></button>
                        <label class="text-sm">FPS: <span id="fps-value">12</span></label>
                        <input type="range" id="fps-slider" min="1" max="30" value="12" style="width: 100px;">
                        <div class="flex-grow"></div>
                        <button class="tool-btn" data-action="addFrame" title=""><i class="fas fa-plus-square"></i></button>
                        <button class="tool-btn" data-action="copyFrame" title=""><i class="far fa-copy"></i></button>
                        <button class="tool-btn" data-action="pasteFrame" title="" disabled><i class="fas fa-paste"></i></button>
                        <button class="tool-btn" data-action="deleteFrame" title=""><i class="fas fa-trash"></i></button>
                    </div>
                    <div id="frame-list"></div>
                </div>
                <div class="anim-statusbar">
                    <span id="zoom-status">100%</span>
                    <span id="canvas-size-status">640 x 360</span>
                    <span id="mouse-coords-status">X: -- Y: --</span>
                </div>
            </div>
        `;
        const studioWindow = createWindow(windowId, '', content, 900, 700);
        studioWindow.querySelector('.window-content').style.padding = '0';
        const dom = {
            wrapper: studioWindow.querySelector('.anim-canvas-wrapper'),
            container: studioWindow.querySelector('#anim-canvas-container'),
            canvas: studioWindow.querySelector('#anim-canvas'),
            onionCanvas: studioWindow.querySelector('#onion-skin-canvas'),
            frameList: studioWindow.querySelector('#frame-list'),
            fpsSlider: studioWindow.querySelector('#fps-slider'),
            fpsValue: studioWindow.querySelector('#fps-value'),
            mainToolbar: studioWindow.querySelector('.anim-toolbar'),
            timelineControls: studioWindow.querySelector('.timeline-controls'),
            colorPicker: studioWindow.querySelector('#anim-color-picker'),
            sizeSlider: studioWindow.querySelector('#anim-size-slider'),
            sizeInput: studioWindow.querySelector('#anim-size-input'),
            zoomStatus: studioWindow.querySelector('#zoom-status'),
            canvasSizeStatus: studioWindow.querySelector('#canvas-size-status'),
            coordsStatus: studioWindow.querySelector('#mouse-coords-status'),
        };
        const ctx = dom.canvas.getContext('2d', { willReadFrequently: true });
        const onionCtx = dom.onionCanvas.getContext('2d');
        let project = { canvasWidth: 640, canvasHeight: 360, frames: [], fps: 12 };
        let activeFrameIndex = 0;
        let isDrawing = false;
        let lastPos = { x: 0, y: 0 };
        let currentTool = 'pen';
        let brushColor = '#000000';
        let brushSizes = { pen: 5, eraser: 20, fill: 1, eyedropper: 1, rect: 2, circle: 2 };
        let isPlaying = false;
        let playbackInterval = null;
        let onionSkinMode = 'off';
        let viewTransform = { x: 0, y: 0, scale: 1 };
        let isPanning = false;
        let panStart = { x: 0, y: 0 };
        let history = [];
        let historyIndex = -1;
        let frameClipboard = null;
        let snapshot = null;
        const createBlankFrame = () => {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = project.canvasWidth;
            tempCanvas.height = project.canvasHeight;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.fillStyle = 'white';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            return { id: Date.now() + Math.random(), data: tempCanvas.toDataURL() };
        };
        const init = () => {
            dom.canvas.width = project.canvasWidth;
            dom.canvas.height = project.canvasHeight;
            dom.onionCanvas.width = project.canvasWidth;
            dom.onionCanvas.height = project.canvasHeight;
            dom.canvasSizeStatus.textContent = `${project.canvasWidth} x ${project.canvasHeight}`;
            project.frames = [createBlankFrame()];
            activeFrameIndex = 0;
            centerCanvas();
            loadFrameOntoCanvas();
            renderTimeline();
            history = [];
            historyIndex = -1;
            saveState();
            updateHistoryButtons();
        };
        const centerCanvas = () => {
            const wrapperRect = dom.wrapper.getBoundingClientRect();
            if (wrapperRect.width === 0 || wrapperRect.height === 0) return;
            viewTransform.scale = Math.min(wrapperRect.width / project.canvasWidth, wrapperRect.height / project.canvasHeight) * 0.9;
            viewTransform.x = (wrapperRect.width - project.canvasWidth * viewTransform.scale) / 2;
            viewTransform.y = (wrapperRect.height - project.canvasHeight * viewTransform.scale) / 2;
            applyViewTransform();
        };
        new ResizeObserver(centerCanvas).observe(dom.wrapper);
        const applyViewTransform = () => {
            dom.container.style.transform = `translate(${viewTransform.x}px, ${viewTransform.y}px) scale(${viewTransform.scale})`;
            dom.zoomStatus.textContent = `${Math.round(viewTransform.scale * 100)}%`;
        };
        const getCanvasCoords = (e) => {
            const wrapperRect = dom.wrapper.getBoundingClientRect();
            const x = (e.clientX - wrapperRect.left - viewTransform.x) / viewTransform.scale;
            const y = (e.clientY - wrapperRect.top - viewTransform.y) / viewTransform.scale;
            return { x, y };
        };
        const saveState = () => {
            if (!project.frames[activeFrameIndex]) return;
            history.length = historyIndex + 1;
            history.push(project.frames[activeFrameIndex].data);
            historyIndex++;
            updateHistoryButtons();
        };
        const undo = () => {
            if (historyIndex > 0) {
                historyIndex--;
                project.frames[activeFrameIndex].data = history[historyIndex];
                loadFrameOntoCanvas();
                updateFrameThumbnail();
            }
            updateHistoryButtons();
        };
        const redo = () => {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                project.frames[activeFrameIndex].data = history[historyIndex];
                loadFrameOntoCanvas();
                updateFrameThumbnail();
            }
            updateHistoryButtons();
        };
        const updateHistoryButtons = () => {
            dom.mainToolbar.querySelector('[data-action="undo"]').disabled = historyIndex <= 0;
            dom.mainToolbar.querySelector('[data-action="redo"]').disabled = historyIndex >= history.length - 1;
        };
        const renderTimeline = () => {
            const activeFrameIdBeforeRender = project.frames[activeFrameIndex]?.id;
            dom.frameList.innerHTML = '';
            project.frames.forEach((frame, index) => {
                const thumb = document.createElement('div');
                thumb.className = 'frame-thumbnail';
                thumb.draggable = true;
                thumb.dataset.id = frame.id;
                thumb.innerHTML = `<img src="${frame.data}"><span class="frame-number">${index + 1}</span>`;
                thumb.addEventListener('click', () => {
                    if (isPlaying) return;
                    const newIndex = project.frames.findIndex(f => f.id === frame.id);
                    if(activeFrameIndex === newIndex) return;
                    activeFrameIndex = newIndex;
                    loadFrameOntoCanvas();
                    renderTimeline();
                    history = [project.frames[activeFrameIndex].data];
                    historyIndex = 0;
                    updateHistoryButtons();
                });
                thumb.addEventListener('dragstart', (e) => {
                    e.target.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', frame.id);
                });
                thumb.addEventListener('dragend', (e) => e.target.classList.remove('dragging'));
                thumb.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const dragging = dom.frameList.querySelector('.dragging');
                    if (dragging && dragging !== thumb) {
                        const rect = thumb.getBoundingClientRect();
                        if (e.clientX > rect.left + rect.width / 2) {
                            thumb.after(dragging);
                        } else {
                            thumb.before(dragging);
                        }
                    }
                });
                dom.frameList.appendChild(thumb);
            });
            const activeThumb = dom.frameList.querySelector(`[data-id="${activeFrameIdBeforeRender}"]`);
            if (activeThumb) {
                activeThumb.classList.add('active');
            }
        };
        dom.frameList.addEventListener('drop', (e) => {
            e.preventDefault();
            const activeFrameId = project.frames[activeFrameIndex].id;
            const newFrames = Array.from(dom.frameList.querySelectorAll('.frame-thumbnail')).map(thumb => {
                 return project.frames.find(f => f.id == thumb.dataset.id);
            });
            project.frames = newFrames;
            activeFrameIndex = project.frames.findIndex(f => f.id === activeFrameId);
            renderTimeline();
        });
        const loadFrameOntoCanvas = () => {
            if (!project.frames[activeFrameIndex]) return;
            const img = new Image();
            img.onload = () => {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, dom.canvas.width, dom.canvas.height);
                ctx.drawImage(img, 0, 0);
                drawOnionSkin();
            };
            img.src = project.frames[activeFrameIndex].data;
        };
        const drawOnionSkin = () => {
            onionCtx.clearRect(0, 0, dom.onionCanvas.width, dom.onionCanvas.height);
            dom.onionCanvas.style.pointerEvents = 'none';
            dom.onionCanvas.style.opacity = '0.3';
            if (onionSkinMode === 'trace' && activeFrameIndex > 0) {
                const prevFrame = project.frames[activeFrameIndex - 1];
                const img = new Image();
                img.onload = () => onionCtx.drawImage(img, 0, 0);
                img.src = prevFrame.data;
            }
        };
        const updateFrameData = () => {
            project.frames[activeFrameIndex].data = dom.canvas.toDataURL();
            updateFrameThumbnail();
            drawOnionSkin();
        };
        const updateFrameThumbnail = () => {
            const activeThumbImg = dom.frameList.querySelector(`.frame-thumbnail.active img`);
            if (activeThumbImg) activeThumbImg.src = project.frames[activeFrameIndex].data;
        };
        const startDrawing = (e) => {
            if (isPanning || !project.frames[activeFrameIndex]) return;
            isDrawing = true;
            lastPos = getCanvasCoords(e);
            snapshot = ctx.getImageData(0, 0, dom.canvas.width, dom.canvas.height);
            if (currentTool === 'pen' || currentTool === 'eraser') {
                drawDot(lastPos.x, lastPos.y);
            } else if (currentTool === 'fill') {
                floodFill(ctx, Math.round(lastPos.x), Math.round(lastPos.y), hexToRgba(brushColor));
                updateFrameData();
                saveState();
                isDrawing = false;
            } else if (currentTool === 'eyedropper') {
                const pixel = ctx.getImageData(lastPos.x, lastPos.y, 1, 1).data;
                brushColor = rgbaToHex(pixel[0], pixel[1], pixel[2]);
                dom.colorPicker.value = brushColor;
                isDrawing = false;
                dom.mainToolbar.querySelector('[data-tool="pen"]').click();
            }
        };
        const draw = (e) => {
            const currentPos = getCanvasCoords(e);
            dom.coordsStatus.textContent = `X: ${Math.round(currentPos.x)} Y: ${Math.round(currentPos.y)}`;
            if (!isDrawing || isPanning) return;
            if (currentTool === 'pen' || currentTool === 'eraser') {
                ctx.globalCompositeOperation = (currentTool === 'eraser') ? 'destination-out' : 'source-over';
                ctx.strokeStyle = (currentTool === 'eraser') ? 'rgba(0,0,0,1)' : brushColor;
                ctx.lineWidth = brushSizes[currentTool];
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.beginPath();
                ctx.moveTo(lastPos.x, lastPos.y);
                ctx.lineTo(currentPos.x, currentPos.y);
                ctx.stroke();
            } else if (['rect', 'circle'].includes(currentTool)) {
                ctx.putImageData(snapshot, 0, 0);
                drawShape(currentPos);
            }
            lastPos = currentPos;
        };
const drawDot = (x, y) => {
    ctx.globalCompositeOperation = (currentTool === 'eraser') ? 'destination-out' : 'source-over';
    ctx.fillStyle = (currentTool === 'eraser') ? 'rgba(0,0,0,1)' : brushColor;
    ctx.beginPath();
    ctx.arc(x, y, brushSizes[currentTool] / 2, 0, Math.PI * 2);
    ctx.fill();
};
const stopDrawing = (e) => {
    if (isDrawing) {
        if (['rect', 'circle', 'line'].includes(currentTool)) {
            ctx.putImageData(snapshot, 0, 0);
            drawShape(getCanvasCoords(e));
        }
        updateFrameData();
    }
    isDrawing = false;
    if (dom.container.hasPointerCapture(e.pointerId)) {
        dom.container.releasePointerCapture(e.pointerId);
    }
};
        const drawShape = (to) => {
            ctx.strokeStyle = brushColor;
            ctx.fillStyle = brushColor;
            ctx.lineWidth = brushSizes[currentTool];
            ctx.beginPath();
            if (currentTool === 'rect') {
                ctx.rect(lastPos.x, lastPos.y, to.x - lastPos.x, to.y - lastPos.y);
            } else if (currentTool === 'circle') {
                const radiusX = Math.abs(to.x - lastPos.x) / 2;
                const radiusY = Math.abs(to.y - lastPos.y) / 2;
                const centerX = lastPos.x + (to.x - lastPos.x) / 2;
                const centerY = lastPos.y + (to.y - lastPos.y) / 2;
                ctx.ellipse(centerX, centerY, radiusX, radiusY, 0, 0, 2 * Math.PI);
            }
            ctx.stroke();
        };
dom.container.addEventListener('pointerdown', (e) => {
    if ((e.pointerType === 'mouse' && e.button !== 0) || isPanning || !project.frames[activeFrameIndex]) return;
    saveState();
    isDrawing = true;
    dom.container.setPointerCapture(e.pointerId);
    lastPos = getCanvasCoords(e);
    snapshot = ctx.getImageData(0, 0, dom.canvas.width, dom.canvas.height);
    if (currentTool === 'pen' || currentTool === 'eraser') {
        drawDot(lastPos.x, lastPos.y);
    } else if (currentTool === 'fill') {
        floodFill(ctx, Math.round(lastPos.x), Math.round(lastPos.y), hexToRgba(brushColor));
        updateFrameData();
        saveState();
        isDrawing = false;
    } else if (currentTool === 'eyedropper') {
        const pixel = ctx.getImageData(lastPos.x, lastPos.y, 1, 1).data;
        brushColor = rgbaToHex(pixel[0], pixel[1], pixel[2]);
        dom.colorPicker.value = brushColor;
        isDrawing = false;
        dom.mainToolbar.querySelector('[data-tool="pen"]').click();
    }
});
dom.container.addEventListener('pointermove', (e) => {
    const currentPos = getCanvasCoords(e);
    dom.coordsStatus.textContent = `X: ${Math.round(currentPos.x)} Y: ${Math.round(currentPos.y)}`;
    if (!isDrawing || isPanning) return;
    if (currentTool === 'pen' || currentTool === 'eraser') {
        ctx.globalCompositeOperation = (currentTool === 'eraser') ? 'destination-out' : 'source-over';
        ctx.strokeStyle = (currentTool === 'eraser') ? 'rgba(0,0,0,1)' : brushColor;
        ctx.lineWidth = brushSizes[currentTool];
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.beginPath();
        ctx.moveTo(lastPos.x, lastPos.y);
        ctx.lineTo(currentPos.x, currentPos.y);
        ctx.stroke();
    } else if (['rect', 'circle', 'line'].includes(currentTool)) {
        ctx.putImageData(snapshot, 0, 0);
        drawShape(currentPos);
    }
    lastPos = currentPos;
});
dom.container.addEventListener('pointerup', stopDrawing);
dom.container.addEventListener('pointerleave', stopDrawing);
        dom.wrapper.addEventListener('wheel', (e) => {
            if (!e.ctrlKey && !e.metaKey) return;
            e.preventDefault();
            const rect = dom.wrapper.getBoundingClientRect();
            const mouseX = e.clientX - rect.left, mouseY = e.clientY - rect.top;
            const wheel = e.deltaY < 0 ? 1.1 : 1 / 1.1;
            const newScale = Math.max(0.1, Math.min(10, viewTransform.scale * wheel));
            const scaleRatio = newScale / viewTransform.scale;
            viewTransform.x = mouseX - (mouseX - viewTransform.x) * scaleRatio;
            viewTransform.y = mouseY - (mouseY - viewTransform.y) * scaleRatio;
            viewTransform.scale = newScale;
            applyViewTransform();
        });
        studioWindow.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            if (e.code === 'Space' && !isPanning) { e.preventDefault(); isPanning = true; dom.wrapper.classList.add('panning'); }
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
            if ((e.ctrlKey || e.metaKey) && e.key === 'y') { e.preventDefault(); redo(); }
        });
        studioWindow.addEventListener('keyup', (e) => {
            if (e.code === 'Space') { isPanning = false; dom.wrapper.classList.remove('panning'); }
        });
        dom.wrapper.addEventListener('mousedown', (e) => {
            if (isPanning) {
                dom.wrapper.style.cursor = 'grabbing';
                panStart = { x: e.clientX, y: e.clientY };
                dom.wrapper.addEventListener('mousemove', onPan);
                dom.wrapper.addEventListener('mouseup', onPanEnd, { once: true });
            }
        });
        const onPan = (e) => {
            const dx = e.clientX - panStart.x, dy = e.clientY - panStart.y;
            viewTransform.x += dx; viewTransform.y += dy;
            panStart = { x: e.clientX, y: e.clientY };
            applyViewTransform();
        };
        const onPanEnd = () => {
            dom.wrapper.style.cursor = 'default';
            dom.wrapper.removeEventListener('mousemove', onPan);
        };
        const handleAction = async (action) => {
            const playBtnIcon = dom.timelineControls.querySelector('[data-action="play"] i');
            switch(action) {
                case 'undo': undo(); break;
                case 'redo': redo(); break;
                case 'newProject': if (await showMessageBox('', '', {showCancel: true})) init(); break;
                case 'saveProject':
                    const targetSave = await showFilePicker({ mode: 'save', title: '', defaultName: 'animation.ranim' });
                    if (targetSave) {
                        const projectData = { ...project };
                        const blob = new Blob([JSON.stringify(projectData)], {type: 'application/json'});
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            await VFS.writeFile(targetSave.path.substring(0, targetSave.path.lastIndexOf('/')) || '/', targetSave.name, 'application/rivift-animation', e.target.result);
                            createNotification('', `${targetSave.name}`, 'info');
                        };
                        reader.readAsDataURL(blob);
                    }
                    break;
                case 'openProject':
                    const filePath = await showFilePicker({ mode: 'open', title: '', acceptTypes: ['application/rivift-animation'] });
                    if(filePath) {
                        const fileData = await VFS.readFile(filePath);
                        const res = await fetch(fileData.content);
                        const projectData = await res.json();
                        project = projectData;
                        dom.canvas.width = project.canvasWidth; dom.canvas.height = project.canvasHeight;
                        dom.onionCanvas.width = project.canvasWidth; dom.onionCanvas.height = project.canvasHeight;
                        dom.fpsSlider.value = project.fps || 12;
                        project.fps = dom.fpsSlider.value;
                        dom.fpsValue.textContent = project.fps;
                        activeFrameIndex = 0;
                        loadFrameOntoCanvas();
                        renderTimeline();
                        centerCanvas();
                        history = [project.frames[0].data];
                        historyIndex = 0;
                        updateHistoryButtons();
                    }
                    break;
                case 'play':
                    if (isPlaying) {
                        clearInterval(playbackInterval); isPlaying = false; playBtnIcon.className = 'fas fa-play';
                    } else {
                        isPlaying = true; playBtnIcon.className = 'fas fa-pause';
                        let playIndex = activeFrameIndex;
                        playbackInterval = setInterval(() => {
                            playIndex = (playIndex + 1) % project.frames.length;
                            activeFrameIndex = playIndex;
                            loadFrameOntoCanvas();
                            renderTimeline();
                        }, 1000 / project.fps);
                    }
                    break;
                case 'addFrame':
                    project.frames.splice(activeFrameIndex + 1, 0, createBlankFrame());
                    activeFrameIndex++;
                    loadFrameOntoCanvas();
                    renderTimeline();
                    history = [project.frames[activeFrameIndex].data];
                    historyIndex = 0;
                    updateHistoryButtons();
                    break;
                case 'copyFrame':
                    frameClipboard = JSON.parse(JSON.stringify(project.frames[activeFrameIndex]));
                    dom.timelineControls.querySelector('[data-action="pasteFrame"]').disabled = false;
                    createNotification('', '', 'info', 2);
                    break;
                case 'pasteFrame':
                    if (frameClipboard) {
                        const newFrame = JSON.parse(JSON.stringify(frameClipboard));
                        newFrame.id = Date.now() + Math.random();
                        project.frames.splice(activeFrameIndex + 1, 0, newFrame);
                        activeFrameIndex++;
                        loadFrameOntoCanvas();
                        renderTimeline();
                        saveState();
                    }
                    break;
                case 'deleteFrame':
                    if (project.frames.length > 1) {
                        project.frames.splice(activeFrameIndex, 1);
                        activeFrameIndex = Math.max(0, activeFrameIndex - 1);
                        loadFrameOntoCanvas();
                        renderTimeline();
                    }
                    break;
                case 'exportGif': exportAsGif(); break;
                case 'canvasSettings':
                    const result = await showMessageBox('', '', { showCancel: true, customHtmlContent: `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"><label>: <input type="number" id="canvas-w" value="${project.canvasWidth}" class="w-full p-1 bg-transparent border rounded"></label><label>: <input type="number" id="canvas-h" value="${project.canvasHeight}" class="w-full p-1 bg-transparent border rounded"></label></div>`});
                    if (result) {
                        const newW = parseInt(document.getElementById('canvas-w').value), newH = parseInt(document.getElementById('canvas-h').value);
                        if (newW > 0 && newH > 0) { project.canvasWidth = newW; project.canvasHeight = newH; init(); }
                    }
                    break;
            }
        };
        dom.mainToolbar.addEventListener('click', e => {
            const target = e.target.closest('button'); if (!target) return;
            if (target.dataset.tool) {
                dom.mainToolbar.querySelector('.tool-btn.active[data-tool]')?.classList.remove('active');
                target.classList.add('active');
                currentTool = target.dataset.tool;
                dom.sizeSlider.value = brushSizes[currentTool];
                dom.sizeInput.value = brushSizes[currentTool];
            }
            if (target.dataset.action) {
                handleAction(target.dataset.action);
            }
            if (target.dataset.onionMode) {
                onionSkinMode = target.dataset.onionMode;
                if (onionSkinMode === 'edit') {
                    if (activeFrameIndex > 0) {
                        const prevFrameData = project.frames[activeFrameIndex - 1].data;
                        const img = new Image();
                        img.onload = () => {
                            ctx.drawImage(img, 0, 0);
                            updateFrameData();
                            saveState();
                        };
                        img.src = prevFrameData;
                    }
                }
                dom.mainToolbar.querySelectorAll('[data-onion-mode]').forEach(b => b.classList.remove('active'));
                target.classList.add('active');
                drawOnionSkin();
            }
        });
        dom.timelineControls.addEventListener('click', e => {
            const target = e.target.closest('button[data-action]');
            if (target) handleAction(target.dataset.action);
        });
        dom.colorPicker.addEventListener('input', e => brushColor = e.target.value);
        const updateBrushSize = (value) => {
            const size = Math.max(1, Math.min(100, parseInt(value)));
            brushSizes[currentTool] = size;
            dom.sizeSlider.value = size;
            dom.sizeInput.value = size;
        };
        dom.sizeSlider.addEventListener('input', e => updateBrushSize(e.target.value));
        dom.sizeInput.addEventListener('change', e => updateBrushSize(e.target.value));
        dom.fpsSlider.addEventListener('input', e => {
            project.fps = e.target.value;
            dom.fpsValue.textContent = project.fps;
            if (isPlaying) { handleAction('play'); handleAction('play'); }
        });
        const exportAsGif = () => {
            createNotification('', 'GIF...', 'info');
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            const iDoc = iframe.contentDocument;
            iDoc.open();
            iDoc.write(`<script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"><\/script><script>
                window.addEventListener('message', (event) => {
                    if (typeof GIF === 'undefined') {
                        window.parent.postMessage({ type: 'gif-error', message: 'gif.js not loaded' }, '*');
                        return;
                    }
                    const { frames, fps, width, height } = event.data;
                    const gif = new GIF({ workers: 2, quality: 10, width, height });
                    gif.on('finished', (blob) => window.parent.postMessage({ type: 'gif-done', blob }, '*'));
                    const addFrameToGif = (frameData) => new Promise(resolve => {
                        const img = new Image();
                        img.onload = () => { gif.addFrame(img, { delay: 1000 / fps }); resolve(); };
                        img.onerror = () => resolve();
                        img.src = frameData;
                    });
                    (async () => {
                        for (const frame of frames) await addFrameToGif(frame.data);
                        gif.render();
                    })();
                });
            <\/script>`);
            iDoc.close();
            const handleGifResult = async (event) => {
                if (event.source === iframe.contentWindow) {
                    if(event.data.type === 'gif-done') {
                        const blob = event.data.blob;
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            const target = await showFilePicker({ mode: 'save', title: 'GIF', defaultName: 'animation.gif' });
                            if (target) {
                                await VFS.writeFile(target.path.substring(0, target.path.lastIndexOf('/')) || '/', target.name, 'image/gif', e.target.result);
                                createNotification('', 'GIF', 'info');
                            }
                        };
                        reader.readAsDataURL(blob);
                    } else if (event.data.type === 'gif-error') {
                        createNotification('GIF', event.data.message, 'error');
                    }
                    window.removeEventListener('message', handleGifResult);
                    document.body.removeChild(iframe);
                }
            };
            window.addEventListener('message', handleGifResult);
            iframe.onload = () => {
                iframe.contentWindow.postMessage({ frames: project.frames, fps: project.fps, width: project.canvasWidth, height: project.canvasHeight }, '*');
            };
        };
        const hexToRgba = (hex) => {
            let r=0, g=0, b=0, a=255;
            if(hex.length==4){ r=parseInt(hex[1]+hex[1],16); g=parseInt(hex[2]+hex[2],16); b=parseInt(hex[3]+hex[3],16); }
            else if(hex.length==7){ r=parseInt(hex.substring(1,3),16); g=parseInt(hex.substring(3,5),16); b=parseInt(hex.substring(5,7),16); }
            return [r,g,b,a];
        };
        const rgbaToHex = (r,g,b) => '#' + ((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1).toUpperCase();
        const floodFill = (ctx, x, y, fillColor) => {
            const imageData = ctx.getImageData(0,0,ctx.canvas.width,ctx.canvas.height);
            const {width, height, data} = imageData;
            const startX = Math.round(x);
            const startY = Math.round(y);
            const targetColor = [data[(startY*width+startX)*4],data[(startY*width+startX)*4+1],data[(startY*width+startX)*4+2],data[(startY*width+startX)*4+3]];
            if(targetColor[0] === fillColor[0] && targetColor[1] === fillColor[1] && targetColor[2] === fillColor[2] && targetColor[3] === fillColor[3]) return;
            const stack = [[startX,startY]];
            while(stack.length){
                const [curX, curY] = stack.pop();
                if(curX<0||curX>=width||curY<0||curY>=height) continue;
                const idx = (curY*width+curX)*4;
                if(data[idx]===targetColor[0]&&data[idx+1]===targetColor[1]&&data[idx+2]===targetColor[2]&&data[idx+3]===targetColor[3]){
                    data[idx]=fillColor[0]; data[idx+1]=fillColor[1]; data[idx+2]=fillColor[2]; data[idx+3]=fillColor[3];
                    stack.push([curX+1,curY]); stack.push([curX-1,curY]); stack.push([curX,curY+1]); stack.push([curX,curY-1]);
                }
            }
            ctx.putImageData(imageData,0,0);
        };
        const originalCloseHandler = studioWindow.querySelector('.close').onclick;
        studioWindow.querySelector('.close').onclick = () => {
            clearInterval(playbackInterval);
            if (originalCloseHandler) originalCloseHandler();
        };
        init();
    }
},
{
    id: 'music-creator',
    name: 'Music Creator',
    icon: 'fas fa-music',
    installed: true,
launcher: (params = {}) => {
    const windowId = `app-window-music-creator-${Date.now()}`;
    const BEAT_WIDTH = 50;
    const NOTE_HEIGHT = 20;
    const TOTAL_BEATS = 16 * 4;
    const PITCHES = [
        'C6', 'B5', 'A#5', 'A5', 'G#5', 'G5', 'F#5', 'F5', 'E5', 'D#5', 'D5', 'C#5', 
        'C5', 'B4', 'A#4', 'A4', 'G#4', 'G4', 'F#4', 'F4', 'E4', 'D#4', 'D4', 'C#4', 
        'C4', 'B3', 'A#3', 'A3', 'G#3', 'G3', 'F#3', 'F3', 'E3', 'D#3', 'D3', 'C#3', 
        'C3', 'B2', 'A#2', 'A2', 'G#2', 'G2', 'F#2', 'F2', 'E2', 'D#2', 'D2', 'C#2', 'C2'
    ];
    const content = `
        <style>
            .piano-roll-app { display: grid; grid-template-rows: auto 1fr; height: 100%; background-color: var(--window-bg-dark); color: var(--text-color-dark); }
            body.light-mode .piano-roll-app { background-color: var(--window-bg-light); color: var(--text-color-light); }
            .pr-toolbar { display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1.5rem; border-bottom: 1px solid var(--border-color-dark); background-color: var(--header-bg-dark); }
            body.light-mode .pr-toolbar { border-color: var(--border-color-light); background-color: var(--header-bg-light); }
            .pr-toolbar-btn { font-size: 1.5rem; color: var(--text-color-dark); background: none; border: none; cursor: pointer; transition: transform 0.1s; }
            body.light-mode .pr-toolbar-btn { color: var(--text-color-light); }
            .pr-toolbar-btn:active { transform: scale(0.9); }
            .pr-control-group { display: flex; align-items: center; gap: 0.5rem; }
            .pr-control-group label { font-size: 0.9rem; color: #aaa; }
            body.light-mode .pr-control-group label { color: #555; }
            .pr-control-group input, .pr-control-group .instrument-btn {
                background-color: var(--input-bg-dark);
                color: var(--text-color-dark);
                border: 1px solid var(--border-color-dark);
                border-radius: 6px; padding: 4px 8px; text-align: center;
            }
            body.light-mode .pr-control-group input, body.light-mode .pr-control-group .instrument-btn {
                background-color: var(--input-bg-light);
                color: var(--text-color-light);
                border-color: var(--border-color-light);
            }
            #mc-project-title { width: 200px; outline: none; } 
            .instrument-btn { cursor: pointer; transition: background-color 0.2s; }
            .instrument-btn.active { background-color: #007bff; color: white; border-color: #007bff; }
            .pr-piano-roll-wrapper { position: relative; overflow: auto; background-color: #2c2d30; }
            body.light-mode .pr-piano-roll-wrapper { background-color: #f1f3f4; }
            #pr-canvas { position: absolute; top: 0; left: 0; }
            #pr-playhead { position: absolute; top: 0; left: 0; width: 2px; height: 100%; background-color: #f44336; pointer-events: none; z-index: 10; }
        </style>
        <div class="piano-roll-app">
            <div class="pr-toolbar">
                <!--  VFS  -->
                <button id="pr-btn-save" class="pr-toolbar-btn" title=""><i class="fas fa-save"></i></button>
                <button id="pr-btn-open" class="pr-toolbar-btn" title=""><i class="fas fa-folder-open"></i></button>
                <div style="width: 1px; height: 24px; background-color: var(--border-color-dark); margin: 0 0.5rem;"></div>
                <button id="pr-btn-play" class="pr-toolbar-btn" title=""><i class="fas fa-play"></i></button>
                <button id="pr-btn-stop" class="pr-toolbar-btn" title=""><i class="fas fa-stop"></i></button>
                <div class="pr-control-group">
                    <label>BPM:</label>
                    <input type="number" id="pr-bpm-input" value="120" min="40" max="240" style="width: 70px;">
                </div>
                <div class="pr-control-group" id="instrument-selector">
                    <label>:</label>
                    <button class="instrument-btn active" data-instrument="synth"></button>
                    <button class="instrument-btn" data-instrument="fmSynth">FM</button>
                    <button class="instrument-btn" data-instrument="sampler"></button>
                </div>
                <div class="flex-grow"></div> <!--  -->
                <input type="text" id="mc-project-title" value="">
            </div>
            <div class="pr-piano-roll-wrapper">
                <div id="pr-playhead"></div>
                <canvas id="pr-canvas"></canvas>
            </div>
        </div>
    `;
    const musicCreatorWindow = createWindow(windowId, 'Piano Roll', content, 900, 500);
    const contentArea = musicCreatorWindow.querySelector('.window-content');
    if (contentArea) { contentArea.style.padding = '0'; contentArea.style.overflow = 'hidden'; }
    const dom = {
        playBtn: musicCreatorWindow.querySelector('#pr-btn-play'),
        stopBtn: musicCreatorWindow.querySelector('#pr-btn-stop'),
        saveBtn: musicCreatorWindow.querySelector('#pr-btn-save'),
        openBtn: musicCreatorWindow.querySelector('#pr-btn-open'),
        bpmInput: musicCreatorWindow.querySelector('#pr-bpm-input'),
        titleInput: musicCreatorWindow.querySelector('#mc-project-title'),
        playIcon: musicCreatorWindow.querySelector('#pr-btn-play i'),
        canvas: musicCreatorWindow.querySelector('#pr-canvas'),
        container: musicCreatorWindow.querySelector('.pr-piano-roll-wrapper'),
        playhead: musicCreatorWindow.querySelector('#pr-playhead'),
        instrumentSelector: musicCreatorWindow.querySelector('#instrument-selector'),
    };
    if (typeof Tone === 'undefined') {
        dom.container.innerHTML = '<p class="text-red-500 p-4">: (Tone.js)</p>';
        return;
    }
    const instruments = {
        synth: new Tone.PolySynth(Tone.Synth).toDestination(),
        fmSynth: new Tone.PolySynth(Tone.FMSynth).toDestination(),
        sampler: new Tone.Sampler({
            urls: { "C4": "C4.mp3", "D#4": "Ds4.mp3", "F#4": "Fs4.mp3", "A4": "A4.mp3" },
            baseUrl: "https://tonejs.github.io/audio/salamander/",
        }).toDestination()
    };
    let activeInstrument = instruments.synth;
    let currentFilePath = null;
    let project = {
        title: '',
        bpm: 120,
        instrument: 'synth',
        notes: []
    };
    let scheduledPart = null;
    const ctx = dom.canvas.getContext('2d');
    const loadProjectData = (data) => {
        project = data;
        dom.titleInput.value = project.title;
        dom.bpmInput.value = project.bpm;
        Tone.Transport.bpm.value = project.bpm;
        dom.instrumentSelector.querySelectorAll('.instrument-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.instrument === project.instrument);
        });
        activeInstrument = instruments[project.instrument] || instruments.synth;
        renderPianoRoll();
        schedulePlayback();
    };
    const renderPianoRoll = () => {
        const isDark = isDarkMode;
        dom.canvas.width = TOTAL_BEATS * BEAT_WIDTH;
        dom.canvas.height = PITCHES.length * NOTE_HEIGHT;
        ctx.clearRect(0, 0, dom.canvas.width, dom.canvas.height);
        for (let i = 0; i < PITCHES.length; i++) {
            const isBlackKey = PITCHES[i].includes('#');
            const isOctaveBoundary = PITCHES[i].startsWith('C');
            if (isBlackKey) ctx.fillStyle = isDark ? '#3a3a3c' : '#e0e0e0';
            else if (isOctaveBoundary) ctx.fillStyle = isDark ? '#313235' : '#f8f9fa';
            else ctx.fillStyle = isDark ? '#2c2d30' : '#ffffff';
            ctx.fillRect(0, i * NOTE_HEIGHT, dom.canvas.width, NOTE_HEIGHT);
        }
        for (let i = 0; i <= TOTAL_BEATS; i++) {
            ctx.strokeStyle = (i % 4 === 0) ? (isDark ? '#666' : '#bbb') : (isDark ? '#444' : '#ddd');
            ctx.lineWidth = (i % 16 === 0) ? 2 : 1;
            ctx.beginPath();
            ctx.moveTo(i * BEAT_WIDTH, 0);
            ctx.lineTo(i * BEAT_WIDTH, dom.canvas.height);
            ctx.stroke();
        }
        ctx.fillStyle = '#007bff';
        ctx.strokeStyle = '#66b0ff';
        ctx.lineWidth = 2;
        project.notes.forEach(note => {
            const pitchIndex = PITCHES.indexOf(note.pitch);
            if (pitchIndex > -1) {
                const x = Tone.Time(note.time).toSeconds() * (project.bpm / 60) * BEAT_WIDTH;
                const y = pitchIndex * NOTE_HEIGHT;
                const width = Tone.Time(note.duration).toSeconds() * (project.bpm / 60) * BEAT_WIDTH;
                ctx.fillRect(x, y, width, NOTE_HEIGHT);
                ctx.strokeRect(x, y, width, NOTE_HEIGHT);
            }
        });
    };
    const schedulePlayback = () => {
        if (scheduledPart) scheduledPart.dispose();
        if (project.notes.length > 0) {
            scheduledPart = new Tone.Part((time, value) => {
                activeInstrument.triggerAttackRelease(value.pitch, value.duration, time);
            }, project.notes).start(0);
            scheduledPart.loop = true;
            scheduledPart.loopEnd = `${TOTAL_BEATS / 4}m`;
        }
    };
    const animatePlayhead = () => {
        if (!musicCreatorWindow || !document.body.contains(musicCreatorWindow)) return;
        const position = Tone.Time(Tone.Transport.position).toSeconds();
        const pixelsPerSecond = (Tone.Transport.bpm.value / 60) * BEAT_WIDTH;
        dom.playhead.style.transform = `translateX(${position * pixelsPerSecond}px)`;
        requestAnimationFrame(animatePlayhead);
    };
    dom.playBtn.addEventListener('click', () => {
        if (Tone.context.state !== 'running') Tone.start();
        if (Tone.Transport.state === 'started') Tone.Transport.pause();
        else { schedulePlayback(); Tone.Transport.start(); }
    });
    dom.stopBtn.addEventListener('click', () => Tone.Transport.stop());
    dom.bpmInput.addEventListener('change', (e) => {
        const newBpm = parseInt(e.target.value);
        if (!isNaN(newBpm) && newBpm >= 40 && newBpm <= 240) {
            project.bpm = newBpm;
            Tone.Transport.bpm.value = newBpm;
            renderPianoRoll();
        }
    });
    dom.titleInput.addEventListener('change', (e) => {
        project.title = e.target.value || '';
    });
    dom.instrumentSelector.addEventListener('click', (e) => {
        const button = e.target.closest('.instrument-btn');
        if (button) {
            const instrumentName = button.dataset.instrument;
            project.instrument = instrumentName;
            activeInstrument = instruments[instrumentName];
            dom.instrumentSelector.querySelectorAll('.instrument-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            if (Tone.Transport.state === 'started') schedulePlayback();
        }
    });
    Tone.Transport.on('start stop pause', () => {
        requestAnimationFrame(() => {
            dom.playIcon.className = (Tone.Transport.state === 'started') ? 'fas fa-pause' : 'fas fa-play';
        });
    });
dom.canvas.addEventListener('mousedown', (e) => {
    const rect = dom.canvas.getBoundingClientRect();
    const x = e.clientX - rect.left + dom.container.scrollLeft;
    const y = e.clientY - rect.top + dom.container.scrollTop;
    const beat = Math.floor(x / BEAT_WIDTH);
    const pitchIndex = Math.floor(y / NOTE_HEIGHT);
    if (pitchIndex < 0 || pitchIndex >= PITCHES.length) return;
    const rootPitch = PITCHES[pitchIndex];
    const time = `${Math.floor(beat / 4)}:${beat % 4}:0`;
    const getMidiFromPitch = (pitch) => {
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const octave = parseInt(pitch.slice(-1));
        const note = pitch.slice(0, -1);
        return noteNames.indexOf(note) + (octave + 1) * 12;
    };
    const getPitchFromMidi = (midi) => {
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const octave = Math.floor(midi / 12) - 1;
        const noteIndex = midi % 12;
        return noteNames[noteIndex] + octave;
    };
    if (e.ctrlKey || e.metaKey) {
        const rootMidi = getMidiFromPitch(rootPitch);
        const chordMidiNumbers = [rootMidi, rootMidi + 4, rootMidi + 7];
        chordMidiNumbers.forEach(midiNumber => {
            const pitch = getPitchFromMidi(midiNumber);
            const existingNoteIndex = project.notes.findIndex(note => note.pitch === pitch && note.time === time);
            if (existingNoteIndex === -1) {
                project.notes.push({ time, pitch, duration: '4n' });
            }
        });
        activeInstrument.triggerAttackRelease(chordMidiNumbers.map(getPitchFromMidi), '8n');
    } else {
        const existingNoteIndex = project.notes.findIndex(note => note.pitch === rootPitch && note.time === time);
        if (existingNoteIndex > -1) {
            project.notes.splice(existingNoteIndex, 1);
        } else {
            project.notes.push({ time, pitch: rootPitch, duration: '4n' });
            activeInstrument.triggerAttackRelease(rootPitch, '8n');
        }
    }
    project.notes.sort((a, b) => Tone.Time(a.time).toSeconds() - Tone.Time(b.time).toSeconds());
    renderPianoRoll();
    if (Tone.Transport.state === 'started') {
        schedulePlayback();
    }
});
    dom.saveBtn.addEventListener('click', async () => {
        const target = currentFilePath ? { path: currentFilePath, name: project.title } : await showFilePicker({ mode: 'save', title: '', defaultName: `${project.title}.rcbeat` });
        if (target) {
            try {
                const dataToSave = JSON.stringify(project);
                const blob = new Blob([dataToSave], { type: 'application/json' });
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const parentPath = target.path.substring(0, target.path.lastIndexOf('/')) || '/';
                    await VFS.writeFile(parentPath, target.name, 'application/rivift-beat', event.target.result);
                    currentFilePath = target.path;
                    musicCreatorWindow.querySelector('.window-header span').textContent = project.title;
                    createNotification('', `${target.name}`, 'info');
                };
                reader.readAsDataURL(blob);
            } catch (err) {
                createNotification('', `: ${err.message}`, 'error');
            }
        }
    });
    dom.openBtn.addEventListener('click', async () => {
        const path = await showFilePicker({ mode: 'open', title: '', acceptTypes: ['application/rivift-beat'] });
        if (path) {
            try {
                const fileData = await readFileWithWorker(path);
                const response = await fetch(fileData.content);
                const text = await response.text();
                const loadedProject = JSON.parse(text);
                loadProjectData(loadedProject);
                currentFilePath = path;
                musicCreatorWindow.querySelector('.window-header span').textContent = loadedProject.title;
            } catch(err) {
                createNotification('', `: ${err.message}`, 'error');
            }
        }
    });
    const themeObserver = new MutationObserver(() => renderPianoRoll());
    themeObserver.observe(document.body, { attributes: true, attributeFilter: ['class'] });
    renderPianoRoll();
    animatePlayhead();
    applyTheme();
    const originalCloseHandler = musicCreatorWindow.querySelector('.close').onclick;
    musicCreatorWindow.querySelector('.close').onclick = () => {
        if (Tone.Transport) { Tone.Transport.stop(); Tone.Transport.cancel(); }
        if (scheduledPart) scheduledPart.dispose();
        Object.values(instruments).forEach(inst => { if (inst.dispose) inst.dispose(); });
        themeObserver.disconnect();
        if (originalCloseHandler) originalCloseHandler();
    };
}
},
{
    id: 'backup-machine',
    name: 'Back UP ',
    icon: 'fas fa-server',
    installed: true,
    launcher: () => {
        const windowId = `app-window-backup-machine-${Date.now()}`;
        const content = `
            <div class="p-4 flex flex-col items-center justify-center h-full text-center gap-6">
                <i class="fas fa-server text-6xl text-gray-400"></i>
                <p class="text-gray-300">OS</p>
                <div class="flex gap-4">
                    <button id="export-backup-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-file-export mr-2"></i>
                    </button>
                    <button id="import-backup-btn" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-file-import mr-2"></i>
                    </button>
                </div>
            </div>
        `;
        const backupWindow = createWindow(windowId, 'Back UP ', content, 500, 350);
        const exportBtn = backupWindow.querySelector('#export-backup-btn');
        const importBtn = backupWindow.querySelector('#import-backup-btn');
        exportBtn.addEventListener('click', async () => {
            try {
                createNotification('', 'OS...', 'info');
                const backupData = await gatherAllOSData();
                const blob = new Blob([JSON.stringify(backupData)], { type: 'application/json' });
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const timestamp = new Date().toISOString().replace(/[-:.]/g, '');
                    const defaultName = `RiviftOS_Backup_${timestamp}.rbackup`;
                    const target = await showFilePicker({ mode: 'save', title: '', defaultName: defaultName });
                    if (target) {
                        await VFS.writeFile(target.path.substring(0, target.path.lastIndexOf('/')) || '/', target.name, 'application/rivift-backup', e.target.result);
                        createNotification('', `${target.name}`, 'info');
                    }
                };
                reader.readAsDataURL(blob);
            } catch (err) {
                console.error(":", err);
                createNotification('', '', 'error');
            }
        });
        importBtn.addEventListener('click', async () => {
            const filePath = await showFilePicker({ mode: 'open', title: '', acceptTypes: ['application/rivift-backup'] });
            if (!filePath) return;
            const confirm = await showMessageBox(
                '',
                '',
                { showCancel: true }
            );
            if (!confirm) return;
            try {
                createNotification('', '...', 'info');
const fileData = await VFS.readFile(filePath);
let backupData;
const content = fileData.content;
if (typeof content === 'string' && content.startsWith('data:')) {
    const parts = content.split(',');
    if (parts.length < 2 || !parts[1]) {
        throw new Error('');
    }
    const base64 = parts[1].trim();
    const jsonText = decodeURIComponent(escape(atob(base64)));
    if (!jsonText.trim()) {
        throw new Error('JSON');
    }
    backupData = JSON.parse(jsonText);
}
else {
    if (!content || !content.trim()) {
        throw new Error('');
    }
    backupData = JSON.parse(content);
}
                if (!backupData.vfsFiles || !backupData.settings) {
                    throw new Error("");
                }
                localStorage.clear();
                for (const key in backupData.settings) {
                    localStorage.setItem(key, backupData.settings[key]);
                }
                console.log("");
                await new Promise((res, rej) => {
                    const deleteRequest = indexedDB.deleteDatabase('RiviftFS_v2');
                    deleteRequest.onsuccess = () => res();
                    deleteRequest.onerror = (e) => rej(e.target.error);
                });
                console.log("");
                await VFS.init();
                for (const file of backupData.vfsFiles) {
                    await VFS.put(file);
                }
                console.log("");
                await showMessageBox(
                    '',
                    'OKOS',
                    { showCancel: false }
                );
                location.reload();
            } catch (err) {
                console.error(":", err);
                createNotification('', `: ${err.message}`, 'error');
                setTimeout(() => location.reload(), 3000);
            }
        });
    }
},
        ];
const customWebApps = JSON.parse(localStorage.getItem('riviftCustomWebApps')) || [];
customWebApps.forEach(customApp => {
    if (apps.some(app => app.id === customApp.id)) return;
    customApp.launcher = () => {
        const webAppWindow = createWindow(`app-window-${customApp.id}`, customApp.name, '', 800, 600);
        webAppWindow.querySelector('.window-content').style.padding = '0';
        webAppWindow.querySelector('.window-content').style.overflow = 'hidden';
        const iframe = document.createElement('iframe');
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = 'none';
        iframe.sandbox = "allow-scripts allow-forms allow-modals allow-popups";
        iframe.src = customApp.htmlContent;
        webAppWindow.querySelector('.window-content').appendChild(iframe);
    };
    apps.push(customApp);
});
function saveCustomWebApps() {
    const webAppsToSave = apps.filter(app => app.isWebApp);
    localStorage.setItem('riviftCustomWebApps', JSON.stringify(webAppsToSave));
}        
function initializeClockApp(appWindow) {
    const menubar = appWindow.querySelector('.clock-menubar');
    const pages = appWindow.querySelectorAll('.clock-page');
    let globalIntervalId = null;
    const formatTime = (ms, showMs = false) => {
        const totalSeconds = Math.floor(ms / 1000);
        const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
        const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
        const s = String(totalSeconds % 60).padStart(2, '0');
        if (showMs) {
            const msPart = String(Math.floor((ms % 1000) / 10)).padStart(2, '0');
            return `${m}:${s}.${msPart}`;
        }
        return `${h}:${m}:${s}`;
    };
    const worldClock = {
        date: appWindow.querySelector('#date-display-clock'),
        digital: appWindow.querySelector('#digital-clock-display'),
        analog: appWindow.querySelector('#analog-clock-canvas'),
        ctx: appWindow.querySelector('#analog-clock-canvas').getContext('2d'),
        controls: appWindow.querySelector('#world-clock-controls'),
        isDigital: true,
        update: () => {
            worldClock.digital.classList.toggle('hidden', !worldClock.isDigital);
            worldClock.analog.classList.toggle('hidden', worldClock.isDigital);
            const now = new Date();
            worldClock.date.textContent = now.toLocaleDateString('ja-JP', { weekday: 'long', month: 'long', day: 'numeric' });
            if (worldClock.isDigital) {
                worldClock.digital.textContent = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            } else {
                drawAnalogClock(now, worldClock.ctx, worldClock.analog.width);
            }
        }
    };
    worldClock.controls.querySelectorAll('.clock-view-btn').forEach(btn => {
        btn.onclick = () => {
            worldClock.isDigital = (btn.dataset.view === 'digital');
            worldClock.controls.querySelectorAll('.clock-view-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        };
    });
    const alarm = {
        addBtn: appWindow.querySelector('#add-alarm-btn'),
        list: appWindow.querySelector('.alarm-list'),
        alarms: JSON.parse(localStorage.getItem('riviftAlarms_v2')) || [{time: '07:00', label:'', enabled:true}],
        render: () => {
            alarm.list.innerHTML = '';
            if (alarm.alarms.length === 0) {
                alarm.list.innerHTML = '<p class="text-center text-gray-500"></p>';
                return;
            }
            alarm.alarms.sort((a,b) => a.time.localeCompare(b.time)).forEach((item, index) => {
                const alarmEl = document.createElement('div');
                alarmEl.className = 'alarm-item';
                alarmEl.innerHTML = `
                    <div>
                        <span class="text-3xl">${item.time}</span>
                        <span class="ml-2 text-gray-400">${item.label}</span>
                    </div>
                    <div class="quick-setting-toggle ${item.enabled ? 'active' : ''}" data-index="${index}">
                        <div class="slider"></div>
                    </div>
                `;
                alarm.list.appendChild(alarmEl);
            });
        },
        save: () => localStorage.setItem('riviftAlarms_v2', JSON.stringify(alarm.alarms)),
        check: () => {
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            alarm.alarms.forEach(item => {
                if (item.enabled && item.time === currentTime && !item.triggeredToday) {
                    createNotification('', item.label, 'alarm');
                    item.triggeredToday = true;
                } else if (item.time !== currentTime) {
                    item.triggeredToday = false;
                }
            });
        }
    };
    alarm.addBtn.onclick = async () => {
        let newAlarm = { h: 8, m: 30 };
        const updateAlarmPickerHTML = () => `<div class="time-picker">
            <div class="time-picker-col"><i class="fas fa-chevron-up time-picker-arrow" data-unit="h" data-dir="1"></i><span>${String(newAlarm.h).padStart(2,'0')}</span><i class="fas fa-chevron-down time-picker-arrow" data-unit="h" data-dir="-1"></i></div>
            <span>:</span>
            <div class="time-picker-col"><i class="fas fa-chevron-up time-picker-arrow" data-unit="m" data-dir="1"></i><span>${String(newAlarm.m).padStart(2,'0')}</span><i class="fas fa-chevron-down time-picker-arrow" data-unit="m" data-dir="-1"></i></div>
        </div>`;
        const resultPromise = showMessageBox('', '', {
            showCancel: true,
            customHtmlContent: `<div id="alarm-picker-modal">${updateAlarmPickerHTML()}</div>`
        });
        const modalContent = document.getElementById('alarm-picker-modal');
        if (modalContent) {
            modalContent.addEventListener('click', (e) => {
                const arrow = e.target.closest('.time-picker-arrow');
                if (arrow) {
                    const unit = arrow.dataset.unit, dir = parseInt(arrow.dataset.dir);
                    if (unit === 'h') newAlarm.h = (newAlarm.h + dir + 24) % 24;
                    if (unit === 'm') newAlarm.m = (newAlarm.m + dir + 60) % 60;
                    modalContent.innerHTML = updateAlarmPickerHTML();
                }
            });
        }
        const result = await resultPromise;
        if (result) {
            const label = await showMessageBox('', '', {showCancel: true, input: {placeholder: ''}});
            const timeStr = `${String(newAlarm.h).padStart(2,'0')}:${String(newAlarm.m).padStart(2,'0')}`;
            alarm.alarms.push({time: timeStr, label: label || '', enabled: true});
            alarm.save();
            alarm.render();
        }
    };
    alarm.list.addEventListener('click', (e) => {
        const toggle = e.target.closest('.quick-setting-toggle');
        if (toggle) {
            const index = parseInt(toggle.dataset.index);
            alarm.alarms[index].enabled = !alarm.alarms[index].enabled;
            toggle.classList.toggle('active');
            alarm.save();
        }
    });
    const timer = {
        display: appWindow.querySelector('#timer-display'),
        picker: appWindow.querySelector('#timer-picker'),
        startBtn: appWindow.querySelector('#start-timer-btn'),
        resetBtn: appWindow.querySelector('#reset-timer-btn'),
        h: appWindow.querySelector('#timer-h'), m: appWindow.querySelector('#timer-m'), s: appWindow.querySelector('#timer-s'),
        intervalId: null, endTime: 0, duration: 300000, state: 'stopped',
        updatePicker: () => {
            const hours = Math.floor(timer.duration / 3600000);
            const minutes = Math.floor((timer.duration % 3600000) / 60000);
            const seconds = Math.floor((timer.duration % 60000) / 1000);
            timer.h.textContent = String(hours).padStart(2, '0');
            timer.m.textContent = String(minutes).padStart(2, '0');
            timer.s.textContent = String(seconds).padStart(2, '0');
        },
        start: () => {
            timer.endTime = Date.now() + timer.duration;
            timer.intervalId = setInterval(timer.update, 100);
            timer.state = 'running';
            timer.startBtn.textContent = '';
            timer.startBtn.classList.replace('start-btn', 'stop-btn');
        },
        update: () => {
            const remaining = Math.max(0, timer.endTime - Date.now());
            timer.display.textContent = formatTime(remaining);
            if (remaining === 0) {
                clearInterval(timer.intervalId);
                timer.intervalId = null;
                timer.state = 'stopped';
                timer.startBtn.textContent = '';
                timer.startBtn.classList.replace('stop-btn', 'start-btn');
                timer.display.classList.add('hidden');
                timer.picker.style.display = 'flex';
                createNotification('', '', 'timer');
            }
        }
    };
    timer.picker.addEventListener('click', (e) => {
        const arrow = e.target.closest('.time-picker-arrow');
        if (!arrow || timer.state !== 'stopped') return;
        const unit = arrow.dataset.unit, dir = parseInt(arrow.dataset.dir);
        if (unit === 'h') timer.duration += dir * 3600000;
        if (unit === 'm') timer.duration += dir * 60000;
        if (unit === 's') timer.duration += dir * 1000;
        timer.duration = Math.max(0, timer.duration);
        timer.updatePicker();
    });
    timer.startBtn.onclick = () => {
        if (timer.state === 'running') {
            clearInterval(timer.intervalId);
            timer.duration = timer.endTime - Date.now();
            timer.state = 'paused';
            timer.startBtn.textContent = '';
            timer.startBtn.classList.replace('stop-btn', 'start-btn');
        } else {
            if (timer.duration <= 0) return;
            timer.picker.style.display = 'none';
            timer.display.classList.remove('hidden');
            timer.start();
        }
    };
    timer.resetBtn.onclick = () => {
        clearInterval(timer.intervalId); timer.intervalId = null; timer.state = 'stopped';
        timer.picker.style.display = 'flex';
        timer.display.classList.add('hidden');
        timer.startBtn.textContent = '';
        timer.startBtn.classList.replace('stop-btn', 'start-btn');
        timer.updatePicker();
    };
    const stopwatch = {
        display: appWindow.querySelector('#stopwatch-display'),
        startBtn: appWindow.querySelector('#start-stopwatch-btn'),
        lapBtn: appWindow.querySelector('#lap-btn'),
        lapList: appWindow.querySelector('.lap-list'),
        intervalId: null, startTime: 0, elapsed: 0, laps: [], state: 'stopped',
        update: () => {
            const totalMs = Date.now() - stopwatch.startTime + stopwatch.elapsed;
            stopwatch.display.textContent = formatTime(totalMs, true);
        }
    };
    stopwatch.startBtn.onclick = () => {
        if (stopwatch.state === 'running') {
            clearInterval(stopwatch.intervalId);
            stopwatch.elapsed += Date.now() - stopwatch.startTime;
            stopwatch.state = 'stopped';
            stopwatch.startBtn.textContent = '';
            stopwatch.startBtn.classList.replace('stop-btn', 'start-btn');
            stopwatch.lapBtn.textContent = '';
        } else {
            stopwatch.startTime = Date.now();
            stopwatch.intervalId = setInterval(stopwatch.update, 10);
            stopwatch.state = 'running';
            stopwatch.startBtn.textContent = '';
            stopwatch.startBtn.classList.replace('start-btn', 'stop-btn');
            stopwatch.lapBtn.textContent = '';
            stopwatch.lapBtn.disabled = false;
        }
    };
    stopwatch.lapBtn.onclick = () => {
        if (stopwatch.state === 'running') {
            const totalMs = Date.now() - stopwatch.startTime + stopwatch.elapsed;
            stopwatch.laps.unshift(totalMs);
            stopwatch.lapList.innerHTML = stopwatch.laps.map((lap, i) => `<div class="lap-item"><span>Lap ${stopwatch.laps.length - i}</span><span>${formatTime(lap, true)}</span></div>`).join('');
        } else {
            stopwatch.elapsed = 0; stopwatch.laps = []; stopwatch.lapList.innerHTML = '';
            stopwatch.display.textContent = '00:00.00';
            stopwatch.lapBtn.disabled = true;
        }
    };
    function switchPage(pageId) {
        clearInterval(globalIntervalId);
        pages.forEach(p => p.classList.toggle('active', p.id === `${pageId}-page`));
        if (pageId === 'world-clock') { globalIntervalId = setInterval(worldClock.update, 1000); worldClock.update(); }
        if (pageId === 'alarm') { globalIntervalId = setInterval(alarm.check, 1000); alarm.render(); }
    }
    menubar.addEventListener('click', (e) => {
        const button = e.target.closest('button[data-page]');
        if (!button) return;
        menubar.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        switchPage(button.dataset.page);
    });
    const originalCloseHandler = appWindow.querySelector('.close').onclick;
    appWindow.querySelector('.close').onclick = () => {
        clearInterval(globalIntervalId);
        clearInterval(timer.intervalId);
        clearInterval(stopwatch.intervalId);
        if (originalCloseHandler) originalCloseHandler();
    };
    function drawAnalogClock(now, ctx, width) {
        const radius = width / 2;
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.clearRect(0, 0, width, width);
        ctx.translate(radius, radius);
        const textColor = isDarkMode ? 'white' : 'black';
        ctx.strokeStyle = textColor; ctx.fillStyle = textColor; ctx.lineWidth = 4;
        ctx.beginPath(); ctx.arc(0, 0, radius - 5, 0, 2 * Math.PI); ctx.stroke();
        const hour = now.getHours() % 12, minute = now.getMinutes(), second = now.getSeconds();
        const hourAngle = (hour * 30 + minute / 2) * Math.PI / 180 - Math.PI / 2;
        const minuteAngle = (minute * 6) * Math.PI / 180 - Math.PI / 2;
        const secondAngle = (second * 6) * Math.PI / 180 - Math.PI / 2;
        const drawHand = (angle, length, width, color) => { ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = width; ctx.moveTo(0, 0); ctx.lineTo(length * Math.cos(angle), length * Math.sin(angle)); ctx.stroke(); };
        drawHand(hourAngle, radius*0.5, 6, textColor);
        drawHand(minuteAngle, radius*0.7, 4, textColor);
        drawHand(secondAngle, radius*0.8, 2, "red");
        ctx.beginPath(); ctx.arc(0, 0, 5, 0, 2*Math.PI); ctx.fill();
    }
    switchPage('world-clock');
    alarm.render();
    timer.updatePicker();
}
function initializeSimplePaint(appWindow) {
    const canvasArea = appWindow.querySelector('#simple-paint-canvas-area');
    const toolbar = appWindow.querySelector('#simple-paint-toolbar');
    const layerPanel = appWindow.querySelector('#layer-panel');
    const layerListEl = appWindow.querySelector('#layer-list');
    const addLayerBtn = appWindow.querySelector('#add-layer-btn');
    const deleteLayerBtn = appWindow.querySelector('#delete-layer-btn');
    const brushPreview = appWindow.querySelector('#brush-preview');
    const brushSizeInput = toolbar.querySelector('#simple-brush-size');
    const fillColorPicker = toolbar.querySelector('#fill-color-picker');
    const strokeColorPicker = toolbar.querySelector('#stroke-color-picker');
    const shapeOptions = toolbar.querySelector('#shape-options');
    const rectOptions = toolbar.querySelector('#rect-options');
    const borderRadiusInput = toolbar.querySelector('#rect-border-radius');
    const undoBtn = toolbar.querySelector('#undo-btn');
    const redoBtn = toolbar.querySelector('#redo-btn');
    let layers = [];
    let activeLayer = null;
    let nextLayerId = 0;
    let currentTool = 'pen';
    let fillColor = 'transparent';
    let strokeColor = '#000000';
    let brushSize = 5;
    let rectBorderRadius = 0;
    let isDrawing = false;
    let snapshot;
    let startPoint = { x: 0, y: 0 };
    let history = [];
    let historyIndex = -1;
const createNewLayer = () => {
    const canvas = document.createElement('canvas');
    canvas.id = `layer-${nextLayerId}`;
    canvas.className = 'absolute top-0 left-0';
    canvasArea.appendChild(canvas);
    const layer = {
        id: nextLayerId,
        name: ` ${nextLayerId + 1}`,
        canvas: canvas,
        ctx: canvas.getContext('2d'),
        visible: true
    };
    layers.push(layer);
    nextLayerId++;
    resizeCanvas();
    setActiveLayer(layer.id);
    renderLayerList();
};
const renderLayerList = () => {
    layerListEl.innerHTML = '';
    [...layers].reverse().forEach(layer => {
        const item = document.createElement('div');
        item.className = `layer-item flex items-center justify-between ${layer.id === activeLayer?.id ? 'active' : ''} ${!layer.visible ? 'hidden-layer' : ''}`;
        const nameSpan = document.createElement('span');
        nameSpan.textContent = layer.name;
        nameSpan.className = 'truncate flex-grow';
        nameSpan.dataset.layerId = layer.id;
        const visibilityBtn = document.createElement('button');
        visibilityBtn.className = 'layer-visibility-btn';
        visibilityBtn.innerHTML = `<i class="fas ${layer.visible ? 'fa-eye' : 'fa-eye-slash'}"></i>`;
        visibilityBtn.addEventListener('click', (e) => {
            e.stopPropagation(); 
            layer.visible = !layer.visible;
            layer.canvas.style.display = layer.visible ? 'block' : 'none';
            renderLayerList();
        });
        item.appendChild(visibilityBtn);
        item.appendChild(nameSpan);
        item.addEventListener('click', (e) => {
            if (e.target.closest('span')) {
                setActiveLayer(layer.id);
            }
        });
        layerListEl.appendChild(item);
    });
};
    const setActiveLayer = (id) => {
        const newActiveLayer = layers.find(l => l.id === id);
        if (newActiveLayer) {
            activeLayer = newActiveLayer;
            renderLayerList();
        }
    };
    const deleteActiveLayer = () => {
        if (layers.length <= 1 || !activeLayer) return;
        const index = layers.findIndex(l => l.id === activeLayer.id);
        const [deletedLayer] = layers.splice(index, 1);
        deletedLayer.canvas.remove();
        const newActiveIndex = Math.max(0, index - 1);
        setActiveLayer(layers[newActiveIndex].id);
        renderLayerList();
    };
    const contentArea = appWindow.querySelector('.window-content');
    const overlay = document.createElement('div');
    overlay.className = 'drop-target-overlay';
    overlay.innerHTML = `<i class="fas fa-file-import"></i>`;
    contentArea.appendChild(overlay);
    let dragCounter = 0; 
    contentArea.addEventListener('dragenter', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragCounter++;
        if (e.dataTransfer.types.includes('text/plain')) {
             overlay.classList.add('visible');
        }
    });
    contentArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragCounter--;
        if (dragCounter === 0) {
            overlay.classList.remove('visible');
        }
    });
    contentArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
    });
    contentArea.addEventListener('drop', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragCounter = 0;
        overlay.classList.remove('visible');
        const filePath = e.dataTransfer.getData('text/plain');
        if (filePath) {
            try {
                const fileData = await VFS.readFile(filePath);
                if (fileData && fileData.type.startsWith('image/')) {
                    const img = new Image();
                    img.onload = () => {
                        if (activeLayer) {
                            activeLayer.canvas.width = img.width;
                            activeLayer.canvas.height = img.height;
                            activeLayer.ctx.drawImage(img, 0, 0);
                            saveHistory();
                        }
                    };
                    img.src = fileData.content;
                } else {
                    createNotification('', '', 'warning');
                }
            } catch (err) {
                createNotification('', '', 'error');
            }
        }
    });
    function saveHistory() {
        if (!activeLayer) return;
        history.length = historyIndex + 1;
        history.push({
            layerId: activeLayer.id,
            imageData: activeLayer.ctx.getImageData(0, 0, activeLayer.canvas.width, activeLayer.canvas.height)
        });
        historyIndex = history.length - 1;
        updateHistoryButtons();
    }
    function undo() {
        if (historyIndex >= 0) {
            const record = history[historyIndex];
            const targetLayer = layers.find(l => l.id === record.layerId);
            if (targetLayer) {
                targetLayer.ctx.putImageData(record.imageData, 0, 0);
            }
            historyIndex--;
            updateHistoryButtons();
        }
    }
    function redo() {
        if (historyIndex < history.length - 1) {
            historyIndex++;
            const record = history[historyIndex];
            const targetLayer = layers.find(l => l.id === record.layerId);
            if (targetLayer) {
                targetLayer.ctx.putImageData(record.imageData, 0, 0);
            }
            updateHistoryButtons();
        }
    }
    function updateHistoryButtons() {
        undoBtn.disabled = historyIndex < 0;
        redoBtn.disabled = historyIndex >= history.length - 1;
    }
    function resizeCanvas() {
        if (!document.body.contains(canvasArea)) {
            if (resizeObserver) resizeObserver.disconnect();
            return;
        }
        const rect = canvasArea.getBoundingClientRect();
        layers.forEach(layer => {
            const tempCanvas = document.createElement('canvas');
            if (layer.canvas.width > 0) {
                tempCanvas.width = layer.canvas.width;
                tempCanvas.height = layer.canvas.height;
                tempCanvas.getContext('2d').drawImage(layer.canvas, 0, 0);
            }
            layer.canvas.width = rect.width;
            layer.canvas.height = rect.height;
            if (tempCanvas.width > 0) {
                layer.ctx.drawImage(tempCanvas, 0, 0);
            }
        });
    }
    const resizeObserver = new ResizeObserver(resizeCanvas);
    resizeObserver.observe(canvasArea);
    const originalCloseHandler = appWindow.querySelector('.close').onclick;
    appWindow.querySelector('.close').onclick = () => {
        resizeObserver.disconnect();
        if (originalCloseHandler) originalCloseHandler();
    };
    toolbar.querySelectorAll('[data-tool]').forEach(btn => {
        btn.addEventListener('click', () => {
            toolbar.querySelector('.active')?.classList.remove('active');
            btn.classList.add('active');
            currentTool = btn.dataset.tool;
            const isShapeTool = ['rect', 'circle', 'line'].includes(currentTool);
            shapeOptions.classList.toggle('hidden', !isShapeTool);
            rectOptions.classList.toggle('hidden', currentTool !== 'rect');
        });
    });
    toolbar.querySelectorAll('.color-none-toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            btn.classList.toggle('disabled');
            const target = btn.dataset.for;
            const picker = (target === 'fill') ? fillColorPicker : strokeColorPicker;
            const isNone = btn.classList.contains('disabled');
            picker.parentElement.classList.toggle('disabled', isNone);
            if (target === 'fill') fillColor = isNone ? 'transparent' : picker.value;
            else strokeColor = isNone ? 'transparent' : picker.value;
        });
    });
    fillColorPicker.addEventListener('input', (e) => {
        fillColor = e.target.value;
        const btn = toolbar.querySelector('[data-for="fill"]');
        btn.classList.remove('disabled');
        fillColorPicker.parentElement.classList.remove('disabled');
    });
    strokeColorPicker.addEventListener('input', (e) => {
        strokeColor = e.target.value;
        const btn = toolbar.querySelector('[data-for="stroke"]');
        btn.classList.remove('disabled');
        strokeColorPicker.parentElement.classList.remove('disabled');
    });
    toolbar.querySelector('[data-for="fill"]').click(); 
    brushSizeInput.addEventListener('input', (e) => {
        brushSize = e.target.value;
        brushPreview.classList.add('visible');
        brushPreview.style.width = `${brushSize}px`;
        brushPreview.style.height = `${brushSize}px`;
        const currentColor = (currentTool === 'eraser') ? '#FFFFFF' : strokeColor;
        brushPreview.style.backgroundColor = currentColor;
    });
    brushSizeInput.addEventListener('blur', () => {
        brushPreview.classList.remove('visible');
    });
    borderRadiusInput.addEventListener('input', (e) => { rectBorderRadius = e.target.value; });
    function drawShape(to) {
        if (!activeLayer) return;
        const ctx = activeLayer.ctx;
        ctx.strokeStyle = strokeColor;
        ctx.fillStyle = fillColor;
        ctx.lineWidth = brushSize;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.beginPath();
        if (currentTool === 'line') {
            ctx.moveTo(startPoint.x, startPoint.y);
            ctx.lineTo(to.x, to.y);
        } else if (currentTool === 'rect') {
            const x = Math.min(startPoint.x, to.x);
            const y = Math.min(startPoint.y, to.y);
            const width = Math.abs(startPoint.x - to.x);
            const height = Math.abs(startPoint.y - to.y);
            if(typeof ctx.roundRect === 'function'){
                ctx.roundRect(x, y, width, height, rectBorderRadius);
            } else {
                ctx.rect(x, y, width, height);
            }
        } else if (currentTool === 'circle') {
            const radiusX = Math.abs(to.x - startPoint.x) / 2;
            const radiusY = Math.abs(to.y - startPoint.y) / 2;
            const centerX = startPoint.x + (to.x - startPoint.x) / 2;
            const centerY = startPoint.y + (to.y - startPoint.y) / 2;
            ctx.ellipse(centerX, centerY, radiusX, radiusY, 0, 0, 2 * Math.PI);
        }
        if (fillColor !== 'transparent') ctx.fill();
        if (strokeColor !== 'transparent') ctx.stroke();
    }
const stopDrawing = (e) => {
    if (isDrawing && (currentTool === 'rect' || currentTool === 'circle' || currentTool === 'line')) {
        if (activeLayer) {
            activeLayer.ctx.putImageData(snapshot, 0, 0); 
            drawShape({ x: e.offsetX, y: e.offsetY }); 
        }
    }
    isDrawing = false;
    if (canvasArea.hasPointerCapture(e.pointerId)) {
        canvasArea.releasePointerCapture(e.pointerId);
    }
    if (activeLayer) activeLayer.ctx.globalCompositeOperation = 'source-over';
};
canvasArea.addEventListener('pointerdown', (e) => {
    if (e.pointerType === 'mouse' && e.button !== 0) return;
    saveHistory(); 
    isDrawing = true;
    canvasArea.setPointerCapture(e.pointerId);
    const rect = canvasArea.getBoundingClientRect();
    startPoint = { x: e.clientX - rect.left, y: e.clientY - rect.top };
    if (activeLayer) {
        snapshot = activeLayer.ctx.getImageData(0, 0, activeLayer.canvas.width, activeLayer.canvas.height);
        const ctx = activeLayer.ctx;
        ctx.beginPath();
        ctx.moveTo(startPoint.x, startPoint.y);
        ctx.lineWidth = brushSize; 
        ctx.strokeStyle = (currentTool === 'eraser') ? '#FFFFFF' : strokeColor;
        ctx.globalCompositeOperation = (currentTool === 'eraser') ? 'destination-out' : 'source-over';
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        if (currentTool === 'pen' || currentTool === 'eraser') {
            ctx.fillStyle = ctx.strokeStyle;
            ctx.arc(startPoint.x, startPoint.y, (ctx.lineWidth / 2), 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(startPoint.x, startPoint.y);
        }
    }
});
canvasArea.addEventListener('pointermove', (e) => {
    if (!isDrawing || !activeLayer) return;
    const rect = canvasArea.getBoundingClientRect();
    const currentPoint = { x: e.clientX - rect.left, y: e.clientY - rect.top };
    const ctx = activeLayer.ctx;
    ctx.lineWidth = brushSize;
    if (currentTool === 'pen' || currentTool === 'eraser') {
        ctx.lineTo(currentPoint.x, currentPoint.y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(currentPoint.x, currentPoint.y);
    } else {
        ctx.putImageData(snapshot, 0, 0);
        drawShape(currentPoint);
    }
});
canvasArea.addEventListener('pointerup', stopDrawing);
canvasArea.addEventListener('pointerleave', stopDrawing);
undoBtn.addEventListener('click', undo);
redoBtn.addEventListener('click', redo);
toolbar.querySelector('#simple-paint-save').addEventListener('click', async () => {
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = layers[0].canvas.width;
    tempCanvas.height = layers[0].canvas.height;
    const tempCtx = tempCanvas.getContext('2d');
    tempCtx.fillStyle = '#FFFFFF';
    tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
    layers.forEach(layer => {
        if (layer.visible) {
            tempCtx.drawImage(layer.canvas, 0, 0);
        }
    });
    const dataUrl = tempCanvas.toDataURL('image/png');
    const target = await showFilePicker({ mode: 'save', title: '', defaultName: `.png` });
    if (target) {
        const parentPath = target.path.substring(0, target.path.lastIndexOf('/')) || '/';
        await VFS.writeFile(parentPath, target.name, 'image/png', dataUrl);
        createNotification('', `${target.name}`, 'info');
    }
});
    toolbar.querySelector('#simple-paint-open').addEventListener('click', async () => {
        const filePath = await showFilePicker({ mode: 'open', title: '', acceptTypes: ['image/'] });
        if (filePath) {
            const path = Array.isArray(filePath) ? filePath[0] : filePath;
            if (!path) return;
            const fileData = await readFileWithWorker(path);
            if (fileData && fileData.content) {
                const img = new Image();
                img.onload = () => {
                    if (activeLayer) {
                        activeLayer.canvas.width = img.width;
                        activeLayer.canvas.height = img.height;
                        activeLayer.ctx.drawImage(img, 0, 0);
                        saveHistory();
                    }
                };
                img.src = fileData.content;
            }
        }
    });
    addLayerBtn.addEventListener('click', createNewLayer);
    deleteLayerBtn.addEventListener('click', deleteActiveLayer);
    const toggleLayersPanelBtn = toolbar.querySelector('#toggle-layers-panel-btn');
    const paintContainer = appWindow.querySelector('#simple-paint-container');
    toggleLayersPanelBtn.addEventListener('click', () => {
        paintContainer.classList.toggle('layers-hidden');
        toggleLayersPanelBtn.classList.toggle('active');
    });
    setTimeout(() => {
        createNewLayer();
        if (activeLayer) {
            const ctx = activeLayer.ctx;
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, activeLayer.canvas.width, activeLayer.canvas.height);
        }
    }, 100);
}
function populateAllApps() {
    const searchTerm = allAppsSearchBar.value.toLowerCase();
    const filteredApps = apps.filter(app => app.installed && app.name.toLowerCase().includes(searchTerm));
    filteredApps.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
    allAppsGridContainer.innerHTML = '';
    allAppsPagination.innerHTML = '';
    const iconsPerPage = 7 * 5;
    const pageCount = Math.ceil(filteredApps.length / iconsPerPage) || 1;
    for (let i = 0; i < pageCount; i++) {
        const pageDiv = document.createElement('div');
        pageDiv.className = 'all-apps-grid-page';
        allAppsGridContainer.appendChild(pageDiv);
        const dot = document.createElement('div');
        dot.className = 'dot';
        if (i === 0) dot.classList.add('active');
        dot.addEventListener('click', () => onPaginationDotClick(i));
        allAppsPagination.appendChild(dot);
    }
    filteredApps.forEach((app, index) => {
        const pageIndex = Math.floor(index / iconsPerPage);
        if (!allAppsGridContainer.children[pageIndex]) return;
        const pageDiv = allAppsGridContainer.children[pageIndex];
        const appIconDiv = document.createElement('div');
        appIconDiv.classList.add('app-icon-fullscreen');
        appIconDiv.dataset.app = app.id;
        let iconHtml = app.icon.endsWith('.svg') ? `<img src="${app.icon}">` : `<i class="${app.icon}"></i>`;
        const isPinned = pinnedApps.includes(app.id);
        appIconDiv.innerHTML = `
            <div class="icon-wrapper">
                <div class="icon-box">${iconHtml}</div>
                <div class="pin-button ${isPinned ? 'pinned' : ''}" data-app-id="${app.id}">
                    <i class="fas fa-thumbtack"></i>
                </div>
            </div>
            <span>${app.name}</span>
        `;
        appIconDiv.addEventListener('click', (e) => {
            if (pinMode && e.target.closest('.pin-button')) return;
            if (!pinMode) {
                launchApp(app.id);
                allAppsFullscreen.classList.remove('active');
            }
        });
        const pinButton = appIconDiv.querySelector('.pin-button');
        pinButton.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!pinMode) return;
            const targetAppId = pinButton.dataset.appId;
            const isPinnedNow = pinnedApps.includes(targetAppId);
            if (isPinnedNow) {
                pinnedApps = pinnedApps.filter(id => id !== targetAppId);
            } else {
                pinnedApps.push(targetAppId);
            }
            pinButton.classList.toggle('pinned', !isPinnedNow);
            savePinnedApps();
        });
        pageDiv.appendChild(appIconDiv);
    });
    if (pinMode) {
        allAppsGridContainer.querySelectorAll('.app-icon-fullscreen').forEach(icon => {
            icon.classList.add('pin-mode');
        });
    }
    applyTheme();
    allAppsScrollHandler();
}
desktop.addEventListener('contextmenu', (e) => {
    if (e.target.closest('.desktop-icon') || e.target.closest('.app-window')) return;
    e.preventDefault();
    const alignmentLabel = desktopIconAlignment === 'grid' ? '' : '';
    const alignmentIcon = desktopIconAlignment === 'grid' ? 'fas fa-arrows-alt' : 'fas fa-grip-lines';
    const widgetAlignmentLabel = autoAlignWidgets ? 'OFF' : '';
    const widgetAlignmentIcon = autoAlignWidgets ? 'fas fa-toggle-on' : 'fas fa-toggle-off';
    const toggleAlignmentAction = () => {
        desktopIconAlignment = (desktopIconAlignment === 'free') ? 'grid' : 'free';
        saveDesktopIconAlignment();
        renderDesktopIcons();
    };
    const menuItems = [
        { 
            label: `${desktopIconsEl.style.display === 'none' ? '' : ''}`, 
            icon: 'fas fa-desktop', 
            action: () => {
                desktopIconsEl.style.display = (desktopIconsEl.style.display === 'none') ? '' : 'none';
            }
        },
        { 
            label: alignmentLabel, 
            icon: alignmentIcon, 
            action: toggleAlignmentAction 
        },                
        { 
            label: widgetAlignmentLabel,
            icon: widgetAlignmentIcon,
            action: () => {
                toggleWidgetAlignment();
            }
        },
        { separator: true },
        { label: '', icon: 'fas fa-image', action: () => {
            launchApp('settings', { category: 'wallpaper' });
        }}
    ];
    showContextMenu(menuItems, e);
});
desktop.addEventListener('dragover', (e) => e.preventDefault());
desktop.addEventListener('drop', async (e) => {
    e.preventDefault();
        if (e.target.id !== 'desktop' && !e.target.closest('#desktop-icons')) {
        return; 
    }
    const sourcePath = e.dataTransfer.getData('text/plain');
    if (sourcePath) {
        try {
            const item = await VFS.readFile(sourcePath);
            if (!item) return;
            const exists = desktopIcons.some(icon => (icon.path && icon.path === item.path) || (icon.appId && icon.appId === item.id));
            if (exists) {
                createNotification('', '', 'info');
                return;
            }
            const isAppShortcut = sourcePath.startsWith('/Apps/');
            const newIcon = {
                name: item.name,
                appId: isAppShortcut ? item.id : null,
                path: isAppShortcut ? null : item.path,
                isApp: isAppShortcut,
                x: e.clientX - 45,
                y: e.clientY - 45
            };
            desktopIcons.push(newIcon);
            saveDesktopIcons();
            renderDesktopIcons();
        } catch (err) { 
            console.error("Shortcut creation failed:", err); 
            createNotification('', '', 'error');
        }
    }
});
function launchApp(appId, params = {}) {
    if (isLocked) return;
    const app = apps.find(a => a.id === appId);
    if (app && app.installed) {
        if (!pinnedApps.includes(appId) && !document.querySelector(`.taskbar-icon[data-app="${appId}"]`)) {
            const taskbarCenter = document.getElementById('taskbar-center');
            const tempIconDiv = document.createElement('div');
            tempIconDiv.classList.add('taskbar-icon', 'app-launcher');
            tempIconDiv.dataset.app = app.id;
            tempIconDiv.innerHTML = `<i class="${app.icon}"></i><div class="status-indicator"></div>`;
tempIconDiv.addEventListener('click', () => handleTaskbarIconClick(app.id));
tempIconDiv.addEventListener('contextmenu', (e) => showAppContextMenu(e, app.id, tempIconDiv));
            taskbarCenter.appendChild(tempIconDiv);
            applyAppIconSize();
        }
        app.launcher(params);
        closeAllPanels();
        allAppsFullscreen.classList.remove('active');
        addRecentItem(appId, app.name, app.icon);
    } else if (app && !app.installed) {
        createNotification('', `${app.name} `, 'error');
    } else {
        createNotification('', '', 'error');
    }
}
function renderDesktopIcons() {
    if (!desktopIconsEl) return;
    const scrollTop = desktopIconsEl.scrollTop;
    desktopIconsEl.innerHTML = '';
    if (desktopIconAlignment === 'grid') {
        desktopIconsEl.style.display = 'grid';
    } else {
        desktopIconsEl.style.display = 'block';
    }
    desktopIcons.forEach((iconData, index) => {
        const iconEl = document.createElement('div');
        iconEl.className = 'desktop-icon';
        iconEl.dataset.index = index;
                iconEl.style.position = 'absolute';
        if (desktopIconAlignment === 'grid') {
            const gridSize = 100;
            const iconsPerColumn = Math.floor((desktopIconsEl.clientHeight - 20) / gridSize);
            const col = Math.floor(index / iconsPerColumn);
            const row = index % iconsPerColumn;
            iconEl.style.left = `${col * gridSize + 10}px`;
            iconEl.style.top = `${row * gridSize + 10}px`;
        } else {
            iconEl.style.left = `${iconData.x || 20}px`;
            iconEl.style.top = `${iconData.y || (index * 100) + 20}px`;
        }
        const iconImgContainer = document.createElement('div');
        iconImgContainer.className = 'desktop-icon-img';
        const renderIcon = async () => {
            if (iconData.isApp) {
                const appInfo = apps.find(app => app.id === iconData.appId);
                if (appInfo) {
    iconImgContainer.innerHTML = appInfo.icon.endsWith('.svg')
        ? `<img src="${appInfo.icon}" class="w-full h-full">`
        : `<i class="${appInfo.icon}"></i>`;
}            } else {
                try {
                    const fileData = await VFS.readFile(iconData.path);
                    if (fileData && fileData.type.startsWith('image/') && fileData.content) {
                        iconImgContainer.innerHTML = `<img src="${fileData.content}" alt="">`;
                    } else {
                        iconImgContainer.innerHTML = `<i class="${getIconForType(fileData.type)}"></i>`;
                    }
                } catch {
                    iconImgContainer.innerHTML = `<i class="fas fa-file-excel"></i>`;
                }
            }
        };
        renderIcon();
        const labelEl = document.createElement('p');
        labelEl.className = 'desktop-icon-label';
        labelEl.textContent = iconData.name;
        iconEl.appendChild(iconImgContainer);
        iconEl.appendChild(labelEl);
const dblClickHandler = () => {
    if (iconData.isApp) {
        launchApp(iconData.appId);
    } else {
        VFS.readFile(iconData.path).then(async fileData => { 
            if(!fileData) {
                playSound('error');
                const confirmDelete = await showMessageBox(
                    '', 
                    `${iconData.name}`,
                    { showCancel: true }
                );
                if (confirmDelete) {
                    desktopIcons.splice(index, 1);
                    saveDesktopIcons();
                    renderDesktopIcons();
                }
                return;}
const appMap = {
    'image/': 'image-viewer',
    'audio/': 'music-player',
    'video/': 'media-player',
    'text/plain': 'text-reader', 
    'text/html': 'html-editor' 
};
                    let appIdToLaunch = null;
                    for (const [typePrefix, appId] of Object.entries(appMap)) {
                        if (fileData.type && fileData.type.startsWith(typePrefix)) {
                            appIdToLaunch = appId;
                            break;
                        }
                    }
                    if (appIdToLaunch) {
                        launchApp(appIdToLaunch, { path: iconData.path });
                    } else {
                        createNotification('', `${iconData.name}`, 'error');
                    }
                });
            }
        };
        iconEl.addEventListener('dblclick', dblClickHandler);
        iconEl.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const renameAction = () => {
                const label = iconEl.querySelector('.desktop-icon-label');
                if (!label) return;
                const currentName = label.textContent;
                label.innerHTML = `<input type="text" class="w-full text-center bg-transparent border border-blue-500 rounded outline-none" style="color: white;" value="${currentName}">`;
                const input = label.querySelector('input');
                input.focus();
                input.select();
                const saveName = () => {
                    const newName = input.value.trim();
                    if (newName && newName !== currentName) {
                        desktopIcons[index].name = newName;
                        saveDesktopIcons();
                    }
                    renderDesktopIcons(); 
                };
                input.addEventListener('blur', saveName);
                input.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter') input.blur();
                    else if (ev.key === 'Escape') renderDesktopIcons();
                });
            };
            const menuItems = [
                { label: '', icon: 'fas fa-folder-open', action: dblClickHandler },
                { label: '', icon: 'fas fa-pen', action: renameAction },
                { separator: true },
                { label: '', icon: 'fas fa-trash', action: () => {
                    desktopIcons.splice(index, 1);
                    saveDesktopIcons();
                    renderDesktopIcons();
                }}
            ];
            showContextMenu(menuItems, e);
        });
        iconEl.addEventListener('mousedown', (e) => {
            if (e.button !== 0) return;
            e.preventDefault();
            e.stopPropagation();
            iconEl.classList.add('selected');
            const shiftX = e.clientX - iconEl.getBoundingClientRect().left;
            const shiftY = e.clientY - iconEl.getBoundingClientRect().top;
            const moveAt = (pageX, pageY) => {
                let newX = pageX - shiftX;
                let newY = pageY - shiftY;
                newX = Math.max(0, Math.min(newX, desktop.clientWidth - iconEl.offsetWidth));
                newY = Math.max(0, Math.min(newY, desktop.clientHeight - iconEl.offsetHeight));
                if (desktopIconAlignment === 'grid') {
                    const gridSize = 100;
                    newX = Math.round(newX / gridSize) * gridSize + 10;
                    newY = Math.round(newY / gridSize) * gridSize + 10;
                }
                iconEl.style.left = `${newX}px`;
                iconEl.style.top = `${newY}px`;
            };
            const onMouseMove = (event) => {
                if (iconEl.style.position !== 'absolute') {
                    const rect = iconEl.getBoundingClientRect();
                    iconEl.style.position = 'absolute';
                    iconEl.style.left = `${rect.left}px`;
                    iconEl.style.top = `${rect.top}px`;
                    desktopIconsEl.appendChild(iconEl); 
                }
                moveAt(event.pageX, event.pageY);
            };
            document.addEventListener('mousemove', onMouseMove);
            iconEl.onmouseup = () => {
                document.removeEventListener('mousemove', onMouseMove);
                iconEl.onmouseup = null;
                desktopIcons[index].x = parseInt(iconEl.style.left);
                desktopIcons[index].y = parseInt(iconEl.style.top);
                saveDesktopIcons();
                if (desktopIconAlignment === 'grid') {
                    desktopIcons.sort((a, b) => (a.y - b.y) || (a.x - b.x));
                    saveDesktopIcons();
                    renderDesktopIcons();
                }
                setTimeout(() => iconEl.classList.remove('selected'), 200);
            };
        });
        desktopIconsEl.appendChild(iconEl);
    });
    desktopIconsEl.scrollTop = scrollTop;
}
function createPopup(id, title, contentHtml, width = 350, height = 150) {
    const popupId = `popup-window-${id}`;
    document.getElementById(popupId)?.remove();
    const popup = document.createElement('div');
    popup.id = popupId;
    popup.className = 'app-window active'; 
    popup.style.width = `${width}px`;
    popup.style.height = `${height}px`;
    popup.style.left = `calc(50% - ${width / 2}px)`;
    popup.style.top = `calc(50% - ${height / 2}px)`;
    popup.style.resize = 'none'; 
    popup.innerHTML = `
        <div class="window-header">
            <div class="window-controls">
                <div class="window-control-btn close" title=""><i class="fas fa-times"></i></div>
            </div>
            <span>${title}</span>
        </div>
        <div class="window-content p-4">${contentHtml}</div>
    `;
    popup.querySelector('.close').onclick = () => popup.remove();
    const header = popup.querySelector('.window-header');
    header.onmousedown = (e) => {
        if (e.target.closest('.window-controls')) return;
        let offsetX = e.clientX - popup.getBoundingClientRect().left;
        let offsetY = e.clientY - popup.getBoundingClientRect().top;
        document.onmousemove = (moveEvent) => {
            popup.style.left = `${moveEvent.clientX - offsetX}px`;
            popup.style.top = `${moveEvent.clientY - offsetY}px`;
        };
        document.onmouseup = () => {
            document.onmousemove = null;
            document.onmouseup = null;
        };
    };
    desktop.appendChild(popup);
    bringWindowToFront(popup);
    return popup;
}
function showContextMenu(menuItems, event) {
    event.preventDefault();
    event.stopPropagation();
    closeContextMenu();
    const contextMenu = document.getElementById('context-menu');
    contextMenu.innerHTML = '';
    menuItems.forEach(item => {
        if (item.separator) {
            const separator = document.createElement('div');
            separator.className = 'context-menu-separator';
            contextMenu.appendChild(separator);
        } else {
            const menuItem = document.createElement('div');
            menuItem.className = 'taskbar-context-menu-item';
            menuItem.innerHTML = `<i class="${item.icon || 'fas fa-circle fa-xs'} mr-3 w-4 text-center"></i> <span>${item.label}</span> ${item.submenu ? '<i class="fas fa-chevron-right ml-auto text-xs opacity-50"></i>' : ''}`;
            if (item.action) {
                menuItem.addEventListener('click', (e) => {
                    e.stopPropagation();
                    item.action();
                    closeContextMenu();
                });
                menuItem.addEventListener('mouseenter', () => {
                     document.querySelectorAll('.submenu-instance').forEach(sm => sm.classList.add('hidden'));
                });
} else if (item.submenu && item.submenu.length > 0) {
    menuItem.addEventListener('mouseenter', () => {
        closeAllSubmenus();
        const showTimer = setTimeout(() => {
            const submenu = document.createElement('div');
            submenu.className = 'taskbar-context-menu fixed z-[3001] submenu-instance';
            item.submenu.forEach(subItem => {
                const subMenuItem = document.createElement('div');
                subMenuItem.className = 'taskbar-context-menu-item';
                subMenuItem.innerHTML = `<i class="${subItem.icon || 'fas fa-circle fa-xs'} mr-3 w-4 text-center"></i> <span>${subItem.label}</span>`;
                subMenuItem.onclick = (e) => {
                    e.stopPropagation();
                    if(subItem.action) subItem.action();
                    closeContextMenu();
                };
                submenu.appendChild(subMenuItem);
            });
            document.body.appendChild(submenu);
            const parentRect = menuItem.getBoundingClientRect();
            const menuWidth = submenu.offsetWidth, menuHeight = submenu.offsetHeight;
            let left = parentRect.right, top = parentRect.top;
            if (left + menuWidth > window.innerWidth - 10) left = parentRect.left - menuWidth;
            if (top + menuHeight > window.innerHeight - 10) top = window.innerHeight - menuHeight - 10;
            submenu.style.top = `${top}px`;
            submenu.style.left = `${left}px`;
            submenu.classList.add('active');
            submenu.addEventListener('mouseleave', () => {
                submenu.classList.remove('active');
                setTimeout(() => submenu.remove(), 300);
            });
        }, 400);
        menuItem.addEventListener('mouseleave', () => {
            clearTimeout(showTimer);
        });
    });
} else {
                menuItem.classList.add('opacity-50', 'cursor-not-allowed');
            }
            contextMenu.appendChild(menuItem);
        }
    });
    contextMenu.addEventListener('mouseleave', (e) => {
        if (!e.relatedTarget || !e.relatedTarget.closest('.submenu-instance')) {
             document.querySelectorAll('.submenu-instance').forEach(sm => sm.classList.add('hidden'));
        }
    });
    const x = Math.min(event.clientX, window.innerWidth - contextMenu.offsetWidth - 10);
    const y = Math.min(event.clientY, window.innerHeight - contextMenu.offsetHeight - 10);
    contextMenu.style.left = `${x}px`;
    contextMenu.style.top = `${y}px`;
    contextMenu.classList.remove('hidden');
    setTimeout(() => contextMenu.classList.add('active'), 10);
    document.addEventListener('click', handleClickOutsideContextMenu, true);
    document.addEventListener('contextmenu', handleClickOutsideContextMenu, true);
}
function closeContextMenu() {
    const contextMenu = document.getElementById('context-menu');
    if (contextMenu) {
        contextMenu.classList.remove('active');
    }
    closeAllSubmenus();
    document.removeEventListener('click', handleClickOutsideContextMenu, true);
    document.removeEventListener('contextmenu', handleClickOutsideContextMenu, true);
}
function closeAllSubmenus() {
    document.querySelectorAll('.submenu-instance').forEach(submenu => {
        submenu.classList.remove('active');
        setTimeout(() => submenu.remove(), 300);
    });
}
let desktopIconsEl = document.getElementById('desktop-icons');
desktop.addEventListener('dragover', (e) => e.preventDefault());
function handleClickOutsideContextMenu(event) {
    const contextMenu = document.getElementById('context-menu');
    if (contextMenu && !contextMenu.contains(event.target)) {
        closeContextMenu();
    }
}
function lockOS() {
    isLocked = true;
    closeAllPanels();
    taskbar.style.display = 'none';
    updateTaskbarAppStatus(); 
    const bgDiv = document.getElementById('lock-screen-bg');
    if (dynamicWallpaperContainer.style.display === 'block') {
        const snapshotCanvas = document.createElement('canvas');
        snapshotCanvas.width = skyCanvas.width;
        snapshotCanvas.height = skyCanvas.height;
        const snapshotCtx = snapshotCanvas.getContext('2d');
        snapshotCtx.drawImage(skyCanvas, 0, 0);
        snapshotCtx.drawImage(landscapeCanvas, 0, 0);
        bgDiv.style.backgroundImage = `url('${snapshotCanvas.toDataURL()}')`;
        if (dynamicWallpaperAnimationId) {
            cancelAnimationFrame(dynamicWallpaperAnimationId);
            dynamicWallpaperAnimationId = null;
        }
    } else {
        bgDiv.style.backgroundImage = osContainer.style.backgroundImage;
    }
    const iconWrapper = document.getElementById('lock-screen-icon-wrapper');
    if (iconWrapper) {
        if (userIcon.mode === 'composite') {
            iconWrapper.innerHTML = `
                <img src="${userIcon.composite.base || ''}" class="absolute inset-0 w-full h-full">
                <img src="${userIcon.composite.eyes || ''}" class="absolute inset-0 w-full h-full">
                <img src="${userIcon.composite.mouth || ''}" class="absolute inset-0 w-full h-full">
                <img src="${userIcon.composite.accessory || ''}" class="absolute inset-0 w-full h-full">
            `;
        } else {
            iconWrapper.innerHTML = `<img src="${userIcon.simpleUrl}" class="absolute inset-0 w-full h-full object-cover rounded-full">`;
        }
    }
    document.getElementById('lock-screen-user-name').textContent = userName;
    lockScreen.classList.remove('password-mode');
    lockScreen.classList.remove('hidden');
    setTimeout(() => lockScreen.classList.add('visible'), 50);
    updateTime();
    startFaceAuthOnLockScreen();
}
async function unlockOS( bypassPasswordCheck = false ) {
    let passwordCorrect = false; 
    if (bypassPasswordCheck) {
        passwordCorrect = true;
    } 
    else if (passwordLoginEnabled) {
        if (osPasswordType === 'pin') {
            const lockPinInput = document.getElementById('lock-pin-input');
            if (lockPinInput && lockPinInput.value === osPassword) {
                passwordCorrect = true;
            } else {
                const errorMsgEl = document.getElementById('lock-screen-error-message');
                if (errorMsgEl) errorMsgEl.textContent = 'PIN';
                if (lockPinInput) {
                    lockPinInput.value = '';
                    lockPinInput.focus();
                }
            }
        } else if (osPasswordType === 'pattern') {
        }
    } 
    else {
        passwordCorrect = true;
    }
    if (passwordCorrect) {
        isLocked = false;
        osContainer.style.opacity = '1';
        lockScreen.classList.remove('visible');
        taskbar.style.display = 'flex';
        updateTaskbarAppStatus();
        setTimeout(() => {
            lockScreen.classList.add('hidden');
        }, 500);
        if (bootRepairReport) {
            setTimeout(() => {
                playSound('error');
                createNotification(
                    '',
                    '',
                    'warning',
                    10 
                );
                setTimeout(() => {
                const repairedMsg = bootRepairReport.repaired > 0 ? `${bootRepairReport.repaired}` : '';
                const rescuedMsg = bootRepairReport.rescued > 0 ? `${bootRepairReport.rescued}/System/Recovered Files` : '';
                playSound('notification');
                createNotification(
                    '',
                    [repairedMsg, rescuedMsg].filter(Boolean).join('\n'), 
                    'info', 
                    15 
                );
                bootRepairReport = null;
                }, 1500);
            }, 1000);
        }
            const dynamicWallpaperPreview = document.querySelector('.wallpaper-preview[data-wallpaper="dynamic"]');
    if (dynamicWallpaperPreview && dynamicWallpaperPreview.classList.contains('selected')) {
        setDynamicWallpaperActive(true);
    }
    }
}
function renderLockScreenPasswordInput() {
    const passwordArea = document.getElementById('lock-screen-password-area');
    if (!passwordArea) {
        console.error("Critical Error: #lock-screen-password-area not found!");
        return;
    }
    passwordArea.innerHTML = '';
    if (osPasswordType === 'pin') {
        passwordArea.innerHTML = `
            <div id="lock-pin-input-container">
                <input type="password" id="lock-pin-input" placeholder="PIN" autofocus>
                <button id="unlock-button"><i class="fas fa-arrow-right"></i></button>
            </div>
            <div id="lock-screen-error-message" class="text-red-400 text-sm text-center mt-2 h-5"></div>
        `;
        const unlockButton = passwordArea.querySelector('#unlock-button');
        const lockPinInput = passwordArea.querySelector('#lock-pin-input');
        unlockButton.addEventListener('click', () => unlockOS());
        lockPinInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                unlockOS();
            }
        });
    } else if (osPasswordType === 'pattern') {
        let enteredPattern = [];
        passwordArea.innerHTML = `
            <div class="bg-black/40 backdrop-blur-md p-5 rounded-xl">
                <p class="text-sm mb-2 text-center"></p>
                <div class="password-pattern-grid grid grid-cols-4 gap-2 w-48 mx-auto">
                    ${Array(16).fill().map((_, i) => `<button data-index="${i}"></button>`).join('')}
                </div>
                <div id="lock-screen-error-message" class="text-red-400 text-sm text-center mt-2 h-5"></div>
                <div class="flex justify-center gap-2 mt-3">
                    <button id="clear-pattern-input-button" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition"></button>
                    <button id="unlock-button-pattern" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"></button>
                </div>
            </div>
        `;
        const patternGridButtons = passwordArea.querySelectorAll('.password-pattern-grid button');
        const errorMsgEl = passwordArea.querySelector('#lock-screen-error-message');
        patternGridButtons.forEach(button => {
            button.addEventListener('click', () => {
                const index = parseInt(button.dataset.index);
                if (!button.classList.contains('selected')) {
                    button.classList.add('selected');
                    enteredPattern.push(index);
                }
            });
        });
        passwordArea.querySelector('#clear-pattern-input-button').onclick = () => {
            enteredPattern = [];
            patternGridButtons.forEach(b => b.classList.remove('selected'));
            if (errorMsgEl) {
                errorMsgEl.textContent = '';
            }
        };
        passwordArea.querySelector('#unlock-button-pattern').onclick = () => {
            if (JSON.stringify(enteredPattern) === JSON.stringify(osPatternPassword)) {
                unlockOS(true);
            } else {
                if (errorMsgEl) {
                    errorMsgEl.textContent = '';
                }
                enteredPattern = [];
                patternGridButtons.forEach(b => b.classList.remove('selected'));
            }
        };
    }
}
lockScreen.addEventListener('click', (e) => {
    if (e.target.closest('#lock-screen-password-area')) {
        return;
    }
    const isClickOnValidArea = e.target.closest('#lock-screen-bg') || 
                               e.target.closest('#lock-screen-default-content');
    if (isClickOnValidArea && isLocked && !lockScreen.classList.contains('password-mode')) {
        const isPasswordSet = passwordLoginEnabled && (osPassword || (osPatternPassword && osPatternPassword.length > 0));
        if (isPasswordSet) {
            lockScreen.classList.add('password-mode');
            renderLockScreenPasswordInput();
        } else {
            unlockOS();
        }
    }
});
        setInterval(updateTime, 1000);
        updateTime();
        applyTheme();
                setInterval(() => {
            updateTime();
        }, 1000);
        updateTime();
        osContainer.style.backgroundImage = `url('${currentWallpaper}')`;
        currentTimeDisplay.addEventListener('click', () => togglePanel(quickSettingsPanel, startMenuPanel));
        desktop.addEventListener('click', (e) => {
            if (!quickSettingsPanel.contains(e.target) && !currentTimeDisplay.contains(e.target) &&
                !startMenuPanel.contains(e.target) && !menuButton.contains(e.target) &&
                (quickSettingsPanel.classList.contains('active') || startMenuPanel.classList.contains('active'))) {
                closeAllPanels();
            }
            closeAppContextMenu();
        });
let hideTaskbarTimeout;
let globalMouseY = 0;
document.addEventListener('mousemove', e => {
    globalMouseY = e.clientY;
}, { passive: true });
let hideTaskbarTimeoutId = null;
let isTaskbarCurrentlyVisible = true;
function checkTaskbarVisibility() {
    if (taskbarAlwaysVisible || openApps.size === 0) {
        taskbar.classList.remove('hidden');
        isTaskbarCurrentlyVisible = true;
        clearTimeout(hideTaskbarTimeoutId);
        return;
    }
    const shouldBeVisible = (globalMouseY >= window.innerHeight - 2 || taskbar.matches(':hover'));
    if (shouldBeVisible) {
        clearTimeout(hideTaskbarTimeoutId);
        hideTaskbarTimeoutId = null;
        if (!isTaskbarCurrentlyVisible) {
            taskbar.classList.remove('hidden');
            isTaskbarCurrentlyVisible = true;
        }
    } else {
        if (isTaskbarCurrentlyVisible && hideTaskbarTimeoutId === null) {
            hideTaskbarTimeoutId = setTimeout(() => {
                taskbar.classList.add('hidden');
                isTaskbarCurrentlyVisible = false;
                hideTaskbarTimeoutId = null; 
            }, 500); 
        }
    }
}
setInterval(checkTaskbarVisibility, 100);
taskbar.addEventListener('mouseenter', () => {
    clearTimeout(hideTaskbarTimeout);
});
taskbar.addEventListener('mouseleave', (e) => {
    if (taskbarAlwaysVisible || openApps.size === 0) return;
    if (e.clientY < window.innerHeight - taskbar.offsetHeight) {
        taskbar.classList.add('hidden');
    }
});
        allAppsSearchBar.addEventListener('input', populateAllApps);
        exitAllAppsButton.addEventListener('click', () => {
            allAppsFullscreen.classList.remove('active'); pinMode = false; selectPinAppsButton.classList.remove('active');
            document.querySelectorAll('.app-icon-fullscreen').forEach(icon => icon.classList.remove('pin-mode'));
            updateTaskbarAppStatus();
        });
selectPinAppsButton.addEventListener('click', () => {
    pinMode = !pinMode;
    selectPinAppsButton.classList.toggle('active', pinMode);
    allAppsFullscreen.querySelectorAll('.app-icon-fullscreen').forEach(icon => {
        icon.classList.toggle('pin-mode', pinMode);
    });
});
        function addRecentItem(appId, appName, appIcon) {
            recentItems = recentItems.filter(item => item.id !== appId);
            recentItems.unshift({ type: 'app', id: appId, name: appName, icon: appIcon });
            if (recentItems.length > 5) recentItems.pop();
            saveRecentItems();
        }
        function applyAppIconSize() {
            document.querySelectorAll('.taskbar-icon').forEach(icon => {
                icon.style.width = `${appIconSize}px`;
                icon.style.height = `${appIconSize}px`;
                const iTag = icon.querySelector('i');
                if (iTag) iTag.style.fontSize = `${appIconSize * 0.5}px`; 
            });
            taskbar.style.height = `${appIconSize + 20}px`;
            quickSettingsPanel.style.bottom = `${appIconSize + 30}px`;
            startMenuPanel.style.bottom = `${appIconSize + 30}px`;
        }
        let draggedSortableItem = null;
        function handleSortableDragStart(e) {
            draggedSortableItem = e.target;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.dataset.appId);
            setTimeout(() => e.target.style.opacity = '0.5', 0);
        }
        function handleSortableDragOver(e) {
            e.preventDefault();
            const target = e.target.closest('[draggable="true"]');
            if (target && target !== draggedSortableItem) {
                const rect = target.getBoundingClientRect();
                const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > .5;
                appBarSortableList.insertBefore(draggedSortableItem, next && target.nextSibling || target);
            }
        }
function handleSortableDrop(e) {
    e.preventDefault();
    e.target.style.opacity = '1';
    draggedSortableItem.style.opacity = '1';
    const appBarSortableList = document.getElementById('app-bar-sortable-list');
    if (appBarSortableList) {
        const newOrder = [];
        appBarSortableList.querySelectorAll('[data-app-id]').forEach(item => {
            newOrder.push(item.dataset.appId);
        });
        pinnedApps = newOrder;
        savePinnedApps(); 
    }
}
function handleSortableDragEnd(e) {
    e.target.style.opacity = '1';
    draggedSortableItem = null;
}
function setupLauncher() {
    const startMenu = document.getElementById('start-menu');
    const searchBar = document.getElementById('launcher-search-bar');
    const showAllBtn = document.getElementById('launcher-show-all-apps-btn');
    const recentAppsContainer = document.getElementById('launcher-recent-apps');
    const appGrid = document.getElementById('launcher-app-grid');
    const menuButton = document.getElementById('menu-button');
    if (!startMenu || !searchBar || !showAllBtn || !recentAppsContainer || !appGrid || !menuButton) {
        return;
    }
    const adjustHeaderWidths = () => {
        const totalWidth = showAllBtn.parentElement.offsetWidth;
        const btnWidth = Math.floor(totalWidth / 5);
        showAllBtn.style.width = `${btnWidth}px`;
        searchBar.style.width = `calc(100% - ${btnWidth}px - 12px)`;
    };
    const renderLauncherContent = (filterText = '') => {
        recentAppsContainer.innerHTML = '';
        const recentAppsToShow = recentItems.filter(item => item.type === 'app').slice(0, 10);
        if (recentAppsToShow.length > 0) {
            recentAppsToShow.forEach(item => {
                const app = apps.find(a => a.id === item.id);
                if (app) {
                    const iconDiv = document.createElement('div');
                    iconDiv.className = 'flex flex-col items-center gap-1 cursor-pointer p-1 rounded-lg hover:bg-white/10 flex-shrink-0 w-16';
                    iconDiv.title = app.name;
                    let iconHtml = app.icon.endsWith('.svg') ? `<img src="${app.icon}" class="w-10 h-10">` : `<i class="${app.icon} text-2xl"></i>`;
                    iconDiv.innerHTML = `
                        <div class="w-12 h-12 rounded-full grid place-items-center bg-white/5">${iconHtml}</div>
                        <p class="text-xs text-center w-full truncate">${app.name}</p>`;
                    iconDiv.addEventListener('click', () => { launchApp(app.id); closeAllPanels(); });
                    recentAppsContainer.appendChild(iconDiv);
                }
            });
        } else {
            recentAppsContainer.innerHTML = `<p class="text-xs text-gray-500 px-2"></p>`;
        }
        const lowerFilter = filterText.toLowerCase();
        const filteredApps = apps.filter(app => app.installed && app.name.toLowerCase().includes(lowerFilter));
        appGrid.style.display = 'grid';
        appGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(80px, 1fr))';
        appGrid.style.gap = '15px';
        appGrid.innerHTML = '';
        if (filteredApps.length === 0) {
            appGrid.innerHTML = `<p class="col-span-full text-center text-gray-500"></p>`;
        } else {
            filteredApps.forEach(app => {
                const iconDiv = document.createElement('div');
                iconDiv.className = 'flex flex-col items-center gap-1 cursor-pointer p-1 rounded-lg hover:bg-white/10';
                iconDiv.title = app.name;
                let iconHtml = app.icon.endsWith('.svg') ? `<img src="${app.icon}" class="w-8 h-8">` : `<i class="${app.icon} text-xl"></i>`;
                iconDiv.innerHTML = `
                    <div class="w-10 h-10 rounded-lg grid place-items-center bg-white/5">${iconHtml}</div>
                    <p class="text-xs text-center w-full truncate">${app.name}</p>`;
                iconDiv.addEventListener('click', () => { launchApp(app.id); closeAllPanels(); });
                appGrid.appendChild(iconDiv);
            });
        }
    };
    menuButton.addEventListener('click', (e) => {
        e.stopPropagation();
        const isActive = startMenu.classList.contains('active');
        closeAllPanels(); 
        if (!isActive) {
            startMenu.classList.add('active');
            renderLauncherContent();
            adjustHeaderWidths();
            searchBar.focus();
        }
    });
    searchBar.addEventListener('input', () => renderLauncherContent(searchBar.value));
    showAllBtn.addEventListener('click', () => {
        closeAllPanels(); 
        populateAllApps();
        allAppsFullscreen.classList.add('active');
        taskbar.classList.add('full-width');
    });
}
window.addEventListener('load', async () => {
    osContainer.style.visibility = 'hidden';
    taskbar.classList.add('hidden');
    applyVisualEffects();
    applyGlassEffectToPanels();
    setupLauncher();
    await VFS.init();
    savePinnedApps();
    populateAllApps();
    applyAppIconSize();
    renderDesktopIcons();
    updateTaskbarAppStatus();
    taskbar.classList.add('hidden');
    document.getElementById('mission-control-btn').addEventListener('click', toggleMissionControl);
    const isSetupComplete = JSON.parse(localStorage.getItem('riviftSetupComplete')) || false;
    const bootScreen = document.getElementById('boot-screen');
    const bootLogo = document.getElementById('boot-logo-container');
    const bootVersion = document.getElementById('boot-version-text');
    const bootLoader = document.getElementById('boot-loader');
    if (!isSetupComplete) {
        if(bootLogo) bootLogo.style.opacity = '0';
        if(bootVersion) bootVersion.style.opacity = '0';
        if(bootLoader) bootLoader.style.opacity = '0';
        setTimeout(() => {
            if (bootScreen) bootScreen.style.opacity = '0';
            setTimeout(() => {
                if (bootScreen) bootScreen.style.display = 'none';
                initializeSetupScreen();
            }, 500);
        }, 500);
    } else {
        if(bootScreen) bootScreen.classList.add('start-anim');
        setTimeout(() => playSound('startup'), 500);
        setTimeout(() => {
            if (bootScreen) bootScreen.style.opacity = '0';
            setTimeout(() => {
                if (bootScreen) bootScreen.style.display = 'none';
                finishSetupAndBoot();
            }, 1000);
        }, 4000);
    }
});
function finishSetupAndBoot() {
            loadAccentColorSettings();
            applyAccentColor(currentAccentColor);
            applyTheme();
            applyTaskbarAlignment(); 
            osContainer.style.backgroundImage = `url('${currentWallpaper}')`;
            lockOS();
            osContainer.style.visibility = 'visible';
            osContainer.style.opacity = '1';
            renderWidgets();
        }
        setInterval(() => {
    updateTime();
    updateAllWidgets(); 
}, 1000);
function applyGlassEffectToPanels() {
    const elementsToStyle = [
        '#taskbar', '#quick-settings', '#start-menu', '#all-apps-fullscreen',
        '.app-window'
    ];
    document.querySelectorAll(elementsToStyle.join(', ')).forEach(el => {
        el.classList.add('glass-effect');
    });
}
});
</script>
</body>
</html>